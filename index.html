<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daytona Account Utility v4.0 (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; padding: 1rem; }
        
        /* Cards */
        .card { background-color: #fff; border: 1px solid #94a3b8; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .card-header { font-size: 1rem; font-weight: 600; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between; }
        
        /* Inputs */
        .pa-input, .pa-textarea, .pa-select { box-sizing: border-box; border-color: #cbd5e1; background-color: #f8fafc; font-size: 0.875rem; padding: 0.5rem; border-width: 1px; border-radius: 0.375rem; width: 100%; transition: all 0.2s; }
        .pa-input:focus, .pa-textarea:focus, .pa-select:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); border-color: #3b82f6; outline: none; background-color: #fff; }
        
        .editable-field { box-sizing: border-box; width: 100%; font-size: 0.875rem; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid transparent; background: transparent; }
        .editable-field:disabled { color: #374151; cursor: default; }
        .is-editable { background-color: #fffbeb !important; border-color: #fcd34d !important; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* Layout */
        .main-content-wrapper { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; width: 100%; max-width: 1920px; margin: 0 auto; }
        .left-column-container { height: calc(100vh - 100px); display: grid; grid-template-rows: 1fr 1fr; gap: 1rem; }
        .right-column-container { height: calc(100vh - 100px); overflow-y: auto; padding-right: 5px; }
        
        .gallery-section .card, #sales-data-container { height: 100%; display: flex; flex-direction: column; padding: 0.75rem; }
        .record-gallery-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; padding-right: 4px; }
        
        /* Gallery Items */
        .gallery-item { display: flex; flex-direction: column; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; background-color: #fff; transition: all 0.2s; cursor: pointer; }
        .gallery-item:hover { border-color: #60a5fa; background-color: #f0f9ff; }
        .gallery-item.is-selected { border-color: #2563eb; background-color: #eff6ff; box-shadow: inset 4px 0 0 0 #2563eb; }
        .gallery-item-id { color: #1e40af; font-weight: 700; font-size: 0.9rem; } 
        .gallery-item-company { color: #334155; font-weight: 600; font-size: 0.85rem; margin-top: 2px; }
        .gallery-item-rep { color: #64748b; font-size: 0.75rem; italic; margin-top: 4px; }

        /* Sticky Header & Marquee */
        #contact-sticky-header { position: sticky; top: 0; z-index: 10; background-color: #e2e8f0; padding-bottom: 1rem; }
        #sales-advisory-marquee { overflow: hidden; background-color: #fee2e2; border: 1px solid #f87171; border-radius: 0.25rem; margin-top: 0.5rem; height: 24px; display: flex; align-items: center; }
        .marquee-content { animation: marquee 15s linear infinite; color: #b91c1c; font-weight: 700; font-size: 0.75rem; white-space: nowrap; display: inline-block; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* AI Summary */
        .ai-summary-box { border-left: 4px solid; padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 0.25rem; background-color: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .ai-imp { border-color: #dc2626; background-color: #fef2f2; }
        .ai-mgr { border-color: #16a34a; background-color: #f0fdf4; }
        .ai-key { border-color: #2563eb; background-color: #f8fafc; }
        .ai-title { font-weight: 700; font-size: 0.75rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .ai-content { font-size: 0.85rem; line-height: 1.4; white-space: pre-wrap; color: #334155; }
        
        .note-preview-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #e2e8f0; }
        .note-preview-item h4 { font-weight: 700; font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
        .note-preview-item pre { white-space: pre-wrap; font-family: 'Inter', sans-serif; font-size: 0.85rem; color: #334155; background: #f8fafc; padding: 0.5rem; border-radius: 0.25rem; }
        
        .loader-container { display: flex; justify-content: center; padding: 2rem; color: #64748b; font-style: italic; }
    </style>
</head>
<body class="p-0 md:p-4">

    <div id="login-container" class="fixed inset-0 bg-slate-900 bg-opacity-90 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
            <i class="fas fa-lock text-5xl text-blue-600 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Daytona Account Utility</h3>
            <p class="text-gray-600 mb-6">Please log in to access your accounts.</p>
            <button onclick="login()" id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center text-lg shadow-lg">
                Sign in with Microsoft
            </button>
            <p id="login-error" class="text-red-600 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <div id="main-app-container" class="hidden">
        <div id="header-panel" class="bg-white p-3 shadow-md mb-4 sticky top-0 z-20 w-full border-b border-gray-200">
            <div class="flex flex-wrap items-center justify-between gap-3 px-4 md:px-0">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold text-gray-800 whitespace-nowrap"><i class="fas fa-list-ul text-blue-600 mr-1"></i> My Accounts</h2>
                    <button onclick="loadRecords()" id="load-records-button" class="py-1 px-3 text-sm rounded-md shadow transition-all duration-200 font-bold bg-green-600 text-white hover:bg-green-700 flex items-center">
                        <i class="fas fa-sync-alt mr-1.5"></i> Refresh
                    </button>
                    <span id="welcome-message" class="text-sm font-medium text-gray-600 hidden"></span>
                </div>
                <div class="flex-grow min-w-[200px] max-w-xs relative">
                    <input type="text" id="search-bar" onkeyup="filterAndSortGallery()" placeholder="Search accounts..." class="pa-input pl-9 w-full text-sm" />
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <select id="sort-dropdown" onchange="filterAndSortGallery()" class="pa-select text-xs">
                        <option value="company-asc">Sort: Company A-Z</option>
                        <option value="company-desc">Sort: Company Z-A</option>
                        <option value="followup-asc">Sort: Follow Up &#x2191;</option>
                    </select>
                    <div class="flex items-center gap-3 border-l pl-3 ml-1">
                        <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer"><input type="checkbox" id="filter-followup" onchange="filterAndSortGallery()"> <span>Follow Ups</span></label>
                        <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer"><input type="checkbox" id="filter-nonotes" onchange="filterAndSortGallery()"> <span>No Notes</span></label>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content-wrapper w-full px-4 md:px-0">
            <div class="left-column-container">
                <div id="gallery-section" class="card p-3 flex flex-col min-h-0">
                    <h3 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-200">Account List</h3>
                    <div id="record-gallery-list" class="record-gallery-list flex-grow min-h-0">
                        <div class="loader-container"><span>Records not loaded.</span></div>
                    </div>
                </div>
                
                <div id="sales-data-container" class="card p-3 flex-grow min-h-0">
                    <h3 class="text-sm font-bold text-green-800 mb-3 pb-2 border-b border-green-200">Sales Snapshot</h3>
                    <div id="sales-advisory-marquee">
                        <div class="marquee-content">Invoiced Sales Only - May Not Include Open Orders!</div>
                    </div>
                    <div id="sales-loader" class="loader-container text-xs italic text-gray-500 py-2 hidden"><span>Loading...</span></div>
                    <div id="sales-content" class="space-y-3 hidden mt-3">
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div><dt class="sales-dt">YTD Sales</dt><dd class="sales-dd text-green-700" id="sales-ytd">--</dd></div>
                            <div><dt class="sales-dt">Orders</dt><dd class="sales-dd" id="sales-total-orders">--</dd></div>
                            <div class="col-span-2"><dt class="sales-dt">Last Order</dt><dd class="sales-dd" id="sales-last-order">--</dd></div>
                        </dl>
                        <div class="border-t pt-2">
                            <h4 class="text-xs font-semibold text-gray-500 mb-1">Category Breakdown</h4>
                            <ul id="sales-category-list" class="space-y-0.5 pr-1" style="max-height: 15rem; overflow-y: auto;"></ul>
                        </div>
                        <div id="live-clock-container" class="pt-2 border-t mt-2"><div id="clock-display" class="text-xs text-center text-gray-500">--</div></div>
                    </div>
                    <div id="sales-placeholder" class="text-xs text-gray-400 italic text-center py-4">Select an account to view sales.</div>
                </div>
            </div>
            
            <div class="right-column-container">
                <div class="space-y-4">
                    <div id="contact-sticky-header">
                         <div id="profile-card" class="card p-4">
                            <div class="card-header">
                                <span><i class="fas fa-id-card text-blue-600"></i> Profile: <span id="acct-number-header" class="font-bold text-blue-700">--</span></span>
                                <div class="flex items-center gap-2">
                                    <button onclick="showManagerFeedback()" class="bg-red-100 hover:bg-red-200 text-red-700 border border-red-200 font-bold py-1 px-2 rounded text-xs">Mgr Feedback</button>
                                    <button onclick="showImportantInfo()" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 border border-yellow-200 font-bold py-1 px-2 rounded text-xs">Imp Info</button>
                                    <button onclick="toggleEditMode()" id="editModeButton" class="py-1 px-3 text-xs rounded font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-300" disabled>Edit Profile</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                                <div><label class="profile-dt">Primary Contact</label><input type="text" id="contact-name-most" class="editable-field" disabled></div>
                                <div><label class="profile-dt">Recent Contact</label><input type="text" id="contact-name-latest" class="editable-field" disabled></div>
                                <div><label class="profile-dt">Phone</label><input type="text" id="contact-phone-primary" class="editable-field" disabled></div>
                                <div><label class="profile-dt">Email</label><input type="email" id="contact-email-most" class="editable-field" disabled></div>
                            </div>
                            <div class="mt-3 pt-2 border-t border-gray-100 grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                                <div><span class="text-gray-500 uppercase font-bold">Company:</span> <span id="acct-company" class="font-medium">--</span></div>
                                <div><span class="text-gray-500 uppercase font-bold">Days Last Order:</span> <span id="acct-days-last-order" class="font-medium">--</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="actions-section" class="card p-4">
                        <div class="card-header"><span><i class="fas fa-tasks text-blue-600"></i> Actions</span></div>
                        <div class="flex flex-col lg:flex-row gap-4">
                            <div class="flex-1 space-y-3">
                                <div class="bg-blue-50 p-3 rounded border border-blue-100">
                                    <label class="block text-xs font-bold text-blue-800 mb-1">Follow Up</label>
                                    <div class="flex gap-2">
                                        <input type="date" id="follow-up-date" class="pa-input text-sm" disabled>
                                        <input type="time" id="follow-up-time" class="w-full pa-input text-sm" disabled>
                                    </div>
                                    <button onclick="createCalendarEvent()" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1.5 rounded text-xs font-bold shadow-sm"><i class="fas fa-calendar-plus mr-1"></i> Add to Calendar</button>
                                </div>
                                <div class="flex gap-2">
                                    <button id="save-button" onclick="handleCustomSave()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow-sm text-sm disabled:opacity-50" disabled>Save</button>
                                    <button id="reset-button" onclick="handleCustomReset()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded shadow-sm text-sm disabled:opacity-50" disabled>Reset</button>
                                </div>
                            </div>
                            <div class="flex-1 space-y-3">
                                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                    <label class="block text-xs font-bold text-gray-700 mb-1">Email Templates</label>
                                    <div class="flex gap-2">
                                        <select id="email-template-dropdown" class="pa-select text-sm flex-grow" disabled>
                                            <option value="Green Category.msg">Green Category</option>
                                            <option value="Green Follow Up Email.msg">Green Follow Up</option>
                                            <option value="Green Non-Buy Email.msg">Green Non-Buy</option>
                                            <option value="Yellow Non-Buy Email.msg">Yellow Non-Buy</option>
                                        </select>
                                        <button onclick="handleActionButtonClick('LaunchEmail')" id="launch-email-button" class="bg-gray-700 hover:bg-gray-800 text-white px-3 rounded text-xs font-bold shadow-sm" disabled><i class="fas fa-paper-plane"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="handleActionButtonClick('Help')" id="help-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded shadow-sm text-xs" disabled>Help!</button>
                                    <button onclick="handleActionButtonClick('NoOpp')" id="noopp-button" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 rounded shadow-sm text-xs" disabled>NO OPP</button>
                                    <button onclick="handleActionButtonClick('CloseAccount')" id="close-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded shadow-sm text-xs" disabled>Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="notes-section" class="card p-4">
                        <div class="card-header"><span><i class="fas fa-sticky-note text-yellow-600"></i> Notes & AI Summary</span></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="flex flex-col h-full">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Enter New Notes:</label>
                                <textarea id="qb-notes-input" oninput="updateNotesPreview()" class="w-full p-3 border border-yellow-300 bg-yellow-50 rounded h-64 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none resize-none font-mono" placeholder="Enter notes..." disabled></textarea>
                            </div>
                            
                            <div class="flex flex-col h-full">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Context & Preview:</label>
                                <div class="flex flex-wrap gap-3 mb-2 text-xs border-b pb-2 border-gray-100">
                                    <label class="flex items-center cursor-pointer hover:text-blue-600 transition-colors"><input type="checkbox" id="show-ai-summary" checked onchange="updateNotesPreview()" class="mr-1.5 accent-blue-600"> <strong>AI Summary</strong></label>
                                    <label class="flex items-center cursor-pointer hover:text-blue-600 transition-colors"><input type="checkbox" id="show-new-note" checked onchange="updateNotesPreview()" class="mr-1.5 accent-blue-600"> New Note</label>
                                    <label class="flex items-center cursor-pointer hover:text-blue-600 transition-colors"><input type="checkbox" id="show-prev-note" onchange="updateNotesPreview()" class="mr-1.5 accent-blue-600"> Raw Previous</label>
                                    <label class="flex items-center cursor-pointer hover:text-blue-600 transition-colors"><input type="checkbox" id="show-mgr-note" onchange="updateNotesPreview()" class="mr-1.5 accent-blue-600"> Raw Manager</label>
                                    <label class="flex items-center cursor-pointer hover:text-blue-600 transition-colors"><input type="checkbox" id="show-imp-note" onchange="updateNotesPreview()" class="mr-1.5 accent-blue-600"> Raw Important</label>
                                </div>
                                <div id="qb-notes-preview" class="w-full p-3 border border-gray-200 rounded h-64 bg-white overflow-y-auto text-sm text-gray-700 shadow-inner">
                                    <p class="text-gray-400 italic text-center mt-10">Select an account to view summaries.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
         <div class="bg-white rounded p-6 max-w-sm w-full shadow-2xl"> 
             <h3 id="notification-title" class="text-lg font-bold text-gray-800 mb-2">Message</h3> 
             <p id="notification-message" class="text-gray-600 mb-4 text-sm"></p> 
             <button onclick="closeNotification()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded">OK</button> 
         </div>
    </div>
    
    <div id="manager-feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-2xl w-full border-t-4 border-red-500">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Manager Feedback</h3>
            <div id="manager-feedback-content" class="bg-gray-50 p-4 rounded h-64 overflow-y-auto whitespace-pre-wrap text-sm border border-gray-200 font-mono"></div>
            <button onclick="closeManagerFeedback()" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 rounded">Close</button>
        </div>
    </div>

    <div id="important-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-2xl w-full border-t-4 border-yellow-500">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Important Account Info</h3>
            <div id="important-info-content" class="bg-gray-50 p-4 rounded h-64 overflow-y-auto whitespace-pre-wrap text-sm border border-gray-200 font-mono"></div>
            <button onclick="closeImportantInfo()" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 rounded">Close</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & GLOBALS ---
        const msalConfig = {
            auth: {
                clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", 
                authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401",
                redirectUri: "https://WB-DT.github.io/daytona-utility/" 
            },
            cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
        };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null;
        
        // SAS URLs
        const GET_MY_RECORDS_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2d5cc7c0ffa34dcb87e6416df29b9acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8qFD-lNiuxDgafyu31UYZ8zzePJMRJ4wpUzLzbb9bMs";
        const PATCH_RECORD_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/774bb53ee87542e5825b46958f5bd55d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EbaJTl1gKlG8rjTn3ZmoLwUiQ430Sju1kWZYZ6hr0zE";
        const SALES_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a6f98d7dcf0434fa630e691778901bf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=me09n4bmICH84IIjEV0BDzCIeLfhoFdy5f7hB2AEDOw";
        const ACTION_BUTTON_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a2fa2c69f1d24a85a980599d21631808/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aSQ1J4-BFNxrOURAp3-8tCQwunP0JITYHZfWV5BbDYI";
        
        const QB_NOTES_TEMPLATE = `Locations: \nNumber of employees: \nCurrent Vendors: \nFrequency of Orders: \nMonthly spend: \nAnyone involved: \nNext Order Expected: \nOPP: \n`;

        let isEditMode = false;
        let allRecords = [];
        let currentSelectedRecord = null;
        let currentRecordId = null;
        let currentUserRepName = null;

        // --- 2. GLOBAL FUNCTIONS ---
        
        function getVal(obj, key, defaultVal = '') { return (obj && obj[key] != null) ? obj[key] : defaultVal; }
        function escapeHTML(str) { if (!str) return ''; return String(str).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'})[m]); }
        function getElementValue(id) { const el=document.getElementById(id); return el ? (el.value?.trim()??el.textContent?.trim()??null) : null; }

        function showNotification(title, message) { 
            const m = document.getElementById('notification-modal'); 
            if(m) {
                document.getElementById('notification-title').textContent = title; 
                document.getElementById('notification-message').innerHTML = message; 
                m.classList.remove('hidden'); 
            }
        }
        function closeNotification() { document.getElementById('notification-modal').classList.add('hidden'); }
        function showLoginError(msg) { const e = document.getElementById('login-error'); if(e) { e.textContent = msg; e.classList.remove('hidden'); } }

        // --- UI Logic ---
        function updateFormDisplayMode() {
            const btn = document.getElementById('editModeButton');
            if(btn) {
                btn.innerHTML = isEditMode ? '<i class="fas fa-eye"></i> View Profile' : '<i class="fas fa-pencil-alt"></i> Edit Profile';
                btn.disabled = !currentSelectedRecord;
                btn.className = isEditMode ? "py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold bg-yellow-500 hover:bg-yellow-600 text-white" : "py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold bg-gray-200 text-gray-700 hover:bg-gray-300";
            }
            
            document.querySelectorAll('.editable-field, #follow-up-date, #follow-up-time').forEach(el => {
                el.disabled = !isEditMode;
                if(isEditMode) el.classList.add('is-editable'); else el.classList.remove('is-editable');
            });

            // Explicit fix for notes input
            const notesInput = document.getElementById('qb-notes-input');
            if (notesInput) {
                notesInput.disabled = !isEditMode;
                if(isEditMode) notesInput.classList.add('is-editable'); else notesInput.classList.remove('is-editable');
            }

            ['save-button', 'reset-button', 'launch-email-button', 'email-template-dropdown', 'help-button', 'noopp-button', 'close-button'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.disabled = !isEditMode;
            });
        }

        function showFormContent(show) {
            const container = document.getElementById('right-column-container');
            if(container) container.style.visibility = show ? 'visible' : 'hidden';
            if(!show) { isEditMode = false; updateFormDisplayMode(); }
        }

        // --- AUTH ---
        function login() {
            document.getElementById('login-button').disabled = true;
            document.getElementById('login-button').textContent = "Signing in...";
            msalInstance.loginPopup({ scopes: ["User.Read"] }).then(handleMsalResponse).catch(e => {
                console.error(e);
                document.getElementById('login-button').disabled = false;
                document.getElementById('login-button').textContent = "Sign in";
                showLoginError("Login failed.");
            });
        }

        function handleMsalResponse(resp) {
            if(resp && resp.account) {
                msalAccount = resp.account;
                currentUserRepName = msalAccount.name;
                initializeAppUI();
            }
        }

        function initializeAppUI() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');
            if(document.getElementById('welcome-message')) document.getElementById('welcome-message').textContent = `Welcome, ${currentUserRepName.split(' ')[0]}`;
            
            updateFormDisplayMode();
            showFormContent(false);
            resetSalesDisplay();
            startClock();
            loadRecords();
        }

        async function getFlowToken() {
            // SAS URLs active, no token needed.
            return "SAS_TOKEN_BYPASSED"; 
        }

        // --- DATA ---
        async function loadRecords() {
            const list = document.getElementById('record-gallery-list');
            list.innerHTML = '<div class="loader-container"><span>Loading...</span></div>';
            allRecords = [];
            
            try {
                const response = await fetch(GET_MY_RECORDS_FLOW_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repName: currentUserRepName })
                });

                if (!response.ok) throw new Error(`Flow Error: ${response.status}`);
                const data = await response.json();
                allRecords = Array.isArray(data) ? data : [];

                filterAndSortGallery();
                const dropdown = document.getElementById('filter-action-dropdown');
                if(dropdown) {
                    const actions = new Set(allRecords.map(r => r.cr714_action).filter(Boolean));
                    dropdown.innerHTML = '<option value="">Filter: All Actions</option>';
                    actions.forEach(a => dropdown.innerHTML += `<option value="${a}">${a}</option>`);
                    dropdown.disabled = false;
                }
            } catch (e) {
                console.error("Load Error:", e);
                list.innerHTML = `<div class="p-4 text-red-600">Error: ${e.message}</div>`;
            }
        }

        function filterAndSortGallery() {
            const search = getElementValue('search-bar')?.toLowerCase() || '';
            const sort = getElementValue('sort-dropdown') || 'company-asc';
            const filter = getElementValue('filter-action-dropdown') || '';
            
            let filtered = allRecords.filter(r => {
                if(filter && r.cr714_action !== filter) return false;
                if(document.getElementById('filter-followup').checked && !r.cr714_followup) return false;
                if(document.getElementById('filter-nonotes').checked && (r.cr714_qbnotes || '').trim() !== '') return false;
                
                if(!search) return true;
                return JSON.stringify(r).toLowerCase().includes(search);
            });

            filtered.sort((a, b) => {
                const valA = (getVal(a, 'cr714_company') || '').toLowerCase();
                const valB = (getVal(b, 'cr714_company') || '').toLowerCase();
                if(sort === 'company-asc') return valA.localeCompare(valB);
                if(sort === 'company-desc') return valB.localeCompare(valA);
                return valA.localeCompare(valB);
            });

            renderGallery(filtered);
        }

        function renderGallery(records) {
            const list = document.getElementById('record-gallery-list');
            list.innerHTML = '';
            if(records.length === 0) { list.innerHTML = '<div class="p-4 text-gray-500 italic">No records found.</div>'; return; }

            records.forEach(r => {
                const item = document.createElement('div');
                item.className = `gallery-item ${String(r.cr714_id) === currentRecordId ? 'is-selected' : ''}`;
                item.onclick = () => selectRecord(r.cr714_id);
                item.innerHTML = `
                    <span class="gallery-item-id">${r.cr714_id}</span>
                    <span class="gallery-item-company">${r.cr714_company}</span>
                    <span class="gallery-item-rep">${r.cr714_accountrep || ''}</span>
                `;
                list.appendChild(item);
            });
        }

        function selectRecord(id) {
            currentRecordId = String(id);
            currentSelectedRecord = allRecords.find(r => String(r.cr714_id) === currentRecordId);
            
            document.querySelectorAll('.gallery-item').forEach(el => {
                el.classList.toggle('is-selected', el.innerText.includes(id)); 
            });

            if(currentSelectedRecord) {
                populateForm(currentSelectedRecord);
                loadSalesData(currentRecordId);
                showFormContent(true);
            }
            isEditMode = false;
            updateFormDisplayMode();
        }

        function populateForm(record) {
            document.getElementById('acct-number-header').innerText = record.cr714_id;
            
            const map = {
                'contact-name-most': 'cr714_namemost', 'contact-name-latest': 'cr714_namelatest',
                'contact-phone-primary': 'cr714_primaryphone', 'contact-email-most': 'cr714_emailmost',
                'contact-email-latest': 'cr714_emaillatest', 'acct-company': 'cr714_company',
                'acct-classification': 'cr714_customerclassification', 'acct-days-last-order': 'cr714_dayssincelastorder',
                'acct-billing-address': 'cr714_billingaddress', 'internal-acct-rep': 'cr714_accountrep',
                'internal-retention-rep': 'cr714_retentionrep'
            };
            for(let id in map) {
                const el = document.getElementById(id);
                if(el) {
                    const val = record[map[id]] || '--';
                    if(el.tagName === 'INPUT') el.value = val;
                    else el.innerText = val;
                }
            }
            
            const notes = document.getElementById('qb-notes-input');
            if(notes) notes.value = QB_NOTES_TEMPLATE;

            const dEl = document.getElementById('follow-up-date');
            const tEl = document.getElementById('follow-up-time');
            if(record.cr714_followup) {
                const dt = new Date(record.cr714_followup);
                if(!isNaN(dt)) {
                    dEl.value = dt.toISOString().split('T')[0];
                    tEl.value = dt.toTimeString().substring(0,5);
                }
            } else {
                dEl.value = ''; tEl.value = '';
            }

            updateNotesPreview();
        }

        async function loadSalesData(id) {
            const container = document.getElementById('sales-content');
            const loader = document.getElementById('sales-loader');
            const placeholder = document.getElementById('sales-placeholder');
            
            container.classList.add('hidden');
            placeholder.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                const res = await fetch(SALES_DATA_FLOW_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ accountId: id })
                });
                if(!res.ok) throw new Error("Sales API Error");
                const data = await res.json();
                
                document.getElementById('sales-ytd').innerText = data.ytdSales || '--';
                document.getElementById('sales-total-orders').innerText = data.orderCount || '--';
                document.getElementById('sales-last-order').innerText = data.lastOrderDate || '--';
                
                const list = document.getElementById('sales-category-list');
                list.innerHTML = '';
                if(data.categories && data.categories.length) {
                    data.categories.forEach(c => {
                        list.innerHTML += `<li class="sales-category-item"><span class="sales-category-name">${c.categoryName}</span><span class="sales-category-amount">${c.categorySales}</span></li>`;
                    });
                } else {
                    list.innerHTML = '<li class="italic text-gray-400">No category data.</li>';
                }
                
                container.classList.remove('hidden');
            } catch(e) {
                console.error(e);
                placeholder.innerText = "Error loading sales.";
                placeholder.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }
        function resetSalesDisplay() {
             document.getElementById('sales-content').classList.add('hidden');
             document.getElementById('sales-placeholder').classList.remove('hidden');
             document.getElementById('sales-placeholder').innerText = "Select an account";
        }

        // --- AI SUMMARY ---
        function generateAiSummary(record) {
            const notes = getVal(record, 'cr714_qbnotes', '').trim();
            const mgrNotes = getVal(record, 'cr714_managernotes', '').trim();
            const impInfo = getVal(record, 'cr714_importantaccountinformation', '').trim();
            
            let summaryHtml = "";
            let summaryFound = false;

            if (impInfo) {
                summaryFound = true;
                summaryHtml += `<div class="ai-summary-box ai-imp"><div class="ai-title text-red-700"><i class="fas fa-exclamation-triangle"></i> IMPORTANT INFO</div><div class="ai-content text-red-900">${escapeHTML(impInfo)}</div></div>`;
            }
            
            if (mgrNotes) {
                summaryFound = true;
                summaryHtml += `<div class="ai-summary-box ai-mgr"><div class="ai-title text-green-700"><i class="fas fa-user-tie"></i> MANAGER FEEDBACK</div><div class="ai-content text-green-900">${escapeHTML(mgrNotes)}</div></div>`;
            }

            if (notes) {
                const qbLines = notes.split('\n').filter(line => line.trim() !== '------------------------------' && line.trim() !== '' && !line.includes('Modified On:') && !line.includes('Modified By:')).slice(0, 5);
                if (qbLines.length > 0) {
                    summaryFound = true;
                    const effectiveSummary = qbLines.join('\n'); 
                    summaryHtml += `<div class="ai-summary-box ai-key"><div class="ai-title text-blue-700"><i class="fas fa-file-alt"></i> KEY ACCOUNT DATA</div><div class="ai-content text-blue-900">${escapeHTML(effectiveSummary)}</div></div>`;
                }
            }
            
            return summaryFound ? summaryHtml : "";
        }

        function updateNotesPreview() {
            const preview = document.getElementById('qb-notes-preview');
            if(!currentSelectedRecord) { preview.innerHTML = '<p class="text-gray-400 italic text-center mt-10">Select an account to view notes.</p>'; return; }

            const showAI = document.getElementById('show-ai-summary').checked;
            const showNew = document.getElementById('show-new-note').checked;
            const showPrev = document.getElementById('show-prev-note').checked;
            const showMgr = document.getElementById('show-mgr-note').checked;
            const showImp = document.getElementById('show-imp-note').checked;
            
            let html = '';
            
            if(showAI) {
                html += generateAiSummary(currentSelectedRecord);
            }

            if(showNew) {
                const newNote = document.getElementById('qb-notes-input').value.replace(QB_NOTES_TEMPLATE, '').trim();
                if(newNote) html += `<div class="note-preview-item"><h4 class="text-blue-600"><i class="fas fa-pencil-alt"></i> New Note</h4><pre>${escapeHTML(newNote)}</pre></div>`;
            }
            
            if(showPrev) {
                 const prev = currentSelectedRecord.cr714_qbnotes;
                 if(prev) html += `<div class="note-preview-item"><h4 class="text-gray-500"><i class="fas fa-history"></i> Previous Notes</h4><pre>${escapeHTML(prev)}</pre></div>`;
            }

            if(showMgr && currentSelectedRecord.cr714_managernotes) {
                 html += `<div class="note-preview-item"><h4 class="text-green-600"><i class="fas fa-user-tie"></i> Raw Manager Notes</h4><pre>${escapeHTML(currentSelectedRecord.cr714_managernotes)}</pre></div>`;
            }

            if(showImp && currentSelectedRecord.cr714_importantaccountinformation) {
                 html += `<div class="note-preview-item"><h4 class="text-red-600"><i class="fas fa-exclamation-triangle"></i> Raw Important</h4><pre>${escapeHTML(currentSelectedRecord.cr714_importantaccountinformation)}</pre></div>`;
            }
            
            preview.innerHTML = html || '<div class="text-gray-400 text-center mt-4 italic">No content selected.</div>';
        }

        // --- HANDLERS ---
        function toggleEditMode() {
            if(!currentSelectedRecord) return;
            isEditMode = !isEditMode;
            updateFormDisplayMode();
        }
        
        function handleCustomReset() {
            if(currentSelectedRecord) populateForm(currentSelectedRecord);
            isEditMode = false;
            updateFormDisplayMode();
        }
        
        async function handleCustomSave() {
             showNotification("Save", "Logic linked to flow.");
        }

        async function handleActionButtonClick(type) {
            showNotification("Action", type + " clicked.");
        }
        
        function createCalendarEvent() { showNotification("Calendar", "Event placeholder."); }
        function showManagerFeedback() { document.getElementById('manager-feedback-modal').classList.remove('hidden'); }
        function closeManagerFeedback() { document.getElementById('manager-feedback-modal').classList.add('hidden'); }
        function showImportantInfo() { document.getElementById('important-info-modal').classList.remove('hidden'); }
        function closeImportantInfo() { document.getElementById('important-info-modal').classList.add('hidden'); }
        function showHelp() { showNotification("Help", "Instructions."); }
        
        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-display').innerText = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            }, 1000);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            msalInstance.handleRedirectPromise().then(handleMsalResponse).catch(console.error);
            const accounts = msalInstance.getAllAccounts();
            if(accounts.length > 0) {
                msalAccount = accounts[0];
                currentUserRepName = msalAccount.name;
                initializeAppUI();
            }
        });
    </script>
</body>
</html>
