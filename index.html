<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daytona Account Utility v4.16 (Smart Email Templates)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-app: #e2e8f0; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b;
            --primary: #2563eb; --primary-fg: #ffffff;
            --accent-danger: #ef4444; --accent-success: #22c55e; --accent-warning: #eab308;
            --border-color: #94a3b8; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 0.5rem; --blur: none;
        }

        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; --shadow: 0 4px 6px -1px rgba(0,0,0,0.5); }
        [data-theme="oled"] { --bg-app: #000000; --bg-card: #121212; --bg-input: #2a2a2a; --text-main: #ffffff; --text-muted: #a1a1aa; --border-color: #27272a; --primary: #facc15; --primary-fg: #000000; --shadow: 0 0 0 1px #333; }
        [data-theme="forest"] { --bg-app: #ecfdf5; --bg-card: #ffffff; --bg-input: #f0fdf4; --text-main: #064e3b; --text-muted: #65a30d; --border-color: #bbf7d0; --primary: #16a34a; --primary-fg: #ffffff; }
        [data-theme="ocean"] { --bg-app: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); --bg-card: rgba(255,255,255,0.85); --bg-input: rgba(255,255,255,0.6); --text-main: #0c4a6e; --text-muted: #0284c7; --border-color: #bae6fd; --primary: #0284c7; --primary-fg: #ffffff; --blur: blur(10px); }
        [data-theme="sunset"] { --bg-app: #fff7ed; --bg-card: #ffffff; --bg-input: #ffedd5; --text-main: #7c2d12; --text-muted: #c2410c; --border-color: #fed7aa; --primary: #ea580c; --primary-fg: #ffffff; }
        [data-theme="cyber"] { --bg-app: #050505; --bg-card: #11001c; --bg-input: #240046; --text-main: #e0aaff; --text-muted: #9d4edd; --border-color: #5a189a; --primary: #ff00ff; --primary-fg: #11001c; --shadow: 0 0 10px #ff00ff; }

        /* --- GLOBAL --- */
        body { font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); padding: 0.5rem 1rem; height: 100vh; overflow: hidden; transition: background 0.3s ease, color 0.3s ease; display: flex; flex-direction: column; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 0.75rem; backdrop-filter: var(--blur); }
        .card-header { font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding: 0.5rem 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        #header-panel { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); backdrop-filter: var(--blur); flex-shrink: 0; margin-bottom: 1rem; }
        
        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 5px; border: 2px solid var(--bg-input); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        input, select, textarea { background-color: var(--bg-input) !important; border: 1px solid var(--border-color) !important; color: var(--text-main) !important; border-radius: 0.375rem; padding: 0.5rem; width: 100%; transition: all 0.2s; font-size: 0.875rem; }
        input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary); border-color: transparent !important; }
        input:disabled, select:disabled, textarea:disabled { opacity: 0.7; cursor: not-allowed; color: var(--text-muted) !important; }
        
        .editable-field { background: transparent !important; border: 1px solid transparent !important; padding: 0.25rem 0.5rem; }
        .editable-field.is-editable { background-color: var(--bg-input) !important; border: 1px solid var(--accent-warning) !important; color: var(--text-main) !important; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }

        .btn-primary { background-color: var(--primary); color: var(--primary-fg); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-primary:hover:not(:disabled) { opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background-color: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background 0.2s; }
        .btn-secondary:hover:not(:disabled) { background-color: var(--border-color); }

        /* GRID LAYOUT */
        .app-grid { 
            display: grid; 
            grid-template-columns: 350px 1fr; 
            gap: 1rem; 
            flex-grow: 1; 
            overflow: hidden; 
            width: 100%;
            max-width: 100%;
        }
        
        .col-left { display: grid; grid-template-rows: 40% 1fr; gap: 1rem; height: 100%; min-height: 0; overflow: hidden; }
        .col-right { display: flex; flex-direction: column; gap: 0.75rem; height: 100%; overflow: hidden; min-width: 0; }
        .col-right .card { flex-shrink: 0; }
        .col-right .card.flex-grow { flex-shrink: 1; min-height: 0; }

        /* Gallery */
        .gallery-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; padding: 2px; }
        .gallery-item { padding: 0.5rem 0.75rem; background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .gallery-item:hover { border-color: var(--primary); transform: translateY(-1px); box-shadow: var(--shadow); opacity: 0.95; }
        .gallery-item.is-selected { border-color: var(--primary); background-color: var(--primary); color: var(--primary-fg); }
        .gallery-item.is-selected * { color: var(--primary-fg) !important; }
        .gallery-item-id { color: var(--primary); font-weight: 700; font-size: 0.9rem; } 
        .gallery-item-company { color: var(--text-main); font-weight: 600; font-size: 0.85rem; margin-top: 2px; }
        .gallery-item-rep { color: var(--text-muted); font-size: 0.75rem; italic; margin-top: 4px; }
        .gallery-item-followup { font-size: 0.7rem; font-weight: 600; color: var(--accent-danger); background-color: var(--bg-input); padding: 1px 6px; border-radius: 999px; display: inline-flex; align-items: center; margin-left: auto; border: 1px solid var(--accent-danger); }

        /* Theme Menu */
        .theme-dropdown { position: relative; display: inline-block; }
        .theme-menu-content { display: none; position: absolute; right: 0; top: 100%; background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: var(--shadow); min-width: 180px; z-index: 50; margin-top: 0.5rem; max-height: 400px; overflow-y: auto; }
        .theme-menu-content.show { display: block; }
        .theme-option { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; cursor: pointer; color: var(--text-main); font-size: 0.85rem; }
        .theme-option:hover { background-color: var(--bg-input); }
        .theme-swatch { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #ccc; }

        /* AI Boxes & Notes */
        .ai-box { padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0.25rem; border-left: 4px solid; background: var(--bg-input); }
        .ai-imp { border-color: var(--accent-danger); background: rgba(239, 68, 68, 0.05); }
        .ai-mgr { border-color: var(--accent-success); background: rgba(34, 197, 94, 0.05); }
        .ai-key { border-color: var(--primary); background: rgba(37, 99, 235, 0.05); }
        .ai-header { font-weight: bold; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .ai-body { font-size: 0.85rem; white-space: pre-wrap; line-height: 1.4; color: var(--text-main); }
        
        /* HISTORY ACCORDION */
        details.note-history { border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-card); margin-bottom: 0.5rem; transition: all 0.2s; }
        details.note-history summary { padding: 0.5rem 0.75rem; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; list-style: none; border-radius: 0.375rem; }
        details.note-history summary:hover { background: var(--bg-input); color: var(--text-main); }
        details.note-history summary::-webkit-details-marker { display: none; }
        details.note-history summary::after { content: '\f078'; font-family: "Font Awesome 6 Free"; font-weight: 900; margin-left: auto; transition: transform 0.2s; }
        details.note-history[open] summary::after { transform: rotate(180deg); }
        
        details.note-history pre { 
            padding: 0.75rem; font-family: 'Inter', sans-serif; font-size: 0.85rem; color: var(--text-main); 
            white-space: pre-wrap; word-wrap: break-word; overflow-wrap: anywhere; 
            background: var(--bg-input); border-top: 1px solid var(--border-color); 
            margin: 0; border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem; 
            max-width: 100%; max-height: 250px; overflow-y: auto; 
        }

        /* PREVIEW CONTAINER SCROLL */
        #qb-notes-preview {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-input);
            padding: 0.75rem;
            overflow-y: scroll; /* FORCE SCROLLBAR TRACK */
            min-height: 0;    
            height: 100%;
        }

        /* Highlighting */
        .btn-has-data-red { background-color: var(--accent-danger) !important; color: white !important; border-color: var(--accent-danger) !important; animation: pulse-alert 2s infinite; opacity: 1 !important; }
        .btn-has-data-yellow { background-color: var(--accent-warning) !important; color: black !important; border-color: var(--accent-warning) !important; animation: pulse-warn 2s infinite; opacity: 1 !important; }
        @keyframes pulse-alert { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes pulse-warn { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

        /* Modals & Utils */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 60; }
        .modal-content { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 0.5rem; max-width: 500px; width: 100%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .marquee-container { overflow: hidden; background: var(--bg-input); border: 1px solid var(--accent-danger); border-radius: 0.25rem; height: 24px; display: flex; align-items: center; margin-bottom: 0.5rem; }
        .marquee-text { white-space: nowrap; animation: scroll 15s linear infinite; color: var(--accent-danger); font-weight: bold; font-size: 0.75rem; padding-left: 100%; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        #welcome-toast { transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s ease-in; transform: translateY(150%); opacity: 0; }
        #welcome-toast.show { transform: translateY(0); opacity: 1; }
        
        /* Loading Animation */
        #global-loader { position: fixed; inset: 0; background: var(--bg-app); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loader-dot { animation: bounce 1.4s infinite ease-in-out both; background-color: var(--primary); border-radius: 50%; display: inline-block; height: 15px; width: 15px; margin: 0 3px; }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; background-color: var(--primary); }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; background-color: var(--accent-warning); }
        .loader-dot:nth-child(3) { animation-delay: 0s; background-color: var(--accent-danger); }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* EMAIL MODAL SPECIFIC */
        #email-modal-content { max-width: 900px; width: 95%; height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .email-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; height: 100%; overflow: hidden; padding: 1rem; }
        .email-left { display: flex; flex-direction: column; gap: 0.5rem; }
        .email-preview-pane { border: 3px solid var(--border-color); background: white; color: black; padding: 1rem; overflow-y: auto; height: 100%; border-radius: 0.375rem; font-family: 'Segoe UI', sans-serif; }
    </style>
</head>
<body class="p-0 md:p-4">

    <div id="global-loader">
        <div class="mb-4">
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
        </div>
        <h2 class="text-lg font-bold" style="color: var(--text-main)">Loading Application...</h2>
        <p class="text-sm" style="color: var(--text-muted)">Fetching your account data</p>
    </div>

    <div id="login-container" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <i class="fas fa-lock text-4xl mb-4" style="color: var(--primary);"></i>
            <h2 class="text-2xl font-bold mb-2">Daytona Utility</h2>
            <p class="mb-6 text-sm opacity-80">Sign in to manage your accounts.</p>
            <button onclick="window.login()" id="login-button" class="btn-primary w-full text-lg py-3">Sign in with Microsoft</button>
            <p id="login-error" class="text-red-500 mt-4 text-sm hidden"></p>
        </div>
    </div>

    <div id="main-app-container" class="hidden flex flex-col h-full">
        <div class="card mb-3 p-3 flex flex-wrap items-center justify-between gap-4 shrink-0" id="header-panel">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold" style="color: var(--primary);"><i class="fas fa-cube mr-2"></i>My Accounts</h1>
                <button onclick="window.loadRecords()" id="load-records-button" class="btn-primary text-xs flex items-center"><i class="fas fa-sync-alt mr-2"></i> Refresh</button>
                <div class="flex items-center gap-2 ml-2 pl-4 border-l" style="border-color: var(--border-color)">
                    <span id="welcome-message" onclick="window.showUserProfileCard()" class="text-sm font-medium text-muted hidden cursor-pointer hover:text-blue-600 transition-colors" title="View Profile"></span>
                    <button onclick="window.promptAdminLogin()" class="hover:text-brand transition-colors" style="color: var(--text-muted);" title="Admin Override"><i class="fas fa-user-lock"></i></button>
                </div>
            </div>
            <div class="flex-grow max-w-md mx-4"><input type="text" id="search-bar" onkeyup="window.filterAndSortGallery()" placeholder="Search accounts..." class="text-sm" /></div>
            <div class="flex items-center gap-3">
                <div class="theme-dropdown">
                    <button onclick="window.toggleThemeMenu()" id="theme-toggle-btn" class="btn-secondary text-xs flex items-center gap-2"><i class="fas fa-palette"></i> Theme</button>
                    <div id="theme-menu" class="theme-menu-content"></div>
                </div>
                <select id="sort-dropdown" onchange="window.filterAndSortGallery()" class="text-xs w-40">
                    <option value="company-asc">Sort: Company A-Z</option>
                    <option value="company-desc">Sort: Company Z-A</option>
                    <option value="followup-asc">Sort: Follow Up (Oldest)</option>
                    <option value="followup-desc">Sort: Follow Up (Newest)</option>
                    <option value="days-asc">Days Since Order &#x2191;</option>
                    <option value="days-desc">Days Since Order &#x2193;</option>
                    <option value="rep-asc">Rep A-Z</option>
                </select>
                <select id="filter-action-dropdown" onchange="window.filterAndSortGallery()" class="text-xs w-40" disabled><option value="">Filter: All Actions</option></select>
            </div>
            <div class="w-full flex justify-end gap-4 text-xs border-t pt-2 mt-1" style="border-color: var(--border-color)">
                 <label class="cursor-pointer flex items-center gap-1" style="color: var(--text-muted);"><input type="checkbox" id="filter-followup" onchange="window.filterAndSortGallery()"> Follow Ups</label>
                 <label class="cursor-pointer flex items-center gap-1" style="color: var(--text-muted);"><input type="checkbox" id="filter-nonotes" onchange="window.filterAndSortGallery()"> No Notes</label>
                 <label class="cursor-pointer flex items-center gap-1" style="color: var(--text-muted);"><input type="checkbox" id="filter-requests" onchange="window.filterAndSortGallery()"> Button Req.</label>
            </div>
        </div>

        <div class="app-grid">
            <div class="col-left">
                <div class="card flex flex-col min-h-0">
                    <div class="card-header"><span>Account List</span><span id="record-count" class="text-xs px-2 py-0.5 rounded text-white" style="background-color: var(--primary);">0</span></div>
                    <div id="record-gallery-list" class="gallery-list"><div class="text-center p-4 text-xs text-muted italic">Records not loaded.</div></div>
                </div>
                <div class="card flex flex-col min-h-0 p-3">
                    <div class="flex items-center justify-between mb-2 border-b pb-2" style="border-color: var(--border-color)">
                        <h3 class="font-bold text-sm" style="color: var(--primary);">Sales Snapshot</h3>
                        <div id="sales-loader" class="text-xs italic hidden" style="color: var(--text-muted);">Loading...</div>
                    </div>
                    <div class="marquee-container mb-3"><div class="marquee-text">Invoiced Sales Only - May Not Include Open Orders!</div></div>
                    <div id="sales-content" class="hidden flex-grow flex flex-col gap-2 overflow-hidden">
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="p-2 rounded" style="background-color: var(--bg-input);"><div class="text-xs uppercase" style="color: var(--text-muted);">3-Month Sales</div><div class="font-bold text-lg" style="color: var(--primary);" id="sales-ytd">--</div></div>
                            <div class="p-2 rounded" style="background-color: var(--bg-input);"><div class="text-xs uppercase" style="color: var(--text-muted);">Orders</div><div class="font-bold" id="sales-total-orders">--</div></div>
                            <div class="p-2 rounded col-span-2 flex justify-between items-center" style="background-color: var(--bg-input);"><div class="text-xs uppercase" style="color: var(--text-muted);">Last Order</div><div class="font-bold" id="sales-last-order">--</div></div>
                        </div>
                        <div class="flex-grow overflow-y-auto border-t pt-2" style="border-color: var(--border-color)">
                            <h4 class="text-xs font-bold mb-1" style="color: var(--text-muted);">Category Breakdown</h4>
                            <ul id="sales-category-list" class="text-xs space-y-1"></ul>
                        </div>
                    </div>
                    <div id="sales-placeholder" class="text-xs text-center py-8 italic" style="color: var(--text-muted);">Select an account to view sales.</div>
                    <div class="text-center pt-2 border-t mt-auto text-xs" style="border-color: var(--border-color); color: var(--text-muted);"><span id="clock-display">--:-- --</span></div>
                </div>
            </div>

            <div class="col-right">
                <div class="card p-3" id="contact-sticky-header">
                    <div class="card-header mt-0 pt-0 px-0 pb-2 mb-2">
                        <span><i class="fas fa-user-circle mr-2" style="color: var(--primary);"></i>Profile: <span id="acct-number-header" class="font-bold" style="color: var(--text-color);">--</span></span>
                        <div class="flex gap-2">
                            <div id="save-controls" class="hidden gap-2 mr-4 border-r pr-4" style="border-color: var(--border-color)">
                                <button onclick="window.handleCustomSave()" class="btn-primary text-xs py-1">Save</button>
                                <button onclick="window.handleCustomReset()" class="btn-secondary text-xs py-1">Cancel</button>
                            </div>
                            <button onclick="window.showManagerFeedback()" id="btn-mgr-feedback" class="text-xs font-bold text-red-500 hover:text-red-600 opacity-50 transition-all">Mgr Feedback</button>
                            <button onclick="window.showImportantInfo()" id="btn-imp-info" class="text-xs font-bold text-yellow-500 hover:text-yellow-600 opacity-50 transition-all">Imp Info</button>
                            <button onclick="window.toggleEditMode()" id="editModeButton" class="btn-secondary text-xs py-1 ml-2" disabled>Edit Profile</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 text-sm mb-2">
                        <div><label class="text-[10px] uppercase block" style="color: var(--text-muted);">Primary Contact</label><input type="text" id="contact-name-most" class="editable-field" disabled></div>
                        <div><label class="text-[10px] uppercase block" style="color: var(--text-muted);">Recent Contact</label><input type="text" id="contact-name-latest" class="editable-field" disabled></div>
                        <div><label class="text-[10px] uppercase block" style="color: var(--text-muted);">Phone</label><input type="text" id="contact-phone-primary" class="editable-field" disabled></div>
                        <div><label class="text-[10px] uppercase block" style="color: var(--text-muted);">Email</label><input type="email" id="contact-email-most" class="editable-field" disabled></div>
                        <div class="hidden"><input type="email" id="contact-email-latest"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-xs pt-1 border-t" style="border-color: var(--border-color);">
                        <div><span class="uppercase font-bold" style="color: var(--text-muted);">Company:</span> <span id="acct-company" class="font-medium">--</span></div>
                        <div><span class="uppercase font-bold" style="color: var(--text-muted);">Days Last Order:</span> <span id="acct-days-last-order" class="font-medium">--</span></div>
                    </div>
                </div>

                <div class="card p-3">
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <div class="flex items-center gap-2">
                            <input type="date" id="follow-up-date" class="text-xs w-24" disabled>
                            <input type="time" id="follow-up-time" class="text-xs w-20" disabled>
                            <button onclick="window.createCalendarEvent()" class="btn-primary text-xs px-2 py-1"><i class="fas fa-calendar-plus"></i></button>
                        </div>
                        <div class="flex gap-2 col-span-1">
                            <select id="email-template-dropdown" class="text-xs flex-grow" disabled>
                                <option value="Green Category.msg">Green Category</option>
                                <option value="Green Follow Up Email.msg">Green Follow Up</option>
                                <option value="Green Non-Buy Email.msg">Green Non-Buy</option>
                                <option value="Yellow Non-Buy Email.msg">Yellow Non-Buy</option>
                            </select>
                            <button onclick="window.launchEmailLogic()" id="launch-email-button" class="btn-secondary text-xs px-3" disabled><i class="fas fa-paper-plane"></i></button>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button onclick="window.handleActionButtonClick('Help')" id="help-button" class="btn-secondary text-xs px-2" style="border-color: #93c5fd; color: #2563eb;" disabled>Help</button>
                            <button onclick="window.handleActionButtonClick('NoOpp')" id="noopp-button" class="btn-secondary text-xs px-2" style="border-color: #d8b4fe; color: #9333ea;" disabled>No Opp</button>
                            <button onclick="window.handleActionButtonClick('CloseAccount')" id="close-button" class="btn-secondary text-xs px-2" style="border-color: #fca5a5; color: #dc2626;" disabled>Close</button>
                        </div>
                    </div>
                </div>

                <div id="notes-section" class="card p-4 flex-grow flex flex-col min-h-0">
                    <div class="card-header mt-0 pt-0 px-0"><span><i class="fas fa-sticky-note mr-2"></i>Notes & AI Summary</span></div>
                    <div class="grid grid-cols-2 gap-6 h-full overflow-hidden">
                        <div class="flex flex-col h-full">
                            <label class="text-xs font-bold mb-1" style="color: var(--text-muted);">New Note</label>
                            <textarea id="qb-notes-input" oninput="window.updateNotesPreview()" class="flex-grow p-3 text-sm font-mono resize-none h-full" placeholder="Enter notes here..." disabled></textarea>
                        </div>
                        <div class="flex flex-col h-full">
                            <div class="flex justify-between items-center mb-1">
                                <label class="text-xs font-bold" style="color: var(--text-muted);">Preview</label>
                                <div class="flex gap-2 text-xs">
                                    <label class="cursor-pointer select-none"><input type="checkbox" id="show-ai-summary" checked onchange="window.toggleNoteView(this.id)"> AI</label>
                                    <label class="cursor-pointer select-none"><input type="checkbox" id="show-new-note" checked onchange="window.updateNotesPreview()"> New</label>
                                    <label class="cursor-pointer select-none"><input type="checkbox" id="show-prev-note" onchange="window.toggleNoteView(this.id)"> Prev</label>
                                    <label class="cursor-pointer select-none"><input type="checkbox" id="show-mgr-note" onchange="window.updateNotesPreview()"> Mgr</label>
                                    <label class="cursor-pointer select-none"><input type="checkbox" id="show-imp-note" onchange="window.updateNotesPreview()"> Imp</label>
                                </div>
                            </div>
                            <div id="qb-notes-preview">
                                <div class="text-center italic mt-10" style="color: var(--text-muted);">Select an account.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal-overlay hidden">
        <div id="email-modal-content" class="modal-content bg-white" style="background-color: rgba(176, 182, 184, 1); border: 3px solid rgba(214, 221, 224, 1);">
            <div class="bg-gray-500 p-2 text-white font-bold text-center border-b-2 border-gray-300 flex justify-between items-center">
                <span>Action Email Screen</span>
                <button onclick="document.getElementById('email-modal').classList.add('hidden')" class="text-yellow-300 hover:text-white font-bold">Close X</button>
            </div>
            <div class="email-grid">
                <div class="email-left">
                    <div>
                        <label class="block text-white font-bold italic underline mb-1">*To</label>
                        <input type="text" id="email-modal-to" class="w-full p-2 rounded border-2 border-gray-300 font-semibold text-green-700">
                    </div>
                    <div>
                        <label class="block text-white font-bold italic underline mb-1">*Subject</label>
                        <input type="text" id="email-modal-subject" class="w-full p-2 rounded border-2 border-gray-300 font-semibold text-green-700">
                    </div>
                    <div class="flex-grow flex flex-col">
                        <label class="block text-white font-bold italic underline mb-1">Email Body</label>
                        <textarea id="email-modal-body" oninput="window.updateEmailPreview()" class="w-full flex-grow p-2 rounded border-2 border-gray-300 font-semibold text-green-700 resize-none"></textarea>
                    </div>
                    <div class="mt-2 text-center">
                         <p class="text-red-800 font-bold text-xs mb-2">Note: The box on the right is a preview. Formatting is automatic.</p>
                         <button onclick="window.sendCustomEmail()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded shadow-lg w-full">Send Email</button>
                    </div>
                </div>
                <div class="email-right h-full">
                    <div id="email-modal-preview" class="email-preview-pane"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Admin Override</h3>
            <input type="password" id="admin-password" class="mb-3" placeholder="Enter Password">
            <div id="admin-rep-input" class="hidden mb-3"><input type="text" id="override-rep-name" placeholder="Rep Name (e.g. John Doe)"></div>
            <div class="flex justify-end gap-2">
                <button onclick="window.closeAdminModal()" class="btn-secondary text-xs">Cancel</button>
                <button onclick="window.checkAdminPassword()" id="admin-action-btn" class="btn-primary text-xs">Authenticate</button>
            </div>
        </div>
    </div>
    <div id="notification-modal" class="modal-overlay hidden">
         <div class="modal-content text-center max-w-xs"> 
             <h3 id="notification-title" class="text-lg font-bold mb-2">Notice</h3> 
             <p id="notification-message" class="text-sm mb-4"></p> 
             <button onclick="window.closeNotification()" class="btn-primary w-full">OK</button> 
         </div>
    </div>
    <div id="manager-feedback-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-2xl border-t-4 border-red-500">
            <h3 class="font-bold mb-4">Manager Feedback</h3>
            <div id="manager-feedback-content" class="p-4 rounded h-64 overflow-y-auto text-sm font-mono border" style="background-color: var(--bg-input); border-color: var(--border-color);"></div>
            <button onclick="window.closeManagerFeedback()" class="btn-secondary w-full mt-4">Close</button>
        </div>
    </div>
    <div id="important-info-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-2xl border-t-4 border-yellow-500">
            <h3 class="font-bold mb-4">Important Info</h3>
            <div id="important-info-content" class="p-4 rounded h-64 overflow-y-auto text-sm font-mono border" style="background-color: var(--bg-input); border-color: var(--border-color);"></div>
            <button onclick="window.closeImportantInfo()" class="btn-secondary w-full mt-4">Close</button>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-content max-w-md p-0 overflow-hidden relative">
            <div class="bg-gradient-to-r from-blue-600 to-blue-400 h-24 relative">
                <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="px-6 pb-6 text-center">
                <div class="relative -mt-12 mb-4">
                    <div class="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center text-4xl text-blue-500 shadow-lg border-4 border-white">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <h3 id="popout-name" class="text-2xl font-bold text-gray-800">--</h3>
                <p id="popout-title" class="text-sm text-gray-500 mb-4 uppercase tracking-wide">--</p>
                <div class="grid grid-cols-2 gap-4 text-left bg-gray-50 p-4 rounded-lg text-sm border border-gray-100">
                    <div class="col-span-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Department</span><span id="popout-department" class="font-semibold text-gray-700 text-sm">--</span></div>
                    <div class="col-span-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Location</span><span id="popout-location" class="font-semibold text-gray-700 text-sm">--</span></div>
                    <div class="col-span-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Manager</span><span id="popout-manager" class="font-semibold text-gray-700 text-sm">--</span></div>
                    <div class="col-span-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Secondary Manager</span><span id="popout-secondary-manager" class="font-semibold text-gray-700 text-sm">--</span></div>
                    <div class="col-span-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Sr. Manager</span><span id="popout-sr-manager" class="font-semibold text-gray-700 text-sm">--</span></div>
                    <div class="col-span-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Supervisor</span><span id="popout-supervisor" class="font-semibold text-gray-700 text-sm">--</span></div>
                    <div class="col-span-2 border-t pt-2 mt-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Gold Star</span><span id="popout-gold-star" class="font-bold text-yellow-600 text-base flex items-center gap-2"><i class="fas fa-star text-yellow-400"></i> <span>--</span></span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="welcome-toast" class="fixed bottom-5 right-5 z-50 hidden transition-all duration-500 transform translate-y-full opacity-0">
        <div class="bg-white border-l-4 border-blue-500 shadow-2xl rounded p-4 max-w-xs">
            <div class="flex justify-between items-start mb-2"><h4 class="font-bold text-blue-800">Welcome! ðŸš€</h4><button onclick="window.dismissWelcome()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
            <p class="text-xs text-gray-600 mb-2">1. Sign in<br>2. Click Refresh<br>3. Select Account</p>
            <button onclick="window.dismissWelcome()" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded hover:bg-blue-200 w-full">Got it</button>
        </div>
    </div>

    <script>
        // 1. CONFIG & STATE
        const msalConfig = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: "https://WB-DT.github.io/daytona-utility/" }, cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false } };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null;

        // FLOW URLS - UPDATE THESE IF NEEDED
        const GET_MY_RECORDS_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2d5cc7c0ffa34dcb87e6416df29b9acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8qFD-lNiuxDgafyu31UYZ8zzePJMRJ4wpUzLzbb9bMs";
        const PATCH_RECORD_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/774bb53ee87542e5825b46958f5bd55d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EbaJTl1gKlG8rjTn3ZmoLwUiQ430Sju1kWZYZ6hr0zE";
        const SALES_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a6f98d7dcf0434fa630e691778901bf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=me09n4bmICH84IIjEV0BDzCIeLfhoFdy5f7hB2AEDOw";
        const ACTION_BUTTON_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a2fa2c69f1d24a85a980599d21631808/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aSQ1J4-BFNxrOURAp3-8tCQwunP0JITYHZfWV5BbDYI";
        
        // **** NEW: ADD THE SPECIFIC EMAIL FLOW URL HERE ****
        const SEND_EMAIL_FLOW_URL = ACTION_BUTTON_FLOW_URL; // Placeholder: Replace if you have a specific flow for sending customized emails
        
        const QB_NOTES_TEMPLATE = `Locations: \nNumber of employees: \nCurrent Vendors: \nFrequency of Orders: \nMonthly spend: \nAnyone involved: \nNext Order Expected: \nOPP: \n`;
        const STANDARD_ACTIONS = ['Help', 'No Opp', 'Close Account', 'Cadence'];
        const CUSTOM_FLOW_ACTIONS = ["Automotive", "Blizzard Water", "Category", "Chair Mat Contest", "Intro", "NONBUY", "NOVNoSales", "OCTNoSales"];
        const THEMES = [{name:'Modern',id:'modern',color:'#2563eb'},{name:'Midnight',id:'midnight',color:'#0f172a'},{name:'OLED',id:'oled',color:'#000000'},{name:'Forest',id:'forest',color:'#16a34a'},{name:'Ocean',id:'ocean',color:'#0ea5e9'},{name:'Sunset',id:'sunset',color:'#ea580c'},{name:'Cyberpunk',id:'cyber',color:'#d946ef'}];
        
        let currentThemeIdx=0, isEditMode=false, allRecords=[], currentSelectedRecord=null, currentRecordId=null, currentUserRepName=null;
        let currentUserProfile = null; 

        // 2. UTILS
        window.getVal = function(obj, key, def = '') { return (obj && obj[key] != null) ? obj[key] : def; }
        window.escapeHTML = function(str) { if (!str) return ''; return String(str).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'})[m]); }
        window.getElementValue = function(id) { const el=document.getElementById(id); return el ? (el.value?.trim()??el.textContent?.trim()??null) : null; }
        window.showNotification = function(title, message) { const m = document.getElementById('notification-modal'); if(m) { document.getElementById('notification-title').textContent = title; document.getElementById('notification-message').innerHTML = message; m.classList.remove('hidden'); } }
        window.closeNotification = function() { document.getElementById('notification-modal').classList.add('hidden'); }
        window.showLoginError = function(msg) { const e = document.getElementById('login-error'); if(e) { e.textContent = msg; e.classList.remove('hidden'); } }
        window.updateTheme = function(idx) { document.body.setAttribute('data-theme', THEMES[idx].id); if(document.getElementById('theme-name')) document.getElementById('theme-name').innerText = THEMES[idx].name; }
        window.toggleThemeMenu = function() { const m=document.getElementById('theme-menu'); m.classList.toggle('show'); if(m.innerHTML.trim()===''){ THEMES.forEach((t,i)=>{ const d=document.createElement('div'); d.className='theme-option'; d.onclick=()=>{window.updateTheme(i);m.classList.remove('show');}; d.innerHTML=`<div class="theme-swatch" style="background-color:${t.color}"></div><span>${t.name}</span>`; m.appendChild(d); }); } }
        window.onclick = function(event) { if (!event.target.matches('#theme-toggle-btn') && !event.target.closest('#theme-toggle-btn')) { const m = document.getElementById('theme-menu'); if (m && m.classList.contains('show')) m.classList.remove('show'); } }
        window.startClock = function() { setInterval(() => { const el = document.getElementById('clock-display'); if(el) el.innerText = new Date().toLocaleTimeString(); }, 1000); }
        window.checkFirstRun = function() { const last = localStorage.getItem('hasSeenWelcome_v4'); const now = new Date(); const cur = `${now.getFullYear()}-${now.getMonth()+1}`; if (last !== cur) { setTimeout(() => { const t = document.getElementById('welcome-toast'); if(t){ t.classList.remove('hidden'); setTimeout(()=>t.classList.add('show'),100);} }, 1500); } }
        window.dismissWelcome = function() { const t = document.getElementById('welcome-toast'); if(t) { t.classList.remove('show'); setTimeout(()=>t.classList.add('hidden'),500); } const now = new Date(); localStorage.setItem('hasSeenWelcome_v4', `${now.getFullYear()}-${now.getMonth()+1}`); }
        
        // 3. CORE LOGIC FUNCTIONS
        window.showUserProfileCard = function(profile) {
            const p = profile || currentUserProfile;
            if(!p) { window.showNotification("No Profile", "User profile data not found."); return; }
            document.getElementById('popout-name').innerText = p.cr714_employeename || 'Unknown';
            document.getElementById('popout-title').innerText = p.cr714_titlename || 'Rep';
            document.getElementById('popout-department').innerText = p.cr714_departmentname || '--';
            document.getElementById('popout-location').innerText = p.cr714_locationname || '--';
            document.getElementById('popout-manager').innerText = p.cr714_managerassigned || '--';
            document.getElementById('popout-secondary-manager').innerText = p.cr714_secondarymanager || '--';
            document.getElementById('popout-sr-manager').innerText = p.cr714_srmanager || '--';
            document.getElementById('popout-supervisor').innerText = p.cr714_supervisors || '--';
            const gs = p.cr714_goldstars || 'None';
            document.getElementById('popout-gold-star').innerHTML = `<i class="fas fa-star text-yellow-400"></i> <span>${gs}</span>`;
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        // --- NEW EMAIL LOGIC ---
        window.launchEmailLogic = function() {
            if (!currentSelectedRecord) { window.showNotification("Error", "Select a record first."); return; }
            
            const action = currentSelectedRecord.cr714_action;
            
            // CASE A: Custom Flow / Email Container
            if (CUSTOM_FLOW_ACTIONS.includes(action)) {
                // Prep Data
                const email = currentSelectedRecord.cr714_emaillatest || currentSelectedRecord.cr714_emailmost || "";
                let subject = "";
                if (action === "Chair Mat Contest") subject = `${currentSelectedRecord.cr714_id} - A Promo That Matters`;
                else if (action === "NONBUY") subject = "WB Mason - 15% Off";
                else if (action === "NOVNoSales") subject = "WB Mason - 10% Off";
                
                // Populate Modal
                document.getElementById('email-modal-to').value = email;
                document.getElementById('email-modal-subject').value = subject;
                document.getElementById('email-modal-body').value = ""; // Clear body
                
                // Show
                document.getElementById('email-modal').classList.remove('hidden');
                window.updateEmailPreview();
            } 
            // CASE B: Cadence / ManDown (Launch Mailto)
            else {
                const template = document.getElementById('email-template-dropdown').value;
                const email = currentSelectedRecord.cr714_emaillatest || currentSelectedRecord.cr714_emailmost || "";
                const account = `${currentSelectedRecord.cr714_id} // ${currentSelectedRecord.cr714_company}`;
                const category = "Office Supplies"; // Default or fetch if available

                let subject = `It's ${currentUserRepName} with WB Mason--ACC# ${account}`;
                let body = "";

                if (template === "Green Category.msg") {
                    body = `Good Morning/Afternoon,\n\nThank you for speaking with me today. I will be on the lookout for your order confirmations.\nWhile I wait, I want to show you a quick view of some of the pricing we offer for ${category} items.\nLet me know if you are getting different items or better pricing elsewhere.\n\n[Insert image of category here]\n`;
                } else if (template === "Green Follow Up Email.msg") {
                    body = `Good Morning/Afternoon!\n\nI was unable to reach you today. When we spoke, you stated that you would review my email and provide a list of items you are purchasing from my competitors for us to quote.\nI have not heard from you and wanted to follow up on this to see if you have gotten the chance to review.\n\nWill you be able to send over items to quote before your next office supply order so you can start saving sooner than later?\n\nWhen can I expect to see that list to get started on your savings?`;
                } else if (template.includes("Non-Buy")) {
                     subject = `WB Mason, Price Match Program--${account}`;
                     body = `Good morning/afternoon!\n\nThank you for speaking with me today. It is my responsibility as a part of the retention department to deliver the best experience possible for our customers.\n\nI would like for W.B Mason to be a one-stop-shop for all your business needs.\nBefore your next order with my competitor, send me any recent order confirmations or their shopping cart from them and I will at least match any pricing if I am not already lower.\n\nJust for the opportunity to show you better pricing on the items you buy from my competitors, we will be giving you 15% off your next order of those items.`;
                }

                const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;

                // Auto-Save Note
                const noteText = `Email Category Sent: ${template}\nQB Notes: ${document.getElementById('qb-notes-input').value}`;
                window.handleCustomSave(noteText, true); // Pass true to suppress notifications if desired
            }
        }

        window.updateEmailPreview = function() {
            if (!currentSelectedRecord) return;
            const action = currentSelectedRecord.cr714_action;
            const to = document.getElementById('email-modal-to').value;
            const sub = document.getElementById('email-modal-subject').value;
            const bodyNote = document.getElementById('email-modal-body').value.replace(/\n/g, "<br>");
            const accName = currentSelectedRecord.cr714_company;
            
            let html = `<div style="font-family: 'Segoe UI', sans-serif; color: #1f2937; line-height: 1.4;">`;
            html += `<div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">`;
            html += `<p style="color:green; font-weight:bold;">TO: ${window.escapeHTML(to)}</p>`;
            html += `<p style="color:green; font-weight:bold;">Subject: ${window.escapeHTML(sub)}</p>`;
            html += `<p>Hi <span style="color:green; font-weight:bold;">${window.escapeHTML(accName)}</span>,</p>`;
            html += `</div>`;

            // Template Specific Content
            if (action === "Chair Mat Contest") {
                html += `<p>I wanted to reach out as it looks like youâ€™ve purchased a chair with us recently. Are you in need of a chair mat for your office?</p>`;
                html += `<p><b><a href="https://www.wbmason.com/shop?q=everlife" style="color:#0b66c3;">Shop Chair Mats | W.B. Mason</a></b></p>`;
                html += `<div style="text-align:center; margin: 15px 0;"><img src="https://raw.githubusercontent.com/WB-DT/daytona-utility/main/WB%20Chair%20Mat.png" style="max-width:100%; height:auto;"></div>`;
            } else if (action === "NONBUY" || action === "NOVNoSales") {
                html += `<p>Iâ€™m reaching out to see if thereâ€™s anything you need before the end of the month. I didnâ€™t see you placed any orders recently.</p>`;
                html += `<p>I just received a coupon you can use through the end of the month!</p>`;
                if(action === "NONBUY") html += `<div style="text-align:center; margin: 15px 0;"><img src="https://raw.githubusercontent.com/WB-DT/daytona-utility/main/WB%2015%20Off.png" style="max-width:100%; height:auto;"></div>`;
                else html += `<div style="text-align:center; margin: 15px 0;"><img src="https://raw.githubusercontent.com/WB-DT/daytona-utility/main/WB%2010%20off.png" style="max-width:100%; height:auto;"></div>`;
            }

            // User Custom Note
            if (bodyNote) {
                html += `<div style="color:green; font-weight:normal; margin: 15px 0;">${bodyNote}</div>`;
            }

            // Signature
            html += `<div style="margin-top:20px; font-size:14px; border-top: 1px solid #eee; padding-top: 10px;">`;
            html += `Thank you,<br><b>${currentUserRepName}</b> | W.B. MASON CO, INC.<br>`;
            html += `Email: ${msalAccount ? msalAccount.username : ''} | <a href="https://www.wbmason.com" style="color:#0b66c3;">www.wbmason.com</a>`;
            html += `</div></div>`;

            document.getElementById('email-modal-preview').innerHTML = html;
        }

        window.sendCustomEmail = async function() {
            window.showNotification("Sending...", "Dispatching email via flow...");
            const payload = {
                action: currentSelectedRecord.cr714_action,
                to: document.getElementById('email-modal-to').value,
                subject: document.getElementById('email-modal-subject').value,
                body: document.getElementById('email-modal-body').value,
                repEmail: msalAccount ? msalAccount.username : '',
                recordId: currentRecordId
            };

            try {
                const res = await fetch(SEND_EMAIL_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error("Email Flow Error");
                
                document.getElementById('email-modal').classList.add('hidden');
                window.showNotification("Success", "Email Sent!");
                
                // Log note
                const noteText = `Action Email Sent via Utility.\nSubject: ${payload.subject}\nNote: ${payload.body}`;
                window.handleCustomSave(noteText, true);
            } catch(e) { window.showNotification("Error", e.message); }
        }

        // --- END NEW EMAIL LOGIC ---


        // NOTE PARSER
        window.parseNotes = function(rawNotes) { 
            if (!rawNotes) return []; 
            const rawEntries = rawNotes.split(/[-]{10,}/).filter(s => s.trim().length > 0); 
            const parsed = []; 
            rawEntries.forEach(entry => { 
                const lines = entry.trim().split('\n'); 
                let date = "Unknown Date"; 
                let author = "Unknown User"; 
                let content = []; 
                lines.forEach(line => { 
                    if (line.toLowerCase().includes('modified on:')) { 
                        const parts = line.split(':')[1] ? line.substring(line.indexOf(':') + 1).trim() : "Unknown"; 
                        date = parts.split(' ')[0]; 
                    } else if (line.toLowerCase().includes('modified by:')) {
                        author = line.split(':')[1] ? line.split(':')[1].trim() : "Unknown";
                    } else { content.push(line); } 
                }); 
                const cleanContent = content.join('\n').trim(); 
                if (cleanContent) parsed.push({ date, author, text: cleanContent }); 
            }); 
            return parsed.reverse(); 
        }

        // 3. UI
        window.updateFormDisplayMode = function() {
            const btn = document.getElementById('editModeButton');
            const saveControls = document.getElementById('save-controls');
            if(btn) {
                btn.innerHTML = isEditMode ? '<i class="fas fa-eye"></i> View' : '<i class="fas fa-pencil-alt"></i> Edit Profile';
                btn.disabled = !currentSelectedRecord;
                if (isEditMode) { btn.className = "py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold text-black bg-yellow-400 hover:bg-yellow-500"; } 
                else { btn.className = "py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold bg-gray-200 text-gray-700 hover:bg-gray-300"; }
            }
            if(saveControls) saveControls.style.display = isEditMode ? 'flex' : 'none';
            document.querySelectorAll('.editable-field, #follow-up-date, #follow-up-time').forEach(el => {
                el.disabled = !isEditMode;
                if(isEditMode) { el.removeAttribute('disabled'); el.classList.add('is-editable'); } else { el.setAttribute('disabled', 'true'); el.classList.remove('is-editable'); }
            });
            const notesInput = document.getElementById('qb-notes-input');
            if (notesInput) {
                if(isEditMode) { notesInput.removeAttribute('disabled'); notesInput.classList.add('is-editable'); notesInput.style.opacity = '1'; } 
                else { notesInput.setAttribute('disabled', 'true'); notesInput.classList.remove('is-editable'); }
            }
            ['launch-email-button', 'email-template-dropdown', 'help-button', 'noopp-button', 'close-button'].forEach(id => {
                const el = document.getElementById(id); if(el) el.disabled = !isEditMode;
            });
        }
        window.showFormContent = function(show) { const c=document.getElementById('right-column-container'); if(c) c.style.visibility=show?'visible':'hidden'; if(!show){isEditMode=false;window.updateFormDisplayMode();} }
        window.resetSalesDisplay = function() { document.getElementById('sales-content').classList.add('hidden'); document.getElementById('sales-placeholder').classList.remove('hidden'); document.getElementById('sales-placeholder').innerText = "Select an account"; }
        
        // TOGGLE VIEW LOGIC
        window.toggleNoteView = function(id) {
            const isChecked = document.getElementById(id).checked;
            // Logic: If Prev checked, uncheck AI. If AI checked, uncheck Prev.
            if (id === 'show-prev-note' && isChecked) {
                document.getElementById('show-ai-summary').checked = false;
            }
            if (id === 'show-ai-summary' && isChecked) {
                document.getElementById('show-prev-note').checked = false;
            }
            window.updateNotesPreview();
        }

        // 4. DATA
        window.loadRecords = async function() {
            const list = document.getElementById('record-gallery-list'); list.innerHTML = '<div class="loader">Loading...</div>';
            const gl = document.getElementById('global-loader'); if(gl) { gl.style.display = 'flex'; gl.style.opacity = '1'; }
            allRecords = [];
            try {
                const response = await fetch(GET_MY_RECORDS_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ repName: currentUserRepName }) });
                if (!response.ok) throw new Error(`Flow Error: ${response.status}`);
                
                const data = await response.json();
                
                // --- UPDATED LOGIC TO HANDLE NEW WRAPPER OBJECT ---
                if (data.accountList && Array.isArray(data.accountList)) {
                    allRecords = data.accountList;
                    if (data.userProfile) {
                        currentUserProfile = data.userProfile;
                        console.log("User Profile Loaded");
                    }
                } else if (Array.isArray(data)) {
                    allRecords = data; // Fallback
                }
                // --------------------------------------------------

                document.getElementById('record-count').textContent = allRecords.length;
                
                const dropdown = document.getElementById('filter-action-dropdown');
                if(dropdown) {
                    const recordActions = new Set(allRecords.map(r => r.cr714_action).filter(Boolean));
                    const allActions = new Set([...STANDARD_ACTIONS, ...recordActions]);
                    dropdown.innerHTML = '<option value="">Filter: All Actions</option>';
                    allActions.forEach(a => dropdown.innerHTML += `<option value="${a}">${a}</option>`);
                    dropdown.disabled = false;
                }
                window.filterAndSortGallery();
                if(gl) { gl.style.opacity = '0'; setTimeout(()=>gl.style.display='none', 500); }
            } catch (e) { console.error("Load Error:", e); list.innerHTML = `<div class="p-4 text-red-600">Error: ${e.message}</div>`; if(gl) gl.style.display='none'; }
        }
        
        window.filterAndSortGallery = function() {
            const search = window.getElementValue('search-bar')?.toLowerCase() || '';
            const sort = window.getElementValue('sort-dropdown') || 'company-asc';
            const filter = window.getElementValue('filter-action-dropdown') || '';
            const filterFollow = document.getElementById('filter-followup')?.checked;
            const filterNoNotes = document.getElementById('filter-nonotes')?.checked;
            const filterRequests = document.getElementById('filter-requests')?.checked;

            let filtered = allRecords.filter(r => {
                if(filter && r.cr714_action !== filter) return false;
                if(filterFollow && !r.cr714_followup) return false;
                if(filterNoNotes && (r.cr714_qbnotes || '').trim() !== '') return false;
                if(filterRequests && !['Help','NoOpp','CloseAccount'].includes(r.cr714_action)) return false; 
                if(search && !JSON.stringify(r).toLowerCase().includes(search)) return false;
                return true;
            });

            filtered.sort((a, b) => {
                const get = (item, key) => (item[key] || '').toString().toLowerCase();
                if(sort.includes('company')) return sort === 'company-asc' ? get(a,'cr714_company').localeCompare(get(b,'cr714_company')) : get(b,'cr714_company').localeCompare(get(a,'cr714_company'));
                if(sort.includes('followup')) {
                    const da = a.cr714_followup ? new Date(a.cr714_followup) : new Date(sort === 'followup-asc' ? 8640000000000000 : -8640000000000000);
                    const db = b.cr714_followup ? new Date(b.cr714_followup) : new Date(sort === 'followup-asc' ? 8640000000000000 : -8640000000000000);
                    return sort === 'followup-asc' ? da - db : db - da;
                }
                if(sort.includes('days')) {
                     const da = parseFloat(a.cr714_dayssincelastorder) || 0;
                     const db = parseFloat(b.cr714_dayssincelastorder) || 0;
                     return sort === 'days-asc' ? da - db : db - da;
                }
                if(sort.includes('rep')) return sort === 'rep-asc' ? get(a,'cr714_rep').localeCompare(get(b,'cr714_rep')) : get(b,'cr714_rep').localeCompare(get(a,'cr714_rep'));
                return 0;
            });
            
            const list = document.getElementById('record-gallery-list');
            list.innerHTML = '';
            document.getElementById('record-count').textContent = filtered.length;
            
            if(filtered.length === 0) { list.innerHTML = '<div class="loader">No records found.</div>'; return; }
            filtered.forEach(r => {
                const div = document.createElement('div');
                div.className = `gallery-item ${currentRecordId === String(r.cr714_id) ? 'is-selected' : ''}`;
                div.onclick = () => window.selectRecord(r.cr714_id);
                
                let followUpBadge = '';
                if(r.cr714_followup) {
                    const d = new Date(r.cr714_followup);
                    if(!isNaN(d)) followUpBadge = `<span class="gallery-item-followup"><i class="fas fa-clock mr-1"></i>${d.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>`;
                }
                let repDisplay = '';
                const action = window.getVal(r, 'cr714_action');
                if (action === 'Cadence') { repDisplay = `<span class="text-xs text-muted italic"><i class="fas fa-shield-alt mr-1"></i>Ret: ${window.escapeHTML(r.cr714_retentionrep)}</span>`; }
                else { repDisplay = `<span class="text-xs text-muted italic"><i class="fas fa-user mr-1"></i>Rep: ${window.escapeHTML(r.cr714_rep)}</span>`; }
                div.innerHTML = `<div class="flex justify-between items-start w-full"><span class="gallery-item-id">${r.cr714_id}</span>${followUpBadge}</div><div class="gallery-item-company">${window.escapeHTML(r.cr714_company)}</div>${repDisplay}`;
                list.appendChild(div);
            });
        }

        window.selectRecord = function(id) {
            currentRecordId = String(id);
            currentSelectedRecord = allRecords.find(r => String(r.cr714_id) === currentRecordId);
            const items = document.querySelectorAll('.gallery-item');
            items.forEach(item => { if(item.innerHTML.includes(id)) item.classList.add('is-selected'); else item.classList.remove('is-selected'); });

            if(currentSelectedRecord) {
                window.populateForm(currentSelectedRecord);
                window.loadSalesData(currentRecordId);
                window.showFormContent(true);
            }
            isEditMode = false;
            window.updateFormDisplayMode();
        }

        window.populateForm = function(rec) {
            if(!rec) return;
            document.getElementById('acct-number-header').innerText = rec.cr714_id || '--';
            document.getElementById('acct-company').innerText = rec.cr714_company || '--';
            document.getElementById('acct-days-last-order').innerText = rec.cr714_dayssincelastorder || '--';
            
            const fields = {'contact-name-most': 'cr714_namemost', 'contact-name-latest': 'cr714_namelatest', 'contact-phone-primary': 'cr714_primaryphone', 'contact-email-most': 'cr714_emailmost', 'contact-email-latest': 'cr714_emaillatest'};
            for(const [id, key] of Object.entries(fields)) { 
                const el = document.getElementById(id); 
                if(el) el.value = rec[key] || ''; 
            }
            
            const notes = document.getElementById('qb-notes-input');
            if(notes) notes.value = QB_NOTES_TEMPLATE;

            const dEl = document.getElementById('follow-up-date');
            const tEl = document.getElementById('follow-up-time');
            if(dEl && tEl) {
                if(rec.cr714_followup) {
                    const dt = new Date(rec.cr714_followup);
                    if(!isNaN(dt)) { dEl.value = dt.toISOString().split('T')[0]; tEl.value = dt.toTimeString().substring(0,5); } else { dEl.value=''; tEl.value=''; }
                } else { dEl.value=''; tEl.value=''; }
            }
            
            const mgrBtn = document.getElementById('btn-mgr-feedback');
            const impBtn = document.getElementById('btn-imp-info');
            if (rec.cr714_managernotes) { mgrBtn.classList.remove('opacity-50'); mgrBtn.classList.add('btn-has-data-red'); document.getElementById('manager-feedback-content').innerText = rec.cr714_managernotes; } 
            else { mgrBtn.classList.add('opacity-50'); mgrBtn.classList.remove('btn-has-data-red'); document.getElementById('manager-feedback-content').innerText = "No feedback."; }
            if (rec.cr714_importantaccountinformation) { impBtn.classList.remove('opacity-50'); impBtn.classList.add('btn-has-data-yellow'); document.getElementById('important-info-content').innerText = rec.cr714_importantaccountinformation; } 
            else { impBtn.classList.add('opacity-50'); impBtn.classList.remove('btn-has-data-yellow'); document.getElementById('important-info-content').innerText = "No important info."; }

            window.updateNotesPreview();
        }

        window.updateNotesPreview = function() {
            if(!currentSelectedRecord) return;
            const showAI = document.getElementById('show-ai-summary')?.checked;
            const showNew = document.getElementById('show-new-note')?.checked;
            const showPrev = document.getElementById('show-prev-note')?.checked;
            const showMgr = document.getElementById('show-mgr-note')?.checked;
            const showImp = document.getElementById('show-imp-note')?.checked;
            const inputVal = document.getElementById('qb-notes-input')?.value.replace(QB_NOTES_TEMPLATE, '').trim();
            
            let html = '';
            if(showAI) {
                const history = window.parseNotes(currentSelectedRecord.cr714_qbnotes || '');
                const latest = history[0]; 
                if(latest) html += `<div class="ai-box ai-key"><div class="ai-header text-brand"><i class="fas fa-info-circle"></i> KEY DATA (${latest.date})</div><div class="ai-body">${window.escapeHTML(latest.text)}</div></div>`;
            }
            if(showMgr && currentSelectedRecord.cr714_managernotes) html += `<div class="ai-box ai-mgr"><div class="ai-header text-green-600"><i class="fas fa-user-tie"></i> Manager</div><div class="ai-body">${window.escapeHTML(currentSelectedRecord.cr714_managernotes)}</div></div>`;
            if(showImp && currentSelectedRecord.cr714_importantaccountinformation) html += `<div class="ai-box ai-imp"><div class="ai-header text-red-600"><i class="fas fa-exclamation-triangle"></i> Important</div><div class="ai-body">${window.escapeHTML(currentSelectedRecord.cr714_importantaccountinformation)}</div></div>`;
            if(showNew && inputVal) html += `<div class="ai-box ai-key" style="border-color: var(--accent-warning); background: var(--bg-input);"><div class="ai-header" style="color: var(--accent-warning);"><i class="fas fa-pencil-alt"></i> Draft Note</div><div class="ai-body">${window.escapeHTML(inputVal)}</div></div>`;
            if(showPrev) {
                 const history = window.parseNotes(currentSelectedRecord.cr714_qbnotes || '');
                 history.forEach(item => {
                     html += `
                        <details class="note-history">
                            <summary>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-history text-blue-500"></i> 
                                    <span class="font-mono font-bold">${window.escapeHTML(item.date)}</span>
                                </div>
                                <span class="text-gray-400 text-[10px] uppercase italic ml-1"><i class="fas fa-user-edit mr-1"></i>${window.escapeHTML(item.author)}</span>
                            </summary>
                            <pre>${window.escapeHTML(item.text)}</pre>
                        </details>
                     `;
                 });
            }
            const preview = document.getElementById('qb-notes-preview');
            if(preview) preview.innerHTML = html || '<div class="text-center text-muted italic mt-10">No content to display.</div>';
        }

        window.loadSalesData = async function(id) {
            const container = document.getElementById('sales-content');
            const loader = document.getElementById('sales-loader');
            const placeholder = document.getElementById('sales-placeholder');
            container.classList.add('hidden'); placeholder.classList.add('hidden'); loader.classList.remove('hidden');

            try {
                const res = await fetch(SALES_DATA_FLOW_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ text: id, accountId: id }) });
                if(!res.ok) throw new Error("Sales API Error");
                const json = await res.json();
                const sales = typeof json.body?.salesByCategory === 'string' ? JSON.parse(json.body.salesByCategory) : (json.body?.salesByCategory || []);
                let total = 0;
                const list = document.getElementById('sales-category-list');
                list.innerHTML = '';
                sales.forEach(s => {
                    const amt = parseFloat(s["[Sales_Last3Months]"] || 0);
                    total += amt;
                    const name = s["DimItemIDitemtypegroup[ItemTypeGroupDescription]"];
                    list.innerHTML += `<li class="flex justify-between border-b py-1" style="border-color: var(--border-color)"><span class="text-muted">${window.escapeHTML(name)}</span><span class="font-bold text-brand">$${amt.toFixed(2)}</span></li>`;
                });
                document.getElementById('sales-ytd').innerText = `$${total.toFixed(2)}`;
                document.getElementById('sales-total-orders').innerText = '--';
                document.getElementById('sales-last-order').innerText = '--';
                container.classList.remove('hidden');
            } catch(e) { console.error(e); placeholder.innerText = "Error loading sales."; placeholder.classList.remove('hidden'); } 
            finally { loader.classList.add('hidden'); }
        }

        window.toggleEditMode = function() { if(currentSelectedRecord) { isEditMode = !isEditMode; window.updateFormDisplayMode(); } }
        window.handleCustomReset = function() { if(currentSelectedRecord) { window.populateForm(currentSelectedRecord); isEditMode = false; window.updateFormDisplayMode(); } }
        window.showManagerFeedback = function() { document.getElementById('manager-feedback-modal').classList.remove('hidden'); }
        window.closeManagerFeedback = function() { document.getElementById('manager-feedback-modal').classList.add('hidden'); }
        window.showImportantInfo = function() { document.getElementById('important-info-modal').classList.remove('hidden'); }
        window.closeImportantInfo = function() { document.getElementById('important-info-modal').classList.add('hidden'); }
        window.promptAdminLogin = function() { document.getElementById('admin-modal').classList.remove('hidden'); }
        window.closeAdminModal = function() { document.getElementById('admin-modal').classList.add('hidden'); }
        window.checkAdminPassword = function() { if(document.getElementById('admin-password').value === 'Jj#23242526') { document.getElementById('admin-rep-input').classList.remove('hidden'); document.getElementById('admin-action-btn').onclick = () => { currentUserRepName = document.getElementById('override-rep-name').value; window.closeAdminModal(); window.loadRecords(); }; document.getElementById('admin-action-btn').textContent = "Set Rep"; } }

        // Updated Custom Save to support optional Note Text for auto-saving
        window.handleCustomSave = async function(customNoteText = null, suppressNotify = false) {
            const noteToSave = customNoteText || document.getElementById('qb-notes-input').value.replace(QB_NOTES_TEMPLATE, '').trim();
            const newEntry = noteToSave ? `------------------------------\nModified On: ${new Date().toLocaleString()}\nModified By: ${currentUserRepName}\n\n${noteToSave}\n\n` : "";
            const fullNotes = newEntry + (currentSelectedRecord.cr714_qbnotes || '');
            
            // Only save if we have edits OR if we are auto-saving a note
            if(!isEditMode && !customNoteText) return;
            
            if (!suppressNotify) window.showNotification("Saving...", "Please wait...");
            
            let isoDate = null;
            const d = document.getElementById('follow-up-date').value;
            const t = document.getElementById('follow-up-time').value;
            if(d) isoDate = t ? `${d}T${t}:00Z` : `${d}T00:00:00Z`;
            const payload = {
                recordId: currentRecordId, qbNotes: fullNotes, followUp: isoDate,
                nameMost: document.getElementById('contact-name-most').value,
                nameLatest: document.getElementById('contact-name-latest').value,
                primaryPhone: document.getElementById('contact-phone-primary').value,
                emailMost: document.getElementById('contact-email-most').value,
                emailLatest: document.getElementById('contact-email-latest').value,
                repName: currentUserRepName
            };
            try {
                const res = await fetch(PATCH_RECORD_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error("Flow Error");
                if (!suppressNotify) window.showNotification("Success", "Saved!");
                
                // Update local model
                currentSelectedRecord.cr714_qbnotes = fullNotes;
                currentSelectedRecord.cr714_followup = isoDate;
                currentSelectedRecord.cr714_namemost = payload.nameMost;
                currentSelectedRecord.cr714_namelatest = payload.nameLatest;
                currentSelectedRecord.cr714_primaryphone = payload.primaryPhone;
                currentSelectedRecord.cr714_emailmost = payload.emailMost;
                currentSelectedRecord.cr714_emaillatest = payload.emailLatest;
                
                if(isEditMode) {
                    isEditMode = false;
                    window.updateFormDisplayMode();
                }
                window.updateNotesPreview();
            } catch(e) { window.showNotification("Error", e.message); }
        }

        window.handleActionButtonClick = async function(type) {
             if(!currentSelectedRecord) return;
             window.showNotification("Processing...", `Sending ${type}...`);
             const notes = window.getElementValue('qb-notes-input').replace(QB_NOTES_TEMPLATE, '').trim();
             const data = { recordId: currentRecordId, action: type, notes: notes, repName: currentUserRepName };
             try {
                 const res = await fetch(ACTION_BUTTON_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                 if(!res.ok) throw new Error("Action Error");
                 window.showNotification("Success", `${type} Completed.`);
             } catch(e) { window.showNotification("Error", e.message); }
        }

        // AUTH
        window.login = function() {
            msalInstance.loginPopup({ scopes: ["User.Read"] }).then(window.handleMsalResponse).catch(e => {
                console.error(e);
                document.getElementById('login-error').textContent = "Login Failed. Check console.";
                document.getElementById('login-error').classList.remove('hidden');
            });
        }

        window.handleMsalResponse = function(resp) {
            if(resp && resp.account) {
                msalAccount = resp.account;
                currentUserRepName = msalAccount.name;
                window.initializeApp();
            }
        }

        window.initializeApp = function() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');
            document.getElementById('welcome-message').textContent = `Hi, ${currentUserRepName.split(' ')[0]}`;
            document.getElementById('welcome-message').classList.remove('hidden');
            document.getElementById('qb-notes-input').value = QB_NOTES_TEMPLATE;
            window.startClock();
            window.loadRecords(); 
            window.checkFirstRun();
            setTimeout(() => { const l = document.getElementById('global-loader'); if(l) { l.style.opacity = '0'; setTimeout(()=>l.style.display='none', 500); } }, 1000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.updateTheme(0);
            msalInstance.handleRedirectPromise().then(window.handleMsalResponse).catch(console.error);
            const accs = msalInstance.getAllAccounts();
            if(accs.length > 0) { msalAccount = accs[0]; currentUserRepName = msalAccount.name; window.initializeApp(); }
        });
    </script>
</body>
</html>
