<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daytona Unified Account Manager v5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        /* --- THEME VARIABLES (Kept existing) --- */
        :root { --bg-app: #e2e8f0; --bg-card: #ffffff; --bg-input: #f8fafc; --text-main: #1e293b; --text-muted: #64748b; --primary: #2563eb; --primary-fg: #ffffff; --accent-danger: #ef4444; --accent-success: #22c55e; --accent-warning: #eab308; --border-color: #94a3b8; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --radius: 0.5rem; }
        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; }
        
        /* GLOBAL STYLES */
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-app); color: var(--text-main); padding: 0.5rem 1rem; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 0.75rem; }
        input, select, textarea { background-color: var(--bg-input) !important; border: 1px solid var(--border-color) !important; color: var(--text-main) !important; border-radius: 0.375rem; padding: 0.5rem; width: 100%; font-size: 0.875rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* APP GRID */
        .app-grid { display: grid; grid-template-columns: 350px 1fr; gap: 1rem; flex-grow: 1; overflow: hidden; height: 100%; }
        .col-left { display: grid; grid-template-rows: 50% 1fr; gap: 1rem; height: 100%; overflow: hidden; }
        .col-right { display: flex; flex-direction: column; gap: 0.75rem; height: 100%; overflow: hidden; }

        /* GALLERY ITEMS */
        .gallery-list { overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; padding: 2px; height: 100%; }
        .gallery-item { padding: 0.75rem; background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .gallery-item:hover { border-color: var(--primary); transform: translateY(-1px); }
        .gallery-item.is-selected { border-left-color: var(--primary); background-color: rgba(37, 99, 235, 0.1); }
        
        /* Action Icons */
        .action-icon { font-size: 1.2rem; margin-right: 5px; }
        
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: var(--bg-card); padding: 1.5rem; border-radius: 0.5rem; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-primary { background-color: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
        .btn-secondary { background-color: var(--bg-input); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 0.375rem; }
        
        /* Email Preview Box */
        .email-preview { border: 1px solid #ccc; padding: 15px; background: white; color: black; height: 300px; overflow-y: auto; font-family: 'Segoe UI', sans-serif; }
    </style>
</head>
<body>

    <div id="login-container" class="modal-overlay">
        <div class="modal-content text-center" style="max-width: 400px;">
            <h2 class="text-2xl font-bold mb-4">Daytona Unified v5</h2>
            <button onclick="window.login()" class="btn-primary w-full py-3">Sign in with Microsoft</button>
            <p id="login-error" class="text-red-500 mt-4 text-sm hidden"></p>
        </div>
    </div>

    <div id="main-app-container" class="hidden flex-col h-full">
        <div class="card p-3 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-blue-600"><i class="fas fa-cube mr-2"></i>Account Manager</h1>
                <button onclick="window.loadRecords()" class="btn-primary text-xs"><i class="fas fa-sync"></i> Refresh</button>
                <span id="welcome-message" class="text-sm text-gray-500 hidden"></span>
            </div>
            <div class="flex-grow max-w-md mx-4"><input type="text" id="search-bar" onkeyup="window.filterGallery()" placeholder="Search accounts or actions..." /></div>
            <div class="flex gap-2">
                <button onclick="document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'midnight' ? '' : 'midnight')" class="btn-secondary text-xs"><i class="fas fa-moon"></i></button>
            </div>
        </div>

        <div class="app-grid">
            <div class="col-left">
                <div class="card flex flex-col min-h-0">
                    <div class="p-2 border-b font-bold flex justify-between">
                        <span>Accounts</span>
                        <span id="record-count" class="bg-blue-600 text-white px-2 rounded text-xs">0</span>
                    </div>
                    <div id="record-gallery-list" class="gallery-list"></div>
                </div>
                <div class="card p-3 flex flex-col min-h-0">
                    <h3 class="font-bold text-sm text-blue-600 mb-2">Sales Snapshot (3 Mo Avg)</h3>
                    <div id="sales-content" class="hidden grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-gray-100 p-2 rounded"><div>Food Service</div><div id="sales-food" class="font-bold text-lg">--</div></div>
                        <div class="bg-gray-100 p-2 rounded"><div>Janitorial</div><div id="sales-jan" class="font-bold text-lg">--</div></div>
                        <div class="bg-gray-100 p-2 rounded"><div>Breakroom</div><div id="sales-break" class="font-bold text-lg">--</div></div>
                        <div class="bg-gray-100 p-2 rounded"><div>Pack & Ship</div><div id="sales-ship" class="font-bold text-lg">--</div></div>
                    </div>
                    <div id="sales-placeholder" class="text-center text-gray-400 text-xs mt-4">Select an account</div>
                </div>
            </div>

            <div class="col-right">
                <div class="card p-3 bg-blue-50 border-blue-200">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <span id="detail-id" class="font-bold text-lg text-blue-800">--</span>
                            <span id="detail-action-badge" class="ml-2 text-xs font-bold px-2 py-1 rounded bg-yellow-200 text-yellow-800 hidden"></span>
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-masonville" onclick="window.launchMasonville()" class="btn-primary text-xs bg-green-600 hover:bg-green-700" disabled>
                                <i class="fas fa-phone-alt mr-1"></i> Masonville
                            </button>
                            <button id="btn-mvgo" onclick="window.openMVGOModal()" class="btn-primary text-xs bg-red-600 hover:bg-red-700" disabled>
                                <i class="fas fa-shopping-cart mr-1"></i> MVGO Catalog
                            </button>
                        </div>
                    </div>
                    <div id="action-message-box" class="hidden p-2 bg-yellow-100 text-yellow-800 text-xs rounded border border-yellow-300 mb-2"></div>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <div><label>Company</label><input id="detail-company" disabled></div>
                        <div><label>Contact</label><input id="detail-contact" disabled></div>
                        <div><label>Phone</label><input id="detail-phone" disabled></div>
                    </div>
                </div>

                <div class="card p-3 flex-grow flex flex-col min-h-0">
                    <div class="flex gap-2 mb-3">
                        <button id="btn-email" onclick="window.openEmailModal()" class="btn-secondary text-xs flex-1" disabled><i class="fas fa-envelope"></i> Action Email</button>
                        <button id="btn-calendar" onclick="window.createCalendarEvent()" class="btn-secondary text-xs flex-1" disabled><i class="fas fa-calendar"></i> Follow Up</button>
                        <button id="btn-escalate" onclick="window.handleAction('Help')" class="btn-secondary text-xs flex-1 text-red-600 border-red-200" disabled><i class="fas fa-exclamation-circle"></i> Help!</button>
                        <button id="btn-close" onclick="window.handleAction('CloseAccount')" class="btn-secondary text-xs flex-1 text-gray-600" disabled>Close Acct</button>
                    </div>

                    <div id="rental-notes-container" class="hidden mb-3">
                        <label class="text-xs font-bold text-blue-600">Water/Rental Notes</label>
                        <textarea id="rental-notes" class="h-16 bg-blue-50 border-blue-200" placeholder="Enter specific rental equipment notes here..."></textarea>
                    </div>

                    <div class="flex-grow flex flex-col min-h-0">
                        <label class="text-xs font-bold text-gray-600">Account Management Notes</label>
                        <div class="grid grid-cols-2 gap-4 h-full">
                            <textarea id="new-note" class="h-full resize-none font-mono text-sm" placeholder="Type new notes here..."></textarea>
                            <div id="prev-notes" class="h-full overflow-y-auto border rounded p-2 bg-gray-50 text-xs font-mono text-gray-600">
                                <em>Select an account to view history.</em>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 flex justify-end">
                        <button id="btn-save" onclick="window.saveRecord()" class="btn-primary w-32" disabled>Save Complete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mvgo-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-red-600">MVGO Catalog Request</h2>
            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                <div>
                    <label class="font-bold block mb-2">1. Requested Action</label>
                    <div class="space-y-1">
                        <label><input type="checkbox" class="mvgo-chk" value="Save/Trouble"> Save/Trouble (Non-buy < 30)</label><br>
                        <label><input type="checkbox" class="mvgo-chk" value="Loss/Winback"> Loss/Winback (Non-buy > 60)</label><br>
                        <label><input type="checkbox" class="mvgo-chk" value="New Buyer"> New Buyer - Meet & Greet</label>
                    </div>
                </div>
                <div>
                    <label class="font-bold block mb-2">2. Category Opportunity</label>
                    <div class="grid grid-cols-2 gap-1">
                        <label><input type="checkbox" class="mvgo-cat" value="Foodservice"> Foodservice</label>
                        <label><input type="checkbox" class="mvgo-cat" value="Janitorial"> Janitorial</label>
                        <label><input type="checkbox" class="mvgo-cat" value="Breakroom"> Breakroom</label>
                        <label><input type="checkbox" class="mvgo-cat" value="Water"> Water</label>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label class="font-bold text-sm">Inside Sales Note (Concern/Instructions)</label>
                <textarea id="mvgo-note" class="h-20"></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('mvgo-modal').classList.add('hidden')" class="btn-secondary">Cancel</button>
                <button onclick="window.submitMVGO()" class="btn-primary bg-red-600">Launch MVGO & Save</button>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between mb-4">
                <h2 class="text-xl font-bold">Action Email Composer</h2>
                <button onclick="document.getElementById('email-modal').classList.add('hidden')" class="text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-3">
                    <div><label class="text-xs font-bold">To</label><input id="email-to"></div>
                    <div><label class="text-xs font-bold">Subject</label><input id="email-subject"></div>
                    <div class="flex-grow"><label class="text-xs font-bold">Custom Note Body</label><textarea id="email-body" class="h-40" oninput="window.updateEmailPreview()"></textarea></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Preview</label>
                    <div id="email-preview-content" class="email-preview rounded"></div>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="window.sendEmail()" class="btn-primary"><i class="fas fa-paper-plane"></i> Send Email</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIG ---
    const MSAL_CONFIG = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: "https://WB-DT.github.io/daytona-utility/" }};
    const msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);
    let currentUser = null;
    let allRecords = [];
    let selectedRecord = null;

    // API ENDPOINTS (Placeholders - Ensure these match your environment)
    const FLOW_GET_RECORDS = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2d5cc7c0ffa34dcb87e6416df29b9acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8qFD-lNiuxDgafyu31UYZ8zzePJMRJ4wpUzLzbb9bMs"; 
    // Note: You need a Flow that accepts a PATCH/POST for saving updates
    const FLOW_PATCH_RECORD = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/774bb53ee87542e5825b46958f5bd55d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EbaJTl1gKlG8rjTn3ZmoLwUiQ430Sju1kWZYZ6hr0zE";
    const FLOW_EMAIL = "YOUR_EMAIL_FLOW_URL"; // Needs to be added if different from existing

    // --- AUTHENTICATION ---
    async function login() {
        try {
            const resp = await msalInstance.loginPopup({ scopes: ["User.Read"] });
            handleLogin(resp.account);
        } catch (e) {
            document.getElementById('login-error').textContent = e.message;
            document.getElementById('login-error').classList.remove('hidden');
        }
    }

    function handleLogin(account) {
        currentUser = account;
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('main-app-container').classList.remove('hidden');
        document.getElementById('main-app-container').classList.add('flex');
        document.getElementById('welcome-message').textContent = `Hi, ${account.name.split(' ')[0]}`;
        document.getElementById('welcome-message').classList.remove('hidden');
        loadRecords();
    }

    // --- DATA LOADING ---
    async function loadRecords() {
        const list = document.getElementById('record-gallery-list');
        list.innerHTML = '<div class="loader"></div>';
        
        try {
            // Sending Rep Email/Name to Flow to filter data
            const res = await fetch(FLOW_GET_RECORDS, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ repName: currentUser.name, repEmail: currentUser.username })
            });
            
            if (!res.ok) throw new Error("Failed to fetch records");
            
            allRecords = await res.json();
            document.getElementById('record-count').textContent = allRecords.length;
            renderGallery(allRecords);
        } catch (e) {
            list.innerHTML = `<div class="text-red-500 p-4">Error: ${e.message}</div>`;
        }
    }

    function renderGallery(records) {
        const list = document.getElementById('record-gallery-list');
        list.innerHTML = '';
        
        records.forEach(r => {
            // Determine Icon based on Action
            let icon = '';
            const action = r.cr714_action || '';
            if(action.includes('Rental') || action.includes('Water')) icon = 'ðŸ’§';
            else if(action.includes('Paper')) icon = 'ðŸ“„';
            else if(action.includes('Food')) icon = 'â˜•';
            else if(action.includes('Winback')) icon = 'ðŸ›¡ï¸';
            
            const div = document.createElement('div');
            div.className = `gallery-item ${selectedRecord && selectedRecord.cr714_id === r.cr714_id ? 'is-selected' : ''}`;
            div.onclick = () => selectRecord(r);
            
            div.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-bold text-blue-600 text-xs">${r.cr714_accountnumber || r.cr714_id}</span>
                    <span class="text-xs text-gray-400">${r.cr714_action || ''}</span>
                </div>
                <div class="font-medium text-sm truncate">${icon} ${r.cr714_accountname || r.cr714_company}</div>
                ${r.cr714_followup ? `<div class="text-xs text-red-500 mt-1"><i class="fas fa-clock"></i> ${new Date(r.cr714_followup).toLocaleDateString()}</div>` : ''}
            `;
            list.appendChild(div);
        });
    }

    function filterGallery() {
        const term = document.getElementById('search-bar').value.toLowerCase();
        const filtered = allRecords.filter(r => 
            (r.cr714_accountname && r.cr714_accountname.toLowerCase().includes(term)) ||
            (r.cr714_accountnumber && r.cr714_accountnumber.includes(term)) ||
            (r.cr714_action && r.cr714_action.toLowerCase().includes(term))
        );
        renderGallery(filtered);
    }

    // --- RECORD SELECTION ---
    function selectRecord(rec) {
        selectedRecord = rec;
        renderGallery(allRecords); // Re-render to update selection style
        
        // Enable Buttons
        document.querySelectorAll('button:disabled').forEach(b => b.disabled = false);
        
        // Populate Header & Fields
        document.getElementById('detail-id').textContent = rec.cr714_accountnumber || rec.cr714_id;
        document.getElementById('detail-company').value = rec.cr714_accountname || rec.cr714_company;
        document.getElementById('detail-contact').value = rec.cr714_contact || rec.cr714_namemost || '';
        document.getElementById('detail-phone').value = rec.cr714_phone || rec.cr714_primaryphone || '';
        
        // Action Message (Important Info)
        const msgBox = document.getElementById('action-message-box');
        if(rec.cr714_actionmessage || rec.cr714_importantaccountinformation) {
            msgBox.textContent = rec.cr714_actionmessage || rec.cr714_importantaccountinformation;
            msgBox.classList.remove('hidden');
        } else {
            msgBox.classList.add('hidden');
        }

        // Action Badge
        const badge = document.getElementById('detail-action-badge');
        if(rec.cr714_action) {
            badge.textContent = rec.cr714_action;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }

        // Rental Notes Visibility
        if(rec.cr714_action === "4. Rental" || rec.cr714_action === "2. BLZ Water") {
            document.getElementById('rental-notes-container').classList.remove('hidden');
            document.getElementById('rental-notes').value = rec.cr714_rentalnotes || '';
        } else {
            document.getElementById('rental-notes-container').classList.add('hidden');
        }

        // Notes History
        const historyDiv = document.getElementById('prev-notes');
        // Logic to parse specific separator "------------------------"
        let notes = rec.cr714_accountmanagementnotes || rec.cr714_qbnotes || '';
        // Simple formatting for display
        historyDiv.innerHTML = notes.replace(/\n/g, '<br>').replace(/------------------------/g, '<hr class="my-2 border-gray-300">');
        
        // Sales Data (Mock mapping based on Power App fields)
        document.getElementById('sales-content').classList.remove('hidden');
        document.getElementById('sales-placeholder').classList.add('hidden');
        document.getElementById('sales-food').textContent = formatCurrency(rec.cr714_foodservice3moavg);
        document.getElementById('sales-jan').textContent = formatCurrency(rec.cr714_janitorialsales);
        document.getElementById('sales-break').textContent = formatCurrency(rec.cr714_breakroom3moavg);
        document.getElementById('sales-ship').textContent = formatCurrency(rec.cr714_shippingsales);
    }

    function formatCurrency(val) {
        if(!val) return "$0.00";
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);
    }

    // --- MASONVILLE LOGIC (Ported from Power FX) ---
    function launchMasonville() {
        if(!selectedRecord) return;
        
        const baseUrl = "https://go.masonville.com/#/activityphone?direction=outgoing";
        const accNum = encodeURIComponent(selectedRecord.cr714_accountnumber || selectedRecord.cr714_id);
        const owner = encodeURIComponent(currentUser.name);
        const subject = encodeURIComponent("Account Management Call");
        
        const dateStr = new Date().toISOString().slice(0, 19).replace('T', ' ');
        const notes = `Modified On: ${dateStr}\r\nModified By: ${currentUser.name}\r\n\r\nAM Notes:\r\n${document.getElementById('new-note').value}`;
        const details = encodeURIComponent(notes);

        const finalUrl = `${baseUrl}&accountNumber=${accNum}&owner=${owner}&salesCallTrigger=${subject}&salesCallTriggerDetails=${details}`;
        
        // Open logic
        window.open(finalUrl, '_blank');
        
        // Auto-save note logic would go here
    }

    // --- MVGO LOGIC ---
    function openMVGOModal() {
        document.getElementById('mvgo-modal').classList.remove('hidden');
    }

    function submitMVGO() {
        // 1. Gather Checked Items
        const actions = Array.from(document.querySelectorAll('.mvgo-chk:checked')).map(c => c.value).join('\n');
        const categories = Array.from(document.querySelectorAll('.mvgo-cat:checked')).map(c => c.value).join('\n');
        const note = document.getElementById('mvgo-note').value;

        // 2. Construct URL (Ported from Power App)
        const baseUrl = "https://go.masonville.com/#/activitysalescall?repCreditCode=&emptyOwner=TRUE";
        const accNum = encodeURIComponent(selectedRecord.cr714_accountnumber || selectedRecord.cr714_id);
        const trigger = "ISReq";
        
        const detailsBody = `Action Plan --- ${new Date().toLocaleDateString()}\n\nRequested Action(s):\n${actions}\n\nCategory Opps:\n${categories}\n\nInside Sales Note:\n${note}`;
        const details = encodeURIComponent(detailsBody);

        const url = `${baseUrl}&accountNumber=${accNum}&salesCallTrigger=${trigger}&salesCallTriggerDetails=${details}`;

        window.open(url, '_blank');
        document.getElementById('mvgo-modal').classList.add('hidden');
        
        // Add logic to save record here indicating MVGO was launched
    }

    // --- EMAIL LOGIC ---
    function openEmailModal() {
        if(!selectedRecord) return;
        const modal = document.getElementById('email-modal');
        
        // Pre-fill
        document.getElementById('email-to').value = selectedRecord.cr714_emailaddress || selectedRecord.cr714_emaillatest || "";
        
        // Dynamic Subject Logic (Switch statement from Power App)
        let subject = "";
        const action = (selectedRecord.cr714_action || "").trim();
        if(action === "Chair Mat Contest") subject = `${selectedRecord.cr714_accountnumber} - A Promo That Matters`;
        else if(action === "NONBUY") subject = "WB Mason - 15% Off";
        else if(action === "NOVNoSales") subject = "WB Mason - 10% Off";
        
        document.getElementById('email-subject').value = subject;
        updateEmailPreview();
        modal.classList.remove('hidden');
    }

    function updateEmailPreview() {
        // Simple HTML construction for preview
        const body = document.getElementById('email-body').value.replace(/\n/g, "<br>");
        const previewDiv = document.getElementById('email-preview-content');
        
        // You can expand this with the full HTML templates provided in the text file
        previewDiv.innerHTML = `
            <div style="font-family:sans-serif; padding:10px;">
                <p><strong>To:</strong> ${document.getElementById('email-to').value}</p>
                <p><strong>Subject:</strong> ${document.getElementById('email-subject').value}</p>
                <hr>
                <p>Hi ${selectedRecord.cr714_accountname},</p>
                <p>${body}</p>
                <br>
                <p>Thank you,<br>${currentUser.name}<br>W.B. Mason Co.</p>
            </div>
        `;
    }

    async function saveRecord() {
        if(!selectedRecord) return;
        const newNote = document.getElementById('new-note').value;
        const rentalNote = document.getElementById('rental-notes').value;
        
        // Construct payload
        const payload = {
            recordId: selectedRecord.cr714_id, // or GUID
            cr714_accountmanagementnotes: newNote ? `${new Date().toLocaleString()} - ${currentUser.name}: ${newNote}\n------------------------\n${selectedRecord.cr714_accountmanagementnotes||''}` : selectedRecord.cr714_accountmanagementnotes,
            cr714_rentalnotes: rentalNote
        };

        try {
            const res = await fetch(FLOW_PATCH_RECORD, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(!res.ok) throw new Error("Save failed");
            alert("Saved successfully!");
            // Clear input
            document.getElementById('new-note').value = '';
            loadRecords(); // Refresh
        } catch(e) {
            alert("Error saving: " + e.message);
        }
    }

    // --- AUTH INIT ---
    window.onload = () => {
        // Check if already logged in
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
            handleLogin(accounts[0]);
        }
    };
</script>
</body>
</html>
