<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daytona Manager v6.66 (Email Fix & Counter)</title>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-app: #e2e8f0; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b;
            --primary: #2563eb; --primary-fg: #ffffff;
            --accent-danger: #ef4444; --accent-success: #22c55e; --accent-warning: #eab308;
            --border-color: #94a3b8; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 0.5rem; --blur: none;
        }

        /* Themes */
        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; }
        [data-theme="oled"] { --bg-app: #000000; --bg-card: #121212; --bg-input: #2a2a2a; --text-main: #ffffff; --text-muted: #a1a1aa; --border-color: #27272a; --primary: #facc15; --primary-fg: #000000; }
        [data-theme="forest"] { --bg-app: #ecfdf5; --bg-card: #ffffff; --bg-input: #f0fdf4; --text-main: #064e3b; --text-muted: #65a30d; --border-color: #bbf7d0; --primary: #16a34a; --primary-fg: #ffffff; }
        [data-theme="ocean"] { --bg-app: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); --bg-card: rgba(255,255,255,0.95); --bg-input: rgba(255,255,255,0.8); --text-main: #0c4a6e; --text-muted: #0284c7; --border-color: #bae6fd; --primary: #0284c7; --primary-fg: #ffffff; }
        [data-theme="sunset"] { --bg-app: #fff7ed; --bg-card: #ffffff; --bg-input: #ffedd5; --text-main: #7c2d12; --text-muted: #c2410c; --border-color: #fed7aa; --primary: #ea580c; --primary-fg: #ffffff; }
        [data-theme="cyber"] { --bg-app: #050505; --bg-card: #11001c; --bg-input: #240046; --text-main: #e0aaff; --text-muted: #9d4edd; --border-color: #5a189a; --primary: #ff00ff; --primary-fg: #11001c; --shadow: 0 0 10px #ff00ff; }
        [data-theme="holiday-cheer"] { --bg-app: #f0fdf4; --bg-card: #ffffff; --bg-input: #fff1f2; --text-main: #14532d; --text-muted: #991b1b; --border-color: #166534; --primary: #dc2626; --primary-fg: #ffffff; --accent-warning: #fbbf24; }
        [data-theme="winter"] { --bg-app: linear-gradient(to bottom, #eff6ff, #dbeafe); --bg-card: #ffffff; --bg-input: #f0f9ff; --text-main: #1e3a8a; --text-muted: #60a5fa; --border-color: #bfdbfe; --primary: #2563eb; --primary-fg: #ffffff; }
        [data-theme="harvest"] { --bg-app: #fffbeb; --bg-card: #ffffff; --bg-input: #fff7ed; --text-main: #78350f; --text-muted: #d97706; --border-color: #fcd34d; --primary: #d97706; --primary-fg: #ffffff; }

        /* --- GLOBAL --- */
        body { font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); padding: 0.5rem 1rem; height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: background 0.3s ease; }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 0.75rem; }
        .card-header { font-weight: 600; border-bottom: 1px solid var(--border-color); padding: 0.5rem 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        
        input, select, textarea { background: var(--bg-input) !important; border: 1px solid var(--border-color) !important; color: var(--text-main) !important; border-radius: 0.375rem; padding: 0.5rem; width: 100%; font-size: 0.875rem; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: var(--primary-fg); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; }
        .btn-secondary { background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; }
        
        /* EDITABLE HIGHLIGHTS */
        .editable-field { background: transparent !important; border: 1px solid transparent !important; padding: 0.25rem 0.5rem; transition: all 0.3s; }
        .editable-field.is-editable { background-color: #ffffff !important; border: 2px solid #eab308 !important; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); color: #000 !important; }

        /* GRID */
        .app-grid { display: grid; grid-template-columns: 350px 1fr; gap: 1rem; flex-grow: 1; overflow: hidden; width: 100%; max-width: 100%; }
        .col-left { display: grid; grid-template-rows: 40% 1fr; gap: 1rem; height: 100%; min-height: 0; overflow: hidden; }
        
        /* RIGHT COLUMN */
        .col-right { display: flex; flex-direction: column; gap: 0.75rem; height: 100%; overflow: hidden; min-width: 0; }
        .col-right #contact-sticky-header { flex-shrink: 0; }
        .col-right .card.workspace { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; }
        
        /* NOTES SCROLL FIX */
        .notes-container { display: flex; flex-direction: column; height: 100%; min-height: 0; overflow: hidden; }
        .note-textarea { width: 100%; resize: none; overflow-y: auto; min-height: 0; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.5rem; white-space: pre-wrap; font-family: monospace; }
        .note-textarea.is-editable { background-color: #ffffff !important; border: 2px solid #eab308 !important; color: #000 !important; }
        
        #qb-notes-preview { flex: 1; border: 1px solid var(--border-color); border-radius: 0.375rem; background-color: var(--bg-input); padding: 0.75rem; overflow-y: auto; min-height: 0; height: 100%; }
        
        /* PREVIEW BODY FORMATTING FIX */
        .ai-body {
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            color: var(--text-main);
            margin-top: 0.25rem;
        }

        /* NOTE HISTORY */
        details.note-history { border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-card); margin-bottom: 0.5rem; }
        details.note-history summary { padding: 0.5rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; background: var(--bg-card); border-bottom: 1px solid var(--border-color); }
        details.note-history[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        
        details.note-history pre { 
            padding: 0.75rem; 
            background: var(--bg-input); 
            margin: 0; 
            max-height: 300px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace; 
            font-size: 0.8rem;
            color: var(--text-main);
        }
        
        /* GALLERY */
        .gallery-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; padding: 2px; }
        .gallery-item { padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .gallery-item.is-selected { border-color: var(--primary); background: var(--primary); color: var(--primary-fg); }
        .gallery-item.is-selected * { color: var(--primary-fg) !important; }
        .gallery-item-id { color: var(--primary); font-weight: 700; font-size: 0.9rem; } 
        .gallery-item-company { color: var(--text-main); font-weight: 600; font-size: 0.85rem; margin-top: 2px; }
        .gallery-item-rep { color: var(--text-muted); font-size: 0.75rem; italic; margin-top: 4px; }
        .gallery-item-followup { font-size: 0.7rem; font-weight: 600; color: var(--accent-danger); background-color: var(--bg-input); padding: 1px 6px; border-radius: 999px; display: inline-flex; align-items: center; margin-left: auto; border: 1px solid var(--accent-danger); }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 60; }
        .modal-content { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 0.5rem; max-width: 500px; width: 100%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        #email-modal-content { max-width: 1600px; width: 90%; height: 90vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .email-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; height: 100%; overflow: hidden; padding: 1.5rem; }
        .email-left { display: flex; flex-direction: column; gap: 1rem; height: 100%; overflow: hidden; }
        .email-body-container { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        #email-modal-body { flex-grow: 1; resize: none; height: 100%; overflow-y: auto !important; border: 1px solid #cbd5e1; background-color: #f8fafc; padding: 10px; }
        .email-footer { flex-shrink: 0; margin-top: 0.5rem; }
        .email-right { height: 100%; overflow: hidden; }
        .email-preview-pane { border: 3px solid var(--border-color); background: white; color: black; padding: 2rem; overflow-y: auto; height: 100%; border-radius: 0.375rem; font-family: 'Segoe UI', sans-serif; }

        /* THEME MENU */
        .theme-dropdown { position: relative; display: inline-block; }
        .theme-menu-content { display: none; position: absolute; right: 0; top: 100%; background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: var(--shadow); min-width: 180px; z-index: 50; margin-top: 0.5rem; max-height: 400px; overflow-y: auto; }
        .theme-menu-content.show { display: block; }
        .theme-option { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; cursor: pointer; color: var(--text-main); font-size: 0.85rem; }
        .theme-option:hover { background-color: var(--bg-input); }
        .theme-swatch { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #ccc; }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* LOADER */
        #global-loader { position: fixed; inset: 0; background: var(--bg-app); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loader-dot { animation: bounce 1.4s infinite ease-in-out both; background-color: var(--primary); border-radius: 50%; display: inline-block; height: 15px; width: 15px; margin: 0 3px; }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; background-color: var(--primary); }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; background-color: var(--accent-warning); }
        .loader-dot:nth-child(3) { animation-delay: 0s; background-color: var(--accent-danger); }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* MISC */
        .ai-box { padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0.25rem; border-left: 4px solid; background: var(--bg-input); }
        .ai-imp { border-color: var(--accent-danger); background: rgba(239, 68, 68, 0.05); }
        .ai-mgr { border-color: var(--accent-success); background: rgba(34, 197, 94, 0.05); }
        .ai-key { border-color: var(--primary); background: rgba(37, 99, 235, 0.05); }
        .ai-header { font-weight: bold; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .ai-body { font-size: 0.85rem; white-space: pre-wrap; line-height: 1.4; color: var(--text-main); }

        .marquee-container { overflow: hidden; background: var(--bg-input); border: 1px solid var(--accent-danger); border-radius: 0.25rem; height: 24px; display: flex; align-items: center; margin-bottom: 0.5rem; }
        .marquee-text { white-space: nowrap; animation: scroll 15s linear infinite; color: var(--accent-danger); font-weight: bold; font-size: 0.75rem; padding-left: 100%; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        /* ALERT BUTTONS */
        .btn-alert-base { font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease; border: 2px solid transparent; position: relative; overflow: hidden; }
        .btn-has-data-red { color: #dc2626 !important; border-color: #dc2626 !important; background: #fee2e2 !important; animation: smooth-pulse-red 2s infinite; opacity: 1 !important; }
        .btn-has-data-yellow { color: #ca8a04 !important; border-color: #ca8a04 !important; background: #fef9c3 !important; animation: smooth-pulse-yellow 2s infinite; opacity: 1 !important; }
        @keyframes smooth-pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        @keyframes smooth-pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(202, 138, 4, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(202, 138, 4, 0); } 100% { box-shadow: 0 0 0 0 rgba(202, 138, 4, 0); } }

        /* STANDARD CHECKBOX */
        input[type="checkbox"] { width: 1.2em; height: 1.2em; accent-color: var(--primary); cursor: pointer; }
    </style>
</head>
<body class="p-0 md:p-4">

    <div id="global-loader"><div class="mb-4"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div><h2 class="text-lg font-bold" style="color:var(--text-main)">Loading...</h2></div>

    <div id="login-container" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <i class="fas fa-lock text-4xl mb-4" style="color: var(--primary);"></i>
            <h2 class="text-2xl font-bold mb-2">Daytona Utility</h2>
            <p class="mb-6 text-sm opacity-80">Sign in to manage your accounts.</p>
            <button onclick="window.login()" id="login-button" class="btn-primary w-full text-lg py-3">Sign in with Microsoft</button>
            <p id="login-error" class="text-red-500 mt-4 text-sm hidden"></p>
        </div>
    </div>

    <div id="main-app-container" class="hidden flex flex-col h-full">
        <div class="card mb-3 p-3 flex flex-wrap items-center justify-between gap-4 shrink-0" id="header-panel">
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <h1 class="text-xl font-bold" style="color: var(--primary);">My Accounts</h1>
                    <span id="header-email-counter" class="text-[10px] text-gray-400 font-mono uppercase tracking-wider mt-0.5">Emails (1hr): 0/100</span>
                </div>
                <button onclick="window.loadRecords()" class="btn-primary text-xs">Refresh</button>
                <div class="flex items-center gap-2 ml-2 pl-4 border-l" style="border-color: var(--border-color)">
                    <span id="welcome-message" onclick="window.showUserProfileCard()" class="text-sm font-medium cursor-pointer hover:text-blue-600" title="View Profile"></span>
                    <button onclick="window.promptAdminLogin()" class="hover:text-brand transition-colors" style="color: var(--text-muted);" title="Admin Override"><i class="fas fa-user-lock"></i></button>
                </div>
            </div>
            <div class="flex-grow max-w-md mx-4"><input type="text" id="search-bar" onkeyup="window.filterAndSortGallery()" placeholder="Search accounts..." class="text-sm" /></div>
            <div class="flex items-center gap-3">
                <div class="theme-dropdown">
                    <button onclick="window.toggleThemeMenu()" id="theme-toggle-btn" class="btn-secondary text-xs flex items-center gap-2"><i class="fas fa-palette"></i> Theme</button>
                    <div id="theme-menu" class="theme-menu-content"></div>
                </div>
                <select id="sort-dropdown" onchange="window.filterAndSortGallery()" class="text-xs w-40">
                    <option value="company-asc">Sort: Company A-Z</option>
                    <option value="company-desc">Sort: Company Z-A</option>
                    <option value="followup-asc">Sort: Follow Up (Oldest)</option>
                    <option value="followup-desc">Sort: Follow Up (Newest)</option>
                    <option value="days-asc">Days Since Order &#x2191;</option>
                    <option value="days-desc">Days Since Order &#x2193;</option>
                    <option value="rep-asc">Rep A-Z</option>
                </select>
                <select id="filter-action-dropdown" onchange="window.filterAndSortGallery()" class="text-xs w-40" disabled><option value="">Filter: All Actions</option></select>
            </div>
            <div class="w-full flex justify-end gap-4 text-xs border-t pt-2 mt-1" style="border-color: var(--border-color)">
                 <label class="cursor-pointer flex items-center gap-1" style="color: var(--text-muted);"><input type="checkbox" id="filter-followup" onchange="window.filterAndSortGallery()"> Follow Ups</label>
                 <label class="cursor-pointer flex items-center gap-1" style="color: var(--text-muted);"><input type="checkbox" id="filter-nonotes" onchange="window.filterAndSortGallery()"> No Notes</label>
                 <label class="cursor-pointer flex items-center gap-1" style="color: var(--text-muted);"><input type="checkbox" id="filter-norecent" onchange="window.filterAndSortGallery()"> No Recent (>14 Days)</label>
                 <label class="cursor-pointer flex items-center gap-1" style="color: var(--text-muted);"><input type="checkbox" id="filter-norecent30" onchange="window.filterAndSortGallery()"> No Recent (>30 Days)</label>
                 <label class="cursor-pointer flex items-center gap-1" style="color: var(--text-muted);"><input type="checkbox" id="filter-requests" onchange="window.filterAndSortGallery()"> Button Req.</label>
            </div>
        </div>

        <div class="app-grid">
            <div class="col-left">
                <div class="card flex flex-col min-h-0">
                    <div class="card-header"><span>Account List</span><span id="record-count" class="text-xs px-2 py-0.5 rounded text-white" style="background-color: var(--primary);">0</span></div>
                    <div id="record-gallery-list" class="gallery-list"><div class="text-center p-4 text-xs text-muted italic">Records not loaded.</div></div>
                </div>
                <div class="card flex flex-col min-h-0 p-3">
                    <div class="flex items-center justify-between mb-2 border-b pb-2" style="border-color: var(--border-color)">
                        <h3 class="font-bold text-sm" style="color: var(--primary);">Sales Snapshot</h3>
                        <div id="sales-loader" class="text-xs italic hidden" style="color: var(--text-muted);">Loading...</div>
                    </div>
                    <div class="marquee-container mb-3"><div class="marquee-text">Invoiced Sales Only - May Not Include Open Orders!</div></div>
                    
                    <div id="sales-content" class="hidden flex-grow flex flex-col gap-3 overflow-hidden">
                        <div class="p-4 rounded border flex flex-col items-center justify-center shadow-sm" style="background-color: var(--bg-input); border-color: var(--border-color);">
                            <div class="text-xs uppercase font-bold tracking-wider mb-1" style="color: var(--text-muted);">3-Month Sales</div>
                            <div class="font-extrabold text-3xl" style="color: var(--primary);" id="sales-ytd">--</div>
                        </div>
                        <div class="flex-grow overflow-y-auto border-t pt-3" style="border-color: var(--border-color)">
                            <h4 class="text-xs font-bold mb-2 uppercase" style="color: var(--text-muted);">Category Breakdown</h4>
                            <ul id="sales-category-list" class="text-xs space-y-2"></ul>
                        </div>
                    </div>

                    <div id="sales-placeholder" class="text-xs text-center py-8 flex flex-col items-center justify-center gap-2" style="color: var(--text-muted);">
                        <span class="italic">Select an account to view sales.</span>
                    </div>
                    <div class="text-center pt-2 border-t mt-auto text-xs" style="border-color: var(--border-color); color: var(--text-muted);"><span id="clock-display">--:-- --</span></div>
                </div>
            </div>

            <div class="col-right">
                <div class="card p-3" id="contact-sticky-header">
                    <div class="card-header mt-0 pt-0 px-0 pb-2 mb-2">
                        <span><i class="fas fa-user-circle mr-2" style="color: var(--primary);"></i>Profile: <span id="acct-number-header" class="font-bold" style="color: var(--text-color);">--</span></span>
                        <div class="flex gap-2">
                            <div id="save-controls" class="hidden gap-2 mr-4 border-r pr-4" style="border-color: var(--border-color)">
                                <button onclick="window.handleCustomSave()" class="btn-primary text-xs py-1">Save</button>
                                <button onclick="window.handleCustomReset()" class="btn-secondary text-xs py-1">Cancel</button>
                            </div>
                            <button onclick="window.showManagerFeedback()" id="btn-mgr-feedback" class="btn-alert-base text-xs opacity-50 text-gray-500 px-2 rounded">Mgr Feedback</button>
                            <button onclick="window.showImportantInfo()" id="btn-imp-info" class="btn-alert-base text-xs opacity-50 text-gray-500 px-2 rounded">Imp Info</button>
                            <button onclick="window.toggleEditMode()" id="editModeButton" class="btn-secondary text-xs py-1 ml-2" disabled>Edit Profile</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 text-sm mb-2">
                        <div><label class="text-[10px] uppercase block" style="color: var(--text-muted);">Primary Contact</label><input type="text" id="contact-name-most" class="editable-field" disabled></div>
                        <div><label class="text-[10px] uppercase block" style="color: var(--text-muted);">Recent Contact</label><input type="text" id="contact-name-latest" class="editable-field" disabled></div>
                        <div><label class="text-[10px] uppercase block" style="color: var(--text-muted);">Phone</label><input type="text" id="contact-phone-primary" class="editable-field" disabled></div>
                        <div><label class="text-[10px] uppercase block" style="color: var(--text-muted);">Email</label><input type="email" id="contact-email-most" class="editable-field" disabled></div>
                        <div class="hidden"><input type="email" id="contact-email-latest"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-xs pt-1 border-t" style="border-color: var(--border-color);">
                        <div><span class="uppercase font-bold" style="color: var(--text-muted);">Company:</span> <span id="acct-company" class="font-medium">--</span></div>
                        <div><span class="uppercase font-bold" style="color: var(--text-muted);">Action Message:</span> <span id="acct-action-message" class="font-medium">--</span></div>
                    </div>
                </div>

                <div class="card workspace p-0 flex flex-col overflow-hidden">
                    <div class="card-header bg-gray-50 p-3 border-b flex-shrink-0">
                        <div class="flex items-center gap-4 w-full justify-between">
                            <div class="flex items-center gap-2">
                                <input type="date" id="follow-up-date" class="text-xs w-32" disabled>
                                <input type="time" id="follow-up-time" class="text-xs w-28" disabled>
                                <button onclick="window.createCalendarEvent()" class="btn-primary text-xs px-2 py-1"><i class="fas fa-calendar-plus"></i></button>
                            </div>
                            <div class="flex gap-2 flex-grow max-w-md">
                                <select id="email-template-dropdown" class="text-xs flex-grow" disabled></select>
                                <button onclick="window.launchEmailLogic()" id="launch-email-button" class="btn-secondary text-xs px-3" disabled><i class="fas fa-paper-plane"></i></button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.handleActionButtonClick('Help')" id="help-button" class="btn-secondary text-xs px-2" style="border-color: #93c5fd; color: #2563eb;" disabled>Help</button>
                                <button onclick="window.handleActionButtonClick('NoOpp')" id="noopp-button" class="btn-secondary text-xs px-2" style="border-color: #d8b4fe; color: #9333ea;" disabled>No Opp</button>
                                <button onclick="window.handleActionButtonClick('CloseAccount')" id="close-button" class="btn-secondary text-xs px-2" style="border-color: #fca5a5; color: #dc2626;" disabled>Close</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow p-4 overflow-hidden">
                        <div class="grid grid-cols-2 gap-6 h-full">
                            <div class="notes-container relative flex flex-col gap-2 h-full">
                                <div class="flex flex-col flex-grow h-[60%] min-h-0">
                                    <div class="flex justify-between items-center mb-1 flex-shrink-0">
                                        <label class="text-xs font-bold" style="color: var(--text-muted);">General Note</label>
                                        <button onclick="window.insertTemplate()" class="text-sm font-bold text-blue-500 hover:underline">+ Template</button>
                                    </div>
                                    <textarea id="qb-notes-input" oninput="window.updateNotesPreview()" class="note-textarea w-full p-3 text-sm font-mono rounded border flex-grow" disabled></textarea>
                                </div>
                                <div class="flex flex-col flex-grow h-[40%] min-h-0 border-t pt-2" style="border-color: var(--border-color)">
                                    <label class="text-xs font-bold mb-1" style="color: var(--text-muted);">Rental Note</label>
                                    <textarea id="rental-notes-input" oninput="window.updateNotesPreview()" class="note-textarea w-full p-3 text-sm font-mono rounded border flex-grow" placeholder="Enter rental specifics..." disabled></textarea>
                                </div>
                            </div>

                            <div class="notes-container">
                                <div class="flex justify-between items-center mb-1 flex-shrink-0">
                                    <label class="text-xs font-bold" style="color: var(--text-muted);">History & Preview</label>
                                    <div class="flex gap-2 text-xs">
                                        <label class="cursor-pointer flex items-center gap-1 select-none"><input type="checkbox" id="show-ai-summary" checked onchange="window.toggleNoteView(this.id)"> AI</label>
                                        <label class="cursor-pointer flex items-center gap-1 select-none"><input type="checkbox" id="show-new-note" checked onchange="window.updateNotesPreview()"> New</label>
                                        <label class="cursor-pointer flex items-center gap-1 select-none"><input type="checkbox" id="show-prev-note" onchange="window.toggleNoteView(this.id)"> Prev</label>
                                    </div>
                                </div>
                                <div id="qb-notes-preview">
                                    <div class="text-center italic mt-10" style="color: var(--text-muted);">Select an account.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal-overlay hidden">
        <div id="email-modal-content" class="modal-content bg-white" style="background-color: rgba(176, 182, 184, 1); border: 3px solid rgba(214, 221, 224, 1);">
            <div class="bg-gray-500 p-3 text-white font-bold text-lg text-center border-b-2 border-gray-300 flex justify-between items-center email-modal-header">
                <span>Action Email Screen</span>
                <button onclick="document.getElementById('email-modal').classList.add('hidden')" class="text-yellow-300 hover:text-white font-bold px-2">Close X</button>
            </div>
            <div class="email-grid">
                <div class="email-left">
                    <div class="email-inputs">
                        <div><label class="block text-white font-bold italic underline mb-1 text-sm">*To</label><input type="text" id="email-modal-to" class="w-full p-2 rounded border-2 border-gray-300 font-semibold text-green-700"></div>
                        <div><label class="block text-white font-bold italic underline mb-1 text-sm">*Subject</label><input type="text" id="email-modal-subject" class="w-full p-2 rounded border-2 border-gray-300 font-semibold text-green-700"></div>
                    </div>
                    <div class="email-body-container">
                        <label class="block text-white font-bold italic underline mb-1 text-sm">Email Body (Note)</label>
                        <textarea id="email-modal-body" oninput="window.updateEmailPreview()" class="w-full p-3 rounded border-2 border-gray-300 font-semibold text-green-700"></textarea>
                    </div>
                    <div class="email-footer text-center">
                         <p id="email-modal-instruction" class="text-red-800 font-bold text-xs mb-2">Review Preview.</p>
                         <button id="email-modal-btn" onclick="window.handleModalSend()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded shadow-lg w-full text-lg">Send Email</button>
                         <p id="email-limit-counter" class="text-xs text-gray-500 mt-1 font-mono"></p>
                    </div>
                </div>
                <div class="email-right h-full"><div id="email-modal-preview" class="email-preview-pane"></div></div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-content max-w-md p-0 overflow-hidden relative">
            <div class="bg-gradient-to-r from-blue-600 to-blue-400 h-24 relative">
                <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="px-6 pb-6 text-center">
                <div class="relative -mt-12 mb-4"><div class="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center text-4xl text-blue-500 shadow-lg border-4 border-white"><i class="fas fa-user"></i></div></div>
                <h3 id="popout-name" class="text-2xl font-bold text-gray-800">--</h3>
                <p id="popout-title" class="text-sm text-gray-500 mb-4 uppercase tracking-wide">--</p>
                <div class="grid grid-cols-2 gap-4 text-left bg-gray-50 p-4 rounded-lg text-sm border border-gray-100 mt-4">
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Department</span><span id="popout-department" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Location</span><span id="popout-location" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Manager</span><span id="popout-manager" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Secondary</span><span id="popout-secondary-manager" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Sr. Manager</span><span id="popout-sr-manager" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Supervisor</span><span id="popout-supervisor" class="font-semibold">--</span></div>
                    <div class="col-span-2 border-t pt-2 mt-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Gold Star</span><span id="popout-gold-star" class="font-bold text-yellow-600 flex items-center gap-2"><i class="fas fa-star text-yellow-400"></i> <span>--</span></span></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-modal" class="modal-overlay hidden"><div class="modal-content"><h3 class="text-lg font-bold mb-2">Admin</h3><input type="password" id="admin-password" class="mb-3" placeholder="Password"><div id="admin-rep-input" class="hidden mb-3"><input type="text" id="override-rep-name" placeholder="Rep Name"></div><div class="flex justify-end gap-2"><button onclick="window.closeAdminModal()" class="btn-secondary text-xs">Cancel</button><button onclick="window.checkAdminPassword()" id="admin-action-btn" class="btn-primary text-xs">Authenticate</button></div></div></div>
    <div id="notification-modal" class="modal-overlay hidden"><div class="modal-content text-center max-w-xs"><h3 id="notification-title" class="text-lg font-bold mb-2">Notice</h3><p id="notification-message" class="text-sm mb-4"></p><button onclick="window.closeNotification()" class="btn-primary w-full">OK</button></div></div>
    <div id="manager-feedback-modal" class="modal-overlay hidden" style="z-index: 70;"><div class="modal-content max-w-2xl border-t-4 border-red-500"><h3 class="font-bold mb-4">Manager Feedback</h3><div id="manager-feedback-content" class="p-4 rounded h-64 overflow-y-auto text-sm font-mono border" style="background-color: var(--bg-input); border-color: var(--border-color);"></div><button onclick="window.closeManagerFeedback()" class="btn-secondary w-full mt-4">Close</button></div></div>
    <div id="important-info-modal" class="modal-overlay hidden" style="z-index: 65;"><div class="modal-content max-w-2xl border-t-4 border-yellow-500"><h3 class="font-bold mb-4">Important Info</h3><div id="important-info-content" class="p-4 rounded h-64 overflow-y-auto text-sm font-mono border" style="background-color: var(--bg-input); border-color: var(--border-color);"></div><button onclick="window.closeImportantInfo()" class="btn-secondary w-full mt-4">Close</button></div></div>
    <div id="welcome-toast" class="fixed bottom-5 right-5 z-50 hidden transition-all duration-500 transform translate-y-full opacity-0"><div class="bg-white border-l-4 border-blue-500 shadow-2xl rounded p-4 max-w-xs"><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-blue-800">Welcome! ðŸš€</h4><button onclick="window.dismissWelcome()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><p class="text-xs text-gray-600 mb-2">1. Sign in<br>2. Click Refresh<br>3. Select Account</p><button onclick="window.dismissWelcome()" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded hover:bg-blue-200 w-full">Got it</button></div></div>

    <script>
        // CONFIG
        const msalConfig = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: "https://WB-DT.github.io/daytona-utility/" }, cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false } };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null;

        const GET_MY_RECORDS_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2d5cc7c0ffa34dcb87e6416df29b9acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8qFD-lNiuxDgafyu31UYZ8zzePJMRJ4wpUzLzbb9bMs";
        const PATCH_RECORD_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/774bb53ee87542e5825b46958f5bd55d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EbaJTl1gKlG8rjTn3ZmoLwUiQ430Sju1kWZYZ6hr0zE";
        const SALES_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a6f98d7dcf0434fa630e691778901bf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=me09n4bmICH84IIjEV0BDzCIeLfhoFdy5f7hB2AEDOw";
        const ACTION_BUTTON_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a2fa2c69f1d24a85a980599d21631808/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aSQ1J4-BFNxrOURAp3-8tCQwunP0JITYHZfWV5BbDYI";
        const SEND_EMAIL_FLOW_URL = ACTION_BUTTON_FLOW_URL; 
        
        const EMAIL_LIMIT_PER_HOUR = 100;

        const QB_NOTES_TEMPLATE = `Locations: \nNumber of employees: \nCurrent Vendors: \nFrequency of Orders: \nMonthly spend: \nAnyone involved: \nNext Order Expected: \nOPP: \n`;
        const STANDARD_ACTIONS = ['Help', 'No Opp', 'Close Account', 'Cadence'];
        const CUSTOM_FLOW_ACTIONS = ["Automotive", "Blizzard Water", "Category", "Chair Mat Contest", "Intro", "NONBUY", "NOVNoSales", "OCTNoSales"];
        const THEMES = [
            {name:'Modern',id:'modern',color:'#2563eb'},{name:'Midnight',id:'midnight',color:'#0f172a'},{name:'OLED',id:'oled',color:'#000000'},
            {name:'Forest',id:'forest',color:'#16a34a'},{name:'Ocean',id:'ocean',color:'#0ea5e9'},{name:'Sunset',id:'sunset',color:'#ea580c'},{name:'Cyberpunk',id:'cyber',color:'#d946ef'},
            {name:'Holiday Cheer',id:'holiday-cheer',color:'#dc2626'},{name:'Winter Wonderland',id:'winter',color:'#3b82f6'},{name:'Harvest',id:'harvest',color:'#d97706'}
        ];
        
        const IMG_10_OFF = "https://raw.githubusercontent.com/WB-DT/daytona-utility/refs/heads/main/WB%2010%20off.png";
        const IMG_15_OFF = "https://raw.githubusercontent.com/WB-DT/daytona-utility/refs/heads/main/WB%2015%20Off.png";
        const IMG_SIG = "https://raw.githubusercontent.com/WB-DT/daytona-utility/refs/heads/main/WB%20Cold%20and%20FLU.jpg";
        const IMG_CHAIR = "https://raw.githubusercontent.com/WB-DT/daytona-utility/refs/heads/main/WB%20Chair%20Mat.png"; 

        let currentThemeIdx=0, isEditMode=false, allRecords=[], currentSelectedRecord=null, currentRecordId=null, currentUserRepName=null, currentUserProfile=null;
        
        // --- HELPER FUNCTIONS (GLOBAL) ---
        window.getVal = function(obj, k) { return (obj && obj[k] != null) ? obj[k] : ''; }
        window.escapeHTML = function(str) { if (!str) return ''; return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'})[m]); }
        window.getElementValue = function(id) { const el=document.getElementById(id); return el ? (el.value?.trim()??el.textContent?.trim()??null) : null; }
        window.showNotification = function(t, m) { const el=document.getElementById('notification-modal'); if(el){ document.getElementById('notification-title').innerText=t; document.getElementById('notification-message').innerText=m; el.classList.remove('hidden'); } }
        window.closeNotification = function() { document.getElementById('notification-modal').classList.add('hidden'); }
        window.updateTheme = function(idx) { if(!THEMES[idx]) return; document.body.setAttribute('data-theme', THEMES[idx].id); }
        window.toggleThemeMenu = function() { const m=document.getElementById('theme-menu'); m.classList.toggle('show'); if(m.innerHTML.trim()===''){ THEMES.forEach((t,i)=>{ const d=document.createElement('div'); d.className='theme-option'; d.onclick=()=>{ window.updateTheme(i); document.getElementById('theme-menu').classList.remove('show'); }; d.innerHTML=`<div class="theme-swatch" style="background-color:${t.color}"></div><span>${t.name}</span>`; document.getElementById('theme-menu').appendChild(d); }); } }
        window.onclick = function(event) { if (!event.target.matches('#theme-toggle-btn') && !event.target.closest('#theme-toggle-btn')) { document.getElementById('theme-menu').classList.remove('show'); } }
        window.startClock = function() { setInterval(() => { const el = document.getElementById('clock-display'); if(el) el.innerText = new Date().toLocaleTimeString(); }, 1000); }
        window.checkFirstRun = function() { const last = localStorage.getItem('hasSeenWelcome_v4'); const now = new Date(); const cur = `${now.getFullYear()}-${now.getMonth()+1}`; if (last !== cur) { setTimeout(() => { const t = document.getElementById('welcome-toast'); if(t){ t.classList.remove('hidden'); setTimeout(()=>t.classList.add('show'),100);} }, 1500); } }
        window.dismissWelcome = function() { const t = document.getElementById('welcome-toast'); if(t) { t.classList.remove('show'); setTimeout(()=>t.classList.add('hidden'),500); } const now = new Date(); localStorage.setItem('hasSeenWelcome_v4', `${now.getFullYear()}-${now.getMonth()+1}`); }
        
        window.checkEmailRateLimit = function() {
             const now = Date.now();
             let timestamps = JSON.parse(localStorage.getItem('daytona_email_timestamps') || '[]');
             timestamps = timestamps.filter(ts => (now - ts) < 3600000);
             localStorage.setItem('daytona_email_timestamps', JSON.stringify(timestamps));
             
             const count = timestamps.length;
             const counterEl = document.getElementById('email-limit-counter');
             if(counterEl) counterEl.innerText = `Emails Sent (Last 1hr): ${count} / ${EMAIL_LIMIT_PER_HOUR}`;
             
             // UPDATE HEADER COUNTER
             const headerCounter = document.getElementById('header-email-counter');
             if(headerCounter) {
                 headerCounter.innerText = `Emails: ${count}/${EMAIL_LIMIT_PER_HOUR}`;
                 headerCounter.classList.remove('hidden');
                 if(count >= EMAIL_LIMIT_PER_HOUR) headerCounter.classList.add('text-red-600', 'font-bold');
                 else headerCounter.classList.remove('text-red-600', 'font-bold');
             }

             if (count >= EMAIL_LIMIT_PER_HOUR) return false;
             return true;
        }
        
        window.logEmailSent = function() {
             const now = Date.now();
             let timestamps = JSON.parse(localStorage.getItem('daytona_email_timestamps') || '[]');
             timestamps.push(now);
             localStorage.setItem('daytona_email_timestamps', JSON.stringify(timestamps));
             window.checkEmailRateLimit();
        }

        // --- AI SUMMARY GENERATION ---
        window.generateAiSummary = function(record) {
            const notes = getVal(record, 'cr714_qbnotes', '').trim();
            const mgrNotes = getVal(record, 'cr714_managernotes', '').trim();
            const impInfo = getVal(record, 'cr714_importantaccountinformation', '').trim();
            
            let summaryHtml = "";
            let summaryFound = false;

            if (impInfo) {
                summaryFound = true;
                summaryHtml += `<div class="ai-box ai-imp"><div class="ai-header text-red-700"><i class="fas fa-exclamation-triangle"></i> IMPORTANT INFO</div><div class="ai-body text-red-900">${escapeHTML(impInfo)}</div></div>`;
            }
            
            if (mgrNotes) {
                summaryFound = true;
                summaryHtml += `<div class="ai-box ai-mgr"><div class="ai-header text-green-700"><i class="fas fa-user-tie"></i> MANAGER FEEDBACK</div><div class="ai-body text-green-900">${escapeHTML(mgrNotes)}</div></div>`;
            }

            if (notes) {
                const qbLines = notes.split('\n').filter(line => line.trim() !== '------------------------------' && line.trim() !== '' && !line.includes('Modified On:') && !line.includes('Modified By:')).slice(0, 5);
                if (qbLines.length > 0) {
                    summaryFound = true;
                    const effectiveSummary = qbLines.join('\n'); 
                    summaryHtml += `<div class="ai-box ai-key"><div class="ai-header text-blue-700"><i class="fas fa-file-alt"></i> KEY ACCOUNT DATA</div><div class="ai-body text-blue-900">${escapeHTML(effectiveSummary)}</div></div>`;
                }
            }
            
            return summaryFound ? summaryHtml : "";
        }

        window.parseNotes = function(rawNotes) { 
            if (!rawNotes) return []; 
            let cleanRaw = rawNotes.replace(/\r\n/g, '\n');
            const rawEntries = cleanRaw.split(/[-]{5,}/).filter(s => s.trim().length > 0); 
            const parsed = []; 
            
            rawEntries.forEach(entry => { 
                const lines = entry.trim().split('\n'); 
                let date = "Unknown Date"; let author = "Unknown User"; let content = []; 
                lines.forEach(line => { 
                    if (line.toLowerCase().includes('modified on:')) { date = line.split(':')[1].trim().split(' ')[0]; } 
                    else if (line.toLowerCase().includes('modified by:')) { author = line.split(':')[1].trim(); } 
                    else { content.push(line); } 
                }); 
                let cleanContent = content.join('\n').trim(); 
                cleanContent = cleanContent.replace(/\n{3,}/g, '\n\n');
                if (cleanContent) parsed.push({ date, author, text: cleanContent }); 
            }); 
            return parsed; 
        }

        window.updateNotesPreview = function() {
            if(!currentSelectedRecord) return;
            const showAI = document.getElementById('show-ai-summary')?.checked; 
            const showNew = document.getElementById('show-new-note')?.checked; 
            const showPrev = document.getElementById('show-prev-note')?.checked; 
            const showMgr = document.getElementById('show-mgr-note')?.checked;
            const showImp = document.getElementById('show-imp-note')?.checked;
            
            const genVal = document.getElementById('qb-notes-input')?.value.replace(QB_NOTES_TEMPLATE, '').trim();
            const rentVal = document.getElementById('rental-notes-input')?.value.trim();

            let html = '';
            if(showAI) html += window.generateAiSummary(currentSelectedRecord);
            
            if(showNew && (genVal || rentVal)) {
                html += `<div class="ai-box ai-key" style="border-color: var(--accent-warning); background: var(--bg-input);"><div class="ai-header" style="color: var(--accent-warning);"><i class="fas fa-pencil-alt"></i> Draft Note Preview</div><div class="ai-body">`;
                if(genVal) html += `<div>${window.escapeHTML(genVal)}</div>`;
                if(genVal && rentVal) html += `<br><hr style="border-color:var(--border-color)"><br>`;
                if(rentVal) html += `<div><strong>RENTAL NOTE:</strong><br>${window.escapeHTML(rentVal)}</div>`;
                html += `</div></div>`;
            }
            
            if(showPrev) { 
                const history = window.parseNotes(currentSelectedRecord.cr714_qbnotes || ''); 
                history.forEach(item => { 
                    let cleanText = item.text.replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n');
                    html += `<details class="note-history"><summary><div class="flex items-center gap-2"><i class="fas fa-history text-blue-500"></i> <span class="font-mono font-bold">${window.escapeHTML(item.date)}</span></div><span class="text-gray-400 text-[10px] uppercase italic ml-1"><i class="fas fa-user-edit mr-1"></i>${window.escapeHTML(item.author)}</span></summary><pre>${window.escapeHTML(cleanText)}</pre></details>`; 
                }); 
            }

            if(showMgr && getVal(currentSelectedRecord, 'cr714_managernotes')) {
                 html += `<div class="ai-box ai-mgr"><div class="ai-header text-green-700"><i class="fas fa-user-tie"></i> MANAGER FEEDBACK</div><div class="ai-body text-green-900">${escapeHTML(getVal(currentSelectedRecord, 'cr714_managernotes'))}</div></div>`;
            }

            if(showImp && getVal(currentSelectedRecord, 'cr714_importantaccountinformation')) {
                 html += `<div class="ai-box ai-imp"><div class="ai-header text-red-700"><i class="fas fa-exclamation-triangle"></i> IMPORTANT INFO</div><div class="ai-body text-red-900">${escapeHTML(getVal(currentSelectedRecord, 'cr714_importantaccountinformation'))}</div></div>`;
            }
            
            document.getElementById('qb-notes-preview').innerHTML = html || '<div class="text-center text-muted italic mt-10">No content to display.</div>';
        }

        // SAFE PARSE HELPER
        window.safeJSONParse = function(str) {
            try {
                if (typeof str === 'object' && str !== null) return str;
                const parsed = JSON.parse(str);
                if (typeof parsed === 'string') return JSON.parse(parsed);
                return parsed;
            } catch (e) {
                console.warn("Parse warning:", e);
                return null;
            }
        };

        // --- MODAL FUNCTIONS ---
        window.showUserProfileCard = function() { 
            if(!currentUserProfile) return;
            const p = currentUserProfile;
            const get = (k, fallback = '--') => (p[k] !== undefined && p[k] !== null) ? p[k] : fallback;
            
            document.getElementById('popout-name').textContent = get('cr714_employeename', 'User');
            document.getElementById('popout-title').textContent = get('cr714_title@OData.Community.Display.V1.FormattedValue', 'Sales Rep');
            document.getElementById('popout-department').textContent = get('cr714_department@OData.Community.Display.V1.FormattedValue');
            document.getElementById('popout-location').textContent = get('cr714_location@OData.Community.Display.V1.FormattedValue');
            document.getElementById('popout-manager').textContent = get('cr714_managerassigned');
            document.getElementById('popout-secondary-manager').textContent = '--'; 
            document.getElementById('popout-sr-manager').textContent = get('cr714_srmanager');
            document.getElementById('popout-supervisor').textContent = '--'; 
            
            const gold = get('cr714_goldstarflag');
            document.getElementById('popout-gold-star').innerHTML = (gold === 'Y') ? `<i class="fas fa-star text-yellow-400"></i> Yes` : 'No';
            
            document.getElementById('profile-modal').classList.remove('hidden'); 
        }
        
        window.showManagerFeedback = function() { document.getElementById('manager-feedback-modal').classList.remove('hidden'); }
        window.closeManagerFeedback = function() { document.getElementById('manager-feedback-modal').classList.add('hidden'); }
        window.showImportantInfo = function() { document.getElementById('important-info-modal').classList.remove('hidden'); }
        window.closeImportantInfo = function() { document.getElementById('important-info-modal').classList.add('hidden'); }
        window.promptAdminLogin = function() { document.getElementById('admin-modal').classList.remove('hidden'); }
        window.closeAdminModal = function() { document.getElementById('admin-modal').classList.add('hidden'); }
        window.checkAdminPassword = function() { if(document.getElementById('admin-password').value === 'Jj#23242526') { document.getElementById('admin-rep-input').classList.remove('hidden'); document.getElementById('admin-action-btn').onclick = () => { currentUserRepName = document.getElementById('override-rep-name').value; window.closeAdminModal(); window.loadRecords(); }; document.getElementById('admin-action-btn').textContent = "Set Rep"; } }
        
        window.handleCustomReset = function() { 
            if(currentSelectedRecord) { window.populateForm(currentSelectedRecord); isEditMode = false; window.updateFormDisplayMode(); } 
        }
        window.toggleEditMode = function() { 
            if(currentSelectedRecord) { isEditMode = !isEditMode; window.updateFormDisplayMode(); } 
        }
        window.toggleNoteView = function(id) {
            const isChecked = document.getElementById(id).checked;
            if (id === 'show-prev-note' && isChecked) document.getElementById('show-ai-summary').checked = false;
            if (id === 'show-ai-summary' && isChecked) document.getElementById('show-prev-note').checked = false;
            window.updateNotesPreview();
        }
        window.insertTemplate = function() {
            const box = document.getElementById('qb-notes-input');
            if (!box.value) box.value = QB_NOTES_TEMPLATE;
            else box.value += "\n" + QB_NOTES_TEMPLATE;
            window.updateNotesPreview();
        }

        // --- MAIN LOGIC ---
        window.loadRecords = async function() {
            const list = document.getElementById('record-gallery-list'); 
            list.innerHTML = '<div class="loader">Loading...</div>'; 
            document.getElementById('global-loader').style.display = 'flex'; 
            document.getElementById('global-loader').style.opacity = '1'; 
            allRecords = [];
            try {
                const response = await fetch(GET_MY_RECORDS_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ repName: currentUserRepName }) });
                if (!response.ok) throw new Error(`Flow Error: ${response.status}`);
                const data = await response.json();
                
                if (data.accountList && Array.isArray(data.accountList)) {
                    allRecords = data.accountList;
                    if (data.userProfile) currentUserProfile = data.userProfile;
                } else if (Array.isArray(data)) { 
                    allRecords = data; 
                }
                
                document.getElementById('record-count').textContent = allRecords.length;
                const dropdown = document.getElementById('filter-action-dropdown');
                if(dropdown) {
                    const recordActions = new Set(allRecords.map(r => r.cr714_action).filter(Boolean));
                    const allActions = new Set([...STANDARD_ACTIONS, ...recordActions]);
                    dropdown.innerHTML = '<option value="">Filter: All Actions</option>';
                    allActions.forEach(a => dropdown.innerHTML += `<option value="${a}">${a}</option>`);
                    dropdown.disabled = false;
                }
                window.filterAndSortGallery();
                document.getElementById('global-loader').style.opacity = '0'; 
                setTimeout(()=>document.getElementById('global-loader').style.display='none', 500);
                window.checkEmailRateLimit(); // Update header on load
            } catch (e) { 
                console.error(e); 
                list.innerHTML = `<div class="p-4 text-red-600">Error: ${e.message}</div>`; 
                document.getElementById('global-loader').style.display='none'; 
            }
        }

        // --- MANUAL SALES TRIGGER (POLLING ENABLED) ---
        window.resetSalesUI = function() {
            document.getElementById('sales-content').classList.add('hidden');
            document.getElementById('sales-loader').classList.add('hidden');
            const ph = document.getElementById('sales-placeholder');
            ph.classList.remove('hidden');
            ph.innerHTML = `<button onclick="window.loadSalesData('${currentRecordId}')" class="btn-primary text-xs shadow-lg animate-pulse">Get Sales Snapshot</button>`;
        }

        async function fetchWithPolling(url, options) {
            let res = await fetch(url, options);
            if (res.status === 202) {
                const location = res.headers.get('location');
                if (!location) throw new Error("Async 202 received but no Location header found.");
                let retries = 0;
                while (retries < 20) {
                    await new Promise(r => setTimeout(r, 2000)); 
                    let pollRes = await fetch(location);
                    if (pollRes.status === 200) return pollRes; 
                    if (pollRes.status === 202) { retries++; continue; } 
                    throw new Error(`Polling failed with status ${pollRes.status}`);
                }
                throw new Error("Polling timed out.");
            }
            return res;
        }

        window.loadSalesData = async function(id) {
            const container = document.getElementById('sales-content');
            const loader = document.getElementById('sales-loader');
            const placeholder = document.getElementById('sales-placeholder');
            
            placeholder.classList.add('hidden'); 
            loader.classList.remove('hidden');   
            
            try {
                const res = await fetchWithPolling(SALES_DATA_FLOW_URL, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ text: id, accountId: id }) 
                });
                
                if(!res.ok) throw new Error(`Sales API Error: ${res.status}`);
                const json = await res.json();
                const root = json.body ? json.body : json;

                let salesData = [];
                if (root.salesByCategory) {
                    salesData = window.safeJSONParse(root.salesByCategory) || [];
                }

                if (root.customers) {
                    let custData = window.safeJSONParse(root.customers) || [];
                    if (Array.isArray(custData) && custData.length > 0) {
                        const cust = custData[0];
                        // SMART UPDATE: BACKFILL MISSING FIELDS
                        const nameField = document.getElementById('contact-name-most');
                        if (!nameField.value || nameField.value === 'Unknown Name') nameField.value = cust['[FullName_most]'] || cust['[FullName_latest]'] || '';
                        const phoneField = document.getElementById('contact-phone-primary');
                        if (!phoneField.value) phoneField.value = cust['[Phone]'] || '';
                        const emailField = document.getElementById('contact-email-most');
                        if (!emailField.value) emailField.value = cust['[Email_most]'] || cust['[Email_latest]'] || '';
                    }
                }
                
                // 3. RENDERING
                let total = 0;
                const list = document.getElementById('sales-category-list');
                list.innerHTML = '';
                
                if (salesData.length > 0) {
                    salesData.sort((a, b) => {
                        const valA = parseFloat(a["[Sales_Last3Months]"] || 0);
                        const valB = parseFloat(b["[Sales_Last3Months]"] || 0);
                        return valB - valA;
                    });

                    salesData.forEach(s => {
                        const amt = parseFloat(s["[Sales_Last3Months]"] || 0);
                        total += amt;
                        const name = s["DimItemIDitemtypegroup[ItemTypeGroupDescription]"] || "Unknown";
                        list.innerHTML += `<li class="flex justify-between border-b py-2 border-dashed" style="border-color: var(--border-color)"><span class="text-muted font-medium">${window.escapeHTML(name)}</span><span class="font-bold text-brand">$${amt.toFixed(2)}</span></li>`;
                    });
                    
                    document.getElementById('sales-ytd').innerText = `$${total.toFixed(2)}`;
                    container.classList.remove('hidden');
                } else {
                    document.getElementById('sales-ytd').innerText = "$0.00";
                    list.innerHTML = `<li class="text-center text-muted italic text-xs py-4">No sales found in the last 3 months.</li>`;
                    container.classList.remove('hidden');
                }

            } catch(e) { 
                console.error("Sales Load Error:", e); 
                placeholder.innerHTML = `<div class="text-red-500 font-bold">Error loading sales. <br><button onclick="window.loadSalesData('${id}')" class="underline mt-1">Retry</button></div>`;
                placeholder.classList.remove('hidden'); 
            } finally { 
                loader.classList.add('hidden'); 
            }
        }

        window.populateForm = function(rec) {
            if(!rec) return;
            document.getElementById('acct-number-header').innerText = rec.cr714_id || '--';
            document.getElementById('acct-company').innerText = rec.cr714_company || '--';
            document.getElementById('acct-action-message').innerText = rec.cr714_actionmessage || rec.cr714_action || '--';

            const fields = {'contact-name-most': 'cr714_namemost', 'contact-name-latest': 'cr714_namelatest', 'contact-phone-primary': 'cr714_primaryphone', 'contact-email-most': 'cr714_emailmost', 'contact-email-latest': 'cr714_emaillatest'};
            for(const [id, key] of Object.entries(fields)) { const el = document.getElementById(id); if(el) el.value = rec[key] || ''; }
            
            // --- NOTES LOGIC (FIXED: Clean Inputs) ---
            const notesInput = document.getElementById('qb-notes-input');
            const rentalInput = document.getElementById('rental-notes-input');
            
            notesInput.value = ""; 
            rentalInput.value = "";
            notesInput.placeholder = QB_NOTES_TEMPLATE;

            const fullHistory = rec.cr714_qbnotes || '';
            if (fullHistory) {
                const splitMarker = "------------------------------";
                const entries = fullHistory.split(splitMarker);
                const latestEntry = entries[0] || '';
                
                if (latestEntry.includes("*** RENTAL NOTE ***")) {
                    const rentParts = latestEntry.split("*** RENTAL NOTE ***");
                     if(rentParts[1]) {
                         rentalInput.value = rentParts[1].trim();
                     }
                }
            }

            const dd = document.getElementById('email-template-dropdown');
            dd.innerHTML = ""; 
            const defaultOptions = [{val: "Green Category.msg", txt: "Green Category"}, {val: "Green Follow Up Email.msg", txt: "Green Follow Up"}, {val: "Green Non-Buy Email.msg", txt: "Green Non-Buy"}, {val: "Yellow Non-Buy Email.msg", txt: "Yellow Non-Buy"}];
            if(rec.cr714_action === "Chair Mat Contest") dd.innerHTML = `<option value="Chair Mat Promo">Chair Mat Promo</option>`;
            else if(rec.cr714_action === "NONBUY") dd.innerHTML = `<option value="15% Off Coupon">15% Off Coupon</option>`;
            else if(rec.cr714_action === "NOVNoSales") dd.innerHTML = `<option value="10% Off Coupon">10% Off Coupon</option>`;
            else defaultOptions.forEach(o => dd.innerHTML += `<option value="${o.val}">${o.txt}</option>`);

            const dEl = document.getElementById('follow-up-date'), tEl = document.getElementById('follow-up-time');
            if(rec.cr714_followup) { const dt = new Date(rec.cr714_followup); if(!isNaN(dt)) { dEl.value = dt.toISOString().split('T')[0]; tEl.value = dt.toTimeString().substring(0,5); } else { dEl.value=''; tEl.value=''; } } else { dEl.value=''; tEl.value=''; }
            
            const mgrBtn = document.getElementById('btn-mgr-feedback');
            const impBtn = document.getElementById('btn-imp-info');
            
            const hasMgr = (rec.cr714_managernotes && rec.cr714_managernotes !== "null" && rec.cr714_managernotes.trim().length > 0);
            const hasImp = (rec.cr714_importantaccountinformation && rec.cr714_importantaccountinformation !== "null" && rec.cr714_importantaccountinformation.trim().length > 0);

            if (hasMgr) { 
                mgrBtn.classList.add('btn-has-data-red'); 
                document.getElementById('manager-feedback-content').innerText = rec.cr714_managernotes;
                document.getElementById('manager-feedback-modal').classList.remove('hidden'); 
            } else { 
                mgrBtn.classList.remove('btn-has-data-red'); 
                document.getElementById('manager-feedback-modal').classList.add('hidden');
            }

            if (hasImp) { 
                impBtn.classList.add('btn-has-data-yellow'); 
                document.getElementById('important-info-content').innerText = rec.cr714_importantaccountinformation; 
                if (!hasMgr) document.getElementById('important-info-modal').classList.remove('hidden');
            } else { 
                impBtn.classList.remove('btn-has-data-yellow'); 
                document.getElementById('important-info-modal').classList.add('hidden');
            }
            window.updateNotesPreview();
        }

        window.selectRecord = function(id) {
            currentRecordId = String(id);
            currentSelectedRecord = allRecords.find(r => String(r.cr714_id) === currentRecordId);
            const items = document.querySelectorAll('.gallery-item');
            items.forEach(item => { if(item.innerHTML.includes(id)) item.classList.add('is-selected'); else item.classList.remove('is-selected'); });
            if(currentSelectedRecord) { 
                window.populateForm(currentSelectedRecord); 
                window.resetSalesUI(); 
                isEditMode = true; 
                window.updateFormDisplayMode(); 
                
                setTimeout(() => {
                    const el = document.getElementById('qb-notes-input');
                    if(el && !el.disabled) el.focus();
                }, 50);
            }
        }

        window.filterAndSortGallery = function() {
            const search = window.getElementValue('search-bar')?.toLowerCase() || '';
            const sort = window.getElementValue('sort-dropdown') || 'company-asc';
            const filter = window.getElementValue('filter-action-dropdown') || '';
            const filterFollow = document.getElementById('filter-followup')?.checked;
            const filterNoNotes = document.getElementById('filter-nonotes')?.checked;
            const filterRequests = document.getElementById('filter-requests')?.checked;
            const filterNoRecent = document.getElementById('filter-norecent')?.checked;
            const filterNoRecent30 = document.getElementById('filter-norecent30')?.checked;

            let filtered = allRecords.filter(r => {
                if (!r.cr714_id) return false;
                if(filter && r.cr714_action !== filter) return false;
                if(filterFollow && !r.cr714_followup) return false;
                if(filterNoNotes && (r.cr714_qbnotes || '').trim() !== '') return false;
                if(filterRequests && !['Help','NoOpp','CloseAccount'].includes(r.cr714_action)) return false; 
                if(search && !JSON.stringify(r).toLowerCase().includes(search)) return false;
                if (filterNoRecent || filterNoRecent30) {
                    const threshold = filterNoRecent30 ? 30 : 14;
                    const notes = window.parseNotes(r.cr714_qbnotes || '');
                    if (notes.length > 0) {
                        const lastDate = new Date(notes[0].date);
                        if (!isNaN(lastDate)) {
                            const diffTime = Math.abs(new Date() - lastDate);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                            if (diffDays < threshold) return false;
                        }
                    }
                }
                return true;
            });
            filtered.sort((a, b) => {
                const get = (item, key) => (item[key] || '').toString().toLowerCase();
                if(sort.includes('company')) return sort === 'company-asc' ? get(a,'cr714_company').localeCompare(get(b,'cr714_company')) : get(b,'cr714_company').localeCompare(get(a,'cr714_company'));
                if(sort.includes('followup')) {
                    const da = a.cr714_followup ? new Date(a.cr714_followup) : new Date(sort === 'followup-asc' ? 8640000000000000 : -8640000000000000);
                    const db = b.cr714_followup ? new Date(b.cr714_followup) : new Date(sort === 'followup-asc' ? 8640000000000000 : -8640000000000000);
                    return sort === 'followup-asc' ? da - db : db - da;
                }
                if(sort.includes('days')) { const da = parseFloat(a.cr714_dayssincelastorder) || 0; const db = parseFloat(b.cr714_dayssincelastorder) || 0; return sort === 'days-asc' ? da - db : db - da; }
                if(sort.includes('rep')) return sort === 'rep-asc' ? get(a,'cr714_rep').localeCompare(get(b,'cr714_rep')) : get(b,'cr714_rep').localeCompare(get(a,'cr714_rep'));
                return 0;
            });
            const list = document.getElementById('record-gallery-list');
            list.innerHTML = '';
            document.getElementById('record-count').textContent = filtered.length;
            if(filtered.length === 0) { list.innerHTML = '<div class="loader">No records found.</div>'; return; }
            filtered.forEach(r => {
                const div = document.createElement('div');
                div.className = `gallery-item ${currentRecordId === String(r.cr714_id) ? 'is-selected' : ''}`;
                div.onclick = () => window.selectRecord(r.cr714_id);
                let followUpBadge = '';
                if(r.cr714_followup) { const d = new Date(r.cr714_followup); if(!isNaN(d)) followUpBadge = `<span class="gallery-item-followup"><i class="fas fa-clock mr-1"></i>${d.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>`; }
                let repDisplay = ''; const action = window.getVal(r, 'cr714_action'); if (action === 'Cadence') { repDisplay = `<span class="text-xs text-muted italic"><i class="fas fa-shield-alt mr-1"></i>Ret: ${window.escapeHTML(r.cr714_retentionrep)}</span>`; } else { repDisplay = `<span class="text-xs text-muted italic"><i class="fas fa-user mr-1"></i>Rep: ${window.escapeHTML(r.cr714_rep)}</span>`; }
                div.innerHTML = `<div class="flex justify-between items-start w-full"><span class="gallery-item-id">${r.cr714_id}</span>${followUpBadge}</div><div class="gallery-item-company">${window.escapeHTML(r.cr714_company)}</div>${repDisplay}`;
                list.appendChild(div);
            });
        }

        window.updateFormDisplayMode = function() {
            const btn = document.getElementById('editModeButton');
            const saveControls = document.getElementById('save-controls');
            if(btn) {
                btn.innerHTML = isEditMode ? '<i class="fas fa-eye"></i> View Profile' : '<i class="fas fa-pencil-alt"></i> Edit Profile';
                btn.disabled = !currentSelectedRecord;
                if (isEditMode) { btn.className = "py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold text-black bg-yellow-400 hover:bg-yellow-500"; } 
                else { btn.className = "py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold bg-gray-200 text-gray-700 hover:bg-gray-300"; }
            }
            if(saveControls) saveControls.style.display = isEditMode ? 'flex' : 'none';
            document.querySelectorAll('.editable-field, #follow-up-date, #follow-up-time').forEach(el => {
                el.disabled = !isEditMode;
                if(isEditMode) { el.removeAttribute('disabled'); el.classList.add('is-editable'); } else { el.setAttribute('disabled', 'true'); el.classList.remove('is-editable'); }
            });
            
            const noteInputs = ['qb-notes-input', 'rental-notes-input'];
            noteInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if(isEditMode) { el.removeAttribute('disabled'); el.classList.add('is-editable'); el.style.opacity = '1'; } 
                    else { el.setAttribute('disabled', 'true'); el.classList.remove('is-editable'); }
                }
            });

            ['launch-email-button', 'email-template-dropdown', 'help-button', 'noopp-button', 'close-button'].forEach(id => {
                const el = document.getElementById(id); if(el) el.disabled = !isEditMode;
            });
        }

        // --- CUSTOM SAVE HANDLER ---
        window.handleCustomSave = async function(customNoteText = null, suppressNotify = false) {
            let noteToSave = customNoteText;
            if (!noteToSave) { 
                // Gather inputs
                const genVal = document.getElementById('qb-notes-input').value.replace(QB_NOTES_TEMPLATE, '').trim();
                const rentVal = document.getElementById('rental-notes-input').value.trim();
                
                let combined = [];
                if(genVal) combined.push(genVal);
                if(rentVal) combined.push(`*** RENTAL NOTE ***\n${rentVal}`);
                
                noteToSave = combined.join('\n\n');
            }
            
            const fullNotes = (noteToSave ? `------------------------------\nModified On: ${new Date().toLocaleString()}\nModified By: ${currentUserRepName}\n\n${noteToSave}\n\n` : "") + (currentSelectedRecord.cr714_qbnotes || '');
            if(!isEditMode && !customNoteText) return;
            if (!suppressNotify) window.showNotification("Saving...", "Please wait...");
            
            let isoDate = null; 
            const d = document.getElementById('follow-up-date').value; 
            const t = document.getElementById('follow-up-time').value; 
            if(d) isoDate = t ? `${d}T${t}:00Z` : `${d}T00:00:00Z`;

            const payload = { 
                recordId: currentRecordId, 
                dataverseId: currentSelectedRecord.cr714_dataverseid, 
                qbNotes: fullNotes, 
                followUp: isoDate, 
                nameMost: document.getElementById('contact-name-most').value, 
                nameLatest: document.getElementById('contact-name-latest').value, 
                primaryPhone: document.getElementById('contact-phone-primary').value, 
                emailMost: document.getElementById('contact-email-most').value, 
                emailLatest: document.getElementById('contact-email-latest').value, 
                repName: currentUserRepName 
            };
            
            try { 
                const res = await fetch(PATCH_RECORD_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                if(!res.ok) throw new Error("Flow Error"); 
                if (!suppressNotify) window.showNotification("Success", "Saved!"); 
                
                // Update local model
                currentSelectedRecord.cr714_qbnotes = fullNotes; 
                currentSelectedRecord.cr714_followup = isoDate; 
                currentSelectedRecord.cr714_namemost = payload.nameMost; 
                currentSelectedRecord.cr714_namelatest = payload.nameLatest; 
                currentSelectedRecord.cr714_primaryphone = payload.primaryPhone; 
                currentSelectedRecord.cr714_emailmost = payload.emailMost; 
                currentSelectedRecord.cr714_emaillatest = payload.emailLatest; 
                
                isEditMode = false; 
                window.updateFormDisplayMode(); 
                window.updateNotesPreview(); 
                
                document.getElementById('qb-notes-input').value = QB_NOTES_TEMPLATE;
                document.getElementById('rental-notes-input').value = "";

            } catch(e) { window.showNotification("Error", e.message); }
        }
        
        // --- ACTION BUTTONS (Explicitly on Window) ---
        window.handleActionButtonClick = async function(type) {
             if(!currentSelectedRecord) return;
             if(type === 'LaunchEmail') { window.launchEmailLogic(); return; }
             window.showNotification("Processing...", `Sending ${type}...`);
             const notes = window.getElementValue('qb-notes-input').replace(QB_NOTES_TEMPLATE, '').trim();
             const data = { recordId: currentRecordId, action: type, notes: notes, repName: currentUserRepName, dataverseId: currentSelectedRecord.cr714_dataverseid };
             try {
                 const res = await fetch(ACTION_BUTTON_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                 if(!res.ok) throw new Error("Action Error");
                 window.showNotification("Success", `${type} Completed.`);
             } catch(e) { window.showNotification("Error", e.message); }
        }

        // --- HYBRID EMAIL LOGIC (Fully Restored & Global) ---
        window.launchEmailLogic = function() {
            if (!currentSelectedRecord) { window.showNotification("Error", "Select a record first."); return; }
            if (!window.checkEmailRateLimit()) { window.showNotification("Rate Limit Reached", "Limit reached."); return; }
            const action = currentSelectedRecord.cr714_action;
            const templateVal = document.getElementById('email-template-dropdown').value;
            const email = currentSelectedRecord.cr714_emaillatest || currentSelectedRecord.cr714_emailmost || "";
            const accName = currentSelectedRecord.cr714_company;
            const accNum = currentSelectedRecord.cr714_id;
            
            let subject = ""; let body = ""; let btnText = ""; let instruction = ""; let mode = "";

            if (CUSTOM_FLOW_ACTIONS.includes(action)) {
                 mode = "FLOW"; btnText = "Send via Flow";
                 instruction = "Review Preview. Images will be included automatically.";
                 if (action === "Chair Mat Contest") {
                    subject = `${accNum} - A Promo That Matters`;
                    body = `I wanted to reach out as it looks like youâ€™ve purchased a chair with us recently. Are you in need of a chair mat for your office?\n\nPlease see attached link for both carpeted and hardwood options: Shop Chair Mats | W.B. Mason.\n\nIâ€™m happy to help narrow down selections and help search for what will best fit your business needs. Let me know how I can assist!`;
                 } else if (action === "NONBUY") {
                    subject = "WB Mason - 15% Off";
                    body = `Iâ€™m reaching out to see if thereâ€™s anything you need before the end of the month. I didnâ€™t see you placed any orders recently.\n\nI just received a coupon you can use through the end of the month!`;
                 } else if (action === "NOVNoSales") {
                    subject = "WB Mason - 10% Off";
                    body = `Iâ€™m reaching out to see if thereâ€™s anything you need before the end of the month. I didnâ€™t see you placed any orders recently.\n\nI just received a coupon you can use through the end of the month!`;
                 }
            } else {
                mode = "LOCAL"; btnText = "Open in Outlook";
                instruction = "Opens local email client. Images cannot be auto-embedded.";
                subject = `It's ${currentUserRepName} with WB Mason--ACC# ${accNum} // ${accName}`;
                if (templateVal === "Green Category.msg") { body = `Good Morning/Afternoon,\n\nThank you for speaking with me today. I will be on the lookout for your order confirmations.\nWhile I wait, I want to show you a quick view of some of the pricing we offer for items you buy.\nLet me know if you are getting different items or better pricing elsewhere.\n\n[INSERT IMAGE OF CATEGORY HERE]\n`; }
                else if (templateVal === "Green Follow Up Email.msg") { body = `Good Morning/Afternoon!\n\nI was unable to reach you today. When we spoke, you stated that you would review my email and provide a list of items you are purchasing from my competitors for us to quote.\nI have not heard from you and wanted to follow up on this to see if you have gotten the chance to review.\n\nWill you be able to send over items to quote before your next office supply order so you can start saving sooner than later?\n\nWhen can I expect to see that list to get started on your savings?`; }
                else if (templateVal.includes("Non-Buy")) { subject = `WB Mason, Price Match Program--${accNum} // ${accName}`; body = `Good morning/afternoon!\n\nThank you for speaking with me today. It is my responsibility as a part of the retention department to deliver the best experience possible for our customers.\n\nI would like for W.B Mason to be a one-stop-shop for all your business needs.\nBefore your next order with my competitor, send me any recent order confirmations or their shopping cart from them and I will at least match any pricing if I am not already lower.\n\nJust for the opportunity to show you better pricing on the items you buy from my competitors, we will be giving you 15% off your next order of those items.\n\nWith that said, what would be a good date and time to connect with you regarding your account?`; }
            }

            document.getElementById('email-modal-to').value = email;
            document.getElementById('email-modal-subject').value = subject;
            document.getElementById('email-modal-body').value = body; 
            document.getElementById('email-modal-btn').innerText = btnText;
            document.getElementById('email-modal-btn').dataset.mode = mode;
            document.getElementById('email-modal-instruction').innerText = instruction;
            
            document.getElementById('email-modal').classList.remove('hidden');
            window.updateEmailPreview();
            window.checkEmailRateLimit();
        }

        window.handleModalSend = function() {
            if (!window.checkEmailRateLimit()) { window.showNotification("Rate Limit Reached", "Limit reached."); return; }
            const mode = document.getElementById('email-modal-btn').dataset.mode;
            if (mode === "FLOW") window.sendCustomEmailViaFlow();
            else window.sendLocalEmail();
        }

        window.updateEmailPreview = function() {
            const to = document.getElementById('email-modal-to').value;
            const sub = document.getElementById('email-modal-subject').value;
            const bodyNote = document.getElementById('email-modal-body').value.replace(/\n/g, "<br>");
            const action = currentSelectedRecord ? currentSelectedRecord.cr714_action : "";
            const accName = currentSelectedRecord ? currentSelectedRecord.cr714_company : "";
            
            let html = `<div style="font-family: 'Segoe UI', sans-serif; color: #1f2937; line-height: 1.4;">`;
            html += `<div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">`;
            html += `<p style="color:green; font-weight:bold;">TO: ${window.escapeHTML(to)}</p>`;
            html += `<p style="color:green; font-weight:bold;">Subject: ${window.escapeHTML(sub)}</p>`;
            html += `<p>Hi <span style="color:green; font-weight:bold;">${window.escapeHTML(accName)}</span>,</p>`;
            html += `</div>`;
            
            if (CUSTOM_FLOW_ACTIONS.includes(action)) { html += `<p style="color:dodgerblue; font-size:12px; font-weight:bold;">Custom Email Notes will be placed here:</p>`; }
            html += `<div style="color:black; font-weight:normal; margin: 10px 0;">${bodyNote}</div>`;
            
            if(action === "Chair Mat Contest") html += `<div style="text-align:center; margin:10px;"><a href="https://www.wbmason.com/shop?q=everlife" target="_blank"><img src="${IMG_CHAIR}" style="max-width:100%;"></a></div>`;
            if(action === "NONBUY") html += `<div style="text-align:center; margin:10px;"><a href="http://www.wbmason.com/" target="_blank"><img src="${IMG_15_OFF}" style="max-width:100%;"></a></div>`;
            if(action === "NOVNoSales") html += `<div style="text-align:center; margin:10px;"><a href="http://www.wbmason.com/" target="_blank"><img src="${IMG_10_OFF}" style="max-width:100%;"></a></div>`;

            html += `<div style="margin-top:20px; font-size:14px; border-top: 1px solid #eee; padding-top: 10px;">`;
            html += `Thank you,<br><b>${currentUserRepName}</b> | W.B. MASON CO, INC.<br>`;
            html += `Email: ${msalAccount ? msalAccount.username : ''} | <a href="https://www.wbmason.com" style="color:#0b66c3;">www.wbmason.com</a>`;
            html += `<div style="margin-top:10px;"><a href="http://whobut.wbmason.com/" target="_blank"><img src="${IMG_SIG}" style="max-width:100%;"></a></div></div></div>`;
            document.getElementById('email-modal-preview').innerHTML = html;
        }

        window.sendCustomEmailViaFlow = async function() {
            window.showNotification("Sending...", "Dispatching via Flow...");
            const action = currentSelectedRecord.cr714_action;
            const bodyText = document.getElementById('email-modal-body').value.replace(/\n/g, "<br>");
            const accName = currentSelectedRecord.cr714_company;
            let imgTag = "";
            if(action === "Chair Mat Contest") imgTag = `<br><a href="https://www.wbmason.com/shop?q=everlife"><img src="${IMG_CHAIR}"></a><br>`;
            if(action === "NONBUY") imgTag = `<br><a href="http://www.wbmason.com/"><img src="${IMG_15_OFF}"></a><br>`;
            if(action === "NOVNoSales") imgTag = `<br><a href="http://www.wbmason.com/"><img src="${IMG_10_OFF}"></a><br>`;
            
            const fullHtmlBody = `Hi <b>${accName}</b>,<br><br>${bodyText}${imgTag}<br><br>Thank you,<br>${currentUserRepName}<br><a href="http://whobut.wbmason.com/"><img src="${IMG_SIG}"></a>`;

            const payload = { action: action, to: document.getElementById('email-modal-to').value, subject: document.getElementById('email-modal-subject').value, body: fullHtmlBody, repEmail: msalAccount ? msalAccount.username : '', recordId: currentRecordId };
            try {
                const res = await fetch(SEND_EMAIL_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error("Email Flow Error");
                window.logEmailSent(); document.getElementById('email-modal').classList.add('hidden');
                window.showNotification("Success", "Email Sent via Flow!");
                window.handleCustomSave(`Action Email Sent (Flow).\nSubject: ${payload.subject}`, true);
            } catch(e) { window.showNotification("Error", e.message); }
        }

        window.sendLocalEmail = function() {
            const to = document.getElementById('email-modal-to').value;
            const sub = document.getElementById('email-modal-subject').value;
            const body = document.getElementById('email-modal-body').value;
            window.location.href = `mailto:${to}?subject=${encodeURIComponent(sub)}&body=${encodeURIComponent(body)}`;
            window.logEmailSent();
            const noteText = `Action Email Launched via Utility.\nSubject: ${sub}`;
            window.handleCustomSave(noteText, true);
            document.getElementById('email-modal').classList.add('hidden');
        }

        window.login = function() { msalInstance.loginPopup({ scopes: ["User.Read"] }).then(window.handleMsalResponse).catch(e => { console.error(e); document.getElementById('login-error').textContent = "Login Failed. Check console."; document.getElementById('login-error').classList.remove('hidden'); }); }
        window.handleMsalResponse = function(resp) { if(resp && resp.account) { msalAccount = resp.account; currentUserRepName = msalAccount.name; window.initializeApp(); } }
        window.initializeApp = function() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');
            document.getElementById('welcome-message').textContent = `Hi, ${currentUserRepName.split(' ')[0]}`;
            document.getElementById('welcome-message').classList.remove('hidden');
            document.getElementById('qb-notes-input').placeholder = QB_NOTES_TEMPLATE;
            window.startClock();
            window.loadRecords(); 
            window.checkFirstRun();
            setTimeout(() => { const l = document.getElementById('global-loader'); if(l) { l.style.opacity = '0'; setTimeout(()=>l.style.display='none', 500); } }, 3000);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            window.updateTheme(0);
            msalInstance.handleRedirectPromise().then(resp => {
                if (resp && resp.account) { window.handleMsalResponse(resp); } 
                else {
                    const accs = msalInstance.getAllAccounts();
                    if(accs.length > 0) { msalAccount = accs[0]; currentUserRepName = msalAccount.name; window.initializeApp(); } 
                    else { document.getElementById('global-loader').style.display = 'none'; document.getElementById('login-container').classList.remove('hidden'); }
                }
            }).catch(e => { console.error(e); document.getElementById('global-loader').style.display = 'none'; document.getElementById('login-container').classList.remove('hidden'); document.getElementById('login-error').textContent = "Auth Error: " + e.message; document.getElementById('login-error').classList.remove('hidden'); });
        });
    </script>
</body>
</html>
