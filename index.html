<script>
        // --- MSAL CONFIG (Needs to be filled in by you) ---
        /* * !!! START OF REQUIRED CHANGES !!!
         * The application is now FULLY configured with your Azure/Flow URLs.
         */
        const msalConfig = {
            auth: {
                // --- 1. PASTE YOUR 'Application (client) ID' FROM AZURE AD HERE ---
                clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", // <-- UPDATED
                
                // --- 2. PASTE YOUR 'Directory (tenant) ID' FROM AZURE AD HERE ---
                authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", // <-- UPDATED
                
                // --- 3. PASTE YOUR HOSTING URL HERE (e.g., your GitHub Pages URL) ---
                redirectUri: "https://WB-DT.github.io/daytona-utility/" // <-- UPDATED
            },
            // !!! END OF REQUIRED CHANGES !!!
            cache: {
                cacheLocation: "localStorage", 
                storeAuthStateInCookie: false,
            }
        };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null; 
        let msalToken = null; 

        // --- GLOBAL APP STATE ---
        let isEditMode = false;
        let allRecords = [];
        let currentSelectedRecord = null;
        let currentRecordId = null;
        let currentUserRepName = null;
        let clockInterval = null;
        const ANNOUNCEMENT_DISMISSED_KEY = 'announcementDismissed_v5';
        const QB_NOTES_TEMPLATE = `Locations: \nNumber of employees: \nCurrent Vendors: \nFrequency of Orders: \nMonthly spend: \nAnyone involved: \nNext Order Expected: \nOPP: \n`;
        
        // --- FLOW URLS (ALL FINALIZED) ---
        // These Flows must be secured with AAD token bearing the low-privilege User.Read scope.
        const GET_MY_RECORDS_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2d5cc7c0ffa34dcb87e6416df29b9acf/triggers/manual/paths/invoke?api-version=1";
        const PATCH_RECORD_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/774bb53ee87542e5825b46958f5bd55d/triggers/manual/paths/invoke?api-version=1";
        const SALES_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a6f98d7dcf0434fa630e691778901bf/triggers/manual/paths/invoke?api-version=1";
        const ACTION_BUTTON_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a2fa2c69f1d24a85a980599d21631808/triggers/manual/paths/invoke?api-version=1";

        // Utility: Placeholder check is now fully bypassed by setting the scopes below.
        function hasPlaceholderConfig() {
            return false;
        }

        // --- HELPER FUNCTIONS (Placed at top for proper scope/initialization) ---
        const getVal = (obj, key, defaultVal = '') => (obj && obj[key] != null) ? obj[key] : defaultVal;
        const escapeHTML = (str) => { if (!str) return ''; return String(str).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'})[m]); };
        function getElementValue(id) { const el=document.getElementById(id); if(!el){console.warn(`! Missing ${id}`); return null;} return el.value?.trim()??el.textContent?.trim()??null; }
        
        // --- SALES DATA UTILITY FUNCTIONS (Must be defined before use in init) ---
        function resetSalesDisplay() {
            const placeholder = document.getElementById('sales-placeholder');
            const content = document.getElementById('sales-content');
            const loader = document.getElementById('sales-loader');
            
            if (placeholder) {
                placeholder.style.display = 'block';
                placeholder.textContent = 'Select an account';
                placeholder.classList.remove('text-red-600');
            }
            if (content) content.style.display = 'none';
            if (loader) loader.style.display = 'none';
            
            ['sales-ytd', 'sales-total-orders', 'sales-last-order'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '--';
            });
            
            const categoryList = document.getElementById('sales-category-list');
            if (categoryList) categoryList.innerHTML = '<li class="sales-category-item italic text-gray-400">No data</li>';
        }

        function displaySalesData(data) {
            const placeholder = document.getElementById('sales-placeholder');
            const content = document.getElementById('sales-content');
            const categoryList = document.getElementById('sales-category-list');
            
            if (!data) {
                resetSalesDisplay();
                if (placeholder) placeholder.textContent = 'No sales data available.';
                return;
            }
            
            try {
                ['sales-ytd', 'sales-total-orders', 'sales-last-order'].forEach(id => {
                    const el = document.getElementById(id);
                    const key = id.replace('sales-', '').replace('total-orders', 'orderCount').replace('last-order', 'lastOrderDate').replace('ytd', 'ytdSales');
                    if (el) el.textContent = getVal(data, key, '--');
                });
                
                if (categoryList) {
                    categoryList.innerHTML = ''; // Clear default
                    const categories = data.categories;
                    if (Array.isArray(categories) && categories.length > 0) {
                        categories.forEach(cat => {
                            const li = document.createElement('li');
                            li.className = 'sales-category-item';
                            li.innerHTML = `
                                <span class="sales-category-name truncate pr-2" title="${escapeHTML(getVal(cat, 'categoryName'))}">${escapeHTML(getVal(cat, 'categoryName', 'N/A'))}</span>
                                <span class="sales-category-amount">${escapeHTML(getVal(cat, 'categorySales', '--'))}</span>
                            `;
                            categoryList.appendChild(li);
                        });
                    } else {
                        categoryList.innerHTML = '<li class="sales-category-item italic text-gray-400">No category data</li>';
                    }
                }
                
                if (placeholder) placeholder.style.display = 'none';
                if (content) content.style.display = 'block';
            } catch (e) {
                console.error("LIVE: Error displaying sales data:", e);
                resetSalesDisplay();
                if (placeholder) {
                    placeholder.style.display = 'block';
                    placeholder.textContent = 'Error displaying sales data.';
                    placeholder.classList.add('text-red-600');
                }
            }
        }

        async function loadSalesData(recordId) {
            console.log("LIVE: loadSalesData for:", recordId);
            if (!recordId) { resetSalesDisplay(); return; }
            
            const token = await getFlowToken();
            if (!token) return; // Error was already shown

            const placeholder = document.getElementById('sales-placeholder');
            const content = document.getElementById('sales-content');
            const loader = document.getElementById('sales-loader');
            
            if (placeholder) placeholder.style.display = 'none';
            if (content) content.style.display = 'none';
            if (loader) loader.style.display = 'flex';
            
            const categoryList = document.getElementById('sales-category-list');
            if (categoryList) categoryList.innerHTML = ''; // Clear old categories
            
            try {
                let data;
                if (SALES_DATA_FLOW_URL === "YOUR_NEW_SALES_DATA_FLOW_URL" || !SALES_DATA_FLOW_URL) {
                    console.warn("LIVE: Mock Sales Data. No Flow URL provided.");
                    await new Promise(r => setTimeout(r, 500)); // Simulate network delay
                    data = { ytdSales: "$1,234.56", orderCount: "12", lastOrderDate: "2025-10-15", categories: [ { categoryName: "Supplies", categorySales: "$500.10" }, { categoryName: "Equipment", categorySales: "$734.46" } ] };
                } else {
                    const response = await fetch(SALES_DATA_FLOW_URL, {
                        method: 'POST',
                        // --- SECURITY: Add AAD Token ---
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ accountId: recordId })
                    });
                    if (response.status === 401) {
                        throw new Error("Unauthorized. You may not have permission to run this Flow.");
                    }
                    if (!response.ok) throw new Error(`Sales Flow Error: ${response.status} ${response.statusText}`);
                    data = await response.json();
                }
                displaySalesData(data);
            } catch (e) {
                console.error("LIVE: Error loading sales data:", e);
                if (placeholder) {
                    placeholder.style.display = 'block';
                    placeholder.textContent = 'Error loading sales data.';
                    placeholder.classList.add('text-red-600');
                }
                showNotification("Sales Data Error", `Could not load sales data: ${e.message}`);
            } finally {
                if (loader) loader.style.display = 'none';
            }
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG: DOM Loaded. v4.0 (Standalone).");
            // Validate configuration early and warn if still using placeholders
            if (hasPlaceholderConfig()) {
                console.warn("Configuration placeholders detected. Please update msalConfig and Flow URLs before attempting to authenticate.");
                showNotification('Configuration Required', 'This app contains placeholder Azure/Flow configuration values. Replace them in the top of the file before attempting authentication. Check console for details.');
            }
            msalInstance.handleRedirectPromise().then(handleMsalResponse).catch(err => {
                console.error("MSAL redirect error:", err);
                showLoginError("Error during login redirect. See console.");
            });

            // Try to get a user from cache
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                msalAccount = accounts[0];
                currentUserRepName = msalAccount.name;
                initializeAppUI();
            } else {
                // No user cached, login screen is shown by default
                console.log("DEBUG: No cached user found. Showing login screen.");
            }
        });

        // --- AUTHENTICATION FUNCTIONS ---
        function login() {
            document.getElementById('login-button').disabled = true;
            document.getElementById('login-button').textContent = "Signing in...";
            msalInstance.loginPopup({
                scopes: ["User.Read"] // Basic scope to read user profile
            }).then(handleMsalResponse).catch(err => {
                console.error("MSAL login error:", err);
                showLoginError("Login failed. Please try again.");
            });
        }

        function handleMsalResponse(response) {
            if (response !== null) {
                msalAccount = response.account;
                currentUserRepName = msalAccount.name;
                initializeAppUI();
            }
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('login-error');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
            const loginBtn = document.getElementById('login-button');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fab fa-microsoft mr-3"></i> Sign in with Microsoft';
            }
        }

        // --- NEW: Token Acquisition ---
        async function getFlowToken() {
            if (!msalAccount) {
                console.error("Not logged in!");
                showNotification("Error", "You are not logged in.");
                return null;
            }
            
            /* FIX: Reverting to the custom API scope. This is the required scope 
               that the Flow security is looking for. */
            const tokenRequest = {
                scopes: ["api://afe649b6-9c70-4b1a-8592-78588284c8ee/.default"],
                account: msalAccount
            };

            // Guard: if tokenRequest still contains a placeholder, bail out with a helpful message
            if (hasPlaceholderConfig()) {
                console.error('Configuration placeholders detected. Cannot request token.');
                showNotification('Configuration Missing', 'Update the Flow App ID URI in getFlowToken() before testing.');
                return null;
            }

            try {
                const response = await msalInstance.acquireTokenSilent(tokenRequest);
                msalToken = response.accessToken;
                return msalToken;
            } catch (error) {
                // If silent fails, try popup (e.g., expired token, new permissions)
                try {
                    const response = await msalInstance.acquireTokenPopup(tokenRequest);
                    msalToken = response.accessToken;
                    return msalToken;
                } catch (popupError) {
                    console.error("Failed to acquire token:", popupError);
                    showNotification("Auth Error", "Could not get authentication token to call Flow. This confirms Admin Consent is missing for the custom API scope.");
                    return null;
                }
            }
        }

        // Main app initialization function
        function initializeAppUI() {
            console.log(`DEBUG: Initializing main app for ${currentUserRepName}`);
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');

            const welcomeMsg = document.getElementById('welcome-message');
            if (welcomeMsg) {
                welcomeMsg.textContent = `Welcome, ${currentUserRepName}`;
                welcomeMsg.classList.remove('hidden');
            }

            // Init UI, but don't load records yet
            updateFormDisplayMode(); 
            showFormContent(false); 
            setInitialAnnouncementState(); 
            resetSalesDisplay(); 
            startClock();
            console.log("DEBUG: App UI Initialized.");
        }

        // --- DATA LOADING & GALLERY (Live Data) ---
        async function loadRecords() {
            console.log(`LIVE: loadRecords called for ${currentUserRepName}`);
            
            const token = await getFlowToken();
            if (!token) return; // Error was already shown

            showGalleryLoader(true);
            allRecords = [];
            currentSelectedRecord = null;
            currentRecordId = null;
            showFormContent(false);
            resetSalesDisplay();
            
            try {
                if (GET_MY_RECORDS_FLOW_URL === "YOUR_GET_MY_RECORDS_FLOW_URL") {
                    console.warn("LIVE: Mock Data. No Flow URL provided.");
                    await new Promise(r => setTimeout(r, 300));
                    allRecords = mockRecords;
                } else {
                    console.log("LIVE: Fetching data from Flow:", GET_MY_RECORDS_FLOW_URL);
                    const response = await fetch(GET_MY_RECORDS_FLOW_URL, { 
                        method: 'POST',
                        // --- SECURITY: Send the AAD Token ---
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        // The Flow gets the user name from the token,
                        // but we pass the RepName explicitly for the Filter.
                        body: JSON.stringify({ repName: currentUserRepName })
                    });
                    if (response.status === 401) {
                        throw new Error("Unauthorized. You may not have permission to run this Flow.");
                    }
                    if (!response.ok) {
                        throw new Error(`Flow Error: ${response.status} ${response.statusText}`);
                    }
                    allRecords = await response.json(); 
                }

                console.log(`LIVE: Loaded ${allRecords.length} records.`);
                filterAndSortGallery();
                populateActionFilter(allRecords, 'filter-action-dropdown');
            } catch (e) {
                console.error("LIVE: Error loading records:", e);
                const galleryList = document.getElementById('record-gallery-list');
                if (galleryList) galleryList.innerHTML = `<div class="loader-container"><p class="text-red-600 italic">Error loading records. Check console.</p></div>`;
                showNotification("Data Error", `Failed to load records: ${e.message}.`);
            } finally {
                showGalleryLoader(false);
                console.log("LIVE: loadRecords finished.");
            }
        }
        
        function showGalleryLoader(isLoading) {
            const loader = document.getElementById('gallery-loader');
            const galleryList = document.getElementById('record-gallery-list');
            if (loader) loader.style.display = isLoading ? 'flex' : 'none';
            if (galleryList) galleryList.style.display = isLoading ? 'none' : 'flex';
            if (isLoading && galleryList) galleryList.innerHTML = ''; // Clear list while loading
        }
        
        function renderGallery(recordsToRender) {
            console.log(`LIVE: renderGallery called with ${recordsToRender?.length ?? 0} records.`);
            const galleryList = document.getElementById('record-gallery-list');
            if (!galleryList) { console.error("LIVE: CRITICAL - Gallery list container not found!"); return; }
            galleryList.innerHTML = ''; // Clear previous items
            try {
                if (!Array.isArray(recordsToRender) || recordsToRender.length === 0) {
                    galleryList.innerHTML = `<div class="loader-container"><p class="text-gray-500 italic">No records match your criteria.</p></div>`;
                    return;
                }
                
                recordsToRender.forEach((record) => {
                    const item = document.createElement('button');
                    const id = String(getVal(record, 'cr714_id'));
                    const company = getVal(record, 'cr714_company', 'No Company');
                    const rep = getVal(record, 'cr714_accountrep') || getVal(record, 'cr714_retentionrep', 'No Rep');

                    item.className = "gallery-item";
                    item.setAttribute('data-id', id);
                    item.onclick = () => selectRecord(id);
                    
                    item.innerHTML = `
                        <span class="block font-bold text-sm gallery-item-id truncate" title="Acc #: ${escapeHTML(id)}">${escapeHTML(id)}</span>
                        <span class="block font-medium text-xs gallery-item-company truncate" title="${escapeHTML(company)}">${escapeHTML(company)}</span>
                        <span class="block text-xs gallery-item-rep truncate" title="Rep: ${escapeHTML(rep)}">${escapeHTML(rep)}</span>
                    `;
                    
                    galleryList.appendChild(item);
                    if (currentRecordId === id) item.classList.add('is-selected');
                });
            } catch (e) {
                console.error("LIVE: Error during renderGallery loop:", e);
                galleryList.innerHTML = `<div class="loader-container"><p class="text-red-500 italic">Error displaying records.</p></div>`;
            } finally {
                showGalleryLoader(false);
            }
        }

        function populateActionFilter(records, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            try {
                const actions = new Set(records.map(r => getVal(r, 'cr714_action')).filter(Boolean));
                if (actions.size > 0) {
                    dropdown.innerHTML = '<option value="">Filter: All Actions</option>';
                    actions.forEach(action => {
                        dropdown.innerHTML += `<option value="${escapeHTML(action)}">${escapeHTML(action)}</option>`;
                    });
                    dropdown.disabled = false;
                } else {
                    dropdown.innerHTML = '<option value="">No Actions to Filter</option>';
                    dropdown.disabled = true;
                }
            } catch (e) {
                console.error("Error populating action filter:", e);
                dropdown.innerHTML = '<option value="">Filter Error</option>';
                dropdown.disabled = true;
            }
        }
        
        function filterAndSortGallery() {
            console.log("LIVE: filterAndSort.");
            const searchValue = getElementValue('search-bar')?.toLowerCase() || '';
            const sortValue = getElementValue('sort-dropdown') || 'company-asc';
            const filterValue = getElementValue('filter-action-dropdown') || ''; 
            // NEW: Get filter checkbox values
            const filterFollowUp = document.getElementById('filter-followup')?.checked || false;
            const filterNoNotes = document.getElementById('filter-nonotes')?.checked || false;
            const filterRequests = document.getElementById('filter-requests')?.checked || false;
            
            if (!Array.isArray(allRecords)) {
                console.warn("LIVE: allRecords is not an array during filter/sort.");
                renderGallery([]);
                return;
            }
            
            let filtered = allRecords.filter(record => 
                filterRecordPredicate(record, searchValue) &&
                (filterValue === '' || getVal(record, 'cr714_action') === filterValue) &&
                // NEW: Apply checkbox filters
                (!filterFollowUp || (getVal(record, 'cr714_followup') || '').trim() !== '') &&
                (!filterNoNotes || (getVal(record, 'cr714_qbnotes') || '').trim() === '') &&
                (!filterRequests || (getVal(record, 'cr714_recordviability') || '').trim() !== '')
            );
            
            filtered.sort((a, b) => {
                const cA = getVal(a, 'cr714_company', '').toLowerCase();
                const cB = getVal(b, 'cr714_company', '').toLowerCase();
                const dA = parseInt(getVal(a, 'cr714_dayssincelastorder', 9999), 10);
                const dB = parseInt(getVal(b, 'cr714_dayssincelastorder', 9999), 10);
                const idA = String(getVal(a, 'cr714_id', ''));
                const idB = String(getVal(b, 'cr714_id', ''));
                const repA = String(getVal(a, 'cr714_accountrep') || getVal(a, 'cr714_retentionrep', '')).toLowerCase();
                const repB = String(getVal(b, 'cr714_accountrep') || getVal(b, 'cr714_retentionrep', '')).toLowerCase();
                const classA = String(getVal(a, 'cr714_customerclassification', '')).toLowerCase();
                const classB = String(getVal(b, 'cr714_customerclassification', '')).toLowerCase();
                const followA = getVal(a, 'cr714_followup');
                const followB = getVal(b, 'cr714_followup');
                const dateA_val = followA ? new Date(followA).getTime() : Infinity;
                const dateB_val = followB ? new Date(followB).getTime() : Infinity;
                const dateA_desc = followA ? new Date(followA).getTime() : -Infinity;
                const dateB_desc = followB ? new Date(followB).getTime() : -Infinity;

                switch (sortValue) {
                    case 'company-desc': return cB.localeCompare(cA);
                    case 'days-asc': return dA - dB;
                    case 'days-desc': return dB - dA;
                    case 'account-asc': return idA.localeCompare(idB, undefined, {numeric: true});
                    case 'account-desc': return idB.localeCompare(idA, undefined, {numeric: true});
                    case 'rep-asc': return repA.localeCompare(repB);
                    case 'rep-desc': return repB.localeCompare(repA);
                    case 'classification-asc': return classA.localeCompare(classB);
                    case 'classification-desc': return classB.localeCompare(classA);
                    case 'followup-asc': return dateA_val - dateB_val;
                    case 'followup-desc': return dateB_desc - dateA_desc;
                    case 'company-asc': default: return cA.localeCompare(cB);
                }
            });
            
            renderGallery(filtered);
        }
        
        function filterRecordPredicate(record, searchValue) {
            if (!searchValue) return true;
            const fieldsToSearch = [
                'cr714_id', 'cr714_company', 'cr714_namelatest', 'cr714_namemost',
                'cr714_emailmost', 'cr714_emaillatest', 'cr714_accountrep', 'cr714_retentionrep'
            ];
            return fieldsToSearch.some(key => String(getVal(record, key)).toLowerCase().includes(searchValue));
        }
        
        function selectRecord(recordId) {
            console.log(`LIVE: selectRecord id: ${recordId}`);
            if (!Array.isArray(allRecords)) { console.error("LIVE: allRecords is not an array on select."); return; }
            
            const idStr = String(recordId);
            currentSelectedRecord = allRecords.find(r => String(getVal(r, 'cr714_id')) === idStr);
            currentRecordId = currentSelectedRecord ? idStr : null;
            
            document.querySelectorAll('#record-gallery-list .gallery-item').forEach(i => i.classList.toggle('is-selected', i.getAttribute('data-id') === currentRecordId));
            
            if (currentSelectedRecord) {
                try {
                    populateForm(currentSelectedRecord);
                    loadSalesData(currentRecordId);
                    showFormContent(true);
                } catch (e) {
                    console.error("Error populating form:", e);
                    showNotification("Display Error", `Could not display record details: ${e.message}`);
                    showFormContent(false);
                }
            } else {
                showFormContent(false);
                resetSalesDisplay();
                const acctHeader = document.getElementById('acct-number-header');
                if (acctHeader) acctHeader.textContent = '--';
            }
            isEditMode = false;
            updateFormDisplayMode();
        }

        // --- FORM DISPLAY & POPULATION (Live Data) ---
        function showFormContent(show) {
            const container = document.getElementById('right-column-container');
            const editButton = document.getElementById('editModeButton');
            const saveButton = document.getElementById('save-button');
            const resetButton = document.getElementById('reset-button');
            // NEW: Get action buttons
            const launchEmailButton = document.getElementById('launch-email-button');
            const emailTemplateDropdown = document.getElementById('email-template-dropdown');
            const helpButton = document.getElementById('help-button');
            const nooppButton = document.getElementById('noopp-button');
            const closeButton = document.getElementById('close-button');


            if (container) container.style.visibility = show ? 'visible' : 'hidden';
            if (!show) {
                isEditMode = false;
                updateFormDisplayMode();
            }
            if (editButton) editButton.disabled = !show;
            if (saveButton) saveButton.disabled = !show;
            if (resetButton) resetButton.disabled = !show;
            // NEW: Enable/disable action buttons
            if (launchEmailButton) launchEmailButton.disabled = !show;
            if (emailTemplateDropdown) emailTemplateDropdown.disabled = !show;
            if (helpButton) helpButton.disabled = !show;
            if (nooppButton) nooppButton.disabled = !show;
            if (closeButton) closeButton.disabled = !show;
        }
        
        function populateForm(record) {
            console.log("LIVE: populateForm.");
            if (!record) { console.error("LIVE: populateForm called with null record."); return; }
            try {
                const acctHeader = document.getElementById('acct-number-header');
                if (acctHeader) acctHeader.textContent = getVal(record, 'cr714_id', '--');

                ['contact-name-most', 'contact-name-latest', 'contact-phone-primary', 'contact-email-most', 'contact-email-latest'].forEach(id => {
                    const el = document.getElementById(id);
                    const key = id.replace('contact-', '').replace('-', '');
                    const dataKey = 'cr714_' + (key === 'phoneprimary' ? 'primaryphone' : key);
                    if (el) el.value = getVal(record, dataKey, '--');
                    else console.warn(`! Missing form element: ${id}`);
                });
                
                ['acct-company', 'acct-classification', 'acct-days-last-order', 'acct-billing-address'].forEach(id => {
                    const el = document.getElementById(id);
                    const key = id.replace('acct-', '').replace('days-last-order', 'dayssincelastorder').replace('billing-address', 'billingaddress');
                    const dataKey = 'cr714_' + key;
                    if (el) el.textContent = getVal(record, dataKey, '--');
                    else console.warn(`! Missing form element: ${id}`);
                });
                
                ['internal-acct-rep', 'internal-retention-rep'].forEach(id => {
                    const el = document.getElementById(id);
                    const key = id.replace('internal-', '').replace('acct-rep', 'accountrep').replace('retention-rep', 'retentionrep');
                    const dataKey = 'cr714_' + key;
                    if (el) el.textContent = getVal(record, dataKey, '--');
                    else console.warn(`! Missing form element: ${id}`);
                });
                
                const notesInput = document.getElementById('qb-notes-input');
                if (notesInput) {
                    notesInput.value = QB_NOTES_TEMPLATE;
                } else console.warn("! Missing qb-notes-input");
                
                const followUpDateEl = document.getElementById('follow-up-date');
                const followUpTimeEl = document.getElementById('follow-up-time');
                const followUpValue = getVal(record, 'cr714_followup');
                
                if (followUpValue) {
                    try {
                        const d = new Date(followUpValue);
                        if (isNaN(d)) throw new Error('Invalid Date');
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const hours = String(d.getHours()).padStart(2, '0');
                        const minutes = String(d.getMinutes()).padStart(2, '0');
                        if (followUpDateEl) followUpDateEl.value = `${year}-${month}-${day}`;
                        if (followUpTimeEl) followUpTimeEl.value = `${hours}:${minutes}`;
                    } catch (e) {
                        if (followUpDateEl) followUpDateEl.value = '';
                        if (followUpTimeEl) followUpTimeEl.value = '';
                        console.error("Bad followup date received:", followUpValue, e);
                    }
                } else {
                    if (followUpDateEl) followUpDateEl.value = '';
                    if (followUpTimeEl) followUpTimeEl.value = '';
                }
                
                updateNotesPreview();
                console.log("LIVE: populateForm finished.");
            } catch (e) {
                console.error("LIVE: Error in populateForm:", e);
                showNotification("Form Error", `Could not display record data: ${e.message}`);
            }
        }

        // --- FORM ACTIONS (Live Data) ---
        async function handleCustomSave() {
            console.log("LIVE: handleCustomSave.");
            if (!currentRecordId) { showNotification("Error", "No record selected to save."); return; }
            if (!isEditMode) { showNotification("Info", "Click 'Edit Profile' to make changes first."); return; }
            
            const token = await getFlowToken();
            if (!token) return; // Error was already shown

            let isoFollowUp = null;
            const dateStr = getElementValue('follow-up-date');
            const timeStr = getElementValue('follow-up-time');
            if (dateStr && timeStr) {
                try {
                    const d = new Date(`${dateStr}T${timeStr}:00`);
                    if (!isNaN(d)) isoFollowUp = d.toISOString();
                } catch (e) { console.error("Bad date/time input:", e); }
            }
            
            let notes = getElementValue('qb-notes-input') || '';
            if (notes.startsWith(QB_NOTES_TEMPLATE)) {
                notes = notes.substring(QB_NOTES_TEMPLATE.length).trim(); // Save only the new/edited notes
            }
            
            const dataToSave = {
                recordId: currentRecordId,
                qbNotes: notes,
                followUp: isoFollowUp,
                nameMost: getElementValue('contact-name-most'),
                nameLatest: getElementValue('contact-name-latest'),
                primaryPhone: getElementValue('contact-phone-primary'),
                emailMost: getElementValue('contact-email-most'),
                emailLatest: getElementValue('contact-email-latest')
            };
            
            console.log("LIVE: Patch data:", dataToSave);
            
            if (PATCH_RECORD_FLOW_URL === "YOUR_EXISTING_PATCH_FLOW_URL" || !PATCH_RECORD_FLOW_URL) {
                console.warn("LIVE: Mock Save. No Flow URL provided.");
                // ... (Mock save logic) ...
                return;
            }
            
            try {
                showNotification("Saving...", "Please wait...");
                const response = await fetch(PATCH_RECORD_FLOW_URL, {
                    method: 'POST',
                    // --- SECURITY: Add AAD Token ---
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dataToSave)
                });
                
                if (response.status === 401) {
                    throw new Error("Unauthorized. You may not have permission to run this Flow.");
                }
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Flow Error ${response.status}: ${errorText || response.statusText}`);
                }
                
                const result = await response.json();
                showNotification("Save Successful", result.message || "Record updated!");
                isEditMode = false;
                updateFormDisplayMode();
                
                const index = allRecords.findIndex(r => String(getVal(r, 'cr714_id')) === currentRecordId);
                if (index !== -1) {
                    allRecords[index] = { ...allRecords[index], 
                        cr714_qbnotes: dataToSave.qbNotes,
                        cr714_followup: dataToSave.followUp,
                        // ... (update other fields)
                    };
                    currentSelectedRecord = allRecords[index];
                    filterAndSortGallery(); 
                    populateForm(currentSelectedRecord); 
                }
                
            } catch (e) {
                console.error("LIVE: Error saving record:", e);
                showNotification("Save Failed", `Could not save record: ${e.message}.`);
            }
        }
        
        // --- NEW: FUNCTION TO HANDLE ACTION BUTTONS (Help, No Opp, Close, Email) ---
        async function handleActionButtonClick(actionType) {
            console.log(`LIVE: handleActionButtonClick: ${actionType}`);
            if (!currentRecordId) { showNotification("Error", "No record selected."); return; }
            if (!isEditMode) { showNotification("Info", "Click 'Edit Profile' to enable actions."); return; }

            const token = await getFlowToken();
            if (!token) return; // Error was already shown

            let notes = getElementValue('qb-notes-input') || '';
            if (notes.startsWith(QB_NOTES_TEMPLATE)) {
                notes = notes.substring(QB_NOTES_TEMPLATE.length).trim(); // Save only the new notes
            }
            
            if (actionType !== 'LaunchEmail' && !notes) {
                showNotification("Note Required", "Please enter a note in the 'Enter New Notes' box before submitting an action.");
                return;
            }

            const dataToSave = {
                recordId: currentRecordId,
                notes: notes,
                action: actionType, // "Help", "NoOpp", "CloseAccount", "LaunchEmail"
                repName: currentUserRepName
            };

            let emailTemplate = '';
            if (actionType === 'LaunchEmail') {
                emailTemplate = getElementValue('email-template-dropdown');
                dataToSave.emailTemplate = emailTemplate;
                
                // ... (Mailto link logic remains the same) ...
                 try {
                    const email = getVal(currentSelectedRecord, 'cr714_emailmost') || getVal(currentSelectedRecord, 'cr714_emaillatest');
                    const subject = `WB Mason -- ACC# ${getVal(currentSelectedRecord, 'cr714_id')} // ${getVal(currentSelectedRecord, 'cr714_company')}`;
                    let body = `Good Morning/Afternoon,\n\n[Your message here]\n\n`;
                    if (emailTemplate.includes("Non-Buy")) {
                        body = `Good Morning/Afternoon,\n\nI am reaching out from our retention department. Before your next order with a competitor, send me their shopping cart and I will at least match any pricing.\n\n[Your message here]\n\n`;
                    } else if (emailTemplate.includes("Follow Up")) {
                         body = `Good Morning/Afternoon,\n\nI was unable to reach you today. When we last spoke, you mentioned... \n\n[Your message here]\n\n`;
                    }
                    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.open(mailtoLink, '_blank');
                } catch (e) {
                    console.error("Mailto link failed:", e);
                    showNotification("Email Error", "Could not open mail client. The note will still be saved.");
                }
            }
            
            console.log("LIVE: Action data:", dataToSave);

            if (ACTION_BUTTON_FLOW_URL === "YOUR_NEW_ACTION_BUTTON_FLOW_URL" || !ACTION_BUTTON_FLOW_URL) {
                console.warn("LIVE: Mock Action. No Flow URL provided.");
                // ... (Mock action logic) ...
                return;
            }
            
            // --- Live Flow Call ---
            try {
                showNotification("Processing Action...", "Please wait...");
                const response = await fetch(ACTION_BUTTON_FLOW_URL, {
                    method: 'POST',
                    // --- SECURITY: Add AAD Token ---
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dataToSave)
                });
                
                if (response.status === 401) {
                    throw new Error("Unauthorized. You may not have permission to run this Flow.");
                }
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Flow Error ${response.status}: ${errorText || response.statusText}`);
                }
                
                const updatedRecord = await response.json(); // Assumes Flow returns the full updated record
                showNotification("Action Successful", `${actionType} action was recorded.`);
                
                // Update local record
                const index = allRecords.findIndex(r => String(getVal(r, 'cr714_id')) === currentRecordId);
                if (index !== -1 && updatedRecord) {
                    allRecords[index] = updatedRecord; // Update with data from Flow
                    currentSelectedRecord = allRecords[index];
                    filterAndSortGallery(); // Re-render gallery
                    populateForm(currentSelectedRecord); // Re-populate form
                } else {
                    await loadRecords(); // Fallback
                }
                // Reset notes
                const notesInput = document.getElementById('qb-notes-input');
                if (notesInput) notesInput.value = QB_NOTES_TEMPLATE;
                updateNotesPreview();
                
            } catch (e) {
                console.error("LIVE: Error with action button:", e);
                showNotification("Action Failed", `Could not process action: ${e.message}.`);
            }
        }

        function handleCustomReset() {
            if (currentSelectedRecord) {
                populateForm(currentSelectedRecord); // Revert to last saved state
                showNotification("Reset", "Changes discarded.");
                isEditMode = false;
                updateFormDisplayMode();
            } else {
                showNotification("Info", "No record selected.");
            }
        }

        // --- EDIT MODE & UI STATE (Live Data) ---
        function toggleEditMode() {
            if (!currentSelectedRecord) return;
            isEditMode = !isEditMode;
            updateFormDisplayMode();
        }
        
        function updateFormDisplayMode() {
            const editButton = document.getElementById('editModeButton');
            const inputs = document.querySelectorAll('#profile-card .editable-field, #follow-up-date, #follow-up-time, #qb-notes-input');
            const saveButton = document.getElementById('save-button');
            const resetButton = document.getElementById('reset-button');
            const launchEmailButton = document.getElementById('launch-email-button');
            const emailTemplateDropdown = document.getElementById('email-template-dropdown');
            const helpButton = document.getElementById('help-button');
            const nooppButton = document.getElementById('noopp-button');
            const closeButton = document.getElementById('close-button');
            
            if (editButton) {
                if (isEditMode) {
                    editButton.innerHTML = '<i class="fas fa-eye mr-1"></i> View Profile';
                    editButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    editButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
                } else {
                    editButton.innerHTML = '<i class="fas fa-pencil-alt mr-1"></i> Edit Profile';
                    editButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
                    editButton.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
                editButton.disabled = !currentSelectedRecord;
            }
            
            if (saveButton) {
                saveButton.disabled = !isEditMode;
                saveButton.classList.toggle('bg-gray-300', !isEditMode);
                saveButton.classList.toggle('cursor-not-allowed', !isEditMode);
                saveButton.classList.toggle('bg-green-600', isEditMode);
                saveButton.classList.toggle('hover:bg-green-700', isEditMode);
            }
            if (resetButton) {
                resetButton.disabled = !isEditMode;
                resetButton.classList.toggle('bg-gray-300', !isEditMode);
                resetButton.classList.toggle('cursor-not-allowed', !isEditMode);
                resetButton.classList.toggle('bg-gray-500', isEditMode);
                resetButton.classList.toggle('hover:bg-gray-600', isEditMode);
            }
            
            if (launchEmailButton) launchEmailButton.disabled = !isEditMode;
            if (emailTemplateDropdown) emailTemplateDropdown.disabled = !isEditMode;
            if (helpButton) helpButton.disabled = !isEditMode;
            if (nooppButton) nooppButton.disabled = !isEditMode;
            if (closeButton) closeButton.disabled = !isEditMode;

            inputs.forEach(input => {
                if (input) {
                    input.disabled = !isEditMode;
                    input.classList.toggle('is-editable', isEditMode);
                }
            });
            console.log("LIVE: Edit mode set to:", isEditMode);
        }

        // --- SALES DATA (Live Data) ---
        async function loadSalesData(recordId) {
            console.log("LIVE: loadSalesData for:", recordId);
            if (!recordId) { resetSalesDisplay(); return; }
            
            const token = await getFlowToken();
            if (!token) return; // Error was already shown

            const placeholder = document.getElementById('sales-placeholder');
            const content = document.getElementById('sales-content');
            const loader = document.getElementById('sales-loader');
            
            if (placeholder) placeholder.style.display = 'none';
            if (content) content.style.display = 'none';
            if (loader) loader.style.display = 'flex';
            
            const categoryList = document.getElementById('sales-category-list');
            if (categoryList) categoryList.innerHTML = ''; // Clear old categories
            
            try {
                let data;
                if (SALES_DATA_FLOW_URL === "YOUR_NEW_SALES_DATA_FLOW_URL" || !SALES_DATA_FLOW_URL) {
                    console.warn("LIVE: Mock Sales Data. No Flow URL provided.");
                    await new Promise(r => setTimeout(r, 500)); // Simulate network delay
                    data = { ytdSales: "$1,234.56", orderCount: "12", lastOrderDate: "2025-10-15", categories: [ { categoryName: "Supplies", categorySales: "$500.10" }, { categoryName: "Equipment", categorySales: "$734.46" } ] };
                } else {
                    const response = await fetch(SALES_DATA_FLOW_URL, {
                        method: 'POST',
                        // --- SECURITY: Add AAD Token ---
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ accountId: recordId })
                    });
                    if (response.status === 401) {
                        throw new Error("Unauthorized. You may not have permission to run this Flow.");
                    }
                    if (!response.ok) throw new Error(`Sales Flow Error: ${response.status} ${response.statusText}`);
                    data = await response.json();
                }
                displaySalesData(data);
            } catch (e) {
                console.error("LIVE: Error loading sales data:", e);
                if (placeholder) {
                    placeholder.style.display = 'block';
                    placeholder.textContent = 'Error loading sales data.';
                    placeholder.classList.add('text-red-600');
                }
                showNotification("Sales Data Error", `Could not load sales data: ${e.message}`);
            } finally {
                if (loader) loader.style.display = 'none';
            }
        }
        
        function displaySalesData(data) {
            const placeholder = document.getElementById('sales-placeholder');
            const content = document.getElementById('sales-content');
            const categoryList = document.getElementById('sales-category-list');
            
            if (!data) {
                resetSalesDisplay();
                if (placeholder) placeholder.textContent = 'No sales data available.';
                return;
            }
            
            try {
                ['sales-ytd', 'sales-total-orders', 'sales-last-order'].forEach(id => {
                    const el = document.getElementById(id);
                    const key = id.replace('sales-', '').replace('total-orders', 'orderCount').replace('last-order', 'lastOrderDate').replace('ytd', 'ytdSales');
                    if (el) el.textContent = getVal(data, key, '--');
                });
                
                if (categoryList) {
                    categoryList.innerHTML = ''; // Clear default
                    const categories = data.categories;
                    if (Array.isArray(categories) && categories.length > 0) {
                        categories.forEach(cat => {
                            const li = document.createElement('li');
                            li.className = 'sales-category-item';
                            li.innerHTML = `
                                <span class="sales-category-name truncate pr-2" title="${escapeHTML(getVal(cat, 'categoryName'))}">${escapeHTML(getVal(cat, 'categoryName', 'N/A'))}</span>
                                <span class="sales-category-amount">${escapeHTML(getVal(cat, 'categorySales', '--'))}</span>
                            `;
                            categoryList.appendChild(li);
                        });
                    } else {
                        categoryList.innerHTML = '<li class="sales-category-item italic text-gray-400">No category data</li>';
                    }
                }
                
                if (placeholder) placeholder.style.display = 'none';
                if (content) content.style.display = 'block';
            } catch (e) {
                console.error("LIVE: Error displaying sales data:", e);
                resetSalesDisplay();
                if (placeholder) {
                    placeholder.style.display = 'block';
                    placeholder.textContent = 'Error displaying sales data.';
                    placeholder.classList.add('text-red-600');
                }
            }
        }

        // --- CLOCK (Shared) ---
        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            updateClock();
            clockInterval = setInterval(updateClock, 1000); // Update every second
        }
        
        function updateClock() {
            const clockEl = document.getElementById('clock-display');
            const now = new Date();
            const timeStr = `${now.toLocaleDateString([], {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})} ${now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
            if (clockEl) clockEl.textContent = timeStr;
        }

        // --- OTHER UI (Live Data) ---
        function updateNotesPreview() {
            const previewBox = document.getElementById('qb-notes-preview');
            if (!previewBox) return;
            
            const showNew = document.getElementById('show-new-note')?.checked;
            const showPrev = document.getElementById('show-prev-note')?.checked;
            const showMgr = document.getElementById('show-mgr-note')?.checked;
            const showImp = document.getElementById('show-imp-note')?.checked;
            
            const newNotesText = getElementValue('qb-notes-input') || '';
            const prevNotes = getVal(currentSelectedRecord, 'cr714_qbnotes', '');
            const mgrNotes = getVal(currentSelectedRecord, 'cr714_managernotes', '');
            const impInfo = getVal(currentSelectedRecord, 'cr714_importantaccountinformation', '');
            
            const timestamp = new Date().toLocaleString();
            let html = '';
            let hasContent = false;
            
            const isNewNoteEmpty = newNotesText.replace(QB_NOTES_TEMPLATE, '').trim().length === 0;
            
            if (showNew && !isNewNoteEmpty) {
                const newNote = newNotesText.startsWith(QB_NOTES_TEMPLATE) ? newNotesText.substring(QB_NOTES_TEMPLATE.length).trim() : newNotesText.trim();
                if (newNote) {
                    html += `<div class="note-preview-item"><h4><i class="fas fa-pencil-alt text-blue-500"></i>New Note Preview (${escapeHTML(timestamp)} - ${escapeHTML(currentUserRepName || 'Current User')})</h4><p>${escapeHTML(newNote).replace(/\n/g, '<br>')}</p></div>`;
                    hasContent = true;
                }
            }
            if (showPrev && prevNotes) {
                html += `<div class="note-preview-item"><h4><i class="fas fa-history text-gray-500"></i>Previous Notes</h4><p>${escapeHTML(prevNotes).replace(/\n/g, '<br>')}</p></div>`;
                hasContent = true;
            }
            if (showMgr && mgrNotes) {
                html += `<div class="note-preview-item"><h4><i class="fas fa-user-tie text-green-600"></i>Manager Notes</h4><p>${escapeHTML(mgrNotes).replace(/\n/g, '<br>')}</p></div>`;
                hasContent = true;
            }
            if (showImp && impInfo) {
                html += `<div class="note-preview-item"><h4><i class="fas fa-exclamation-triangle text-red-500"></i>Important Info</h4><p>${escapeHTML(impInfo).replace(/\n/g, '<br>')}</p></div>`;
                hasContent = true;
            }
            
            previewBox.innerHTML = hasContent ? html : '<p class="text-gray-400 italic text-center text-sm mt-4">No notes to display based on filters.</p>';
        }
        
        function createCalendarEvent() {
            const dateEl = document.getElementById('follow-up-date');
            const timeEl = document.getElementById('follow-up-time');
            const acctNum = getVal(currentSelectedRecord, 'cr714_id', 'N/A'); 
            
            if (!dateEl || !timeEl) return;
            if (!dateEl.value || !timeEl.value) {
                showNotification("Missing Date/Time", "Please select a follow-up date and time first.");
                return;
            }
            
            const dateTime = new Date(`${dateEl.value}T${timeEl.value}:00`);
            if (isNaN(dateTime)) {
                showNotification("Invalid Date/Time", "The selected date or time is not valid.");
                return;
            }
            
            try {
                const repName = currentUserRepName || "Rep";
                const instructions = `Modified On: ${new Date().toLocaleString()}\nModified By: ${repName}\n\nQB Notes:\n${(getElementValue('qb-notes-input') || '').replace(QB_NOTES_TEMPLATE, '').trim()}`;
                const dueDate = dateTime.toISOString();
                
                showNotification("Calendar Event", "Please wait, attempting to add to your Outlook calendar...");
                // NOTE: This requires a new, separate Flow secured with AAD that can run the
                // Office365Outlook.V4CalendarPostItem action.
                console.log("Simulating Office365Outlook.V4CalendarPostItem call...");
                showNotification("Calendar (Mock)", "Calendar event created in mock mode.");

            } catch(e) {
                console.error("Error creating calendar event:", e);
                showNotification("Error", "Could not create calendar event.");
            }
        }
        
        function showHelp() {
            showNotification("Help", "This is a placeholder for help instructions.");
        }
        
        function setInitialAnnouncementState() {
            const section = document.getElementById('announcements-section');
            const button = document.getElementById('announcement-toggle-btn');
            let isDismissed = false;
            try {
                isDismissed = JSON.parse(localStorage.getItem(ANNOUNCEMENT_DISMISSED_KEY) || 'false');
            } catch (e) { console.error("Could not parse announcement state", e); }
            
            if (section && button) {
                section.classList.toggle('announcements-collapsed', isDismissed);
                section.classList.toggle('announcements-expanded', !isDismissed);
                button.textContent = isDismissed ? '[Show]' : '[Dismiss]';
            }
        }
        
        function toggleAnnouncements() {
            const section = document.getElementById('announcements-section');
            const button = document.getElementById('announcement-toggle-btn');
            if (!section || !button) return;

            const isExpanded = section.classList.contains('announcements-expanded');
            const newState = !isExpanded;
            // Save the new collapsed/expanded state (true => dismissed/collapsed)
            localStorage.setItem(ANNOUNCEMENT_DISMISSED_KEY, JSON.stringify(!newState));
            section.classList.toggle('announcements-collapsed', !newState);
            section.classList.toggle('announcements-expanded', newState);
            button.textContent = newState ? '[Dismiss]' : '[Show]';
        }

        // --- NOTIFICATION MODAL (Shared) ---
        function showNotification(title, message) { 
            const m = document.getElementById('notification-modal'); 
            const t = document.getElementById('notification-title'); 
            const msg = document.getElementById('notification-message'); 
            if (m && t && msg) { 
                t.textContent = title; 
                msg.innerHTML = message; 
                m.classList.remove('hidden'); 
            } else { 
                // Fallback for safety, though alert() is bad
                console.log("NOTIFICATION:", title, message);
                // alert(`${title}\n\n${message}`); 
            } 
        }
        
        function closeNotification() { 
            const m = document.getElementById('notification-modal'); 
            if (m) m.classList.add('hidden'); 
        }

    </script>
</body>
</html>
