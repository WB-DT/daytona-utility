<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daytona Account Utility v4.0 (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; /* bg-slate-200 */ }

        /* --- Global Styles --- */
        .card { background-color: #fff; border: 1px solid #e2e8f0; /* slate-200 */ border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05), 0 1px 2px -1px rgba(0,0,0,0.05); }
        .card-header { font-size: 1rem; font-weight: 600; color: #1e293b; /* slate-800 */ border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between; }
        .card-header i { margin-right: 0.5rem; color: #475569; /* slate-600 */ width: 1.25rem; /* Ensure consistent icon spacing */ }
        .pa-label { color: #166534; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.1rem; text-transform: uppercase; letter-spacing: 0.025em; }
        .pa-input, .pa-textarea, .pa-select {
            border-color: #cbd5e1; background-color: #f8fafc; font-size: 0.875rem; /* Base size */
            padding: 0.5rem 0.75rem; border-width: 1px; border-radius: 0.375rem; width: 100%;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .pa-input:focus, .pa-textarea:focus, .pa-select:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); border-color: #3b82f6; outline: none; background-color: #fff;
        }

        /* --- Layout Specific --- */
        .main-content-wrapper { display: grid; grid-template-columns: 280px 1fr; gap: 1rem; /* Fixed gallery width */ }
        .left-column-container { max-height: calc(100vh - 145px); /* Adjusted for tabs/header */ display: grid; grid-template-rows: minmax(150px, 1fr) auto; gap: 1rem; background-color: #f8fafc; /* bg-slate-50 */ border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 0.75rem; }
        .gallery-section { display: flex; flex-direction: column; overflow: hidden; /* Prevent internal scrollbar issues */ }
        .record-gallery-list { display: flex; flex-direction: column; gap: 0.3rem; overflow-y: auto; flex-grow: 1; padding-right: 2px; scrollbar-width: thin; scrollbar-color: #94a3b8 #e2e8f0; }
        .record-gallery-list::-webkit-scrollbar { width: 6px; }
        .record-gallery-list::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 3px; }
        .record-gallery-list::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 3px; border: 1px solid #e2e8f0; }
        .right-column-container { max-height: calc(100vh - 145px); /* Adjusted for tabs/header */ overflow-y: auto; padding-right: 5px; /* Space for scrollbar */ scrollbar-width: thin; scrollbar-color: #94a3b8 #e2e8f0;}
        .right-column-container::-webkit-scrollbar { width: 6px; }
        .right-column-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 3px; }
        .right-column-container::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 3px; border: 1px solid #e2e8f0; }

        /* --- Section Specific Styles --- */
        #profile-card { background-color: #fff; }
    /* Replaced Tailwind @apply with explicit CSS so file works standalone in the browser */
    .profile-dt { font-size: 0.7rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0; line-height: 1.1; }
    .profile-dd { font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
    .editable-field { width: 100%; font-size: 0.875rem; font-weight: 500; line-height: 1.4rem; border-radius: 0.375rem; transition: all 150ms ease-in-out; border: 1px solid transparent; }
        .editable-field:disabled { background: transparent; padding: 0.5rem 0.1rem; color: #1f2937; cursor: default; }
        /* Make editable fields visually consistent with .pa-input when enabled */
        .editable-field:not(:disabled) {
            border-color: #cbd5e1; background-color: #FFFFFF; font-size: 0.875rem; padding: 0.5rem 0.75rem; border-width: 1px; border-radius: 0.375rem; width: 100%;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .editable-field[type="email"]:disabled { color: #2563eb; text-decoration: underline; cursor: pointer; padding: 0.5rem 0.1rem;}
        .editable-field[type="email"]:disabled:hover { color: #1d4ed8; }
        .is-editable { background-color: #fefce8 !important; border-color: #fcd34d !important; }
        .is-editable:focus { box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.4) !important; border-color: #facc15 !important; }

    #notes-section { background-color: #fefce8; border-color: #fde68a; }
        #notes-section .card-header { border-color: #fde68a; }
        .notes-preview-box { background-color: #fff; border: 1px solid #fde047; border-radius: 0.375rem; padding: 0.75rem; font-size: 0.8rem; line-height: 1.4; overflow-y: auto; }
        .note-preview-item { margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed #fee2e2; }
        .note-preview-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        /* Note Formatting */
        .note-preview-item h4 { display: flex; align-items: center; font-weight: 700; font-size: 0.7rem; color: #713f12; margin-bottom: 0.2rem; text-transform: uppercase; letter-spacing: 0.05em;}
        .note-preview-item h4 i { width: 0.75rem; margin-right: 0.375rem; text-align: center; }
        .note-preview-item pre { white-space: pre-wrap; font-family: 'Inter', sans-serif; margin-top: 0.1rem; }

    #actions-section { background-color: #eff6ff; border-color: #bfdbfe; }
    #actions-section .card-header { border-color: #bfdbfe; }
    
    #announcements-section, .marquee-container { background-color: #f1f5f9; border-color: #cbd5e1; }
    .marquee { overflow: hidden; position: relative; white-space: nowrap; background: white; border: 1px solid #cbd5e1; border-radius: 0.25rem; padding: 0.25rem 0; }
    .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 25s linear infinite; font-size: 0.8rem; color: #475569; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .announcements-collapsed .marquee-container { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; transition: all 0.3s ease-out; margin-top: 0;}
    .announcements-expanded .marquee-container { max-height: 100px; transition: all 0.3s ease-in; margin-top: 0.25rem;}

    #sales-data-container { background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03); overflow-y: auto; padding: 0.75rem; }
    .sales-data-container::-webkit-scrollbar { width: 5px; }
    .sales-data-container::-webkit-scrollbar-track { background: #dcfce7; border-radius: 2.5px; }
    .sales-data-container::-webkit-scrollbar-thumb { background-color: #86efac; border-radius: 2.5px; }
    /* Sales styles (explicit CSS replacing Tailwind @apply) */
    .sales-dt { font-size: 0.7rem; font-weight: 500; color: #166534; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0; line-height: 1.1; }
    .sales-dd { font-size: 1rem; font-weight: 600; color: #064e3b; margin-bottom: 0.5rem; }
    .sales-category-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; padding: 0.25rem 0; border-bottom: 1px solid #dff6e8; }
    .sales-category-item:last-child { border-bottom: 0; }
    .sales-category-name { color: #166534; }
    .sales-category-amount { font-weight: 600; color: #064e3b; }
    #live-clock-container { border-top: 1px solid #bbf7d0; margin-top: 0.75rem; padding-top: 0.75rem; }

    /* --- Gallery Item Style --- */
    .gallery-item { transition: all 150ms ease-in-out; border: 1px solid #d1d5db; background-color: #fff; border-radius: 0.375rem; text-align: left; width: 100%; padding: 0.5rem; flex-shrink: 0; cursor: pointer; }
    .gallery-item:hover { background-color: #f0f9ff; border-color: #7dd3fc; }
    .gallery-item.is-selected { background-color: #3b82f6; color: white; border-color: #2563eb; }
    .gallery-item.is-selected .gallery-item-id, .gallery-item.is-selected .gallery-item-company, .gallery-item.is-selected .gallery-item-rep { color: #e0e7ff; }
    .gallery-item.is-selected .gallery-item-id { color: white; }
    .gallery-item .gallery-item-id { font-weight: 700; font-size: 0.9rem; color: #1e3a8a; }
    .gallery-item .gallery-item-company { font-weight: 500; font-size: 0.8rem; color: #374151; }
    .gallery-item .gallery-item-rep { font-size: 0.7rem; color: #6b7280; font-style: italic; }

    .header-panel { background-color: #fff; border-bottom: 1px solid #e2e8f0; }
    .loader-container { min-height: 60px; display: flex; align-items: center; justify-content: center; width: 100%; flex-grow: 1;}
    </style>
</head>
<body class="p-0 md:p-4">

    <div id="login-container" class="fixed inset-0 bg-slate-900 bg-opacity-90 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <i class="fas fa-lock text-5xl text-blue-600 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Daytona Account Utility</h3>
            <p class="text-gray-700 mb-6">Please log in with your Microsoft account to continue.</p>
            <button onclick="login()" id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center text-lg">
                <i class="fab fa-microsoft mr-3"></i>
                Sign in with Microsoft
            </button>
            <p id="login-error" class="text-red-600 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <div id="main-app-container" class="hidden">

        <div id="live-data-content" class="active">
            <div id="header-panel" class="header-panel p-3 shadow-md mb-4 sticky top-0 z-10 bg-white">
                <div class="max-w-screen-xl mx-auto flex flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-gray-800 whitespace-nowrap"><i class="fas fa-list-ul text-blue-600 mr-1"></i>My Accounts</h2>
                        <button onclick="loadRecords()" id="load-records-button" class="py-1 px-3 text-sm rounded-md shadow transition-all duration-200 font-bold bg-green-600 text-white hover:bg-green-700">
                            <i class="fas fa-sync mr-1"></i> Load My Records
                        </button>
                        <span id="welcome-message" class="text-sm text-gray-600 hidden"></span>
                    </div>
                    <div class="flex-grow min-w-[200px] max-w-xs relative">
                        <input type="text" id="search-bar" onkeyup="filterAndSortGallery()" placeholder="Search accounts..." class="pa-input pl-10 w-full text-sm" />
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <select id="sort-dropdown" onchange="filterAndSortGallery()" class="pa-select text-xs">
                            <option value="company-asc">Sort: Company A-Z</option>
                            <option value="company-desc">Sort: Company Z-A</option>
                            <option value="account-asc">Sort: Account # &#x2191;</option>
                            <option value="account-desc">Sort: Account # &#x2193;</option>
                            <option value="rep-asc">Sort: Rep A-Z</option>
                            <option value="rep-desc">Sort: Rep Z-A</option>
                            <option value="days-asc">Sort: Days Since Order &#x2191;</option>
                            <option value="days-desc">Sort: Days Since Order &#x2193;</option>
                            <option value="classification-asc">Sort: Classification A-Z</option>
                            <option value="classification-desc">Sort: Classification Z-A</option>
                            <option value="followup-asc">Sort: Follow Up &#x2191;</option>
                            <option value="followup-desc">Sort: Follow Up &#x2193;</option>
                        </select>
                        <select id="filter-action-dropdown" onchange="filterAndSortGallery()" class="pa-select text-xs" disabled>
                            <option value="">Filter: All Actions</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-3 flex-wrap border-l pl-3 ml-1">
                        <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                            <input type="checkbox" id="filter-followup" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                            <span>Show Follow Ups</span>
                        </label>
                         <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                            <input type="checkbox" id="filter-nonotes" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                            <span>No Notes</span>
                        </label>
                         <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                            <input type="checkbox" id="filter-requests" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                            <span>Button Requests</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="main-content-wrapper-live" class="main-content-wrapper max-w-screen-xl mx-auto px-3 md:px-0">
                <div id="left-column-container" class="left-column-container">
                    <div id="gallery-section" class="gallery-section">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2 pb-1 border-b border-gray-200 flex-shrink-0 whitespace-nowrap">Account List</h3>
                        <div id="record-gallery-list" class="record-gallery-list flex-grow min-h-0">
                            <div id="gallery-loader" class="loader-container"><span class="italic text-gray-500">Click "Load My Records"</span></div>
                        </div>
                    </div>
                    <div id="sales-data-container" class="sales-data-container">
                        <h3 class="text-base font-semibold text-green-800 mb-3 pb-2 border-b border-green-200 flex items-center"><i class="fas fa-chart-line w-4 mr-2 text-green-600"></i>Sales Snapshot</h3>
                        <div id="sales-loader" class="loader-container text-xs italic text-gray-500 py-2 hidden"><span>Loading sales...</span></div>
                        <div id="sales-content" class="space-y-3 hidden">
                            <dl class="grid grid-cols-2 gap-x-4 gap-y-1"><div><dt class="sales-dt">YTD Sales</dt><dd class="sales-dd" id="sales-ytd">--</dd></div><div><dt class="sales-dt">Total Orders</dt><dd class="sales-dd" id="sales-total-orders">--</dd></div><div class="col-span-2"><dt class="sales-dt">Last Order Date</dt><dd class="sales-dd" id="sales-last-order">--</dd></div></dl>
                            <div id="sales-category-section" class="pt-2 border-t border-green-100"><h4 class="text-xs font-semibold text-green-700 mb-1">By Category:</h4><ul id="sales-category-list" class="space-y-0.5 max-h-24 overflow-y-auto pr-1"><li class="sales-category-item italic text-gray-400">No category data</li></ul></div>
                            <div id="live-clock-container" class="live-clock-container"><h4 class="text-xs font-semibold text-gray-500 mb-1 flex items-center"><i class="far fa-clock w-3 mr-1.5 text-gray-400"></i>Current Time</h4><div id="clock-display" class="text-xs text-gray-700 font-medium">--</div></div>
                        </div>
                        <div id="sales-placeholder" class="text-xs text-gray-400 italic text-center py-4">Select an account</div>
                    </div>
                </div>
                <div id="right-column-container" class="right-column-container">
                    <div class="space-y-4">
                         <div id="profile-card" class="card p-4">
                            <div class="card-header">
                                <span>
                                    <i class="fas fa-id-card text-blue-600"></i>Account Profile - 
                                    <span id="acct-number-header" class="font-bold text-blue-700">--</span>
                                </span>
                                <div class="flex items-center gap-2">
                                    <button onclick="showHelp()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold w-7 h-7 rounded-full flex items-center justify-center shadow transition-all duration-200 flex-shrink-0" aria-label="Help">
                                        <i class="fas fa-question text-xs"></i>
                                    </button>
                                    <button onclick="toggleEditMode()" id="editModeButton" class="py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold bg-gray-200 text-gray-700 hover:bg-gray-300" disabled><i class="fas fa-pencil-alt mr-1"></i> Edit Profile</button>
                                </div>
                            </div>
                            <div><h3 class="text-sm font-semibold text-blue-700 mb-2 flex items-center"><i class="fas fa-users w-4 mr-1.5"></i>Contact Details</h3><dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1"><div><dt class="profile-dt">Primary Contact (Most)</dt><dd><input type="text" id="contact-name-most" class="editable-field" value="--" disabled></dd></div><div><dt class="profile-dt">Recent Contact (Latest)</dt><dd><input type="text" id="contact-name-latest" class="editable-field" value="--" disabled></dd></div><div><dt class="profile-dt">Primary Phone</dt><dd><input type="text" id="contact-phone-primary" class="editable-field" value="--" disabled></dd></div><div></div><div><dt class="profile-dt">Primary Email (Most)</dt><dd><input type="email" id="contact-email-most" class="editable-field" value="--" disabled></dd></div><div><dt class="profile-dt">Recent Email (Latest)</dt><dd><input type="email" id="contact-email-latest" class="editable-field" value="--" disabled></dd></div></dl></div>
                            <div class="mt-4 border-t pt-3"><h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center"><i class="fas fa-building w-4 mr-1.5"></i>Account Details (Read-Only)</h3><dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1"><div><dt class="profile-dt">Company</dt><dd class="profile-dd" id="acct-company">--</dd></div><div><dt class="profile-dt">Classification</dt><dd class="profile-dd" id="acct-classification">--</dd></div><div><dt class="profile-dt">Days Since Last Order</dt><dd class="profile-dd" id="acct-days-last-order">--</dd></div><div class="sm:col-span-2"><dt class="profile-dt">Billing Address</dt><dd class="profile-dd whitespace-pre-line" id="acct-billing-address">--</dd></div></dl></div>
                            <div class="mt-4 border-t pt-3"><h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center"><i class="fas fa-briefcase w-4 mr-1.5"></i>Internal Assignment (Read-Only)</h3><dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1"><div><dt class="profile-dt">Account Rep</dt><dd class="profile-dd" id="internal-acct-rep">--</dd></div><div><dt class="profile-dt">Retention Rep</dt><dd class="profile-dd" id="internal-retention-rep">--</dd></div></dl></div>
                        </div>
                        <div id="notes-section" class="card p-4">
                            <div class="card-header"><span><i class="fas fa-sticky-note text-yellow-600"></i>QB Notes</span></div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="flex flex-col"><label for="qb-notes-input" class="block text-xs font-medium text-gray-600 mb-1">Enter New Notes:</label><textarea id="qb-notes-input" oninput="updateNotesPreview()" class="w-full p-2 border rounded shadow-inner pa-textarea flex-grow min-h-[250px] bg-white border-yellow-300" placeholder="Enter notes..." disabled></textarea></div>
                                <div class="flex flex-col"><label class="block text-xs font-medium text-gray-600 mb-1">Notes Preview:</label><div class="flex flex-wrap gap-1.5 items-center bg-yellow-100 p-1.5 rounded border border-yellow-200 mb-2"><span class="text-xs font-semibold text-yellow-800">Show:</span><label class="flex items-center space-x-1 text-xs"><input type="checkbox" id="show-new-note" class="form-checkbox h-3 w-3 text-yellow-600 focus:ring-yellow-500 rounded" onchange="updateNotesPreview()" checked><span>New</span></label><label class="flex items-center space-x-1 text-xs"><input type="checkbox" id="show-prev-note" class="form-checkbox h-3 w-3 text-yellow-600 focus:ring-yellow-500 rounded" onchange="updateNotesPreview()" checked><span>Previous</span></label><label class="flex items-center space-x-1 text-xs"><input type="checkbox" id="show-mgr-note" class="form-checkbox h-3 w-3 text-yellow-600 focus:ring-yellow-500 rounded" onchange="updateNotesPreview()" checked><span>Manager</span></label><label class="flex items-center space-x-1 text-xs"><input type="checkbox" id="show-imp-note" class="form-checkbox h-3 w-3 text-yellow-600 focus:ring-yellow-500 rounded" onchange="updateNotesPreview()" checked><span>Important</span></label></div><div id="qb-notes-preview" class="w-full p-3 border rounded shadow-inner bg-white overflow-y-auto text-xs space-y-2 flex-grow min-h-[250px] border-yellow-300"><p class="text-gray-400 italic text-center text-sm mt-4">Notes preview.</p></div></div>
                            </div>
                        </div>
                        <div id="actions-section" class="card p-4">
                            <div class="card-header"><span><i class="fas fa-tasks text-blue-600"></i>Actions</span></div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                                
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
                                        <label class="block pa-label text-blue-800 text-sm mb-1">Follow Up</label>
                                        <input type="date" id="follow-up-date" class="w-full pa-input text-sm mb-1" disabled>
                                        <input type="time" id="follow-up-time" class="w-full pa-input text-sm" disabled>
                                        <button onclick="createCalendarEvent()" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-3 rounded shadow transition-all duration-200 text-xs"><i class="fas fa-calendar-plus mr-1"></i> Add to Calendar</button>
                                    </div>
                                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 h-full pt-2">
                                        <button id="save-button" onclick="handleCustomSave()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 h-10 flex items-center justify-center text-sm" disabled>
                                            <i class="fas fa-save mr-2"></i>Save Changes
                                        </button>
                                        <button id="reset-button" onclick="handleCustomReset()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 h-10 flex items-center justify-center text-sm" disabled>
                                            <i class="fas fa-undo mr-2"></i>Reset
                                        </button>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
                                        <label for="email-template-dropdown" class="block pa-label text-blue-800 text-sm mb-1">Launch Email Template</label>
                                        <select id="email-template-dropdown" class="pa-select text-sm mb-2" disabled>
                                            <option value="Green Category.msg">Green Category.msg</option>
                                            <option value="Green Follow Up Email.msg">Green Follow Up Email.msg</option>
                                            <option value="Green Non-Buy Email.msg">Green Non-Buy Email.msg</option>
                                            <option value="Yellow Non-Buy Email.msg">Yellow Non-Buy Email.msg</option>
                                        </select>
                                        <button onclick="handleActionButtonClick('LaunchEmail')" id="launch-email-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-3 rounded shadow transition-all duration-200 text-xs" disabled>
                                            <i class="fas fa-envelope mr-1"></i> Launch & Save Note
                                        </button>
                                    </div>
                                    
                                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
                                        <label class="block pa-label text-blue-800 text-sm mb-2 text-center">Escalation / Button Requests</label>
                                        <div class="grid grid-cols-3 gap-2">
                                            <button onclick="handleActionButtonClick('Help')" id="help-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-2 rounded-lg shadow text-xs" disabled>Help!</button>
                                            <button onclick="handleActionButtonClick('NoOpp')" id="noopp-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-2 rounded-lg shadow text-xs" disabled>NO OPP</button>
                                            <button onclick="handleActionButtonClick('CloseAccount')" id="close-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-2 rounded-lg shadow text-xs" disabled>Close Account</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="announcements-section" class="card p-4 announcements-expanded">
                            <div class="flex justify-between items-center mb-1"><h3 class="text-sm font-semibold text-slate-700 flex items-center"><i class="fas fa-bullhorn w-4 mr-1.5 text-slate-500"></i>Company Announcements</h3><button onclick="toggleAnnouncements()" id="announcement-toggle-btn" class="text-xs text-blue-600 hover:text-blue-800 font-medium">[Dismiss]</button></div>
                            <div class="marquee-container pt-1"><div class="marquee bg-white rounded border border-slate-200 p-1.5"><p class="marquee-content text-xs text-gray-700 font-medium">Q4 promotions are live!</p></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div> </div> <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
         <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full"> <div class="flex justify-between items-center mb-4"> <h3 id="notification-title" class="text-xl font-bold text-gray-800">Notify</h3> <button onclick="closeNotification()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button> </div> <p id="notification-message" class="text-gray-700">Message.</p> <button onclick="closeNotification()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button> </div>
    </div>

    <div id="mvgo-link-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">MasonvilleGO Launch Complete</h3>
            <p id="mvgo-link-message" class="text-gray-700 mb-6">The note has been saved, and the MasonvilleGO window is open. Please complete your action there.</p>
            <p class="text-sm text-gray-500 italic">This modal will auto-close in 5 seconds.</p>
        </div>
    </div>

    <div id="manager-feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-200 rounded-lg shadow-xl p-6 max-w-2xl w-full border-2 border-red-600">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Manager Feedback</h3>
            <div id="manager-feedback-content" class="bg-white p-4 rounded h-96 overflow-y-auto whitespace-pre-wrap"></div>
            <button onclick="closeManagerFeedback()" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>
    
    <div id="important-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-yellow-100 rounded-lg shadow-xl p-6 max-w-2xl w-full border-2 border-yellow-600">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Important Account Information ⚠️</h3>
            <div id="important-info-content" class="bg-white p-4 rounded h-96 overflow-y-auto whitespace-pre-wrap"></div>
            <button onclick="closeImportantInfo()" class="mt-6 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>


    <script>
        // --- MSAL CONFIG (Needs to be filled in by you) ---
        const msalConfig = {
            auth: {
                clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", 
                authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401",
                redirectUri: "https://WB-DT.github.io/daytona-utility/"
            },
            cache: {
                cacheLocation: "localStorage", 
                storeAuthStateInCookie: false,
            }
        };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null; 
        let msalToken = null; 

        // --- GLOBAL APP STATE ---
        let isEditMode = false;
        let allRecords = [];
        let currentSelectedRecord = null;
        let currentRecordId = null;
        let currentUserRepName = null;
        let clockInterval = null;
        const ANNOUNCEMENT_DISMISSED_KEY = 'announcementDismissed_v5';
        const QB_NOTES_TEMPLATE = `Locations: \nNumber of employees: \nCurrent Vendors: \nFrequency of Orders: \nMonthly spend: \nAnyone involved: \nNext Order Expected: \nOPP: \n`;
        
        // --- FLOW URLS (SAS TOKEN LINKS) ---
        // Flows must be configured to accept 'Anyone' authentication for these links to work.
        const GET_MY_RECORDS_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2d5cc7c0ffa34dcb87e6416df29b9acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8qFD-lNiuxDgafyu31UYZ8zzePJMRJ4wpUzLzbb9bMs";
        const PATCH_RECORD_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/774bb53ee87542e5825b46958f5bd55d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EbaJTl1gKlG8rjTn3ZmoLwUiQ430Sju1kWZYZ6hr0zE";
        const SALES_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a6f98d7dcf0434fa630e691778901bf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=me09n4bmICH84IIjEV0BDzCIeLfhoFdy5f7hB2AEDOw";
        const ACTION_BUTTON_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a2fa2c69f1d24a85a980599d21631808/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aSQ1J4-BFNxrOURAp3-8tCQwunP0JITYHZfWV5BbDYI";

        // --- HELPER FUNCTIONS ---
        const getVal = (obj, key, defaultVal = '') => (obj && obj[key] != null) ? obj[key] : defaultVal;
        const escapeHTML = (str) => { if (!str) return ''; return String(str).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'})[m]); };
        function getElementValue(id) { const el=document.getElementById(id); if(!el){return null;} return el.value?.trim()??el.textContent?.trim()??null; }
        
        // --- AUTHENTICATION FUNCTIONS ---
        async function getFlowToken() {
            // FIX: Bypass the token acquisition that requires Admin Consent,
            // as the Flows are now secured by SAS URLs.
            return null;
        }

        function login() {
            document.getElementById('login-button').disabled = true;
            document.getElementById('login-button').textContent = "Signing in...";
            msalInstance.loginPopup({
                scopes: ["User.Read"] // Only request basic user profile scope
            }).then(handleMsalResponse).catch(err => {
                console.error("MSAL login error:", err);
                showLoginError("Login failed. Please try again.");
            });
        }

        function handleMsalResponse(response) {
            if (response !== null) {
                msalAccount = response.account;
                currentUserRepName = msalAccount.name;
                initializeAppUI();
            }
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('login-error');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
            const loginBtn = document.getElementById('login-button');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fab fa-microsoft mr-3"></i> Sign in with Microsoft';
            }
        }

        function initializeAppUI() {
            console.log(`DEBUG: Initializing main app for ${currentUserRepName}`);
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');

            const welcomeMsg = document.getElementById('welcome-message');
            if (welcomeMsg) {
                welcomeMsg.textContent = `Welcome, ${currentUserRepName.split(' ')[0]}`;
                welcomeMsg.classList.remove('hidden');
            }

            updateFormDisplayMode(); 
            showFormContent(false); 
            setInitialAnnouncementState(); 
            resetSalesDisplay(); 
            startClock();
            console.log("DEBUG: App UI Initialized.");
        }
        
        // --- DATA LOADING & GALLERY (Live Data) ---
        async function loadRecords() {
            console.log(`LIVE: loadRecords called for ${currentUserRepName}`);
            
            showGalleryLoader(true);
            allRecords = [];
            currentSelectedRecord = null;
            currentRecordId = null;
            showFormContent(false);
            resetSalesDisplay();
            
            try {
                console.log("LIVE: Fetching data from Flow:", GET_MY_RECORDS_FLOW_URL);
                
                const response = await fetch(GET_MY_RECORDS_FLOW_URL, { 
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ repName: currentUserRepName })
                });

                if (!response.ok) {
                    throw new Error(`Flow Error: ${response.status} ${response.statusText}`);
                }
                
                // Assuming the flow is correctly sending the clean array back now
                allRecords = await response.json(); 

                console.log(`LIVE: Loaded ${allRecords.length} records.`);
                filterAndSortGallery();
                populateActionFilter(allRecords, 'filter-action-dropdown');
            } catch (e) {
                console.error("LIVE: Error loading records:", e);
                const galleryList = document.getElementById('record-gallery-list');
                if (galleryList) galleryList.innerHTML = `<div class="loader-container"><p class="text-red-600 italic">Error loading records. Check console.</p></div>`;
                showNotification("Data Error", `Failed to load records: ${e.message}.`);
            } finally {
                showGalleryLoader(false);
                console.log("LIVE: loadRecords finished.");
            }
        }
        
        function filterAndSortGallery() {
            // ... (Your previous filter and sort implementation remains here) ...
            
            console.log("LIVE: filterAndSort.");
            const searchValue = getElementValue('search-bar')?.toLowerCase() || '';
            const sortValue = getElementValue('sort-dropdown') || 'company-asc';
            const filterValue = getElementValue('filter-action-dropdown') || ''; 
            const filterFollowUp = document.getElementById('filter-followup')?.checked || false;
            const filterNoNotes = document.getElementById('filter-nonotes')?.checked || false;
            const filterRequests = document.getElementById('filter-requests')?.checked || false;
            
            if (!Array.isArray(allRecords)) {
                renderGallery([]);
                return;
            }
            
            let filtered = allRecords.filter(record => 
                (filterRecordPredicate(record, searchValue)) &&
                (filterValue === '' || getVal(record, 'cr714_action') === filterValue) &&
                (!filterFollowUp || (getVal(record, 'cr714_followup') || '').trim() !== '') &&
                (!filterNoNotes || (getVal(record, 'cr714_qbnotes', '') || '').trim() === QB_NOTES_TEMPLATE.trim()) &&
                (!filterRequests || (getVal(record, 'cr714_recordviability', '') || '').trim() !== '') // Assuming viability field indicates a button request status
            );
            
            filtered.sort((a, b) => {
                const cA = getVal(a, 'cr714_company', '').toLowerCase();
                const cB = getVal(b, 'cr714_company', '').toLowerCase();
                const dA = parseInt(getVal(a, 'cr714_dayssincelastorder', 9999), 10);
                const dB = parseInt(getVal(b, 'cr714_dayssincelastorder', 9999), 10);
                const idA = String(getVal(a, 'cr714_id', ''));
                const idB = String(getVal(b, 'cr714_id', ''));
                const repA = String(getVal(a, 'cr714_accountrep') || getVal(a, 'cr714_retentionrep', '')).toLowerCase();
                const repB = String(getVal(b, 'cr714_accountrep') || getVal(b, 'cr714_retentionrep', '')).toLowerCase();
                const classA = String(getVal(a, 'cr714_customerclassification', '')).toLowerCase();
                const classB = String(getVal(b, 'cr714_customerclassification', '')).toLowerCase();
                const followA = getVal(a, 'cr714_followup');
                const followB = getVal(b, 'cr714_followup');
                const dateA_val = followA ? new Date(followA).getTime() : Infinity;
                const dateB_val = followB ? new Date(followB).getTime() : Infinity;
                const dateA_desc = followA ? new Date(followA).getTime() : -Infinity;
                const dateB_desc = followB ? new Date(followB).getTime() : -Infinity;

                switch (sortValue) {
                    case 'company-desc': return cB.localeCompare(cA);
                    case 'days-asc': return dA - dB;
                    case 'days-desc': return dB - dA;
                    case 'account-asc': return idA.localeCompare(idB, undefined, {numeric: true});
                    case 'account-desc': return idB.localeCompare(idA, undefined, {numeric: true});
                    case 'rep-asc': return repA.localeCompare(repB);
                    case 'rep-desc': return repB.localeCompare(repA);
                    case 'classification-asc': return classA.localeCompare(classB);
                    case 'classification-desc': return classB.localeCompare(classA);
                    case 'followup-asc': return dateA_val - dateB_val;
                    case 'followup-desc': return dateB_desc - dateA_desc;
                    case 'company-asc': default: return cA.localeCompare(cB);
                }
            });
            
            renderGallery(filtered);
            // After filtering/sorting, ensure the currently selected record is the pinned one, or clear the form if it was filtered out
            const pinnedRecord = allRecords.find(r => String(getVal(r, 'cr714_id')) === currentRecordId);
            if (!pinnedRecord || !filtered.find(r => String(getVal(r, 'cr714_id')) === currentRecordId)) {
                 selectRecord(null);
            } else if(currentRecordId) {
                // Re-select to ensure form is populated with fresh data and correct selection state
                selectRecord(currentRecordId);
            }
        }
        
        function selectRecord(recordId) {
            // ... (Your existing selectRecord logic) ...
            console.log(`LIVE: selectRecord id: ${recordId}`);
            
            // Clear current selection state if null or not found
            if (!recordId) { 
                currentSelectedRecord = null;
                currentRecordId = null;
                showFormContent(false);
                resetSalesDisplay();
                const acctHeader = document.getElementById('acct-number-header');
                if (acctHeader) acctHeader.textContent = '--';
                document.querySelectorAll('#record-gallery-list .gallery-item').forEach(i => i.classList.remove('is-selected'));
                return;
            }
            
            const idStr = String(recordId);
            currentSelectedRecord = allRecords.find(r => String(getVal(r, 'cr714_id')) === idStr);
            currentRecordId = currentSelectedRecord ? idStr : null;
            
            document.querySelectorAll('#record-gallery-list .gallery-item').forEach(i => i.classList.toggle('is-selected', i.getAttribute('data-id') === currentRecordId));
            
            if (currentSelectedRecord) {
                try {
                    populateForm(currentSelectedRecord);
                    loadSalesData(currentRecordId);
                    showFormContent(true);
                } catch (e) {
                    console.error("Error populating form:", e);
                    showNotification("Display Error", `Could not display record details: ${e.message}`);
                    showFormContent(false);
                }
            } else {
                showFormContent(false);
                resetSalesDisplay();
                const acctHeader = document.getElementById('acct-number-header');
                if (acctHeader) acctHeader.textContent = '--';
            }
            isEditMode = false;
            updateFormDisplayMode();
        }

        // --- FORM ACTIONS (Live Data) ---
        async function handleCustomSave() {
            console.log("LIVE: handleCustomSave.");
            if (!currentSelectedRecord || !isEditMode) return;
            
            // 0. Note Check (as per PowerApps logic, checking for placeholder or empty note)
            let newNotesInput = getElementValue('qb-notes-input');
            let strippedNotes = newNotesInput.replace(QB_NOTES_TEMPLATE, '').trim();

            if (!strippedNotes) {
                 showNotification("Note Required", "Please enter new notes in the 'Enter New Notes' box before saving.");
                 return;
            }

            const now = new Date();
            const timestamp = now.toLocaleString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const oldNotes = getVal(currentSelectedRecord, 'cr714_qbnotes', '');
            
            // 1. Construct the new, fully formatted note string (mimicking PowerApps Concatenate/Char(10)/Char(13))
            const formattedNewNote = 
                `------------------------------\r\n` +
                `Modified On: ${timestamp.replace(',', '')}\r\n` + 
                `Modified By: ${currentUserRepName}\r\n` + 
                `\n${strippedNotes}\r\n\n`;

            const dataToSave = {
                recordId: currentRecordId,
                // Patch combines the new note with the existing notes, separated by separators
                // The flow needs to handle pre-pending this string to the existing data.
                // We send the new note content, formatted with separators for the Flow to prepend.
                qbNotes: formattedNewNote + oldNotes, // The JS concatenates the string for the flow to set it
                
                followUp: null, // Default to null/no update unless date/time is set
                
                // Updatable fields
                nameMost: getElementValue('contact-name-most'),
                nameLatest: getElementValue('contact-name-latest'),
                primaryPhone: getElementValue('contact-phone-primary'),
                emailMost: getElementValue('contact-email-most'),
                emailLatest: getElementValue('contact-email-latest'),
                
                // Pass Rep name for server-side logic/logging
                repName: currentUserRepName 
            };
            
            // 2. Process Follow-up Date/Time
            const dateStr = getElementValue('follow-up-date');
            const timeStr = getElementValue('follow-up-time');
            if (dateStr && timeStr) {
                // Convert to ISO 8601 string for Dataverse (Flow can parse this)
                dataToSave.followUp = `${dateStr}T${timeStr}:00Z`;
            } else if (dateStr) {
                 // Date selected, but time not set - set to default start of day (00:00:00)
                 dataToSave.followUp = `${dateStr}T00:00:00Z`;
            }

            try {
                showNotification("Saving...", "Please wait. This may take a moment to update the record.");
                const response = await fetch(PATCH_RECORD_FLOW_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSave)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Flow Error ${response.status}: ${errorText || response.statusText}`);
                }
                
                const updatedRecord = await response.json(); 
                showNotification("Save Successful", "Record and notes updated!");
                isEditMode = false;
                updateFormDisplayMode();
                
                // Update local record data in the cache (allRecords array)
                const index = allRecords.findIndex(r => String(getVal(r, 'cr714_id')) === currentRecordId);
                if (index !== -1 && updatedRecord) {
                    // Assuming the flow returns the updated record fields in 'updatedRecord'
                    Object.assign(allRecords[index], updatedRecord); 
                    currentSelectedRecord = allRecords[index];
                    filterAndSortGallery(); // Re-render gallery with new notes/followup
                    populateForm(currentSelectedRecord); // Re-populate form with fresh server data
                } else {
                     await loadRecords(); // Fallback to full reload
                }
                
            } catch (e) {
                console.error("LIVE: Error saving record:", e);
                showNotification("Save Failed", `Could not save record: ${e.message}.`);
            }
        }
        
        async function handleActionButtonClick(actionType) {
            console.log(`LIVE: handleActionButtonClick: ${actionType}`);
            if (!currentSelectedRecord || !isEditMode) { showNotification("Info", "Select a record and enable edit mode first."); return; }

            const accountId = currentRecordId;
            const repName = currentUserRepName;
            const company = getVal(currentSelectedRecord, 'cr714_company', 'N/A');
            const accountNum = getVal(currentSelectedRecord, 'cr714_id', 'N/A');
            const notes = getElementValue('qb-notes-input').replace(QB_NOTES_TEMPLATE, '').trim();
            const email = getVal(currentSelectedRecord, 'cr714_emailmost') || getVal(currentSelectedRecord, 'cr714_emaillatest');

            if (actionType !== 'LaunchEmail' && !notes) {
                showNotification("Note Required", "Please enter a note in the 'Enter New Notes' box before submitting an action.");
                return;
            }

            const dataToFlow = {
                recordId: accountId,
                action: actionType,
                notes: notes, // Flow needs to handle pre-pending this to existing notes
                repName: repName,
            };

            // 1. MVGO Link Launch (If applicable)
            if (actionType === 'LaunchEmail') {
                const template = getElementValue('email-template-dropdown');
                dataToFlow.emailTemplate = template;

                let subject = `WB Mason -- ACC# ${accountNum} // ${company}`;
                let body = `Good Morning/Afternoon,\r\n\r\n[Your message here]\r\n\r\n`;

                if (template.includes("Non-Buy")) {
                    subject = `WB Mason, Price Match Program--ACC# ${accountNum} // ${company}`;
                    body = `Good Morning/Afternoon!\r\n\r\nI am reaching out to you today from our retention department. It is my responsibility to ensure your company has the best experience possible.\r\n\r\nI would like for W.B Mason to be a one-stop-shop for all your business needs.\r\n\r\nBefore your next order with my competitor, send me any recent order confirmations or their shopping cart from them and I will at least match any pricing if I am not already lower.\r\n\r\nIf orders are ever time sensitive, reach out to me so we can confirm availability and explore alternative options if need be.\r\n\r\nOnce the order is in the system, we can start tracking shortly after.\r\n\r\n**Just for the opportunity to show you better pricing on the items you buy from my competitors, we will be giving you 15% off your next order of those items.**\r\n\r\n${template.includes('Yellow') ? '**With that said, what would be a good date and time to connect with you regarding your account?**' : ''}`;
                } else if (template.includes("Follow Up")) {
                    body = `Good Morning/Afternoon!\r\n\r\nI was unable to reach you today. When we spoke, you stated that you would review my email and provide a list of items you are purchasing from my competitors for us to quote.\r\n\r\nI have not heard from you and wanted to follow up on this to see if you have gotten the chance to review.\r\n\r\nWill you be able to send over items to quote before your next office supply order so you can start saving sooner than later?\r\n\r\nWe did discuss some items you are ordering elsewhere. Below is some of the pricing we offer for the commonly ordered items of that category.\r\n\r\n[Insert image of PPL category here]\r\n\r\nWhen can I expect to see that list to get started on your savings?`;
                }

                try {
                    const mailtoLink = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.open(mailtoLink, '_blank');
                    showNotification("Email Launched", `Mail client opened for ${template}. Now logging note via Flow...`);
                } catch (e) {
                    console.error("Mailto link failed:", e);
                    showNotification("Email Error", "Could not open mail client. Please send manually. Still logging note via Flow...");
                }
            }
            
            // 2. Flow Call to log action/update status
            try {
                const response = await fetch(ACTION_BUTTON_FLOW_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToFlow)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Flow Error ${response.status}: ${errorText || response.statusText}`);
                }
                
                const updatedRecord = await response.json(); 
                showNotification("Action Logged", `${actionType} request logged and notes saved.`);
                
                // Update local record data
                const index = allRecords.findIndex(r => String(getVal(r, 'cr714_id')) === accountId);
                if (index !== -1 && updatedRecord) {
                    Object.assign(allRecords[index], updatedRecord); 
                    currentSelectedRecord = allRecords[index];
                    filterAndSortGallery();
                    populateForm(currentSelectedRecord);
                } else {
                    await loadRecords();
                }
                
                // Reset notes input after successful submission
                document.getElementById('qb-notes-input').value = QB_NOTES_TEMPLATE;
                updateNotesPreview();
                
            } catch (e) {
                console.error("LIVE: Error with action button:", e);
                showNotification("Action Failed", `Could not process action: ${e.message}.`);
            }
        }
        
        function createCalendarEvent() {
            // NOTE: Client-side calendar creation requires Outlook API access, which is too complex for this standalone HTML file.
            // Power Apps handles this using Office365Outlook.V4CalendarPostItem.
            showNotification("Calendar Event", "To use the calendar function, copy the date/time and manually create the event in Outlook/Teams.");
        }

        // --- NOTES PREVIEW (Power Apps HTML Text emulation) ---
        function updateNotesPreview() {
            const previewBox = document.getElementById('qb-notes-preview');
            if (!previewBox) return;
            
            const showNew = document.getElementById('show-new-note')?.checked;
            const showPrev = document.getElementById('show-prev-note')?.checked;
            const showMgr = document.getElementById('show-mgr-note')?.checked;
            const showImp = document.getElementById('show-imp-note')?.checked;
            
            const newNotesInput = getElementValue('qb-notes-input');
            const newNotesText = newNotesInput ? newNotesInput.replace(QB_NOTES_TEMPLATE, '').trim() : '';
            
            const prevNotes = getVal(currentSelectedRecord, 'cr714_qbnotes', '');
            const mgrNotes = getVal(currentSelectedRecord, 'cr714_managernotes', '');
            const impInfo = getVal(currentSelectedRecord, 'cr714_importantaccountinformation', '');
            
            let html = '';
            let hasContent = false;
            
            const now = new Date();
            const timestamp = now.toLocaleString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });

            // 1. New Note Preview
            if (showNew && newNotesText) {
                const lines = newNotesText.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
                const content = lines.map(line => `<pre style="white-space: pre-wrap; margin: 0; font-size: 0.8rem;">${escapeHTML(line)}</pre>`).join('');

                html += `<div class="note-preview-item" style="background-color:#e6f7ff; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <h4><i class="fas fa-pencil-alt text-blue-500"></i>New Note Preview (${escapeHTML(timestamp.replace(',', ''))} - ${escapeHTML(currentUserRepName || 'Current User')})</h4>
                    ${content}
                </div>`;
                hasContent = true;
            }

            // 2. Previous Notes
            if (showPrev && prevNotes) {
                html += `<div class="note-preview-item" style="background-color:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <h4><i class="fas fa-history text-gray-500"></i>Previous QB Notes</h4>
                    <pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; font-size: 0.8rem; color: #57534e;">${escapeHTML(prevNotes)}</pre>
                </div>`;
                hasContent = true;
            }
            
            // 3. Manager Notes
            if (showMgr && mgrNotes) {
                html += `<div class="note-preview-item" style="background-color:#e8ffe8; padding:10px; border-radius:5px; margin-bottom:10px; border: 1px solid #bbf7d0;">
                    <h4><i class="fas fa-user-tie text-green-600"></i>Manager Notes</h4>
                    <pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; font-size: 0.8rem; color: #064e3b;">${escapeHTML(mgrNotes)}</pre>
                </div>`;
                hasContent = true;
            }
            
            // 4. Important Info
            if (showImp && impInfo) {
                html += `<div class="note-preview-item" style="background-color:#fff4e6; padding:10px; border-radius:5px; margin-bottom:10px; border: 1px solid #fde047;">
                    <h4><i class="fas fa-exclamation-triangle text-red-500"></i>Important Info</h4>
                    <pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; font-size: 0.8rem; color: #9a3412;">${escapeHTML(impInfo)}</pre>
                </div>`;
                hasContent = true;
                // Automatically show the popup if this section is visible in the data
                document.getElementById('important-info-content').textContent = impInfo;
                document.getElementById('important-info-modal').classList.remove('hidden');
            }

            previewBox.innerHTML = hasContent ? html : '<p class="text-gray-400 italic text-center text-sm mt-4">No notes to display based on filters.</p>';
        }

        // --- MODAL FUNCTIONS ---
        function showManagerFeedback() {
            if (!currentSelectedRecord) return;
            const mgrNotes = getVal(currentSelectedRecord, 'cr714_managernotes', 'No manager feedback available for this account.');
            document.getElementById('manager-feedback-content').textContent = mgrNotes;
            document.getElementById('manager-feedback-modal').classList.remove('hidden');
        }

        function closeManagerFeedback() {
            document.getElementById('manager-feedback-modal').classList.add('hidden');
        }

        function closeImportantInfo() {
            document.getElementById('important-info-modal').classList.add('hidden');
        }

        // --- CLOCK (Shared) ---
        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            updateClock();
            clockInterval = setInterval(updateClock, 1000); // Update every second
        }
        
        function updateClock() {
            const clockEl = document.getElementById('clock-display');
            const now = new Date();
            const timeStr = `${now.toLocaleDateString([], {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})} ${now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
            if (clockEl) clockEl.textContent = timeStr;
        }

        // --- OTHER UI (Live Data) ---
        function showNotification(title, message) { 
            const m = document.getElementById('notification-modal'); 
            const t = document.getElementById('notification-title'); 
            const msg = document.getElementById('notification-message'); 
            if (m && t && msg) { 
                t.textContent = title; 
                msg.innerHTML = message; 
                m.classList.remove('hidden'); 
                // Set timeout to auto-close standard notifications
                if (title !== "MVGO Link Launched" && title !== "Saving...") {
                    setTimeout(closeNotification, 5000);
                }
            } else { 
                console.log("NOTIFICATION:", title, message);
            } 
        }
        
        function closeNotification() { 
            const m = document.getElementById('notification-modal'); 
            if (m) m.classList.add('hidden'); 
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG: DOM Loaded. v4.0 (Standalone).");
            msalInstance.handleRedirectPromise().then(handleMsalResponse).catch(err => {
                console.error("MSAL redirect error:", err);
                showLoginError("Error during login redirect. See console.");
            });

            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                msalAccount = accounts[0];
                currentUserRepName = msalAccount.name;
                initializeAppUI();
            } else {
                console.log("DEBUG: No cached user found. Showing login screen.");
            }
        });
    </script>
</body>
</html>
