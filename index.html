<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daytona Account Utility v4.0 (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #e2e8f0; 
            padding: 1rem; 
        }
        /* --- Global Styles --- */
        .card { 
            background-color: #fff; 
            border: 1px solid #94a3b8;
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06); 
            margin-bottom: 1rem; 
        }
        .card-header { font-size: 1rem; font-weight: 600; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between; }
        .card-header i { margin-right: 0.5rem; color: #475569; width: 1.25rem; }
        .pa-label { color: #166534; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.1rem; text-transform: uppercase; letter-spacing: 0.025em; }
        .pa-input, .pa-textarea, .pa-select { box-sizing: border-box; border-color: #cbd5e1; background-color: #f8fafc; font-size: 0.875rem; padding: 0.5rem 0.75rem; border-width: 1px; border-radius: 0.375rem; width: 100%; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .pa-input:focus, .pa-textarea:focus, .pa-select:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); border-color: #3b82f6; outline: none; background-color: #fff; }
        
        /* --- Layout Overrides (Full Width) --- */
        .main-content-wrapper { 
            display: grid; 
            grid-template-columns: 320px 1fr; /* Fixed left column, flexible right */
            gap: 1.5rem; 
            width: 100%;
        }
        
        .left-column-container { 
            height: calc(100vh - 80px); 
            display: grid; 
            grid-template-rows: 300px 1fr; /* Gallery (300px) + Sales (Rest of space) */
            gap: 1rem; 
            background-color: transparent; 
            border: none;
            padding: 0;
        }

        .gallery-section .card { 
            height: 100%; 
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
        }

        .record-gallery-list { 
            max-height: 250px; 
            overflow-y: auto;
            display: flex; 
            flex-direction: column; 
            gap: 0.3rem; 
            padding-right: 2px;
        }

        .right-column-container { 
            height: calc(100vh - 80px); 
            overflow-y: auto; 
            padding-right: 5px; 
            background-color: transparent; 
        }

        /* --- Sticky Contact Header (Crucial for the requested behavior) --- */
        #contact-sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #e2e8f0; 
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
        }
        
        /* --- Sales Advisory Marquee --- */
        #sales-advisory-marquee {
            overflow: hidden;
            background-color: #fee2e2;
            border: 1px solid #f87171;
            padding: 4px 0;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            box-shadow: none;
        }
        #sales-advisory-marquee .marquee-content {
            animation: marquee 15s linear infinite;
            color: #b91c1c; 
            font-weight: 600;
        }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- Other Aesthetics --- */
        .editable-field { box-sizing: border-box; }
        #notes-section .note-preview-item pre { white-space: pre-wrap; font-family: monospace; font-size: 0.8rem; color: #57534e; }
        
        /* FIX: Ensure sales category list scrolls correctly */
        #sales-category-list {
            max-height: 15rem; 
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-0 md:p-4">

    <div id="login-container" class="fixed inset-0 bg-slate-900 bg-opacity-90 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <i class="fas fa-lock text-5xl text-blue-600 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Daytona Account Utility</h3>
            <p class="text-gray-700 mb-6">Please log in with your Microsoft account to continue.</p>
            <button onclick="login()" id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center text-lg">
                <i class="fab fa-microsoft mr-3"></i>
                Sign in with Microsoft
            </button>
            <p id="login-error" class="text-red-600 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <div id="main-app-container" class="hidden">

        <div id="header-panel" class="header-panel p-3 shadow-md mb-4 sticky top-0 z-20 bg-white w-full">
            <div class="flex flex-wrap items-center justify-between gap-3 px-4 md:px-0">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold text-gray-800 whitespace-nowrap"><i class="fas fa-list-ul text-blue-600 mr-1"></i>My Accounts</h2>
                    <button onclick="loadRecords()" id="load-records-button" class="py-1 px-3 text-sm rounded-md shadow transition-all duration-200 font-bold bg-green-600 text-white hover:bg-green-700">
                        <i class="fas fa-sync mr-1"></i> Load My Records
                    </button>
                    <span id="welcome-message" class="text-sm text-gray-600 hidden"></span>
                </div>
                <div class="flex-grow min-w-[200px] max-w-xs relative">
                    <input type="text" id="search-bar" onkeyup="filterAndSortGallery()" placeholder="Search accounts..." class="pa-input pl-10 w-full text-sm" />
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <select id="sort-dropdown" onchange="filterAndSortGallery()" class="pa-select text-xs">
                        <option value="company-asc">Sort: Company A-Z</option>
                        <option value="followup-asc">Sort: Follow Up &#x2191;</option>
                        <option value="days-asc">Sort: Days Since Order &#x2191;</option>
                        <option value="rep-asc">Sort: Rep A-Z</option>
                        <option value="classification-asc">Sort: Classification A-Z</option>
                    </select>
                    <select id="filter-action-dropdown" onchange="filterAndSortGallery()" class="pa-select text-xs" disabled>
                        <option value="">Filter: All Actions</option>
                    </select>
                </div>
                <div class="flex items-center gap-3 flex-wrap border-l pl-3 ml-1">
                    <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                        <input type="checkbox" id="filter-followup" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                        <span>Show Follow Ups</span>
                    </label>
                     <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                        <input type="checkbox" id="filter-nonotes" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                        <span>No Notes</span>
                    </label>
                     <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                        <input type="checkbox" id="filter-requests" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                        <span>Button Requests</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="main-content-wrapper-live" class="main-content-wrapper w-full px-4 md:px-0">
            
            <div id="left-column-container" class="left-column-container">
                
                <div id="gallery-section" class="card p-3 flex flex-col min-h-0">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2 pb-1 border-b border-gray-200 flex-shrink-0 whitespace-nowrap">Account List</h3>
                    <div id="record-gallery-list" class="record-gallery-list flex-grow min-h-0">
                        <div id="gallery-loader" class="loader-container"><span class="italic text-gray-500">Loading records automatically...</span></div>
                    </div>
                </div>
                
                <div id="sales-data-container" class="card p-3 flex-grow min-h-0">
                    <h3 class="text-base font-semibold text-green-800 mb-3 pb-2 border-b border-green-200 flex items-center"><i class="fas fa-chart-line w-4 mr-2 text-green-600"></i>Sales Snapshot</h3>
                    
                    <div id="sales-advisory-marquee" style="max-height: 20px; transition: none;">
                        <div class="marquee"><p class="marquee-content">Invoiced Sales Only - May Not Include Open Orders!</p></div>
                    </div>
                    
                    <div id="sales-loader" class="loader-container text-xs italic text-gray-500 py-2 hidden"><span>Loading sales...</span></div>
                    <div id="sales-content" class="space-y-3 hidden">
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-1"><div><dt class="sales-dt">YTD Sales</dt><dd class="sales-dd" id="sales-ytd">--</dd></div><div><dt class="sales-dt">Total Orders</dt><dd class="sales-dd" id="sales-total-orders">--</dd></div><div class="col-span-2"><dt class="sales-dt">Last Order Date</dt><dd class="sales-dd" id="sales-last-order">--</dd></div></dl>
                        <div id="sales-category-section" class="pt-2 border-t border-green-100"><h4 class="text-xs font-semibold text-green-700 mb-1">By Category:</h4><ul id="sales-category-list" class="space-y-0.5 pr-1" style="max-height: 15rem; overflow-y: auto;"><li class="sales-category-item italic text-gray-400">No category data</li></ul></div>
                        <div id="live-clock-container" class="live-clock-container"><h4 class="text-xs font-semibold text-gray-500 mb-1 flex items-center"><i class="far fa-clock w-3 mr-1.5 text-gray-400"></i>Current Time</h4><div id="clock-display" class="text-xs text-gray-700 font-medium">--</div></div>
                    </div>
                    <div id="sales-placeholder" class="text-xs text-gray-400 italic text-center py-4">Select an account</div>
                </div>
            </div>
            
            <div id="right-column-container" class="right-column-container">
                <div class="space-y-4">
                     
                    <div id="profile-card" class="card p-4">
                        <div class="card-header">
                            <span>
                                <i class="fas fa-id-card text-blue-600"></i>Account Profile - 
                                <span id="acct-number-header" class="font-bold text-blue-700">--</span>
                            </span>
                            <div class="flex items-center gap-2">
                                <button onclick="showManagerFeedback()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg shadow transition-all duration-200 text-xs flex-shrink-0" id="manager-feedback-btn">Manager Feedback</button>
                                <button onclick="showImportantInfo()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg shadow transition-all duration-200 text-xs flex-shrink-0" id="important-info-btn">Important Info</button>
                                <button onclick="toggleEditMode()" id="editModeButton" class="py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold bg-gray-200 text-gray-700 hover:bg-gray-300" disabled><i class="fas fa-pencil-alt mr-1"></i> Edit Profile</button>
                            </div>
                        </div>
                        
                        <div id="contact-sticky-header">
                            <h3 class="text-sm font-semibold text-blue-700 mb-2 flex items-center"><i class="fas fa-users w-4 mr-1.5"></i>Contact Details (Sticky)</h3>
                            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
                                <div><dt class="profile-dt">Primary Contact (Most)</dt><dd><input type="text" id="contact-name-most" class="editable-field" value="--" disabled></dd></div>
                                <div><dt class="profile-dt">Recent Contact (Latest)</dt><dd><input type="text" id="contact-name-latest" class="editable-field" value="--" disabled></dd></div>
                                <div><dt class="profile-dt">Primary Phone</dt><dd><input type="text" id="contact-phone-primary" class="editable-field" value="--" disabled></dd></div>
                                <div><dt class="profile-dt">Days Since Last Order</dt><dd class="profile-dd" id="acct-days-last-order">--</dd></div>
                                <div><dt class="profile-dt">Primary Email (Most)</dt><dd><input type="email" id="contact-email-most" class="editable-field" value="--" disabled></dd></div>
                                <div><dt class="profile-dt">Recent Email (Latest)</dt><dd><input type="email" id="contact-email-latest" class="editable-field" value="--" disabled></dd></div>
                            </dl>
                        </div>
                        
                        <div class="mt-4 pt-3"><h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center"><i class="fas fa-building w-4 mr-1.5"></i>Account Details</h3><dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1"><div><dt class="profile-dt">Company</dt><dd class="profile-dd" id="acct-company">--</dd></div><div><dt class="profile-dt">Classification</dt><dd class="profile-dd" id="acct-classification">--</dd></div><div class="sm:col-span-2"><dt class="profile-dt">Billing Address</dt><dd class="profile-dd whitespace-pre-line" id="acct-billing-address">--</dd></div></dl></div>
                        <div class="mt-4 border-t pt-3"><h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center"><i class="fas fa-briefcase w-4 mr-1.5"></i>Internal Assignment (Read-Only)</h3><dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1"><div><dt class="profile-dt">Account Rep</dt><dd class="profile-dd" id="internal-acct-rep">--</dd></div><div><dt class="profile-dt">Retention Rep</dt><dd class="profile-dd" id="internal-retention-rep">--</dd></div></dl></div>
                    </div>
                    
                    <div id="actions-section" class="card p-4">
                        <div class="card-header"><span><i class="fas fa-tasks text-blue-600"></i>Actions</span></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
                                    <label class="block pa-label text-blue-800 text-sm mb-1">Follow Up</label>
                                    <input type="date" id="follow-up-date" class="w-full pa-input text-sm mb-1" disabled>
                                    <input type="time" id="follow-up-time" class="w-full pa-input text-sm" disabled>
                                    <button onclick="createCalendarEvent()" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-3 rounded shadow transition-all duration-200 text-xs"><i class="fas fa-calendar-plus mr-1"></i> Add to Calendar</button>
                                </div>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 h-full pt-2">
                                    <button id="save-button" onclick="handleCustomSave()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 h-10 flex items-center justify-center text-sm" disabled>
                                        <i class="fas fa-save mr-2"></i>Save Changes
                                    </button>
                                    <button id="reset-button" onclick="handleCustomReset()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 h-10 flex items-center justify-center text-sm" disabled>
                                        <i class="fas fa-undo mr-2"></i>Reset
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
                                    <label for="email-template-dropdown" class="block pa-label text-blue-800 text-sm mb-1">Launch Email Template</label>
                                    <select id="email-template-dropdown" class="pa-select text-sm mb-2" disabled>
                                        <option value="Green Category.msg">Green Category.msg</option>
                                        <option value="Green Follow Up Email.msg">Green Follow Up Email.msg</option>
                                        <option value="Green Non-Buy Email.msg">Green Non-Buy Email.msg</option>
                                        <option value="Yellow Non-Buy Email.msg">Yellow Non-Buy Email.msg</option>
                                    </select>
                                    <button onclick="handleActionButtonClick('LaunchEmail')" id="launch-email-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-3 rounded shadow transition-all duration-200 text-xs" disabled>
                                        <i class="fas fa-envelope mr-1"></i> Launch & Save Note
                                    </button>
                                </div>
                                
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
                                    <label class="block pa-label text-blue-800 text-sm mb-2 text-center">Escalation / Button Requests</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="handleActionButtonClick('Help')" id="help-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-2 rounded-lg shadow text-xs" disabled>Help!</button>
                                        <button onclick="handleActionButtonClick('NoOpp')" id="noopp-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-2 rounded-lg shadow text-xs" disabled>NO OPP</button>
                                        <button onclick="handleActionButtonClick('CloseAccount')" id="close-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-2 rounded-lg shadow text-xs" disabled>Close Account</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="notes-section" class="card p-4">
                        <div class="card-header"><span><i class="fas fa-sticky-note text-yellow-600"></i>QB Notes</span></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="flex flex-col">
                                <label for="qb-notes-input" class="block text-xs font-medium text-gray-600 mb-1">Enter New Notes:</label>
                                <textarea id="qb-notes-input" oninput="updateNotesPreview()" class="w-full p-2 border rounded shadow-inner pa-textarea flex-grow min-h-[250px] bg-white border-yellow-300" placeholder="Enter notes..." disabled></textarea>
                            </div>
                            <div class="flex flex-col">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Notes Preview/AI Summary:</label>
                                <div id="qb-notes-preview" class="w-full p-3 border rounded shadow-inner bg-white overflow-y-auto text-xs space-y-2 flex-grow min-h-[250px] border-yellow-300">
                                    <p class="text-gray-400 italic text-center text-sm mt-4">No notes selected.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="announcements-section" class="card p-4 announcements-expanded">
                        <div class="flex justify-between items-center mb-1"><h3 class="text-sm font-semibold text-slate-700 flex items-center"><i class="fas fa-bullhorn w-4 mr-1.5 text-slate-500"></i>Company Announcements</h3><button onclick="toggleAnnouncements()" id="announcement-toggle-btn" class="text-xs text-blue-600 hover:text-blue-800 font-medium">[Dismiss]</button></div>
                        <div class="marquee-container pt-1"><div class="marquee"><p class="marquee-content text-xs text-gray-700 font-medium">Q4 promotions are live!</p></div></div>
                    </div>
                </div>
            </div>
        </div> </div> <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
         <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full"> <div class="flex justify-between items-center mb-4"> <h3 id="notification-title" class="text-xl font-bold text-gray-800">Notify</h3> <button onclick="closeNotification()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button> </div> <p id="notification-message" class="text-gray-700">Message.</p> <button onclick="closeNotification()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button> </div>
    </div>
    
    <div id="manager-feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-200 rounded-lg shadow-xl p-6 max-w-2xl w-full border-2 border-red-600">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Manager Feedback</h3>
            <div id="manager-feedback-content" class="bg-white p-4 rounded h-96 overflow-y-auto whitespace-pre-wrap"></div>
            <button onclick="closeManagerFeedback()" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>

    <div id="important-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-yellow-100 rounded-lg shadow-xl p-6 max-w-2xl w-full border-2 border-yellow-600">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Important Account Information ⚠️</h3>
            <div id="important-info-content" class="bg-white p-4 rounded h-96 overflow-y-auto whitespace-pre-wrap"></div>
            <button onclick="closeImportantInfo()" class="mt-6 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>

    <script>
        // ====================================================================
        // --- 1. GLOBAL CONFIG & STATE ---
        // ====================================================================

        const msalConfig = {
            auth: {
                clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", 
                authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401",
                redirectUri: "https://WB-DT.github.io/daytona-utility/"
            },
            cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
        };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null; 
        let msalToken = null; 

        let isEditMode = false;
        let allRecords = [];
        let currentSelectedRecord = null;
        let currentRecordId = null;
        let currentUserRepName = null;
        let clockInterval = null;
        const ANNOUNCEMENT_DISMISSED_KEY = 'announcementDismissed_v5';
        const QB_NOTES_TEMPLATE = `Locations: \nNumber of employees: \nCurrent Vendors: \nFrequency of Orders: \nMonthly spend: \nAnyone involved: \nNext Order Expected: \nOPP: \n`;
        
        // --- FLOW URLS (SAS TOKEN LINKS) ---
        const GET_MY_RECORDS_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2d5cc7c0ffa34dcb87e6416df29b9acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8qFD-lNiuxDgafyu31UYZ8zzePJMRJ4wpUzLzbb9bMs";
        const PATCH_RECORD_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/774bb53ee87542e5825b46958f5bd55d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EbaJTl1gKlG8rjTn3ZmoLwUiQ430Sju1kWZYZ6hr0zE";
        const SALES_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a6f98d7dcf0434fa630e691778901bf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=me09n4bmICH84IIjEV0BDzCIeLfhoFdy5f7hB2AEDOw";
        const ACTION_BUTTON_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a2fa2c69f1d24a85a980599d21631808/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aSQ1J4-BFNxrOURAp3-8tCQwunP0JITYHZfWV5BbDYI";

        // ====================================================================
        // --- 2. CORE FUNCTIONS (DEFINITIVE GLOBAL HOISTING FIX) ---
        // ====================================================================
        
        // --- Global Utilities ---
        const getVal = (obj, key, defaultVal = '') => (obj && obj[key] != null) ? obj[key] : defaultVal;
        const escapeHTML = (str) => { if (!str) return ''; return String(str).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'})[m]); };
        function getElementValue(id) { const el=document.getElementById(id); if(!el){return null;} return el.value?.trim()??el.textContent?.trim()??null; }
        
        // --- Authentication & App Lifecycle ---

        function login() {
            document.getElementById('login-button').disabled = true;
            document.getElementById('login-button').textContent = "Signing in...";
            
            msalInstance.loginPopup({ scopes: ["User.Read"] })
                .then(handleMsalResponse)
                .catch(err => {
                    console.error("MSAL login error:", err);
                    showLoginError("Login failed. Please try again.");
                });
        }
        
        function handleMsalResponse(response) {
            if (response && response.account) {
                msalAccount = response.account;
                currentUserRepName = msalAccount.name;
                initializeAppUI();
            } else {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    msalAccount = accounts[0];
                    currentUserRepName = msalAccount.name;
                    initializeAppUI();
                } else {
                     console.log("DEBUG: handleMsalResponse called without a valid account in response.");
                }
            }
        }
        
        function initializeAppUI() {
            console.log(`DEBUG: Initializing main app for ${currentUserRepName}`);
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');

            const welcomeMsg = document.getElementById('welcome-message');
            if (welcomeMsg) {
                const firstName = currentUserRepName ? currentUserRepName.split(' ')[0] : 'User';
                welcomeMsg.textContent = `Welcome, ${firstName}`;
                welcomeMsg.classList.remove('hidden');
            }

            updateFormDisplayMode(); 
            showFormContent(false); 
            setInitialAnnouncementState(); 
            resetSalesDisplay(); 
            startClock();

            // Auto-load records: This is the desired behavior on app load/init.
            loadRecords(); 

            console.log("DEBUG: App UI Initialized.");
        }
        
        // --- UI Display Helpers ---

        function showNotification(title, message) { 
            const m = document.getElementById('notification-modal'); 
            const t = document.getElementById('notification-title'); 
            const msg = document.getElementById('notification-message'); 
            if (m && t && msg) { 
                t.textContent = title; 
                msg.innerHTML = message; 
                m.classList.remove('hidden'); 
                if (title !== "Saving...") {
                    setTimeout(closeNotification, 5000);
                }
            } else { 
                console.log("NOTIFICATION:", title, message);
            } 
        }
        
        function closeNotification() { 
            const m = document.getElementById('notification-modal'); 
            if (m) m.classList.add('hidden'); 
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('login-error');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
            const loginBtn = document.getElementById('login-button');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fab fa-microsoft mr-3"></i> Sign in with Microsoft';
            }
        }
        
        function showGalleryLoader(isLoading) {
            const loader = document.getElementById('gallery-loader');
            const galleryList = document.getElementById('record-gallery-list');
            if (loader) loader.style.display = isLoading ? 'flex' : 'none';
            if (galleryList) galleryList.style.display = isLoading ? 'none' : 'flex';
            if (isLoading && galleryList) galleryList.innerHTML = '';
        }

        function showFormContent(show) {
            const container = document.getElementById('right-column-container');
            const editButton = document.getElementById('editModeButton');
            const controls = document.querySelectorAll('#save-button, #reset-button, #launch-email-button, #email-template-dropdown, #help-button, #noopp-button, #close-button');

            if (container) container.style.visibility = show ? 'visible' : 'hidden';
            if (!show) { isEditMode = false; updateFormDisplayMode(); }
            if (editButton) editButton.disabled = !show;
            
            controls.forEach(ctrl => {
                if (ctrl.id !== 'editModeButton') ctrl.disabled = true;
            });
        }
        
        function updateFormDisplayMode() {
            const editButton = document.getElementById('editModeButton');
            const inputs = document.querySelectorAll('#profile-card .editable-field, #follow-up-date, #follow-up-time, #qb-notes-input');
            const actionButtons = document.querySelectorAll('#save-button, #reset-button, #launch-email-button, #email-template-dropdown, #help-button, #noopp-button, #close-button');
            
            if (editButton) {
                if (isEditMode) {
                    editButton.innerHTML = '<i class="fas fa-eye mr-1"></i> View Profile';
                    editButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    editButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
                } else {
                    editButton.innerHTML = '<i class="fas fa-pencil-alt mr-1"></i> Edit Profile';
                    editButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
                    editButton.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
                editButton.disabled = !currentSelectedRecord;
            }
            
            actionButtons.forEach(btn => { btn.disabled = !isEditMode; });
            inputs.forEach(input => {
                if (input) {
                    input.disabled = !isEditMode;
                    input.classList.toggle('is-editable', isEditMode);
                }
            });
        }

        function showManagerFeedback() {
            if (!currentSelectedRecord) return;
            const mgrNotes = getVal(currentSelectedRecord, 'cr714_managernotes', 'No manager feedback available for this account.');
            document.getElementById('manager-feedback-content').textContent = mgrNotes;
            document.getElementById('manager-feedback-modal').classList.remove('hidden');
        }

        function closeManagerFeedback() {
            document.getElementById('manager-feedback-modal').classList.add('hidden');
        }

        function closeImportantInfo() {
            if (!currentSelectedRecord) return;
            const impInfo = getVal(currentSelectedRecord, 'cr714_importantaccountinformation', '');
            if (impInfo) {
                document.getElementById('important-info-modal').classList.add('hidden');
            }
        }

        function showImportantInfo() {
            if (!currentSelectedRecord) return;
            const impInfo = getVal(currentSelectedRecord, 'cr714_importantaccountinformation', 'No important account information provided.');
            document.getElementById('important-info-content').textContent = impInfo;
            document.getElementById('important-info-modal').classList.remove('hidden');
        }

        function showHelp() {
            showNotification("Help", "This is the Help section. For Manager Feedback or Important Account Info, use the buttons above.");
        }
        
        function setInitialAnnouncementState() {
            const section = document.getElementById('announcements-section');
            const button = document.getElementById('announcement-toggle-btn');
            let isDismissed = false;
            try {
                isDismissed = JSON.parse(localStorage.getItem(ANNOUNCEMENT_DISMISSED_KEY) || 'false');
            } catch (e) { console.error("Could not parse announcement state", e); }
            
            if (section && button) {
                section.classList.toggle('announcements-collapsed', isDismissed);
                section.classList.toggle('announcements-expanded', !isDismissed);
                button.textContent = isDismissed ? '[Show]' : '[Dismiss]';
            }
        }
        
        function toggleAnnouncements() {
            const section = document.getElementById('announcements-section');
            const button = document.getElementById('announcement-toggle-btn');
            if (!section || !button) return;

            const isExpanded = section.classList.contains('announcements-expanded');
            const newState = !isExpanded;
            localStorage.setItem(ANNOUNCEMENT_DISMISSED_KEY, JSON.stringify(!newState));
            section.classList.toggle('announcements-collapsed', !newState);
            section.classList.toggle('announcements-expanded', newState);
            button.textContent = newState ? '[Dismiss]' : '[Show]';
        }

        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            updateClock();
            clockInterval = setInterval(updateClock, 1000); 
        }
        
        function updateClock() {
            const clockEl = document.getElementById('clock-display');
            const now = new Date();
            const timeStr = `${now.toLocaleDateString([], {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})} ${now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
            if (clockEl) clockEl.textContent = timeStr;
        }

        // --- Data-centric Functions ---

        function filterRecordPredicate(record, searchValue) {
            if (!searchValue) return true;
            const fieldsToSearch = [
                'cr714_id', 'cr714_company', 'cr714_namelatest', 'cr714_namemost',
                'cr714_emailmost', 'cr714_emaillatest', 'cr714_accountrep', 'cr714_retentionrep'
            ];
            return fieldsToSearch.some(key => String(getVal(record, key)).toLowerCase().includes(searchValue));
        }

        function populateActionFilter(records, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            try {
                const rawActions = records.map(r => getVal(r, 'cr714_action')).filter(Boolean);
                const uniqueActions = [...new Set(rawActions.map(a => a.trim()))].sort();
                
                if (uniqueActions.length > 0) {
                    dropdown.innerHTML = '<option value="">Filter: All Actions</option>';
                    uniqueActions.forEach(action => {
                        dropdown.innerHTML += `<option value="${escapeHTML(action)}">${escapeHTML(action)}</option>`;
                    });
                    dropdown.disabled = false;
                } else {
                    dropdown.innerHTML = '<option value="">No Actions to Filter</option>';
                    dropdown.disabled = true;
                }
            } catch (e) {
                console.error("Error populating action filter:", e);
                dropdown.innerHTML = '<option value="">Filter Error</option>';
                dropdown.disabled = true;
            }
        }
        
        function filterAndSortGallery() {
            console.log("LIVE: filterAndSort.");
            const searchValue = getElementValue('search-bar')?.toLowerCase() || '';
            const sortValue = getElementValue('sort-dropdown') || 'company-asc';
            const filterValue = getElementValue('filter-action-dropdown') || ''; 
            const filterFollowUp = document.getElementById('filter-followup')?.checked || false;
            const filterNoNotes = document.getElementById('filter-nonotes')?.checked || false;
            const filterRequests = document.getElementById('filter-requests')?.checked || false;
            
            if (!Array.isArray(allRecords)) {
                renderGallery([]);
                return;
            }
            
            let filtered = allRecords.filter(record => {
                const isSearchMatch = filterRecordPredicate(record, searchValue);
                const isActionMatch = filterValue === '' || getVal(record, 'cr714_action') === filterValue;
                
                const isFollowUpMatch = !filterFollowUp || (getVal(record, 'cr714_followup') || '').trim() !== '';
                const isNoNotesMatch = !filterNoNotes || (getVal(record, 'cr714_qbnotes', '') || '').replace(QB_NOTES_TEMPLATE.trim(), '').trim() === '';
                const isRequestMatch = !filterRequests || ['Help', 'Help - No Opp', 'Help - Close Account Button'].includes((getVal(record, 'cr714_recordviability', '') || '').trim());

                return isSearchMatch && isActionMatch && isFollowUpMatch && isNoNotesMatch && isRequestMatch;
            });
            
            filtered.sort((a, b) => {
                const cA = getVal(a, 'cr714_company', '').toLowerCase();
                const cB = getVal(b, 'cr714_company', '').toLowerCase();
                const dA = parseInt(getVal(a, 'cr714_dayssincelastorder', 9999), 10);
                const dB = parseInt(getVal(b, 'cr714_dayssincelastorder', 9999), 10);
                const repA = String(getVal(a, 'cr714_accountrep') || getVal(a, 'cr714_retentionrep', '')).toLowerCase();
                const repB = String(getVal(b, 'cr714_accountrep') || getVal(b, 'cr714_retentionrep', '')).toLowerCase();
                const classA = String(getVal(a, 'cr714_customerclassification', '')).toLowerCase();
                const classB = String(getVal(b, 'cr714_customerclassification', '')).toLowerCase();
                
                const followA = getVal(a, 'cr714_followup');
                const followB = getVal(b, 'cr714_followup');
                const dateA_val = followA ? new Date(followA).getTime() : Infinity;
                const dateB_val = followB ? new Date(followB).getTime() : Infinity;

                switch (sortValue) {
                    case 'company-asc': default: return cA.localeCompare(cB);
                    case 'company-desc': return cB.localeCompare(cA);
                    case 'days-asc': return dA - dB;
                    case 'days-desc': return dB - dA;
                    case 'rep-asc': return repA.localeCompare(repB);
                    case 'rep-desc': return repB.localeCompare(repA);
                    case 'classification-asc': return classA.localeCompare(classB);
                    case 'classification-desc': return classB.localeCompare(classA);
                    case 'followup-asc': return dateA_val - dateB_val;
                    case 'followup-desc': return dateB_val - dateA_val; 
                }
            });
            
            renderGallery(filtered);
            const pinnedRecord = allRecords.find(r => String(getVal(r, 'cr714_id')) === currentRecordId);
            if (!pinnedRecord || !filtered.find(r => String(getVal(r, 'cr714_id')) === currentRecordId)) {
                 selectRecord(null);
            } else if(currentRecordId) {
                selectRecord(currentRecordId);
            }
        }
        
        function renderGallery(recordsToRender) {
            console.log(`LIVE: renderGallery called with ${recordsToRender?.length ?? 0} records.`);
            const galleryList = document.getElementById('record-gallery-list');
            if (!galleryList) { console.error("CRITICAL - Gallery list container not found!"); return; }
            galleryList.innerHTML = ''; 
            try {
                if (!Array.isArray(recordsToRender) || recordsToRender.length === 0) {
                    galleryList.innerHTML = `<div class="loader-container"><p class="text-gray-500 italic">No records match your criteria.</p></div>`;
                    return;
                }
                
                recordsToRender.forEach((record) => {
                    const item = document.createElement('button');
                    const id = String(getVal(record, 'cr714_id'));
                    const company = getVal(record, 'cr714_company', 'No Company');
                    const rep = getVal(record, 'cr714_accountrep') || getVal(record, 'cr714_retentionrep', 'No Rep');

                    item.className = "gallery-item";
                    item.setAttribute('data-id', id);
                    item.onclick = () => selectRecord(id);
                    
                    item.innerHTML = `
                        <span class="block font-bold text-sm gallery-item-id truncate" title="Acc #: ${escapeHTML(id)}">${escapeHTML(id)}</span>
                        <span class="block font-medium text-xs gallery-item-company truncate" title="${escapeHTML(company)}">${escapeHTML(company)}</span>
                        <span class="block text-xs gallery-item-rep truncate" title="Rep: ${escapeHTML(rep)}">${escapeHTML(rep)}</span>
                    `;
                    
                    galleryList.appendChild(item);
                    if (currentRecordId === id) item.classList.add('is-selected');
                });
            } catch (e) {
                console.error("LIVE: Error during renderGallery loop:", e);
                galleryList.innerHTML = `<div class="loader-container"><p class="text-red-500 italic">Error displaying records.</p></div>`;
            } finally {
                showGalleryLoader(false);
            }
        }

        function selectRecord(recordId) {
            console.log(`LIVE: selectRecord id: ${recordId}`);
            
            if (!recordId) { 
                currentSelectedRecord = null;
                currentRecordId = null;
                showFormContent(false);
                resetSalesDisplay();
                document.getElementById('acct-number-header').textContent = '--';
                document.querySelectorAll('#record-gallery-list .gallery-item').forEach(i => i.classList.remove('is-selected'));
                return;
            }
            
            const idStr = String(recordId);
            currentSelectedRecord = allRecords.find(r => String(getVal(r, 'cr714_id')) === idStr);
            currentRecordId = currentSelectedRecord ? idStr : null;
            
            document.querySelectorAll('#record-gallery-list .gallery-item').forEach(i => i.classList.toggle('is-selected', i.getAttribute('data-id') === currentRecordId));
            
            if (currentSelectedRecord) {
                try {
                    populateForm(currentSelectedRecord);
                    loadSalesData(currentRecordId);
                    showFormContent(true);
                } catch (e) {
                    console.error("Error populating form:", e);
                    showNotification("Display Error", `Could not display record details: ${e.message}`);
                    showFormContent(false);
                }
            } else {
                showFormContent(false);
                resetSalesDisplay();
                document.getElementById('acct-number-header').textContent = '--';
            }
            isEditMode = false;
            updateFormDisplayMode();
        }

        function populateForm(record) {
            console.log("LIVE: populateForm.");
            if (!record) return;

            document.getElementById('acct-number-header').textContent = getVal(record, 'cr714_id', '--');

            const fieldMap = {
                'contact-name-most': 'cr714_namemost',
                'contact-name-latest': 'cr714_namelatest',
                'contact-phone-primary': 'cr714_primaryphone',
                'contact-email-most': 'cr714_emailmost',
                'contact-email-latest': 'cr714_emaillatest',
                'acct-company': 'cr714_company',
                'acct-classification': 'cr714_customerclassification',
                'acct-days-last-order': 'cr714_dayssincelastorder',
                'acct-billing-address': 'cr714_billingaddress',
                'internal-acct-rep': 'cr714_accountrep',
                'internal-retention-rep': 'cr714_retentionrep'
            };

            for (const [htmlId, dataKey] of Object.entries(fieldMap)) {
                const el = document.getElementById(htmlId);
                const val = getVal(record, dataKey, '--');
                if (el) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.value = val;
                    } else {
                        el.textContent = val;
                    }
                }
            }
            
            const notesInput = document.getElementById('qb-notes-input');
            if (notesInput) {
                notesInput.value = QB_NOTES_TEMPLATE;
            }
            
            const followUpValue = getVal(record, 'cr714_followup');
            const followUpDateEl = document.getElementById('follow-up-date');
            const followUpTimeEl = document.getElementById('follow-up-time');
            
            if (followUpValue) {
                try {
                    const d = new Date(followUpValue);
                    const isoDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const isoTime = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                    if (followUpDateEl) followUpDateEl.value = isoDate;
                    if (followUpTimeEl) followUpTimeEl.value = isoTime;
                } catch (e) {
                    if (followUpDateEl) followUpDateEl.value = '';
                    if (followUpTimeEl) followUpTimeEl.value = '';
                }
            } else {
                if (followUpDateEl) followUpDateEl.value = '';
                if (followUpTimeEl) followUpTimeEl.value = '';
            }
            
            updateNotesPreview();
        }

        // --- FORM ACTIONS ---
        function toggleEditMode() {
            if (!currentSelectedRecord) return;
            isEditMode = !isEditMode;
            updateFormDisplayMode();
        }

        function handleCustomReset() {
            if (currentSelectedRecord) {
                populateForm(currentSelectedRecord);
                showNotification("Reset", "Changes discarded.");
                isEditMode = false;
                updateFormDisplayMode();
            } else {
                showNotification("Info", "No record selected.");
            }
        }

        async function handleCustomSave() {
            console.log("LIVE: handleCustomSave.");
            if (!currentSelectedRecord || !isEditMode) return;
            
            const newNotesInput = getElementValue('qb-notes-input');
            const strippedNewNotes = newNotesInput.replace(QB_NOTES_TEMPLATE, '').trim();

            if (!strippedNewNotes) {
                 showNotification("Note Required", "Please enter new notes in the 'Enter New Notes' box before saving.");
                 return;
            }

            const now = new Date();
            const timestamp = now.toLocaleString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(',', '');
            const existingNotes = getVal(currentSelectedRecord, 'cr714_qbnotes', '');

            // Construct the full new note entry, formatted to prepend to existing notes.
            const newNoteEntry = 
                `------------------------------\r\n` +
                `Modified On: ${timestamp}\r\n` + 
                `Modified By: ${currentUserRepName}\r\n` + 
                `\r\n${strippedNewNotes}\r\n\r\n`;

            let isoFollowUp = null;
            const dateStr = getElementValue('follow-up-date');
            const timeStr = getElementValue('follow-up-time');
            if (dateStr && timeStr) {
                isoFollowUp = `${dateStr}T${timeStr}:00Z`;
            } else if (dateStr) {
                 isoFollowUp = `${dateStr}T00:00:00Z`;
            }
            
            const dataToSave = {
                recordId: currentRecordId,
                // Concatenate the new entry + existing notes for the Flow to write back
                qbNotes: newNoteEntry + existingNotes, 
                followUp: isoFollowUp, 
                nameMost: getElementValue('contact-name-most'),
                nameLatest: getElementValue('contact-name-latest'),
                primaryPhone: getElementValue('contact-phone-primary'),
                emailMost: getElementValue('contact-email-most'),
                emailLatest: getElementValue('contact-email-latest'),
                repName: currentUserRepName
            };
            
            try {
                showNotification("Saving...", "Please wait. This may take a moment to update the record.");
                const response = await fetch(PATCH_RECORD_FLOW_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Flow Error ${response.status}: ${errorText || response.statusText}`);
                }
                
                const updatedRecord = await response.json(); 
                showNotification("Save Successful", "Record and notes updated!");
                isEditMode = false;
                updateFormDisplayMode();
                
                const index = allRecords.findIndex(r => String(getVal(r, 'cr714_id')) === currentRecordId);
                if (index !== -1 && updatedRecord) {
                    Object.assign(allRecords[index], updatedRecord); 
                    allRecords[index].cr714_qbnotes = getVal(updatedRecord, 'cr714_qbnotes', allRecords[index].cr714_qbnotes);
                    currentSelectedRecord = allRecords[index];
                    filterAndSortGallery();
                    populateForm(currentSelectedRecord);
                } else {
                    await loadRecords();
                }
                
            } catch (e) {
                console.error("LIVE: Error saving record:", e);
                showNotification("Save Failed", `Could not save record: ${e.message}.`);
            }
        }
        
        async function handleActionButtonClick(actionType) {
            console.log(`LIVE: handleActionButtonClick: ${actionType}`);
            if (!currentSelectedRecord || !isEditMode) { showNotification("Info", "Select a record and enable edit mode first."); return; }

            const accountId = currentRecordId;
            const repName = currentUserRepName;
            const company = getVal(currentSelectedRecord, 'cr714_company', 'N/A');
            const accountNum = getVal(currentSelectedRecord, 'cr714_id', 'N/A');
            const newNotesInput = getElementValue('qb-notes-input');
            const strippedNewNotes = newNotesInput.replace(QB_NOTES_TEMPLATE, '').trim();
            const existingNotes = getVal(currentSelectedRecord, 'cr714_qbnotes', '');

            if (!strippedNewNotes && actionType !== 'LaunchEmail') {
                showNotification("Note Required", "Please enter a note in the 'Enter New Notes' box before submitting this action.");
                return;
            }

            const now = new Date();
            const timestamp = now.toLocaleString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(',', '');
            
            let noteToLog = '';
            if (strippedNewNotes) {
                 noteToLog = 
                    `------------------------------\r\n` +
                    `Modified On: ${timestamp}\r\n` + 
                    `Modified By: ${repName}\r\n` + 
                    `Action: ${actionType}\r\n` + 
                    `\r\n${strippedNewNotes}\r\n\r\n`;
            }

            const dataToFlow = {
                recordId: accountId,
                action: actionType,
                notes: noteToLog + existingNotes, 
                repName: repName,
            };

            if (actionType === 'LaunchEmail') {
                const template = getElementValue('email-template-dropdown');
                const email = getElementValue('contact-email-most') || getElementValue('contact-email-latest', '');
                const phone = getElementValue('contact-phone-primary', 'N/A');
                let subject = '';
                let body = '';
                
                const repNameInitials = repName.split(' ').map(n => n[0]).join('');

                if (template.includes("Non-Buy")) {
                    subject = `WB Mason, Price Match Program--ACC# ${accountNum}//${company}`;
                    body = `Good Morning/Afternoon!\r\n\r\nI am reaching out to you today from our retention department. It is my responsibility to ensure your company has the best experience possible.\r\n\r\nI would like for W.B Mason to be a one-stop-shop for all your business needs.\r\n\r\nBefore your next order with my competitor, send me any recent order confirmations or their shopping cart from them and I will at least match any pricing if I am not already lower.\r\n\r\nIf orders are ever time sensitive, reach out to me so we can confirm availability and explore alternative options if need be.\r\n\r\nOnce the order is in the system, we can start tracking shortly after.\r\n\r\n**Just for the opportunity to show you better pricing on the items you buy from my competitors, we will be giving you 15% off your next order of those items.**\r\n\r\n${template.includes('Yellow') ? '**With that said, what would be a good date and time to connect with you regarding your account?**' : ''}`;
                } else if (template.includes("Follow Up")) {
                    subject = `It's ${repNameInitials} with WB Mason--ACC# ${accountNum}//${company}`;
                    body = `Good Morning/Afternoon!\r\n\r\nI was unable to reach you today. When we spoke, you stated that you would review my email and provide a list of items you are purchasing from my competitors for us to quote.\r\n\r\nI have not heard from you and wanted to follow up on this to see if you have gotten the chance to review.\r\n\r\nWill you be able to send over items to quote before your next office supply order so you can start saving sooner than later?\r\n\r\nWe did discuss some items you are ordering elsewhere. Below is some of the pricing we offer for the commonly ordered items of that category.\r\n\r\n[Insert image of PPL category here]\r\n\r\nWhen can I expect to see that list to get started on your savings?`;
                }

                const signatureBlock = `\r\n\r\nSincerely,\r\n${repName} | W.B. MASON CO, INC.\r\nDirect Line: ${phone} | Email: ${email}`;
                body += signatureBlock;

                try {
                    const mailtoLink = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.open(mailtoLink, '_blank');
                    showNotification("Email Launched", `Mail client opened for ${template}. Now logging note via Flow...`);
                } catch (e) {
                    showNotification("Email Error", "Could not open mail client. Please send manually. Still logging note via Flow...");
                }
            }
            
            try {
                showNotification("Action Submitting...", "Please wait. Logging action and saving notes.");
                const response = await fetch(ACTION_BUTTON_FLOW_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToFlow)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Flow Error ${response.status}: ${errorText || response.statusText}`);
                }
                
                const updatedRecord = await response.json(); 
                showNotification("Action Logged", `${actionType} request logged and notes saved.`);
                
                const index = allRecords.findIndex(r => String(getVal(r, 'cr714_id')) === currentRecordId);
                if (index !== -1 && updatedRecord) {
                    Object.assign(allRecords[index], updatedRecord); 
                    allRecords[index].cr714_qbnotes = getVal(updatedRecord, 'cr714_qbnotes', allRecords[index].cr714_qbnotes);
                    currentSelectedRecord = allRecords[index];
                    filterAndSortGallery();
                    populateForm(currentSelectedRecord);
                } else {
                    await loadRecords();
                }
                
                document.getElementById('qb-notes-input').value = QB_NOTES_TEMPLATE;
                updateNotesPreview();
                
            } catch (e) {
                console.error("LIVE: Error with action button:", e);
                showNotification("Action Failed", `Could not process action: ${e.message}.`);
            }
        }

        function createCalendarEvent() {
            showNotification("Calendar Event", "To use the calendar function, copy the date/time and manually create the event in Outlook/Teams. The app does not support external calendar events directly.");
        }


        // --- NOTES PREVIEW (Power Apps HTML Text emulation) ---
        function updateNotesPreview() {
            const previewBox = document.getElementById('qb-notes-preview');
            if (!previewBox) return;
            
            if (!currentSelectedRecord) {
                 previewBox.innerHTML = "<p class='text-gray-400 italic text-center text-sm mt-4'>No record selected.</p>";
                 return;
            }

            const showNew = document.getElementById('show-new-note')?.checked;
            const showPrev = document.getElementById('show-prev-note')?.checked;
            
            const newNotesInput = getElementValue('qb-notes-input');
            const strippedNewNotes = newNotesInput ? newNotesInput.replace(QB_NOTES_TEMPLATE, '').trim() : '';
            
            const existingNotes = getVal(currentSelectedRecord, 'cr714_qbnotes', '');
            
            let html = '';
            
            // AI Summary (always generated first for context)
            if (currentSelectedRecord) {
                html += generateAiSummary(currentSelectedRecord);
            }
            
            const now = new Date();
            const timestamp = now.toLocaleString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(',', '');

            // New Note Preview
            if (showNew && strippedNewNotes) {
                const content = `<pre style="white-space: pre-wrap; margin: 0; font-family: monospace; font-size: 0.8rem;">${escapeHTML(strippedNewNotes)}</pre>`;
                html += `<div class="note-preview-item" style="background-color:#e6f7ff; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <h4><i class="fas fa-pencil-alt text-blue-500"></i>New Note Preview (${escapeHTML(timestamp)} - ${escapeHTML(currentUserRepName || 'Current User')})</h4>
                    ${content}
                </div>`;
            }

            // Raw Previous Notes (for comparison)
            if (showPrev && existingNotes.trim()) {
                html += `<div class="note-preview-item" style="background-color:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <h4><i class="fas fa-history text-gray-500"></i>Raw Previous QB Notes (for verification)</h4>
                    <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.8rem; color: #57534e;">${escapeHTML(existingNotes)}</pre>
                </div>`;
            }

            previewBox.innerHTML = html || "<p class='text-gray-400 italic text-center text-sm mt-4'>Check the checkboxes to see notes/previews.</p>";
        }


        // --- SALES DATA (Simplified Placeholder) ---
        function resetSalesDisplay() {
            const placeholder = document.getElementById('sales-placeholder');
            const content = document.getElementById('sales-content');
            const loader = document.getElementById('sales-loader');
            if (placeholder) {
                placeholder.style.display = 'block';
                placeholder.textContent = 'Select an account';
                placeholder.classList.remove('text-red-600');
            }
            if (content) content.style.display = 'none';
            if (loader) loader.style.display = 'none';
            ['sales-ytd', 'sales-total-orders', 'sales-last-order'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '--';
            });
            const categoryList = document.getElementById('sales-category-list');
            if (categoryList) categoryList.innerHTML = '<li class="sales-category-item italic text-gray-400">No data</li>';
        }

        function displaySalesData(data) {
            const placeholder = document.getElementById('sales-placeholder');
            const content = document.getElementById('sales-content');
            if (placeholder) placeholder.style.display = 'none';
            if (content) content.style.display = 'block';
            
            document.getElementById('sales-ytd').textContent = getVal(data, 'ytdSales', '$1,234.56');
            document.getElementById('sales-total-orders').textContent = getVal(data, 'orderCount', '12');
            document.getElementById('sales-last-order').textContent = getVal(data, 'lastOrderDate', '2025-10-15');
            
            const categories = getVal(data, 'categories', [ { categoryName: "Janitorial", categorySales: "$500.10" }, { categoryName: "Coffee", categorySales: "$734.46" } ]);
            const categoryList = document.getElementById('sales-category-list');
            if (categoryList) {
                categoryList.innerHTML = '';
                categories.forEach(cat => {
                    const li = document.createElement('li');
                    li.className = 'sales-category-item';
                    li.innerHTML = `<span class="sales-category-name truncate pr-2" title="${escapeHTML(getVal(cat, 'categoryName'))}">${escapeHTML(getVal(cat, 'categoryName', 'N/A'))}</span><span class="sales-category-amount">${escapeHTML(getVal(cat, 'categorySales', '--'))}</span>`;
                    categoryList.appendChild(li);
                });
            }
        }

        async function loadSalesData(recordId) {
            if (!recordId) { resetSalesDisplay(); return; }
            const loader = document.getElementById('sales-loader');
            const placeholder = document.getElementById('sales-placeholder');

            if (placeholder) placeholder.style.display = 'none';
            if (loader) loader.style.display = 'flex';

            try {
                // Placeholder: Simulate a response.
                await new Promise(r => setTimeout(r, 500)); 
                const mockData = { ytdSales: "$1,234.56", orderCount: "12", lastOrderDate: "2025-10-15", categories: [ { categoryName: "Janitorial", categorySales: "$500.10" }, { categoryName: "Coffee", categorySales: "$734.46" } ] };
                displaySalesData(mockData);
            } catch (e) {
                if (placeholder) {
                    placeholder.style.display = 'block';
                    placeholder.textContent = 'Error loading sales data.';
                    placeholder.classList.add('text-red-600');
                }
            } finally {
                if (loader) loader.style.display = 'none';
            }
        }
        
        // --- POPUP/MODAL FUNCTIONS ---
        function showManagerFeedback() {
            if (!currentSelectedRecord) return;
            const mgrNotes = getVal(currentSelectedRecord, 'cr714_managernotes', 'No manager feedback available for this account.');
            document.getElementById('manager-feedback-content').textContent = mgrNotes;
            document.getElementById('manager-feedback-modal').classList.remove('hidden');
        }

        function closeManagerFeedback() {
            document.getElementById('manager-feedback-modal').classList.add('hidden');
        }

        function closeImportantInfo() {
            if (!currentSelectedRecord) return;
            const impInfo = getVal(currentSelectedRecord, 'cr714_importantaccountinformation', '');
            if (impInfo) {
                document.getElementById('important-info-modal').classList.add('hidden');
            }
        }

        function showImportantInfo() {
            if (!currentSelectedRecord) return;
            const impInfo = getVal(currentSelectedRecord, 'cr714_importantaccountinformation', 'No important account information provided.');
            document.getElementById('important-info-content').textContent = impInfo;
            document.getElementById('important-info-modal').classList.remove('hidden');
        }

        function showHelp() {
            showNotification("Help", "This is the Help section. For Manager Feedback or Important Account Info, use the buttons above.");
        }
        
        // --- ANNOUNCEMENT/CLOCK FUNCTIONS ---
        function setInitialAnnouncementState() {
            const section = document.getElementById('announcements-section');
            const button = document.getElementById('announcement-toggle-btn');
            let isDismissed = false;
            try {
                isDismissed = JSON.parse(localStorage.getItem(ANNOUNCEMENT_DISMISSED_KEY) || 'false');
            } catch (e) { console.error("Could not parse announcement state", e); }
            
            if (section && button) {
                section.classList.toggle('announcements-collapsed', isDismissed);
                section.classList.toggle('announcements-expanded', !isDismissed);
                button.textContent = isDismissed ? '[Show]' : '[Dismiss]';
            }
        }
        
        function toggleAnnouncements() {
            const section = document.getElementById('announcements-section');
            const button = document.getElementById('announcement-toggle-btn');
            if (!section || !button) return;

            const isExpanded = section.classList.contains('announcements-expanded');
            const newState = !isExpanded;
            localStorage.setItem(ANNOUNCEMENT_DISMISSED_KEY, JSON.stringify(!newState));
            section.classList.toggle('announcements-collapsed', !newState);
            section.classList.toggle('announcements-expanded', newState);
            button.textContent = newState ? '[Dismiss]' : '[Show]';
        }

        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            updateClock();
            clockInterval = setInterval(updateClock, 1000); 
        }
        
        function updateClock() {
            const clockEl = document.getElementById('clock-display');
            const now = new Date();
            const timeStr = `${now.toLocaleDateString([], {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})} ${now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
            if (clockEl) clockEl.textContent = timeStr;
        }

        // --- AI Summary Logic (Local Placeholder) ---
        
        function generateAiSummary(record) {
            if (!record) {
                 return "<p class='text-gray-400 italic text-center text-sm mt-4'>Select a record to see AI Summary.</p>";
            }

            const notes = getVal(record, 'cr714_qbnotes', '').trim();
            const mgrNotes = getVal(record, 'cr714_managernotes', '').trim();
            const impInfo = getVal(record, 'cr714_importantaccountinformation', '').trim();
            
            let summaryHtml = "";
            let summaryFound = false;

            if (impInfo) {
                summaryFound = true;
                summaryHtml += `
                    <div style="background-color:#fee2e2; padding:8px; border-radius:4px; margin-bottom:6px;">
                        <h4 style="font-weight: 700; color: #b91c1c; margin-bottom: 4px;"><i class="fas fa-exclamation-triangle"></i> IMPORTANT INFO:</h4>
                        <pre style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; color: #b91c1c;">${escapeHTML(impInfo)}</pre>
                    </div>
                `;
            }
            
            if (mgrNotes) {
                summaryFound = true;
                summaryHtml += `
                    <div style="background-color:#dcfce7; padding:8px; border-radius:4px; margin-bottom:6px;">
                        <h4 style="font-weight: 700; color: #16a34a; margin-bottom: 4px;"><i class="fas fa-user-tie"></i> MANAGER FEEDBACK:</h4>
                        <pre style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; color: #16a34a;">${escapeHTML(mgrNotes)}</pre>
                    </div>
                `;
            }

            if (notes) {
                const qbLines = notes.split('\n').filter(line => line.trim() !== '------------------------------' && line.trim() !== '');
                if (qbLines.length > 0) {
                    summaryFound = true;
                    const effectiveSummary = qbLines.slice(0, 10).join('\n'); 
                    summaryHtml += `
                        <div style="background-color:#f8fafc; padding:8px; border-radius:4px; border: 1px solid #eee;">
                            <h4 style="font-weight: 700; font-size: 0.8rem; margin-bottom: 4px; color: #2563eb;">KEY ACCOUNT DATA/PREVIOUS NOTES:</h4>
                            <pre style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; color: #374151;">${escapeHTML(effectiveSummary)}</pre>
                        </div>
                    `;
                }
            }
            
            if (!summaryFound) {
                 return "<p class='text-gray-400 italic text-center text-sm mt-4'>No previous notes or external feedback found.</p>";
            }

            return summaryHtml;
        }


        // ====================================================================
        // --- 3. MAIN APP ENTRY POINT (Initiates MSAL and App Flow) ---
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG: DOM Loaded. v4.0 (Standalone).");
            
            const initializeAuth = async () => {
                try {
                    // 1. Handle redirect promise (if user just signed in via popup)
                    let response = await msalInstance.handleRedirectPromise();
                    
                    if (response && response.account) {
                        handleMsalResponse(response);
                        return;
                    }

                    // 2. Attempt to silently acquire token for cached accounts
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        response = await msalInstance.acquireTokenSilent({
                            scopes: ["User.Read"],
                            account: accounts[0]
                        });
                        handleMsalResponse(response);
                        return;
                    }
                    
                    // 3. No active session found. Keep login screen visible.
                    console.log("DEBUG: No active session found. User must click log in.");
                } catch (err) {
                    console.error("MSAL initialization failed:", err);
                }
            };

            initializeAuth();
        });
    </script>
</body>
</html>
