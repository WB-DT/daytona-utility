<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title updated -->
    <title>Daytona Account Utility v4.0 (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- NEW: Microsoft Authentication Library (MSAL) -->
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; /* bg-slate-200 */ }

        /* --- Global Styles --- */
        .card { background-color: #fff; border: 1px solid #e2e8f0; /* slate-200 */ border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05), 0 1px 2px -1px rgba(0,0,0,0.05); }
        .card-header { font-size: 1rem; font-weight: 600; color: #1e293b; /* slate-800 */ border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between; }
        .card-header i { margin-right: 0.5rem; color: #475569; /* slate-600 */ width: 1.25rem; /* Ensure consistent icon spacing */ }
        .pa-label { color: #166534; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.1rem; text-transform: uppercase; letter-spacing: 0.025em; }
        .pa-input, .pa-textarea, .pa-select {
            border-color: #cbd5e1; background-color: #f8fafc; font-size: 0.875rem; /* Base size */
            padding: 0.5rem 0.75rem; border-width: 1px; border-radius: 0.375rem; width: 100%;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .pa-input:focus, .pa-textarea:focus, .pa-select:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); border-color: #3b82f6; outline: none; background-color: #fff;
        }

        /* --- Layout Specific --- */
        .main-content-wrapper { display: grid; grid-template-columns: 280px 1fr; gap: 1rem; /* Fixed gallery width */ }
        .left-column-container { max-height: calc(100vh - 145px); /* Adjusted for tabs/header */ display: grid; grid-template-rows: minmax(150px, 1fr) auto; gap: 1rem; background-color: #f8fafc; /* bg-slate-50 */ border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 0.75rem; }
        .gallery-section { display: flex; flex-direction: column; overflow: hidden; /* Prevent internal scrollbar issues */ }
        .record-gallery-list { display: flex; flex-direction: column; gap: 0.3rem; overflow-y: auto; flex-grow: 1; padding-right: 2px; scrollbar-width: thin; scrollbar-color: #94a3b8 #e2e8f0; }
        .record-gallery-list::-webkit-scrollbar { width: 6px; }
        .record-gallery-list::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 3px; }
        .record-gallery-list::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 3px; border: 1px solid #e2e8f0; }
        .right-column-container { max-height: calc(100vh - 145px); /* Adjusted for tabs/header */ overflow-y: auto; padding-right: 5px; /* Space for scrollbar */ scrollbar-width: thin; scrollbar-color: #94a3b8 #e2e8f0;}
        .right-column-container::-webkit-scrollbar { width: 6px; }
        .right-column-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 3px; }
        .right-column-container::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 3px; border: 1px solid #e2e8f0; }

        /* --- Section Specific Styles --- */
        #profile-card { background-color: #fff; }
        .profile-dt { @apply text-[0.7rem] font-medium text-gray-500 uppercase tracking-wider mb-0 leading-tight; }
        .profile-dd { @apply text-sm font-semibold text-gray-800 mb-2; }
        .editable-field { width: 100%; font-size: 0.875rem; font-weight: 500; line-height: 1.4rem; border-radius: 0.375rem; transition: all 150ms ease-in-out; border: 1px solid transparent; }
        .editable-field:disabled { background: transparent; padding: 0.5rem 0.1rem; color: #1f2937; cursor: default; }
        .editable-field:not(:disabled) { @apply pa-input; background-color: #FFFFFF; padding: 0.5rem 0.75rem; border-color: #cbd5e1; }
        .editable-field[type="email"]:disabled { color: #2563eb; text-decoration: underline; cursor: pointer; padding: 0.5rem 0.1rem;}
        .editable-field[type="email"]:disabled:hover { color: #1d4ed8; }
        .is-editable { background-color: #fefce8 !important; border-color: #fcd34d !important; }
        .is-editable:focus { box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.4) !important; border-color: #facc15 !important; }

        #notes-section { background-color: #fefce8; border-color: #fde68a; }
        #notes-section .card-header { border-color: #fde68a; }
        .notes-preview-box { background-color: #fff; border: 1px solid #fde047; border-radius: 0.375rem; padding: 0.75rem; font-size: 0.8rem; line-height: 1.4; overflow-y: auto; }
        .note-preview-item { margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed #fee2e2; }
        .note-preview-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .note-preview-item h4 { display: flex; align-items: center; font-weight: 700; font-size: 0.7rem; color: #713f12; margin-bottom: 0.2rem; text-transform: uppercase; letter-spacing: 0.05em;}
        .note-preview-item h4 i { width: 0.75rem; margin-right: 0.375rem; text-align: center; }
        .note-preview-item p { font-size: 0.8rem; color: #57534e; white-space: pre-line; margin-top: 0.1rem; }

        #actions-section { background-color: #eff6ff; border-color: #bfdbfe; }
        #actions-section .card-header { border-color: #bfdbfe; }
        
        #announcements-section, .marquee-container { background-color: #f1f5f9; border-color: #cbd5e1; }
        .marquee { overflow: hidden; position: relative; white-space: nowrap; background: white; border: 1px solid #cbd5e1; border-radius: 0.25rem; padding: 0.25rem 0; }
        .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 25s linear infinite; font-size: 0.8rem; color: #475569; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .announcements-collapsed .marquee-container { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; transition: all 0.3s ease-out; margin-top: 0;}
        .announcements-expanded .marquee-container { max-height: 100px; transition: all 0.3s ease-in; margin-top: 0.25rem;}

        #sales-data-container { background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03); overflow-y: auto; padding: 0.75rem; }
        .sales-data-container::-webkit-scrollbar { width: 5px; }
        .sales-data-container::-webkit-scrollbar-track { background: #dcfce7; border-radius: 2.5px; }
        .sales-data-container::-webkit-scrollbar-thumb { background-color: #86efac; border-radius: 2.5px; }
        .sales-dt { @apply text-[0.7rem] font-medium text-green-700 uppercase tracking-wider mb-0 leading-tight; }
        .sales-dd { @apply text-base font-semibold text-green-900 mb-2; }
        .sales-category-item { @apply flex justify-between items-center text-xs py-1 border-b border-green-100 last:border-b-0; }
        .sales-category-name { @apply text-green-800; }
        .sales-category-amount { @apply font-medium text-green-900; }
        #live-clock-container { border-top: 1px solid #bbf7d0; margin-top: 0.75rem; padding-top: 0.75rem; }

        /* --- Gallery Item Style --- */
        .gallery-item { transition: all 150ms ease-in-out; border: 1px solid #d1d5db; background-color: #fff; border-radius: 0.375rem; text-align: left; width: 100%; padding: 0.5rem; flex-shrink: 0; cursor: pointer; }
        .gallery-item:hover { background-color: #f0f9ff; border-color: #7dd3fc; }
        .gallery-item.is-selected { background-color: #3b82f6; color: white; border-color: #2563eb; }
        .gallery-item.is-selected .gallery-item-id, .gallery-item.is-selected .gallery-item-company, .gallery-item.is-selected .gallery-item-rep { color: #e0e7ff; }
        .gallery-item.is-selected .gallery-item-id { color: white; }
        .gallery-item .gallery-item-id { font-weight: 700; font-size: 0.9rem; color: #1e3a8a; }
        .gallery-item .gallery-item-company { font-weight: 500; font-size: 0.8rem; color: #374151; }
        .gallery-item .gallery-item-rep { font-size: 0.7rem; color: #6b7280; font-style: italic; }

        .header-panel { background-color: #fff; border-bottom: 1px solid #e2e8f0; }
        .loader-container { min-height: 60px; display: flex; align-items: center; justify-content: center; width: 100%; flex-grow: 1;}
    </style>
</head>
<body class="p-0 md:p-4">

    <!-- NEW: Login Container -->
    <div id="login-container" class="fixed inset-0 bg-slate-900 bg-opacity-90 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <i class="fas fa-lock text-5xl text-blue-600 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Daytona Account Utility</h3>
            <p class="text-gray-700 mb-6">Please log in with your Microsoft account to continue.</p>
            <button onclick="login()" id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center text-lg">
                <i class="fab fa-microsoft mr-3"></i>
                Sign in with Microsoft
            </button>
            <p id="login-error" class="text-red-600 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- Main App Container - Will be hidden until login -->
    <div id="main-app-container" class="hidden">

        <!-- Live Data Content (no longer a tab) -->
        <div id="live-data-content" class="active">
            <!-- Top Header Panel (Live Data) -->
            <div id="header-panel" class="header-panel p-3 shadow-md mb-4 sticky top-0 z-10 bg-white">
                <div class="max-w-screen-xl mx-auto flex flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-gray-800 whitespace-nowrap"><i class="fas fa-list-ul text-blue-600 mr-1"></i>My Accounts</h2>
                        <!-- NEW: Load Records Button -->
                        <button onclick="loadRecords()" id="load-records-button" class="py-1 px-3 text-sm rounded-md shadow transition-all duration-200 font-bold bg-green-600 text-white hover:bg-green-700">
                            <i class="fas fa-sync mr-1"></i> Load My Records
                        </button>
                        <span id="welcome-message" class="text-sm text-gray-600 hidden"></span>
                    </div>
                    <div class="flex-grow min-w-[200px] max-w-xs relative">
                        <input type="text" id="search-bar" onkeyup="filterAndSortGallery()" placeholder="Search accounts..." class="pa-input pl-10 w-full text-sm" />
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <!-- SORT DROPDOWN -->
                        <select id="sort-dropdown" onchange="filterAndSortGallery()" class="pa-select text-xs">
                            <option value="company-asc">Sort: Company A-Z</option>
                            <option value="company-desc">Sort: Company Z-A</option>
                            <option value="account-asc">Sort: Account # &#x2191;</option>
                            <option value="account-desc">Sort: Account # &#x2193;</option>
                            <option value="rep-asc">Sort: Rep A-Z</option>
                            <option value="rep-desc">Sort: Rep Z-A</option>
                            <option value="days-asc">Sort: Days Since Order &#x2191;</option>
                            <option value="days-desc">Sort: Days Since Order &#x2193;</option>
                            <option value="classification-asc">Sort: Classification A-Z</option>
                            <option value="classification-desc">Sort: Classification Z-A</option>
                            <option value="followup-asc">Sort: Follow Up &#x2191;</option>
                            <option value="followup-desc">Sort: Follow Up &#x2193;</option>
                        </select>
                        <!-- FILTER DROPDOWN -->
                        <select id="filter-action-dropdown" onchange="filterAndSortGallery()" class="pa-select text-xs" disabled>
                            <option value="">Filter: All Actions</option>
                        </select>
                    </div>
                    <!-- NEW: Filter Checkboxes -->
                    <div class="flex items-center gap-3 flex-wrap border-l pl-3 ml-1">
                        <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                            <input type="checkbox" id="filter-followup" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                            <span>Show Follow Ups</span>
                        </label>
                         <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                            <input type="checkbox" id="filter-nonotes" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                            <span>No Notes</span>
                        </label>
                         <label class="flex items-center space-x-1 text-xs font-medium text-gray-600 cursor-pointer">
                            <input type="checkbox" id="filter-requests" class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 rounded" onchange="filterAndSortGallery()">
                            <span>Button Requests</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Main App Layout (Live Data) -->
            <div id="main-content-wrapper-live" class="main-content-wrapper max-w-screen-xl mx-auto px-3 md:px-0">
                <!-- Left Column (Live) -->
                <div id="left-column-container" class="left-column-container">
                    <div id="gallery-section" class="gallery-section">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2 pb-1 border-b border-gray-200 flex-shrink-0 whitespace-nowrap">Account List</h3>
                        <div id="record-gallery-list" class="record-gallery-list flex-grow min-h-0">
                            <div id="gallery-loader" class="loader-container"><span class="italic text-gray-500">Click "Load My Records"</span></div>
                        </div>
                    </div>
                    <div id="sales-data-container" class="sales-data-container">
                        <h3 class="text-base font-semibold text-green-800 mb-3 pb-2 border-b border-green-200 flex items-center"><i class="fas fa-chart-line w-4 mr-2 text-green-600"></i>Sales Snapshot</h3>
                        <div id="sales-loader" class="loader-container text-xs italic text-gray-500 py-2 hidden"><span>Loading sales...</span></div>
                        <div id="sales-content" class="space-y-3 hidden">
                            <dl class="grid grid-cols-2 gap-x-4 gap-y-1"><div><dt class="sales-dt">YTD Sales</dt><dd class="sales-dd" id="sales-ytd">--</dd></div><div><dt class="sales-dt">Total Orders</dt><dd class="sales-dd" id="sales-total-orders">--</dd></div><div class="col-span-2"><dt class="sales-dt">Last Order Date</dt><dd class="sales-dd" id="sales-last-order">--</dd></div></dl>
                            <div id="sales-category-section" class="pt-2 border-t border-green-100"><h4 class="text-xs font-semibold text-green-700 mb-1">By Category:</h4><ul id="sales-category-list" class="space-y-0.5 max-h-24 overflow-y-auto pr-1"><li class="sales-category-item italic text-gray-400">No category data</li></ul></div>
                            <div id="live-clock-container" class="live-clock-container"><h4 class="text-xs font-semibold text-gray-500 mb-1 flex items-center"><i class="far fa-clock w-3 mr-1.5 text-gray-400"></i>Current Time</h4><div id="clock-display" class="text-xs text
