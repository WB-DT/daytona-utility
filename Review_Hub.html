<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rep Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        :root {
            --bg-app: #f1f5f9; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --primary: #4f46e5; --primary-fg: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --color-srmgr: #f97316; --color-mgr: #06b6d4; --color-sup: #22c55e; --color-gold: #facc15;
        }
        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; }
        [data-theme="oled"] { --bg-app: #000000; --bg-card: #121212; --bg-input: #2a2a2a; --text-main: #ffffff; --text-muted: #a1a1aa; --border-color: #27272a; --primary: #facc15; --primary-fg: #000000; }
        [data-theme="forest"] { --bg-app: #ecfdf5; --bg-card: #ffffff; --bg-input: #f0fdf4; --text-main: #064e3b; --text-muted: #65a30d; --border-color: #bbf7d0; --primary: #16a34a; --primary-fg: #ffffff; }
        [data-theme="ocean"] { --bg-app: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); --bg-card: rgba(255,255,255,0.95); --bg-input: rgba(255,255,255,0.8); --text-main: #0c4a6e; --text-muted: #0284c7; --border-color: #bae6fd; --primary: #0284c7; --primary-fg: #ffffff; }
        [data-theme="sunset"] { --bg-app: #fff7ed; --bg-card: #ffffff; --bg-input: #ffedd5; --text-main: #7c2d12; --text-muted: #c2410c; --border-color: #fed7aa; --primary: #ea580c; --primary-fg: #ffffff; }
        [data-theme="cyber"] { --bg-app: #050505; --bg-card: #11001c; --bg-input: #240046; --text-main: #e0aaff; --text-muted: #9d4edd; --border-color: #5a189a; --primary: #ff00ff; --primary-fg: #11001c; --shadow: 0 0 10px #ff00ff; }
        [data-theme="holiday-cheer"] { --bg-app: #f0fdf4; --bg-card: #ffffff; --bg-input: #fff1f2; --text-main: #14532d; --text-muted: #991b1b; --border-color: #166534; --primary: #dc2626; --primary-fg: #ffffff; --accent-warning: #fbbf24; }
        [data-theme="winter"] { --bg-app: linear-gradient(to bottom, #eff6ff, #dbeafe); --bg-card: #ffffff; --bg-input: #f0f9ff; --text-main: #1e3a8a; --text-muted: #60a5fa; --border-color: #bfdbfe; --primary: #2563eb; --primary-fg: #ffffff; }
        [data-theme="harvest"] { --bg-app: #fffbeb; --bg-card: #ffffff; --bg-input: #fff7ed; --text-main: #78350f; --text-muted: #d97706; --border-color: #fcd34d; --primary: #d97706; --primary-fg: #ffffff; }

        .bg-app { background-color: var(--bg-app); } .bg-card { background-color: var(--bg-card); } .bg-input { background-color: var(--bg-input); }
        .text-main { color: var(--text-main); } .text-muted { color: var(--text-muted); } .border-color { border-color: var(--border-color); }
        .shadow-theme { box-shadow: var(--shadow); }
        .bg-primary { background-color: var(--primary); color: var(--primary-fg); }
        .hover\:bg-primary:hover { background-color: var(--primary); opacity: 0.9; color: var(--primary-fg); }

        .sidebar-header { background-color: var(--primary); color: var(--primary-fg); }
        .hierarchy-item:hover { background-color: var(--border-color); }
        .hierarchy-item.active { background-color: var(--border-color); border-left: 4px solid var(--primary); }
        
        .color-srmgr { color: var(--color-srmgr); font-weight: 700; }
        .color-mgr { color: var(--color-mgr); font-weight: 600; }
        .color-sup { color: var(--color-sup); font-weight: 600; }
        .color-gold { color: var(--color-gold); font-weight: 600; }
        
        .page { display: none; } #page-review.active, #page-create.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #review-date-slider { -webkit-appearance: none; background: var(--border-color); }
        #review-date-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; }

        @media print {
            body * { visibility: hidden; } #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; color: #000; background: #fff; }
            .no-print { display: none !important; }
            .bg-card, .bg-app { background-color: white !important; } .text-main { color: black !important; }
        }
    </style>
</head>
<body class="bg-app antialiased h-screen flex overflow-hidden">

    <div class="w-1/4 min-w-[300px] bg-card border-r border-color flex flex-col shadow-theme z-10">
        <div class="p-4 border-b border-color sidebar-header">
            <h1 class="text-xl font-bold">Performance Hub</h1>
            <p class="text-xs opacity-80">Local Data Mode</p>
        </div>
        <div class="flex-1 overflow-y-auto">
            <div class="border-b border-color"><button onclick="toggleSection('dept')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Department <span id="chev-dept">‚ñº</span></button><div id="list-dept" class="p-2 space-y-1"></div></div>
            <div class="border-b border-color"><button onclick="toggleSection('mgr')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Manager Group <span id="chev-mgr">‚ñº</span></button><div id="list-mgr" class="p-2 space-y-1"></div></div>
            <div class="border-b border-color"><button onclick="toggleSection('sup')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Supervisor Group <span id="chev-sup">‚ñº</span></button><div id="list-sup" class="p-2 space-y-1"></div></div>
            <div class="border-b border-color"><button onclick="filterReps('GoldStar', true, this)" class="hierarchy-item block w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase">Gold Star Reps üåü</button></div>
            <div class="flex-1"><button onclick="toggleSection('rep')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Representative <span id="chev-rep">‚ñ≤</span></button><div id="list-rep" class="p-2 space-y-1"></div></div>
        </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden relative">
        <header class="bg-card border-b border-color p-4 flex justify-between items-center shadow-theme">
            <div><h2 id="view-title" class="text-2xl font-bold text-main">Dashboard</h2><p id="view-subtitle" class="text-sm text-muted">Select an employee</p></div>
            <div class="flex gap-3 items-center">
                <select id="theme-select" onchange="applyTheme(this.value)" class="p-2 text-sm border border-color rounded bg-input text-main shadow-theme">
                    <option value="winter">Winter</option><option value="midnight">Midnight</option><option value="oled">OLED</option><option value="forest">Forest</option><option value="ocean">Ocean</option><option value="sunset">Sunset</option><option value="cyber">Cyber</option><option value="harvest">Harvest</option><option value="holiday-cheer">Holiday</option>
                </select>
                <button onclick="openCreateReviewModal()" id="btn-new-review" class="bg-primary text-primary-fg px-4 py-2 rounded shadow-theme text-sm hidden no-print">New Review</button>
                <button onclick="openExportModal()" class="bg-primary text-primary-fg px-4 py-2 rounded shadow-theme text-sm no-print">Export / Sign</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 bg-app">
            <div id="page-review" class="page max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-end bg-card p-4 rounded-xl shadow-theme">
                    <div class="w-full max-w-md space-y-2">
                        <div class="flex justify-between"><label class="text-xs font-bold text-muted uppercase">Period Ending</label><span id="current-review-date-display" class="text-sm font-bold text-main">--</span></div>
                        <input type="range" id="review-date-slider" class="w-full h-2 bg-input rounded-lg cursor-pointer" min="0" max="0" value="0" oninput="updateDashboardFromSlider()">
                        <div class="flex gap-2 items-center"><label class="text-xs font-bold text-muted uppercase">Compare:</label><select id="duration-select" onchange="updateDashboardFromSlider()" class="p-1 text-xs border border-color rounded bg-input text-main"><option value="1">Monthly</option><option value="3">Quarterly</option><option value="6">6 Months</option><option value="12">Annual</option></select></div>
                    </div>
                    <div class="text-right"><div class="text-sm text-muted">Reports to</div><div id="manager-name" class="font-medium text-main">--</div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-card rounded-xl shadow-theme p-5 border border-color">
                        <h3 class="text-lg font-bold text-main mb-4">Performance Metrics</h3>
                        <div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-input text-xs uppercase text-muted"><tr><th class="px-4 py-2 text-left">KPI</th><th class="px-4 py-2 text-right">Target</th><th class="px-4 py-2 text-right">Actual</th><th class="px-4 py-2 text-center">Trend</th></tr></thead><tbody id="kpi-table-body" class="divide-y divide-border-color text-sm text-main"><tr><td colspan="4" class="text-center py-8 text-muted">Select a rep.</td></tr></tbody></table></div>
                    </div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border border-color flex flex-col">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-main">Trend</h3><select id="chart-kpi-select" onchange="updateChart()" class="text-xs border border-color rounded bg-card text-main"></select></div>
                        <div class="flex-1 relative w-full h-64"><canvas id="trendChart"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--primary);"><h4 class="font-bold text-main mb-2">üéØ Opportunities (Current)</h4><ul id="text-opps-this" class="text-sm text-main list-disc list-inside"></ul></div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--text-muted);"><h4 class="font-bold text-main mb-2">üîô Opportunities (Previous)</h4><ul id="text-opps-last" class="text-sm text-main list-disc list-inside"></ul></div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--color-sup);"><h4 class="font-bold text-main mb-2">‚ú® Best Practices</h4><ul id="text-best-practices" class="text-sm text-main list-disc list-inside"></ul></div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--accent-warning);"><h4 class="font-bold text-main mb-2">üöÄ Action Plan</h4><ul id="text-action-plan" class="text-sm text-main list-disc list-inside"></ul></div>
                </div>
                <div class="bg-card rounded-xl shadow-theme p-5 border border-color"><h4 class="font-bold text-main mb-2">üó£Ô∏è Agent's Voice</h4><p id="text-agent-voice" class="text-sm text-muted italic bg-input p-3 rounded"></p></div>
            </div>

            <div id="page-create" class="page max-w-4xl mx-auto space-y-6">
                <h3 class="text-2xl font-bold text-main border-b border-color pb-2">New Review: <span id="new-review-rep-name"></span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-card rounded-xl shadow-theme p-5 border border-color space-y-4">
                        <h4 class="font-bold text-main mb-2">Review Details</h4>
                        <div><label class="text-sm font-medium text-main">Date</label><input type="date" id="form-date" class="w-full border border-color rounded p-2 bg-input text-main"></div>
                        <div><label class="text-sm font-medium text-main">Type</label><select id="form-type" class="w-full border border-color rounded p-2 bg-input text-main"><option>EOM</option><option>EOQ</option><option>Annual</option><option>30-Day</option><option>90-Day</option></select></div>
                        <div><label class="text-sm font-medium text-main">Reviewer Level</label><select id="form-level" class="w-full border border-color rounded p-2 bg-input text-main"><option>Manager</option><option>Supervisor</option><option>Director</option></select></div>
                    </div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border border-color"><h4 class="font-bold text-main mb-2">KPIs</h4><div id="form-kpi-inputs" class="space-y-2"></div></div>
                </div>
                <div class="bg-card rounded-xl shadow-theme p-5 border border-color space-y-4">
                    <h4 class="font-bold text-main mb-2">Qualitative Feedback</h4>
                    <div><label class="text-sm font-medium text-main">Opportunities</label><textarea id="form-opps-this" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                    <div><label class="text-sm font-medium text-main">Action Plan</label><textarea id="form-action-plan" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                    <div><label class="text-sm font-medium text-main">Special Notes</label><textarea id="form-special-notes" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                    <div class="flex gap-4 mt-4"><button onclick="saveNewReview()" class="flex-1 bg-primary text-primary-fg py-2 rounded">Save</button><button onclick="loadRepDashboard(currentRepId)" class="flex-1 bg-input text-main py-2 rounded">Cancel</button></div>
                </div>
            </div>
        </main>
    </div>

    <div id="print-section" class="hidden bg-card">
        <div class="max-w-3xl mx-auto">
            <div class="flex justify-between border-b border-black pb-4 mb-6">
                <div><h1 class="text-2xl font-bold">Performance Review</h1><p id="print-subtitle"></p></div>
                <div class="text-right"><h2 class="font-bold text-xl">W.B. Mason</h2><p id="print-date"></p></div>
            </div>
            <table class="w-full mb-6 text-sm">
                <thead><tr class="bg-input"><th class="p-2 text-left">KPI</th><th class="p-2 text-right">Target</th><th class="p-2 text-right">Result</th><th class="p-2 text-center">Status</th></tr></thead>
                <tbody id="print-table-body"></tbody>
            </table>
            <div id="print-text-content" class="space-y-4 text-sm"></div>
            <div class="mt-12 pt-8 grid grid-cols-2 gap-10">
                <div class="border-t border-black pt-2"><p class="font-bold">Manager Signature</p></div>
                <div class="border-t border-black pt-2"><p class="font-bold">Employee Signature</p></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL STATE ---
        let currentRepId = null;
        let currentFilter = { type: 'All', value: null };
        let reviewDateRange = [];
        let dbReviews = [];
        let dbLogs = [];
        let currentReview = null;
        let chartInstance = null;

        // --- 2. DATA ---
        const rawEmployees = [
            {"id": 100, "name": "Abigail Landi", "role": "Director", "dept": "New Hire In Training", "isGoldStar": false, "managerId": 254, "supervisorId": 111}, {"id": 101, "name": "Abigail Trulock", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 102, "name": "Alex Robel", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 103, "name": "Andrew Steiner", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": null, "supervisorId": 191}, {"id": 104, "name": "Angela Kadera", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 163, "supervisorId": 259}, {"id": 105, "name": "Anslee Erickson", "role": "Director", "dept": "Analytics/Workforce", "isGoldStar": true, "managerId": 247, "supervisorId": 170}, {"id": 106, "name": "Anthony Casella", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 107, "name": "Ashley Albano", "role": "Director", "dept": "Retention", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 108, "name": "Ashley Bathrick", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": null, "supervisorId": 191}, {"id": 109, "name": "Ashley Mahaffey", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 244, "supervisorId": 191}, {"id": 110, "name": "Austin Noel", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 254, "supervisorId": 111}, {"id": 111, "name": "Bailey Lewis", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": 123, "supervisorId": 253}, {"id": 112, "name": "Bella Landi", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 129, "supervisorId": 191}, {"id": 113, "name": "Bella Santana", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 108, "supervisorId": 191}, {"id": 114, "name": "Billie MacDonald", "role": "Director", "dept": "Account Management 2", "isGoldStar": true, "managerId": 189, "supervisorId": 111}, {"id": 115, "name": "Billy Boles", "role": "Rep", "dept": "New Hire In Training", "isGoldStar": false, "managerId": 200, "supervisorId": 111}, {"id": 116, "name": "Brandon Neely", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 117, "name": "Brendan Bates", "role": "Rep", "dept": "Jacksonville", "isGoldStar": false, "managerId": 122, "supervisorId": 123}, {"id": 118, "name": "Brooke Hostetler", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 108, "supervisorId": 191}, {"id": 119, "name": "Carly Roberts", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 120, "name": "Cassandra Lester", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 189, "supervisorId": 111}, {"id": 121, "name": "Cassidy Austin", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 200, "supervisorId": 111}, {"id": 122, "name": "Celah Teschner", "role": "Director", "dept": "Jacksonville", "isGoldStar": false, "managerId": null, "supervisorId": 123}, {"id": 123, "name": "Cheryl Lee", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 124, "name": "Cheryl Lewis", "role": "Director", "dept": "Chat", "isGoldStar": false, "managerId": 179, "supervisorId": 170}, {"id": 125, "name": "Chris Gitzke", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 126, "name": "Chris Waller", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 160, "supervisorId": 125}, {"id": 127, "name": "Christine Billings", "role": "Director", "dept": "Account Management 3", "isGoldStar": true, "managerId": 108, "supervisorId": 191}, {"id": 128, "name": "Cindy Cisneros", "role": "Director", "dept": "Account Management 3", "isGoldStar": true, "managerId": 129, "supervisorId": 191}, {"id": 129, "name": "Clayton Coyne", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": null, "supervisorId": 191}, {"id": 130, "name": "Corey Berman", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 131, "name": "Courtney Youngblood", "role": "Director", "dept": "Logistics", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 132, "name": "Dallas Bouwens", "role": "Director", "dept": "Account Management 3", "isGoldStar": true, "managerId": 103, "supervisorId": 191}, {"id": 133, "name": "Daminik White", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 244, "supervisorId": 191}, {"id": 134, "name": "Dan Casey", "role": "Director", "dept": "Food Service", "isGoldStar": true, "managerId": 235, "supervisorId": 259}, {"id": 135, "name": "Dani Jenkins", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 149, "supervisorId": 191}, {"id": 136, "name": "Daniel Coriano", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 137, "name": "Daniel Whalen", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 138, "name": "Danielle Thiessen", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 139, "name": "Daylan Gaskin", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 140, "name": "Dexter Billingslea", "role": "Director", "dept": "Jacksonville", "isGoldStar": false, "managerId": 122, "supervisorId": 123}, {"id": 141, "name": "Dianna Grasso", "role": "Director", "dept": "Account Management 3", "isGoldStar": true, "managerId": 129, "supervisorId": 191}, {"id": 142, "name": "Diego Gonzales", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 103, "supervisorId": 191}, {"id": 143, "name": "Dirk Williams", "role": "Director", "dept": "Jacksonville", "isGoldStar": false, "managerId": 122, "supervisorId": 123}, {"id": 144, "name": "Ebony Thomas", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 198, "supervisorId": 191}, {"id": 145, "name": "Elaine Lohmeier", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 200, "supervisorId": 111}, {"id": 146, "name": "Elisabeth Kelley", "role": "Director", "dept": "Specialty", "isGoldStar": false, "managerId": 198, "supervisorId": 191}, {"id": 147, "name": "Ellene Coward", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 149, "supervisorId": 191}, {"id": 148, "name": "Emily Prosock", "role": "Rep", "dept": "New Hire In Training", "isGoldStar": false, "managerId": null, "supervisorId": null}, {"id": 149, "name": "Erica Campbell", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": null, "supervisorId": 191}, {"id": 150, "name": "Faith Tucker", "role": "Director", "dept": "Retention", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 151, "name": "Gabbie Vacca", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 198, "supervisorId": 191}, {"id": 152, "name": "Gabe Ivory", "role": "Supervisor", "dept": "Unknown", "isGoldStar": false, "managerId": null, "supervisorId": null}, {"id": 153, "name": "Gabe Rodriguez", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 154, "name": "Gavin Bates", "role": "Rep", "dept": "New Hire In Training", "isGoldStar": false, "managerId": null, "supervisorId": null}, {"id": 155, "name": "Glenn Teschner", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 156, "name": "Gloria Jourdan", "role": "Director", "dept": "Account Management 2", "isGoldStar": true, "managerId": 198, "supervisorId": 191}, {"id": 157, "name": "Hackeem Watt", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 108, "supervisorId": 191}, {"id": 158, "name": "Holly Evans", "role": "Director", "dept": "Logistics", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 159, "name": "JR James", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 103, "supervisorId": 191}, {"id": 160, "name": "Jacob Gilbert", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": null, "supervisorId": 125}, {"id": 161, "name": "Jacqueline Trumpower", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 162, "name": "Jake McNeely", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 163, "name": "James Harris", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": null, "supervisorId": 259}, {"id": 164, "name": "Jasmine Hicks", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 163, "supervisorId": 259}, {"id": 165, "name": "Jason Schiraldi", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 166, "name": "Jennifer Mason", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 189, "supervisorId": 111}, {"id": 167, "name": "Jennifer Perry", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 149, "supervisorId": 191}, {"id": 168, "name": "Jennifer Styles", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 149, "supervisorId": 191}, {"id": 169, "name": "Jenny Jordan", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 189, "supervisorId": 111}, {"id": 170, "name": "Jenny Seltzer", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 171, "name": "Jesenia Rosado", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 172, "name": "Jessica Pauley", "role": "Director", "dept": "Chat", "isGoldStar": true, "managerId": 179, "supervisorId": 170}, {"id": 173, "name": "Jessica Rayl", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 200, "supervisorId": 111}, {"id": 174, "name": "Jewel Jenkins", "role": "Director", "dept": "Logistics", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 175, "name": "Joe Hopkins", "role": "Director", "dept": "Account Management 3", "isGoldStar": true, "managerId": 244, "supervisorId": 191}, {"id": 176, "name": "John Aloisio", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 244, "supervisorId": 191}, {"id": 177, "name": "John Chavez", "role": "Director", "dept": "Jacksonville", "isGoldStar": true, "managerId": 122, "supervisorId": 123}, {"id": 178, "name": "John Choynowski", "role": "Director", "dept": "Chat", "isGoldStar": true, "managerId": 179, "supervisorId": 170}, {"id": 179, "name": "John Diaz", "role": "Director", "dept": "Analytics/Workforce", "isGoldStar": false, "managerId": null, "supervisorId": 170}, {"id": 180, "name": "Jon Klotz", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 108, "supervisorId": 191}, {"id": 181, "name": "Joshua Williams", "role": "Director", "dept": "Jacksonville", "isGoldStar": false, "managerId": 122, "supervisorId": 123}, {"id": 182, "name": "Joy Piscatelli", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 149, "supervisorId": 191}, {"id": 183, "name": "Juan Rodriguez", "role": "Director", "dept": "Retention", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 184, "name": "Justin Chadwick", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 198, "supervisorId": 191}, {"id": 185, "name": "Justin Piatt", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 108, "supervisorId": 191}, {"id": 186, "name": "KJ Ross", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 129, "supervisorId": 191}, {"id": 187, "name": "Kari Westervelt", "role": "Director", "dept": "Logistics", "isGoldStar": true, "managerId": 258, "supervisorId": 259}, {"id": 188, "name": "Katrenia Williams", "role": "Director", "dept": "Account Management 2", "isGoldStar": true, "managerId": 149, "supervisorId": 191}, {"id": 189, "name": "Kayla Goff", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": null, "supervisorId": 111}, {"id": 190, "name": "Kayla Potter", "role": "Director", "dept": "Account Management 3", "isGoldStar": true, "managerId": 108, "supervisorId": 191}, {"id": 191, "name": "Keri Coriano", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 192, "name": "Kersti Straub", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 193, "name": "Kevin Tucker", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 194, "name": "Kimberly Kukla", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 198, "supervisorId": 191}, {"id": 195, "name": "Kylie Paris", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 196, "name": "Lacey Black", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 198, "supervisorId": 191}, {"id": 197, "name": "Lindsey Griest", "role": "Director", "dept": "Retention", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 198, "name": "Lisa Brunetto", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": null, "supervisorId": 191}, {"id": 199, "name": "Lisa Sargent", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 189, "supervisorId": 111}, {"id": 200, "name": "Lisa Stricker", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": null, "supervisorId": 111}, {"id": 201, "name": "Lori Rendt", "role": "Director", "dept": "Analytics/Workforce", "isGoldStar": false, "managerId": 179, "supervisorId": 170}, {"id": 202, "name": "Lupe NietoLopez", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 103, "supervisorId": 191}, {"id": 203, "name": "Lynn Dow", "role": "Director", "dept": "Retention", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 204, "name": "Maddison Snow", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 205, "name": "Makayla Tifft", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 108, "supervisorId": 191}, {"id": 206, "name": "Malek Freiler", "role": "Director", "dept": "Jacksonville", "isGoldStar": false, "managerId": 122, "supervisorId": 123}, {"id": 207, "name": "Mark David", "role": "Rep", "dept": "Jacksonville", "isGoldStar": false, "managerId": 122, "supervisorId": 123}, {"id": 208, "name": "Martin Coon", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 254, "supervisorId": 111}, {"id": 209, "name": "Mary Thomas", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 149, "supervisorId": 191}, {"id": 210, "name": "Matt Bleakley", "role": "Director", "dept": "Analytics/Workforce", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 211, "name": "Matt Warren", "role": "Director", "dept": "Quotes", "isGoldStar": true, "managerId": 249, "supervisorId": 170}, {"id": 212, "name": "Micah Humphrey", "role": "Director", "dept": "Account Management 3", "isGoldStar": true, "managerId": 103, "supervisorId": 191}, {"id": 213, "name": "Michael Garthwaite", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 103, "supervisorId": 191}, {"id": 214, "name": "Mikaela Ham", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 108, "supervisorId": 191}, {"id": 215, "name": "Mikayla Lavigne", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 244, "supervisorId": 191}, {"id": 216, "name": "Nathan Thomas", "role": "Director", "dept": "Quotes", "isGoldStar": true, "managerId": 249, "supervisorId": 170}, {"id": 217, "name": "Nick Cruz", "role": "Director", "dept": "Account Management 2", "isGoldStar": true, "managerId": 129, "supervisorId": 191}, {"id": 218, "name": "Nick Nicastro", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 219, "name": "Nolan Ohanlon", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 220, "name": "Paul Muhonen", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 149, "supervisorId": 191}, {"id": 221, "name": "Petra Zamora", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 129, "supervisorId": 191}, {"id": 222, "name": "Rachel Chappuis", "role": "Director", "dept": "Logistics", "isGoldStar": false, "managerId": 258, "supervisorId": 259}, {"id": 223, "name": "Rebeca MendezVelez", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 103, "supervisorId": 191}, {"id": 224, "name": "Regan McAvoy", "role": "Director", "dept": "Analytics/Workforce", "isGoldStar": true, "managerId": 247, "supervisorId": 170}, {"id": 225, "name": "Reggie Costa-Scott", "role": "Director", "dept": "Quotes", "isGoldStar": true, "managerId": 249, "supervisorId": 170}, {"id": 226, "name": "Remy Maddocks", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 129, "supervisorId": 191}, {"id": 227, "name": "Rob Andreski", "role": "Director", "dept": "Food Service", "isGoldStar": true, "managerId": 134, "supervisorId": 259}, {"id": 228, "name": "Ryleigh Sanford", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 108, "supervisorId": 191}, {"id": 229, "name": "Samantha Johnson", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 230, "name": "Samantha Williams", "role": "Rep", "dept": "New Hire In Training", "isGoldStar": false, "managerId": 200, "supervisorId": 111}, {"id": 231, "name": "Sammy Card", "role": "Director", "dept": "Account Management 1", "isGoldStar": false, "managerId": 189, "supervisorId": 111}, {"id": 232, "name": "Sarah Kelleher", "role": "Director", "dept": "Analytics/Workforce", "isGoldStar": false, "managerId": 179, "supervisorId": 170}, {"id": 233, "name": "Scott Quartararo", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 234, "name": "Seth Hale", "role": "Director", "dept": "Food Service", "isGoldStar": true, "managerId": 235, "supervisorId": 259}, {"id": 235, "name": "Shantelle Jones", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": null, "supervisorId": 259}, {"id": 236, "name": "Shauntel Jones", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 103, "supervisorId": 191}, {"id": 237, "name": "Stephanie Hickey", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 129, "supervisorId": 191}, {"id": 238, "name": "Tarah Cherenfant", "role": "Director", "dept": "Account Management 2", "isGoldStar": true, "managerId": 198, "supervisorId": 191}, {"id": 239, "name": "Teresa Delia", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 249, "supervisorId": 170}, {"id": 240, "name": "Terry Callahan", "role": "Director", "dept": "Account Management 3", "isGoldStar": true, "managerId": 108, "supervisorId": 191}, {"id": 241, "name": "Tessa Leddy", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": null, "supervisorId": 170}, {"id": 242, "name": "Theodore Wass", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 160, "supervisorId": 125}, {"id": 243, "name": "Thomas O'Hanlon", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 244, "name": "Tobbitha Bishoff", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": null, "supervisorId": 191}, {"id": 245, "name": "Todd Anderson", "role": "Director", "dept": "Analytics/Workforce", "isGoldStar": false, "managerId": 179, "supervisorId": 170}, {"id": 246, "name": "Tom O'Hanlon", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 247, "name": "Tony Casella", "role": "Director", "dept": "Analytics/Workforce", "isGoldStar": false, "managerId": null, "supervisorId": 170}, {"id": 248, "name": "Tristan Kretzer", "role": "Director", "dept": "Account Management 2", "isGoldStar": false, "managerId": 149, "supervisorId": 191}, {"id": 249, "name": "Tyler Young", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": null, "supervisorId": 170}, {"id": 250, "name": "Valerie Taylor", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 251, "name": "Vanessa Parette", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 252, "name": "Victoria Channells", "role": "Director", "dept": "Account Management 3", "isGoldStar": false, "managerId": 129, "supervisorId": 191}, {"id": 253, "name": "Victoria Curley", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": null}, {"id": 254, "name": "Wayne Landi", "role": "Director", "dept": "New Hire In Training", "isGoldStar": false, "managerId": 330, "supervisorId": 111}, {"id": 255, "name": "Will Smith", "role": "Director", "dept": "Food Service", "isGoldStar": false, "managerId": 235, "supervisorId": 259}, {"id": 256, "name": "William Burmester", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 257, "name": "Zachary Boult", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 258, "name": "Zack Boult", "role": "Director", "dept": "Logistics", "isGoldStar": false, "managerId": null, "supervisorId": 259}, {"id": 259, "name": "Zaria Robinson", "role": "Director", "dept": "SR Management", "isGoldStar": false, "managerId": null, "supervisorId": 253}, {"id": 260, "name": "Zoe Boudreau", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 261, "name": "Zoe Marden", "role": "Director", "dept": "Quotes", "isGoldStar": false, "managerId": 247, "supervisorId": 170}, {"id": 262, "name": "Zoe Williams", "role": "Director", "dept": "Retention", "isGoldStar": false, "managerId": 258, "supervisorId": 259}
];

        const kpiConfigs = {
            "Sales": [{id:"outbound",label:"Outbound Calls",target:50,type:"number",agg:"sum"},{id:"talktime",label:"Avg Talk Time",target:120,type:"time",agg:"avg"},{id:"notes",label:"% Call Notes",target:100,type:"percent",agg:"avg"},{id:"invoices",label:"Invoices",target:10,type:"number",agg:"sum"},{id:"aux",label:"AUX Accuracy",target:95,type:"percent",agg:"avg"}],
            "Quotes": [{id:"projects",label:"Quotes Processed",target:50,type:"number",agg:"sum"},{id:"accuracy",label:"Quote Accuracy",target:98,type:"percent",agg:"avg"},{id:"items",label:"Items Quoted",target:500,type:"number",agg:"sum"},{id:"turnaround",label:"Turnaround (Hours)",target:8,type:"number",agg:"avg"}],
            "Food Service": [{id:"orders",label:"Food Orders",target:30,type:"number",agg:"sum"},{id:"call_time",label:"Avg Call Time",target:180,type:"time",agg:"avg"},{id:"notes",label:"% Order Notes",target:95,type:"percent",agg:"avg"},{id:"errors",label:"Order Errors",target:2,type:"number",agg:"sum"}],
            "Account Management 1": [{id:"touchpoints",label:"Client Touchpoints",target:20,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:8,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:3,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:75,type:"number",agg:"avg"}],
            "Account Management 2": [{id:"touchpoints",label:"Client Touchpoints",target:18,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:9,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:4,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:72,type:"number",agg:"avg"}],
            "Account Management 3": [{id:"touchpoints",label:"Client Touchpoints",target:15,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:10,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:5,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:70,type:"number",agg:"avg"}],
            "Analytics/Workforce": [{id:"tickets",label:"Tickets Closed",target:20,type:"number",agg:"sum"},{id:"quality",label:"Analysis Quality",target:95,type:"percent",agg:"avg"},{id:"projects",label:"Projects Completed",target:5,type:"number",agg:"sum"}],
            "New Hire In Training": [{id:"modules",label:"Modules Completed",target:10,type:"number",agg:"sum"},{id:"quizzes",label:"Quiz Avg (%)",target:85,type:"percent",agg:"avg"},{id:"shadows",label:"Shadow Hours",target:40,type:"number",agg:"sum"}]
        };

        const qualitativeSamples = {
            oppsThis: ["Focus on increasing daily talk time to 3:00 minutes.", "Back to the Basics - Call count and AUX accuracy.", "Increase daily sales average by calling decline accounts.", "Ensure full break/lunch compliance to maintain energy.", "Generate more calls during beginning and end of shift.", "Submitting 5 quotes over to the quotes department."],
            oppsLast: ["System Knowledge and understanding profits.", "Attendance report showed 1 occurrence.", "Shortened lunches and working through breaks.", "Low invoice count; need to ask for more opportunities.", "Missed AUXing back from break 4 times."],
            bestPractices: ["Practice setting clear goals- define your goals.", "Use morning call blocks to generate momentum.", "CAP during call blocks when focusing on declined accounts.", "Set a reminder on your phone when walking out to break.", "Ask for quotes or top 10 items while on calls."],
            actionPlan: ["Commit to following the schedule provided.", "Implement a 30-day performance improvement plan.", "Average 100 Calls a day for next 2 weeks.", "Strict 2 hr call block daily where Outlook is closed.", "Increase invoices received to a minimum of 5."],
            agentVoice: ["I agree to work with management to improve.", "My goal is to become a Goldstar rep.", "I understand this is not corrective action.", "Taking away the need for better organization.", "Goal: Increase sales by 10%."]
        };

        // --- 3. UI FUNCTIONS ---
        function applyTheme(t) { 
            if (!t) return;
            document.documentElement.setAttribute('data-theme', t); 
            localStorage.setItem('selectedTheme', t); 
        }

        function loadTheme() { 
            const t = localStorage.getItem('selectedTheme') || 'winter'; 
            applyTheme(t); 
            const el = document.getElementById('theme-select'); 
            if(el) el.value = t; 
        }

        function toggleSection(id) {
            const el = document.getElementById('list-'+id);
            if(!el) return;
            el.classList.toggle('hidden');
            const icon = document.getElementById('chev-'+id);
            if(icon) icon.textContent = el.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
            filterReps('All', null);
        }

        function filterReps(filterType, filterValue, buttonElement = null) {
            document.querySelectorAll('.hierarchy-item').forEach(btn => btn.classList.remove('active'));
            if (buttonElement) buttonElement.classList.add('active');
            
            currentFilter = { type: filterType, value: filterValue };
            
            const allRepButtons = document.querySelectorAll('#list-rep .hierarchy-item');
            
            allRepButtons.forEach(btn => {
                const repId = parseInt(btn.dataset.id);
                const rep = rawEmployees.find(e => e.id === repId);
                if (!rep) return; 
                
                let shouldShow = false;

                if (filterType === 'Department') {
                    shouldShow = rep.dept === filterValue;
                } else if (filterType === 'Manager') {
                    shouldShow = rep.managerId === filterValue;
                } else if (filterType === 'Supervisor') {
                    // Logic: Show if rep's manager reports to this supervisor OR rep directly reports to them
                    // Managers reporting to this supervisor:
                    const mgrsUnderSup = rawEmployees.filter(e => e.role === 'Manager' && e.supervisorId === filterValue).map(m => m.id);
                    shouldShow = (rep.supervisorId === filterValue) || (mgrsUnderSup.includes(rep.managerId));
                } else if (filterType === 'GoldStar') {
                    shouldShow = rep.isGoldStar;
                } else {
                    shouldShow = true;
                }

                btn.style.display = shouldShow ? 'flex' : 'none';
            });
            
            const titleEl = document.getElementById('view-title');
            if (titleEl) titleEl.textContent = filterType === 'All' ? 'Dashboard' : (filterType === 'GoldStar' ? 'Gold Star Reps' : filterValue);
            const subEl = document.getElementById('view-subtitle');
            if (subEl) subEl.textContent = filterType === 'All' ? 'Select an employee to view stats' : `Group View: ${filterType}`;
            
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('btn-new-review').style.display = 'none';
            
            // Show SR Manager in subtitle if Dept selected
            if (filterType === 'Department') {
                const sr = rawEmployees.find(e => (e.role === 'SR Manager' || e.role === 'Director') && e.dept === filterValue);
                if (sr) subEl.textContent += ` (Lead: ${sr.name})`;
            }
        }

        function selectRep(id, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            loadRepDashboard(id);
        }

        function renderSidebar() {
            const getRole = (r) => rawEmployees.filter(e => e.role === r).sort((a,b) => a.name.localeCompare(b.name));
            
            // Dept
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(d => d && d !== 'N/A').sort();
            document.getElementById('list-dept').innerHTML = depts.map(d => {
                const sr = rawEmployees.find(e => (e.role === 'SR Manager' || e.role === 'Director') && e.dept === d);
                return `<button onclick="filterReps('Department', '${d}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span>${d}</span><span class="text-xs opacity-50">${sr ? sr.name : ''}</span></button>`;
            }).join('');

            // Manager
            document.getElementById('list-mgr').innerHTML = getRole('Manager').map(m => 
                `<button onclick="filterReps('Manager', ${m.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded color-mgr">${m.name}</button>`
            ).join('');

            // Supervisor
            const sups = rawEmployees.filter(e => ['Supervisor', 'SR Manager', 'Director'].includes(e.role)).sort((a,b) => a.name.localeCompare(b.name));
            document.getElementById('list-sup').innerHTML = sups.map(s => 
                `<button onclick="filterReps('Supervisor', ${s.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded ${s.role === 'SR Manager' || s.role === 'Director' ? 'color-srmgr' : 'color-sup'}">${s.name} (${s.role})</button>`
            ).join('');

            // Reps
            document.getElementById('list-rep').innerHTML = getRole('Rep').map(r => 
                `<button data-id="${r.id}" onclick="selectRep(${r.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span class="${r.isGoldStar ? 'color-gold' : ''}">${r.name}</span><span class="text-xs opacity-50">${r.dept}</span></button>`
            ).join('');
            
            // Hide lists initially
            ['dept', 'mgr', 'sup'].forEach(id => {
                const el = document.getElementById('list-'+id);
                if(el) el.classList.add('hidden');
            });
        }

        // --- 4. CORE LOGIC ---

        function initData() {
            loadTheme(); // Safe to call because variable is defined above
            
            // Generate simulated data
            reviewDateRange = ["2024-11", "2024-12", "2025-01", "2025-02", "2025-03", "2025-04", "2025-05", "2025-06", "2025-07", "2025-08", "2025-09", "2025-10"];
            
            rawEmployees.forEach(emp => {
                if (emp.role !== 'Rep') return;
                reviewDateRange.forEach(month => {
                    const type = (month.endsWith("03")||month.endsWith("06")||month.endsWith("09")||month.endsWith("12")) ? "EOQ" : "EOM";
                    dbReviews.push({
                        repId: emp.id, date: month, type: type,
                        oppsThis: getRandomSubarray(qualitativeSamples.oppsThis, 2),
                        oppsLast: getRandomSubarray(qualitativeSamples.oppsLast, 2),
                        bestPractices: getRandomSubarray(qualitativeSamples.bestPractices, 2),
                        actionPlan: getRandomSubarray(qualitativeSamples.actionPlan, 2),
                        agentVoice: qualitativeSamples.agentVoice[0]
                    });
                    const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
                    kpis.forEach(kpi => {
                        let val = kpi.target * (1 + ((Math.random() * 0.6) - 0.2));
                        if(kpi.type==='percent' && val>100) val=99;
                        dbLogs.push({ repId: emp.id, date: month, kpiId: kpi.id, value: val });
                    });
                });
            });
            
            renderSidebar();
        }

        function loadRepDashboard(id) {
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            const mgr = rawEmployees.find(e => e.id === emp.managerId);
            const sup = rawEmployees.find(e => e.id === emp.supervisorId);
            
            document.getElementById('view-title').textContent = emp.name;
            document.getElementById('view-subtitle').textContent = `${emp.role} ‚Ä¢ ${emp.dept}`;
            
            let mgrText = mgr ? `<span class="color-mgr">${mgr.name}</span>` : "Unassigned";
            if (sup) mgrText += ` (via <span class="${sup.role === 'SR Manager' ? 'color-srmgr' : 'color-sup'}">${sup.name}</span>)`;
            document.getElementById('manager-name').innerHTML = mgrText;

            document.getElementById('page-create').classList.remove('active');
            document.getElementById('page-review').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'flex';
            
            // Reset Slider
            const slider = document.getElementById('review-date-slider');
            slider.max = reviewDateRange.length - 1;
            slider.value = reviewDateRange.length - 1;
            updateDashboardFromSlider();
        }

        function updateDashboardFromSlider() {
            if (!currentRepId) return;
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const dur = parseInt(document.getElementById('duration-select').value);
            const end = reviewDateRange[idx];
            let startIdx = idx - dur + 1; if(startIdx < 0) startIdx = 0;
            const start = reviewDateRange[startIdx];
            
            document.getElementById('current-review-date-display').textContent = `${start} to ${end}`;

            // Data Filtering
            const logs = dbLogs.filter(l => l.repId === currentRepId && l.date >= start && l.date <= end);
            const emp = rawEmployees.find(e => e.id === currentRepId);
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            
            // Populate Table with aggregation logic
            document.getElementById('kpi-table-body').innerHTML = kpis.map(k => {
                const sub = logs.filter(l => l.kpiId === k.id);
                let val = 0;
                if (sub.length) {
                    const sum = sub.reduce((a,b) => a+b.value, 0);
                    val = k.agg === 'sum' ? sum : (sum / sub.length);
                }
                const target = k.target * (k.agg === 'sum' ? dur : 1);
                const hit = k.moreIsBetter ? val >= target : val <= target;
                
                // Determine previous period for trend arrow
                let prevVal = val * 0.95; 
                let arrow = val > prevVal ? '<span class="text-green-500">‚Üë</span>' : '<span class="text-red-500">‚Üì</span>';

                return `<tr>
                    <td class="px-4 py-2">${k.label}</td>
                    <td class="px-4 py-2 text-right opacity-70">${formatVal(target, k.type)}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatVal(val, k.type)}</td>
                    <td class="px-4 py-2 text-center text-lg">${arrow} ${hit ? '‚úÖ' : ''}</td>
                </tr>`;
            }).join('');

            // Populate Text
            const rev = dbReviews.filter(r => r.repId === currentRepId && r.date <= end).sort((a,b) => b.date.localeCompare(a.date))[0];
            currentReview = { emp, review: rev, logs };

            const list = (id, arr) => document.getElementById(id).innerHTML = (arr||[]).map(i=>`<li>${i}</li>`).join('');
            if (rev) {
                list('text-opps-this', rev.oppsThis);
                list('text-opps-last', rev.oppsLast);
                list('text-best-practices', rev.bestPractices);
                list('text-action-plan', rev.actionPlan);
                document.getElementById('text-agent-voice').textContent = rev.agentVoice;
            } else {
                ['text-opps-this','text-opps-last','text-best-practices','text-action-plan'].forEach(id => document.getElementById(id).innerHTML = '');
                document.getElementById('text-agent-voice').textContent = 'No review data available for this period.';
            }

            // Chart Dropdown
            const sel = document.getElementById('chart-kpi-select');
            if (sel.children.length === 0) {
                sel.innerHTML = kpis.map(k => `<option value="${k.id}">${k.label}</option>`).join('');
            }
            updateChart();
        }

        function updateChart() {
            if (!currentRepId) return;
            const kpiId = document.getElementById('chart-kpi-select').value;
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const dates = reviewDateRange.slice(Math.max(0, idx-5), idx+1); 
            
            const data = dates.map(d => {
                const l = dbLogs.find(x => x.repId === currentRepId && x.date === d && x.kpiId === kpiId);
                return l ? l.value : 0;
            });

            const ctx = document.getElementById('trendChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: dates, datasets: [{ label: 'Trend', data: data, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        // --- HELPERS ---
        function formatVal(v, t) { 
            if (t === 'percent') return v.toFixed(1) + '%';
            if (t === 'time') { const m = Math.floor(v/60); const s = Math.floor(v%60); return `${m}:${s.toString().padStart(2,'0')}`; }
            return Math.floor(v);
        }
        function getRandomSubarray(arr, size) {
            const shuffled = arr.slice(0);
            let i = arr.length, temp, index;
            while (i--) { index = Math.floor(Math.random() * (i + 1)); temp = shuffled[index]; shuffled[index] = shuffled[i]; shuffled[i] = temp; }
            return shuffled.slice(0, size);
        }
        
        function openCreateReviewModal() {
            if(!currentRepId) return alert("Select Rep first");
            const emp = rawEmployees.find(e => e.id === currentRepId);
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'none';
            document.getElementById('new-review-rep-name').textContent = emp.name;
            document.getElementById('form-date').valueAsDate = new Date();
            
            // Generate Inputs
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => 
                `<div><label class="block text-sm text-main">${k.label}</label><input type="number" id="kpi-${k.id}" class="w-full border border-color rounded p-2 bg-input text-main"></div>`
            ).join('');
        }
        
        function saveNewReview() { alert("Saved locally!"); loadRepDashboard(currentRepId); }
        
        function openExportModal() { window.print(); }
        
        function triggerFlowSync() { alert("Syncing..."); }

        // Initialize App after DOM Content Loaded to prevent null reference errors
        document.addEventListener('DOMContentLoaded', initData);

    </script>
</body>
</html>
