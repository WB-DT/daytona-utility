<script>
        // --- 1. MSAL CONFIGURATION ---
        const msalConfig = {
            auth: {
                clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", 
                authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", 
                redirectUri: window.location.href
            },
            cache: { cacheLocation: "localStorage" }
        };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let username = "";

        // --- 2. FLOW URLS ---
        const GET_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c82c5aa6117a4df3b1f8dbb0f8a098bb/triggers/manual/paths/invoke?api-version=1";
        const SAVE_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/088be03ff3724bb4ac49e37532d96136/triggers/manual/paths/invoke?api-version=1";

        // --- 3. GLOBAL VARIABLES ---
        let currentRepId = null;
        let currentFilter = { type: 'All', value: null };
        let reviewDateRange = ["2024-11", "2024-12", "2025-01"]; // Default fallback
        let rawEmployees = []; 
        let dbReviews = [];
        let dbLogs = [];
        let currentReview = null;
        let chartInstance = null;

        // KPI Definitions
        const kpiConfigs = {"Sales":[{id:"outbound",label:"Outbound Calls",target:50,type:"number",agg:"sum"},{id:"talktime",label:"Avg Talk Time",target:120,type:"time",agg:"avg"},{id:"notes",label:"% Call Notes",target:100,type:"percent",agg:"avg"},{id:"invoices",label:"Invoices",target:10,type:"number",agg:"sum"},{id:"aux",label:"AUX Accuracy",target:95,type:"percent",agg:"avg"}],"Quotes":[{id:"projects",label:"Quotes Processed",target:50,type:"number",agg:"sum"},{id:"accuracy",label:"Quote Accuracy",target:98,type:"percent",agg:"avg"},{id:"items",label:"Items Quoted",target:500,type:"number",agg:"sum"},{id:"turnaround",label:"Turnaround (Hours)",target:8,type:"number",agg:"avg"}],"Food Service":[{id:"orders",label:"Food Orders",target:30,type:"number",agg:"sum"},{id:"call_time",label:"Avg Call Time",target:180,type:"time",agg:"avg"},{id:"notes",label:"% Order Notes",target:95,type:"percent",agg:"avg"},{id:"errors",label:"Order Errors",target:2,type:"number",agg:"sum"}],"Account Management 1":[{id:"touchpoints",label:"Client Touchpoints",target:20,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:8,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:3,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:75,type:"number",agg:"avg"}],"Account Management 2":[{id:"touchpoints",label:"Client Touchpoints",target:18,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:9,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:4,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:72,type:"number",agg:"avg"}],"Account Management 3":[{id:"touchpoints",label:"Client Touchpoints",target:15,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:10,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:5,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:70,type:"number",agg:"avg"}],"Analytics/Workforce":[{id:"tickets",label:"Tickets Closed",target:20,type:"number",agg:"sum"},{id:"quality",label:"Analysis Quality",target:95,type:"percent",agg:"avg"},{id:"projects",label:"Projects Completed",target:5,type:"number",agg:"sum"}],"New Hire In Training":[{id:"modules",label:"Modules Completed",target:10,type:"number",agg:"sum"},{id:"quizzes",label:"Quiz Avg (%)",target:85,type:"percent",agg:"avg"},{id:"shadows",label:"Shadow Hours",target:40,type:"number",agg:"sum"}]};

        // --- 4. AUTHENTICATION & API ---
        async function signIn() {
            try {
                const resp = await msalInstance.loginPopup({ scopes: ["User.Read"] });
                if (resp && resp.account) {
                    username = resp.account.username;
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('loading-overlay').style.display = 'flex';
                    initData();
                }
            } catch (e) {
                console.error("Login Failed:", e);
                alert("Login failed: " + e.message);
            }
        }

        async function getToken() {
            const account = msalInstance.getAllAccounts()[0];
            if (!account) return null;
            const request = { scopes: ["User.Read"], account: account };
            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (e) {
                console.warn("Silent token acquisition failed, trying popup...");
                try {
                    const response = await msalInstance.acquireTokenPopup(request);
                    return response.accessToken;
                } catch (err) {
                    console.error("Token error:", err);
                    return null;
                }
            }
        }

        async function callFlow(url, body) {
            const token = await getToken();
            if (!token) throw new Error("No access token available. Please sign in.");

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(body)
            };

            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`Flow Error: ${res.status} ${res.statusText}`);
            return await res.json();
        }

        // --- 5. INITIALIZATION ---
        async function initData() {
            loadTheme();

            // Check if user is signed in
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('auth-container').classList.remove('hidden');
                return;
            }

            // Update UI for loading
            const loader = document.getElementById('loading-overlay');
            if(loader) {
                loader.innerHTML = '<div class="spinner"></div><div id="loading-text">Fetching Data...</div>';
                loader.style.display = 'flex';
            }

            try {
                // CALL FLOW
                const data = await callFlow(GET_DATA_FLOW_URL, {});
                
                // Assign Data
                rawEmployees = data.employees || [];
                dbReviews = data.reviews || [];
                dbLogs = data.logs || [];

                // Update Dates
                if (dbLogs.length > 0) {
                    reviewDateRange = [...new Set(dbLogs.map(l => l.date))].sort();
                }

                // Render UI
                if(loader) loader.style.display = 'none';
                renderSidebar();
                console.log("Data Loaded Successfully:", rawEmployees.length, "employees");

            } catch (error) {
                console.error("Init Data Error:", error);
                if(loader) loader.innerHTML = `<div class="text-red-500 text-center font-bold">Error Loading Data<br><span class="text-sm font-normal">${error.message}</span><br><button onclick="location.reload()" class="mt-4 underline">Retry</button></div>`;
            }
        }

        // --- 6. UI LOGIC ---
        function renderSidebar() {
            if(!rawEmployees.length) return;

            const getRole = (r) => rawEmployees.filter(e => e.role === r).sort((a,b) => a.name.localeCompare(b.name));
            
            // Depts
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(d => d && d !== 'N/A').sort();
            document.getElementById('list-dept').innerHTML = depts.map(d => {
                const sr = rawEmployees.find(e => (e.role === 'SR Manager' || e.role === 'Director') && e.dept === d);
                return `<button onclick="filterReps('Department', '${d}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span>${d}</span><span class="text-xs opacity-50">${sr ? sr.name : ''}</span></button>`;
            }).join('');

            // Managers
            document.getElementById('list-mgr').innerHTML = getRole('Manager').map(m => 
                `<button onclick="filterReps('Manager', ${m.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded color-mgr">${m.name}</button>`
            ).join('');

            // Supervisors
            const sups = rawEmployees.filter(e => ['Supervisor', 'SR Manager', 'Director'].includes(e.role)).sort((a,b) => a.name.localeCompare(b.name));
            document.getElementById('list-sup').innerHTML = sups.map(s => 
                `<button onclick="filterReps('Supervisor', ${s.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded ${s.role === 'SR Manager' || s.role === 'Director' ? 'color-srmgr' : 'color-sup'}">${s.name} (${s.role})</button>`
            ).join('');

            // Reps
            document.getElementById('list-rep').innerHTML = getRole('Rep').map(r => 
                `<button data-id="${r.id}" onclick="selectRep(${r.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span class="${r.isGoldStar ? 'color-gold' : ''}">${r.name}</span><span class="text-xs opacity-50">${r.dept}</span></button>`
            ).join('');

            // Hide lists by default
            ['dept', 'mgr', 'sup'].forEach(id => {
                const el = document.getElementById('list-'+id);
                if(el) el.classList.add('hidden');
            });
        }

        function filterReps(type, val, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            document.querySelectorAll('#list-rep .hierarchy-item').forEach(rBtn => {
                const rep = rawEmployees.find(e => e.id == rBtn.dataset.id);
                if (!rep) return; 
                
                let show = false;
                if (type === 'Department') show = rep.dept === val;
                else if (type === 'Manager') show = rep.managerId === val;
                else if (type === 'Supervisor') {
                    const mgrsUnderSup = rawEmployees.filter(e => e.role === 'Manager' && e.supervisorId === val).map(m => m.id);
                    show = (rep.supervisorId === val) || (mgrsUnderSup.includes(rep.managerId));
                } else if (type === 'GoldStar') {
                    show = rep.isGoldStar;
                } else {
                    show = true;
                }
                rBtn.style.display = show ? 'flex' : 'none';
            });

            // Ensure Rep list is open
            const repList = document.getElementById('list-rep');
            if(repList.classList.contains('hidden')) toggleSection('rep');
            
            // Update Headers
            const title = type === 'All' ? 'Dashboard' : (type === 'GoldStar' ? 'Gold Star Reps' : val);
            const sub = type === 'All' ? 'Select an employee' : `Group View: ${type}`;
            document.getElementById('view-title').textContent = title;
            document.getElementById('view-subtitle').textContent = sub;
            
            // Hide Data Views
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('btn-new-review').style.display = 'none';
        }

        function selectRep(id, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            loadRepDashboard(id);
        }

        function loadRepDashboard(id) {
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            const mgr = rawEmployees.find(e => e.id === emp.managerId);
            const sup = rawEmployees.find(e => e.id === emp.supervisorId);

            document.getElementById('view-title').textContent = emp.name;
            document.getElementById('view-subtitle').textContent = `${emp.role} • ${emp.dept}`;
            
            let mgrText = mgr ? `<span class="color-mgr">${mgr.name}</span>` : "Unassigned";
            if (sup) mgrText += ` (via <span class="${sup.role === 'SR Manager' ? 'color-srmgr' : 'color-sup'}">${sup.name}</span>)`;
            document.getElementById('manager-name').innerHTML = mgrText;

            document.getElementById('page-create').classList.remove('active');
            document.getElementById('page-review').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'flex';
            
            // Slider Setup
            const slider = document.getElementById('review-date-slider');
            slider.max = Math.max(0, reviewDateRange.length - 1);
            slider.value = slider.max;
            updateDashboardFromSlider();
        }

        function updateDashboardFromSlider() {
            if (!currentRepId || reviewDateRange.length === 0) return;
            
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const dur = parseInt(document.getElementById('duration-select').value);
            const end = reviewDateRange[idx];
            let startIdx = Math.max(0, idx - dur + 1);
            const start = reviewDateRange[startIdx];

            document.getElementById('current-review-date-display').textContent = `${start} to ${end}`;

            const logs = dbLogs.filter(l => l.repId === currentRepId && l.date >= start && l.date <= end);
            const emp = rawEmployees.find(e => e.id === currentRepId);
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];

            document.getElementById('kpi-table-body').innerHTML = kpis.map(k => {
                const sub = logs.filter(l => l.kpiId === k.id);
                let val = 0;
                if(sub.length) {
                    const sum = sub.reduce((a,b)=>a+b.value,0);
                    val = k.agg === 'sum' ? sum : (sum/sub.length);
                }
                const t = k.target * (k.agg === 'sum' ? dur : 1);
                const hit = k.moreIsBetter ? val >= t : val <= t;
                let pVal = val * 0.95; 
                let arrow = val > pVal ? '<span class="text-green-500">↑</span>' : '<span class="text-red-500">↓</span>';
                return `<tr><td class="px-4 py-2">${k.label}</td><td class="px-4 py-2 text-right opacity-70">${formatVal(t, k.type)}</td><td class="px-4 py-2 text-right font-bold">${formatVal(val, k.type)}</td><td class="px-4 py-2 text-center text-lg">${arrow} ${hit?'✅':''}</td></tr>`;
            }).join('');

            // Reviews
            const rev = dbReviews.filter(r => r.repId === currentRepId && r.date <= end).sort((a,b)=>b.date.localeCompare(a.date)).reverse()[0];
            currentReview = { emp, review: rev, logs };

            const fill = (id, arr) => {
                const el = document.getElementById(id);
                if(!el) return;
                el.innerHTML = (arr && arr.length) ? arr.map(i=>`<li>${i}</li>`).join('') : '<li class="text-muted">No data.</li>';
            };
            
            if (rev) {
                fill('text-opps-this', rev.oppsThis);
                fill('text-opps-last', rev.oppsLast);
                fill('text-best-practices', rev.bestPractices);
                fill('text-action-plan', rev.actionPlan);
                document.getElementById('text-agent-voice').textContent = rev.agentVoice || '--';
            } else {
                fill('text-opps-this', []); fill('text-opps-last', []);
                fill('text-best-practices', []); fill('text-action-plan', []);
                document.getElementById('text-agent-voice').textContent = 'No review data found for this period.';
            }
            
            const sel = document.getElementById('chart-kpi-select');
            if(sel.children.length === 0) sel.innerHTML = kpis.map(k => `<option value="${k.id}">${k.label}</option>`).join('');
            updateChart();
        }

        function updateChart() {
            if (!currentRepId) return;
            const kpiId = document.getElementById('chart-kpi-select').value;
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const dates = reviewDateRange.slice(Math.max(0, idx-5), idx+1);
            const data = dates.map(d => { const l = dbLogs.find(x => x.repId === currentRepId && x.date === d && x.kpiId === kpiId); return l ? l.value : 0; });
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: dates, datasets: [{ label: 'Trend', data: data, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
        }

        // --- HELPERS ---
        function formatVal(v, t) { if(t==='percent') return v.toFixed(1)+'%'; if(t==='time') return `${Math.floor(v/60)}:${Math.floor(v%60).toString().padStart(2,'0')}`; return Math.floor(v); }
        function applyTheme(t) { if(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('selectedTheme', t); } }
        function loadTheme() { const t = localStorage.getItem('selectedTheme') || 'winter'; applyTheme(t); const el = document.getElementById('theme-select'); if(el) el.value = t; }
        function toggleSection(id) { const el = document.getElementById('list-'+id); if(el) { el.classList.toggle('hidden'); document.getElementById('chev-'+id).textContent = el.classList.contains('hidden') ? '▼' : '▲'; filterReps('All', null); } }
        function openExportModal() { window.print(); }
        function triggerFlowSync() { alert("Sync triggered... (Requires Flow configuration)"); callFlow(GET_DATA_FLOW_URL, {}).then(()=>alert("Done")); }
        
        function openCreateReviewModal() {
            if(!currentRepId) return alert("Select Rep");
            const e = rawEmployees.find(x=>x.id===currentRepId);
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.add('active');
            document.getElementById('btn-new-review').style.display='none';
            document.getElementById('new-review-rep-name').textContent=e.name;
            document.getElementById('form-date').valueAsDate=new Date();
            const kpis = kpiConfigs[e.dept] || kpiConfigs["Sales"];
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => `<div><label class="text-sm font-bold text-main">${k.label}</label><input id="kpi-${k.id}" type="number" class="w-full border p-2 rounded bg-input text-main"></div>`).join('');
        }

        async function saveNewReview() {
            const emp = rawEmployees.find(e => e.id === currentRepId);
            const dt = document.getElementById('form-date').value;
            if(!dt) return alert("Select date");
            
            const payload = {
                repId: currentRepId,
                date: dt,
                type: document.getElementById('form-type').value,
                reviewerLevel: document.getElementById('form-level').value,
                oppsThis: document.getElementById('form-opps-this').value.split('\n'),
                actionPlan: document.getElementById('form-action-plan').value.split('\n'),
                specialNotes: document.getElementById('form-special-notes').value,
                kpis: []
            };
            
            // KPI collection logic...
            try {
                await callFlow(SAVE_DATA_FLOW_URL, payload);
                alert("Review Saved!");
                initData(); // Reload
            } catch(e) { alert("Save failed: " + e.message); }
        }

        // BOOTSTRAP
        document.addEventListener('DOMContentLoaded', initData);

    </script>
</body>
</html>
