<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Hub Pro + Migration Tool</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            darkMode: ['class', '[data-theme="midnight"]'],
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: 'var(--color-primary)',
                        bg: 'var(--color-bg)',
                        card: 'var(--color-card)',
                        text: 'var(--color-text)',
                        muted: 'var(--color-muted)',
                        border: 'var(--color-border)',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>

    <style>
        /* --- THEMING VARIABLES --- */
        :root { --color-primary: #002f6c; --color-bg: #f4f7f6; --color-card: #ffffff; --color-text: #2c3e50; --color-muted: #7f8c8d; --color-border: #e2e8f0; --secondary: #d42e12; }
        [data-theme="midnight"] { --color-primary: #60a5fa; --color-bg: #0f172a; --color-card: #1e293b; --color-text: #f1f5f9; --color-muted: #94a3b8; --color-border: #334155; --secondary: #f87171; }
        
        body { background-color: var(--color-bg); color: var(--color-text); transition: background-color 0.3s, color 0.3s; }
        
        /* --- UTILITIES --- */
        .glass-panel { background: var(--color-card); border: 1px solid var(--color-border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hidden-force { display: none !important; }
        .animate-enter { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- COMPONENT STYLES --- */
        .view { display: none; }
        .view.active { display: block; animation: slideIn 0.3s ease-in-out; }

        .nav-item { cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(0,0,0,0.05); border-left-color: var(--secondary); color: var(--color-primary); }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 10px 12px; background: var(--color-bg); color: var(--color-muted); font-weight: 700; border-bottom: 2px solid var(--color-border); text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--color-border); vertical-align: top; }
        tr:hover td { background: rgba(0,0,0,0.02); }

        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-review { background: #fef9c3; color: #854d0e; }

        .tabs { display: flex; gap: 20px; border-bottom: 2px solid var(--color-border); margin-bottom: 20px; }
        .tab { padding: 10px 0; cursor: pointer; color: var(--color-muted); font-weight: 500; position: relative; }
        .tab.active { color: var(--color-primary); }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: var(--color-primary); }

        /* Form Inputs */
        input, select, textarea { background-color: var(--color-card); color: var(--color-text); border-color: var(--color-border); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); ring: 2px; }

        /* Terminal Style for Migration Logs */
        .console-log {
            background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; font-size: 0.75rem;
            padding: 1rem; border-radius: 0.5rem; height: 150px; overflow-y: auto;
            border: 1px solid #333; margin-bottom: 1rem;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="loading-overlay" class="fixed inset-0 z-[9998] bg-white flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700" id="loading-text">Loading System...</h2>
        <button onclick="window.forceLoad()" id="force-load-btn" class="mt-8 text-xs text-red-400 hover:text-red-600 underline hidden">Force Load Dashboard</button>
    </div>

    <aside id="sidebar-container" class="w-64 bg-card border-r border-border flex flex-col z-20 shadow-xl transition-all duration-300 hidden-force">
        <div class="p-6 border-b border-border flex items-center gap-3">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold shadow">P</div>
            <h1 class="font-bold text-lg tracking-tight text-text">Performance<span class="text-primary">Hub</span></h1>
        </div>
        
        <div class="flex-1 overflow-y-auto px-2 space-y-1" id="nav-content">
            <div class="mt-4 px-3 text-xs font-bold text-muted uppercase">Main Menu</div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3 active" onclick="router.navigate('employees')">
                <i class="fa-solid fa-users w-5 text-center"></i> All Employees
            </div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3" onclick="router.navigate('reviews-list')">
                <i class="fa-solid fa-clipboard-check w-5 text-center"></i> Review Log
            </div>
            
            <div class="mt-4 px-3 text-xs font-bold text-muted uppercase">Admin</div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3 text-warning bg-warning/5 border border-warning/20" onclick="router.navigate('migration')">
                <i class="fa-solid fa-server w-5 text-center"></i> Migration Hub
            </div>
            
            <div id="dept-groups" class="mt-4 pt-4 border-t border-border"></div>
        </div>

        <div class="p-4 border-t border-border">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-primary/10 text-primary rounded-full flex items-center justify-center"><i class="fa-solid fa-user"></i></div>
                <div class="overflow-hidden">
                    <div id="user-name" class="text-sm font-bold text-text truncate">User</div>
                    <div class="text-[10px] text-muted truncate">Connected</div>
                </div>
            </div>
        </div>
    </aside>

    <div id="main-content" class="flex-1 flex flex-col h-full overflow-hidden relative hidden-force">
        
        <header class="h-16 bg-card border-b border-border flex items-center justify-between px-6 shadow-sm z-10">
            <div>
                <h2 id="page-title" class="text-xl font-bold text-text">Team Dashboard</h2>
                <div id="breadcrumbs" class="text-xs text-muted flex items-center gap-2">Home</div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="window.setTheme('winter')" class="p-2 text-muted hover:text-primary transition-colors"><i class="fa-solid fa-sun"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6">
            
            <div id="view-employees" class="view active max-w-7xl mx-auto">
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-4 border-b border-border bg-bg/50 flex justify-between items-center">
                        <h3 class="font-bold text-text">Employee Roster</h3>
                        <div class="text-xs text-muted" id="roster-count">0 Records</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="emp-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Title</th>
                                    <th>Department</th>
                                    <th>Manager</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-migration" class="view max-w-7xl mx-auto">
                
                <div class="glass-panel p-6 rounded-xl mb-6">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-10 h-10 rounded-lg bg-warning text-white flex items-center justify-center text-lg shadow-lg"><i class="fa-solid fa-file-import"></i></div>
                        <div>
                            <h2 class="text-xl font-bold text-text">Data Migration & Testing</h2>
                            <p class="text-xs text-muted">Parse files into the <strong>Review</strong> and <strong>KPI</strong> tables.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-bg/50 p-4 rounded-lg border border-border flex flex-col justify-center">
                            <input type="file" id="mig-file-input" multiple class="hidden" onchange="window.handleMigrationFiles(this)">
                            <button onclick="document.getElementById('mig-file-input').click()" class="w-full bg-white hover:bg-bg border border-border text-text font-semibold py-2 px-4 rounded shadow-sm mb-2 transition-all flex items-center justify-center gap-2">
                                <i class="fa-regular fa-file"></i> Select Files
                            </button>
                            <input type="file" id="mig-folder-input" webkitdirectory multiple class="hidden" onchange="window.handleMigrationFiles(this)">
                            <button onclick="document.getElementById('mig-folder-input').click()" class="w-full bg-white hover:bg-bg border border-border text-text font-semibold py-2 px-4 rounded shadow-sm transition-all flex items-center justify-center gap-2">
                                <i class="fa-regular fa-folder-open"></i> Select Folder
                            </button>
                            <div id="mig-count" class="text-center text-xs font-bold text-muted mt-2">0 files selected</div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <button id="btn-parse" onclick="window.startParsing()" class="h-full bg-primary text-white py-2 rounded-lg font-bold shadow opacity-50 cursor-not-allowed flex items-center justify-center gap-2" disabled>
                                <i class="fa-solid fa-gears"></i> Parse to Tables
                            </button>
                        </div>
                        
                        <div class="flex flex-col gap-2">
                            <button id="btn-test-load" onclick="window.loadToDashboard()" class="h-1/2 bg-indigo-600 text-white py-2 rounded-lg font-bold shadow opacity-50 cursor-not-allowed flex items-center justify-center gap-2" disabled>
                                <i class="fa-solid fa-vial"></i> Test: Load to App
                            </button>
                            <button id="btn-upload" onclick="window.uploadBatches()" class="h-1/2 bg-success text-white py-2 rounded-lg font-bold shadow opacity-50 cursor-not-allowed flex items-center justify-center gap-2" disabled>
                                <i class="fa-solid fa-cloud-arrow-up"></i> Upload to Flow
                            </button>
                        </div>
                    </div>
                    
                    <div id="mig-console" class="console-log">
                        > Ready for files...
                    </div>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden min-h-[400px]">
                    <div class="flex border-b border-border bg-bg/50">
                        <button class="px-6 py-3 text-sm font-bold text-primary border-b-2 border-primary bg-white" onclick="switchPreviewTab('reviews', this)">
                            Reviews Table (<span id="count-reviews">0</span>)
                        </button>
                        <button class="px-6 py-3 text-sm font-bold text-muted hover:text-text" onclick="switchPreviewTab('kpis', this)">
                            KPIs Table (<span id="count-kpis">0</span>)
                        </button>
                    </div>

                    <div id="preview-reviews" class="block h-96 overflow-y-auto">
                        <table class="w-full">
                            <thead class="sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th>#</th>
                                    <th>Employee Name</th>
                                    <th>Review Date</th>
                                    <th>Review Type</th>
                                    <th>Opportunities</th>
                                    <th>Action Plan</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-preview-reviews" class="bg-white">
                                <tr><td colspan="6" class="text-center p-8 text-muted italic">No data parsed yet. Select files and click "Parse".</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="preview-kpis" class="hidden h-96 overflow-y-auto">
                        <table class="w-full">
                            <thead class="sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th>#</th>
                                    <th>Employee Name</th>
                                    <th>Log Date</th>
                                    <th>Metric Name</th>
                                    <th>Value</th>
                                    <th>Source File</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-preview-kpis" class="bg-white">
                                <tr><td colspan="6" class="text-center p-8 text-muted italic">No data parsed yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-employee-detail" class="view max-w-6xl mx-auto">
                <div class="mb-6 flex items-center justify-between">
                    <button onclick="router.navigate('employees')" class="text-sm font-medium text-muted hover:text-primary flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> Back</button>
                </div>
                <div class="glass-panel p-8 rounded-xl mb-6">
                    <h1 id="detail-name" class="text-3xl font-bold text-primary mb-2">Employee</h1>
                    <div class="flex gap-4 text-sm text-text"><span id="detail-dept" class="font-bold">--</span> | <span id="detail-title">--</span></div>
                </div>
                <div class="glass-panel rounded-xl overflow-hidden p-0">
                    <div class="p-4 bg-bg border-b border-border font-bold">Review History</div>
                    <table id="detail-reviews-table">
                        <thead><tr><th>Date</th><th>Type</th><th>Agent Voice</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- FLOW CONFIG ---
        // Replace this URL with your actual Power Automate Flow HTTP trigger
        const FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg";
        
        // --- STATE ---
        let migrationQueue = { reviews: [], kpis: [] };
        let store = { employees: [], reviews: [] }; // Global App State
        let selectedFiles = [];

        // --- MIGRATION HANDLERS ---
        window.handleMigrationFiles = function(input) {
            const files = Array.from(input.files).filter(f => f.name.endsWith('.docx') || f.name.endsWith('.pdf'));
            if(files.length === 0) return logConsole("! No valid files selected.");

            selectedFiles = files;
            document.getElementById('mig-count').textContent = `${files.length} files queued`;
            logConsole(`> Queued ${files.length} files.`);
            
            // Enable Parse
            const btn = document.getElementById('btn-parse');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        };

        window.startParsing = async function() {
            if(!selectedFiles.length) return;
            
            logConsole(`> --- STARTING PARSE ---`);
            migrationQueue = { reviews: [], kpis: [] }; // Clear queue
            
            // UI Feedback
            const btn = document.getElementById('btn-parse');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Parsing...`;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                logConsole(`> Reading [${i+1}/${selectedFiles.length}]: ${file.name}`);
                
                try {
                    let text = "";
                    if (file.name.endsWith('.docx')) {
                        const ab = await file.arrayBuffer();
                        const res = await mammoth.extractRawText({ arrayBuffer: ab });
                        text = res.value;
                    } else if (file.name.endsWith('.pdf')) {
                        const ab = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(ab).promise;
                        for (let j = 1; j <= pdf.numPages; j++) {
                            const page = await pdf.getPage(j);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ") + "\n";
                        }
                    }

                    if(text) {
                        const data = extractDataFromText(text);
                        if(data.name) {
                            // 1. Add to Reviews Table Queue
                            const revObj = {
                                id: i, // temp id
                                fileName: file.name,
                                cr714_employeename: data.name,
                                cr714_reviewdate: data.date,
                                cr714_reviewtype: "End of Month", // Default/Inferred
                                cr714_opportunities_current: data.opps,
                                cr714_actionplan: data.plan,
                                cr714_agentvoice: data.voice
                            };
                            migrationQueue.reviews.push(revObj);

                            // 2. Add to KPIs Table Queue (Simple regex for demo)
                            // Looks for patterns like "Call Volume: 50" or "Score: 90"
                            const kpiRegex = /(Call Volume|Sales|Score|Quality)[:\s]+(\d+)/gi;
                            let match;
                            while ((match = kpiRegex.exec(text)) !== null) {
                                migrationQueue.kpis.push({
                                    id: migrationQueue.kpis.length,
                                    fileName: file.name,
                                    cr714_employeename: data.name,
                                    cr714_logdate: data.date,
                                    cr714_kpiname: match[1],
                                    cr714_kpivalue: match[2]
                                });
                            }
                        } else {
                            logConsole(`  ! Could not find Agent Name in ${file.name}`);
                        }
                    }
                } catch(e) {
                    logConsole(`  ! Error: ${e.message}`);
                }
            }

            btn.innerHTML = originalText;
            logConsole(`> Parse Complete.`);
            updatePreviewTables();
            
            // Enable Next Steps
            if(migrationQueue.reviews.length > 0) {
                document.getElementById('btn-test-load').disabled = false;
                document.getElementById('btn-test-load').classList.remove('opacity-50', 'cursor-not-allowed');
                
                document.getElementById('btn-upload').disabled = false;
                document.getElementById('btn-upload').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        function updatePreviewTables() {
            // Update Counts
            safeSetText('count-reviews', migrationQueue.reviews.length);
            safeSetText('count-kpis', migrationQueue.kpis.length);

            // Populate Reviews Table
            const tbodyRev = document.getElementById('tbody-preview-reviews');
            tbodyRev.innerHTML = migrationQueue.reviews.map((r, idx) => `
                <tr class="hover:bg-blue-50">
                    <td class="text-xs text-muted">${idx+1}</td>
                    <td class="font-bold text-primary">${r.cr714_employeename}</td>
                    <td>${r.cr714_reviewdate}</td>
                    <td><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${r.cr714_reviewtype}</span></td>
                    <td class="text-xs truncate max-w-[150px]" title="${r.cr714_opportunities_current}">${r.cr714_opportunities_current || '-'}</td>
                    <td class="text-xs truncate max-w-[150px]" title="${r.cr714_actionplan}">${r.cr714_actionplan || '-'}</td>
                </tr>
            `).join('');

            // Populate KPIs Table
            const tbodyKpi = document.getElementById('tbody-preview-kpis');
            if(migrationQueue.kpis.length === 0) {
                tbodyKpi.innerHTML = '<tr><td colspan="6" class="text-center p-4">No KPIs found in text.</td></tr>';
            } else {
                tbodyKpi.innerHTML = migrationQueue.kpis.map((k, idx) => `
                    <tr>
                        <td class="text-xs text-muted">${idx+1}</td>
                        <td class="font-bold">${k.cr714_employeename}</td>
                        <td>${k.cr714_logdate}</td>
                        <td>${k.cr714_kpiname}</td>
                        <td class="font-mono font-bold text-secondary">${k.cr714_kpivalue}</td>
                        <td class="text-xs text-muted truncate max-w-[100px]">${k.fileName}</td>
                    </tr>
                `).join('');
            }
        }

        window.loadToDashboard = function() {
            // This maps the parsed data into the app's main state "store.reviews"
            // So you can click "All Employees" -> "Profile" and see the data there immediately.
            
            // Map parsed reviews to store format
            const testReviews = migrationQueue.reviews.map(r => {
                // Find matching employee to link ID
                const emp = store.employees.find(e => e.name.toLowerCase().includes(r.cr714_employeename.toLowerCase().split(' ')[0]));
                return {
                    id: 'mig-' + r.id,
                    empId: emp ? emp.id : 'unknown',
                    date: r.cr714_reviewdate,
                    type: r.cr714_reviewtype,
                    oppsThis: r.cr714_opportunities_current,
                    actionPlan: r.cr714_actionplan,
                    agentVoice: r.cr714_agentvoice,
                    status: 'Staged'
                };
            });

            store.reviews = [...store.reviews, ...testReviews];
            logConsole(`> Loaded ${testReviews.length} reviews into Dashboard memory.`);
            alert("Data Loaded to App! Go to 'All Employees' and click a profile to verify.");
            router.navigate('employees');
        };

        window.uploadBatches = async function() {
            const BATCH_SIZE = 20;
            const reviews = migrationQueue.reviews;
            const total = Math.ceil(reviews.length / BATCH_SIZE);
            
            if(!confirm(`Upload ${reviews.length} records to Flow?`)) return;

            logConsole(`> Starting Upload...`);
            for(let i=0; i<reviews.length; i+=BATCH_SIZE) {
                const batch = reviews.slice(i, i+BATCH_SIZE);
                const num = Math.floor(i/BATCH_SIZE)+1;
                logConsole(`> Sending Batch ${num}/${total}...`);
                
                try {
                    await fetch(FLOW_URL, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ mode: 'bulk_upload', table: 'reviews', data: batch })
                    });
                    logConsole(`  > Batch ${num} OK.`);
                } catch(e) {
                    logConsole(`  ! Batch ${num} Failed: ${e.message}`);
                }
            }
            alert("Upload Complete.");
        };

        // --- TEXT EXTRACTOR ---
        function extractDataFromText(text) {
            const clean = text.replace(/\s+/g, ' ').trim();
            let nameMatch = clean.match(/Agent Name[:\s,]*([A-Za-z]+[\s]+[A-Za-z]+)/i);
            let dateMatch = clean.match(/Date[:\s,]*(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
            
            const getSection = (headers) => {
                let start = -1;
                for(let h of headers) { let idx = clean.search(new RegExp(h, "i")); if(idx !== -1) { start = idx + h.length; break; } }
                if(start === -1) return "";
                const stops = ["Action Plan", "Best Practices", "Agent's Voice", "Manager Signature", "Next Steps"];
                let end = clean.length;
                for(let s of stops) { let idx = clean.indexOf(s, start + 10); if(idx !== -1 && idx < end) end = idx; }
                return clean.substring(start, end).replace(/^[:\-\s]+/, '').trim();
            };

            return {
                name: nameMatch ? nameMatch[1] : null,
                date: dateMatch ? new Date(dateMatch[1]).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                plan: getSection(["Action Plan"]),
                best: getSection(["Best Practices"]),
                voice: getSection(["Agent's Voice", "Buy In"]),
                opps: getSection(["Summary of Expectations", "Opportunities"])
            };
        }

        // --- APP INIT ---
        async function initData() {
            // Loading the raw employee list you provided
            const rawData = { "value": [
                {"cr714_employeename":"Joshua Williams","cr714_employeeinformation1id":"9c98e6d3-997e-f011-b4cb-000d3a149458","cr714_department@OData.Community.Display.V1.FormattedValue":"Jacksonville","cr714_title@OData.Community.Display.V1.FormattedValue":"Rep","cr714_managerassigned":"Celah Teschner","cr714_status@OData.Community.Display.V1.FormattedValue":"Active"},
                {"cr714_employeename":"Abigail Landi","cr714_employeeinformation1id":"4e3a4020-1f7d-f011-b4cb-000d3a537e3f","cr714_department@OData.Community.Display.V1.FormattedValue":"New Hire In Training","cr714_title@OData.Community.Display.V1.FormattedValue":"Rep","cr714_managerassigned":"Tondalaya Currier","cr714_status@OData.Community.Display.V1.FormattedValue":"Active"}
            ]};

            store.employees = rawData.value.map(e => ({
                id: e.cr714_employeeinformation1id,
                name: e.cr714_employeename,
                title: e['cr714_title@OData.Community.Display.V1.FormattedValue'],
                dept: e['cr714_department@OData.Community.Display.V1.FormattedValue'],
                manager: e.cr714_managerassigned,
                status: e['cr714_status@OData.Community.Display.V1.FormattedValue']
            }));

            renderEmployeeList();
            renderSidebar();
            toggleForce('loading-overlay', false);
            toggleForce('sidebar-container', true);
            toggleForce('main-content', true);
        }

        // --- UI HELPERS ---
        const router = {
            navigate: (viewId) => {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
            },
            openEmployee: (empId) => {
                store.currentEmployee = store.employees.find(e => e.id === empId);
                renderEmployeeProfile();
                router.navigate('employee-detail');
            },
            backToProfile: () => router.navigate('employee-detail')
        };

        function renderEmployeeList() {
            document.querySelector('#emp-table tbody').innerHTML = store.employees.map(e => `
                <tr onclick="router.openEmployee('${e.id}')">
                    <td class="font-medium text-primary">${e.name}</td>
                    <td>${e.title}</td>
                    <td>${e.dept}</td>
                    <td>${e.manager}</td>
                    <td><span class="status-badge status-active">${e.status}</span></td>
                </tr>
            `).join('');
            safeSetText('roster-count', `${store.employees.length} Records`);
        }

        function renderEmployeeProfile() {
            const emp = store.currentEmployee;
            if(!emp) return;
            safeSetText('detail-name', emp.name);
            safeSetText('detail-title', emp.title);
            safeSetText('detail-dept', emp.dept);
            
            // Show reviews for this user
            const userReviews = store.reviews.filter(r => r.empId === emp.id);
            document.querySelector('#detail-reviews-table tbody').innerHTML = userReviews.length ? userReviews.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.type}</td>
                    <td class="truncate max-w-xs text-xs">${r.agentVoice || '-'}</td>
                    <td><span class="status-badge status-review">${r.status}</span></td>
                </tr>
            `).join('') : '<tr><td colspan="4" class="text-center p-4 text-muted">No reviews yet. Check Migration Hub.</td></tr>';
        }

        function renderSidebar() {
            const depts = [...new Set(store.employees.map(e => e.dept))];
            document.getElementById('dept-groups').innerHTML = depts.map(d => `
                <div class="mb-2"><div class="px-3 text-xs font-bold text-muted uppercase">${d}</div></div>
            `).join('');
        }

        function switchPreviewTab(tab, btn) {
            document.getElementById('preview-reviews').classList.add('hidden');
            document.getElementById('preview-kpis').classList.add('hidden');
            document.getElementById(`preview-${tab}`).classList.remove('hidden');
            
            btn.parentElement.querySelectorAll('button').forEach(b => {
                b.classList.remove('border-b-2', 'border-primary', 'bg-white', 'text-primary');
                b.classList.add('text-muted');
            });
            btn.classList.add('border-b-2', 'border-primary', 'bg-white', 'text-primary');
            btn.classList.remove('text-muted');
        }

        // Utils
        const safeSetText = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        const toggleForce = (id, show) => { const el = document.getElementById(id); if(el) show ? el.classList.remove('hidden-force') : el.classList.add('hidden-force'); };
        function logConsole(msg) { const c = document.getElementById('mig-console'); c.innerHTML += msg + "<br>"; c.scrollTop = c.scrollHeight; }
        
        document.addEventListener('DOMContentLoaded', () => { initData(); });

    </script>
</body>
</html>
