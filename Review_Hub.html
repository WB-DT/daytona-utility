<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rep Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        :root {
            --bg-app: #f1f5f9; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --primary: #4f46e5; --primary-fg: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --color-srmgr: #f97316; --color-mgr: #06b6d4; --color-sup: #22c55e; --color-gold: #facc15;
        }
        /* Themes */
        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; }
        
        .bg-app { background-color: var(--bg-app); } .bg-card { background-color: var(--bg-card); } .bg-input { background-color: var(--bg-input); }
        .text-main { color: var(--text-main); } .text-muted { color: var(--text-muted); } .border-color { border-color: var(--border-color); }
        .shadow-theme { box-shadow: var(--shadow); }
        .bg-primary { background-color: var(--primary); color: var(--primary-fg); }
        .sidebar-header { background-color: var(--primary); color: var(--primary-fg); }
        
        .hierarchy-item:hover { background-color: var(--border-color); }
        .hierarchy-item.active { background-color: var(--border-color); border-left: 4px solid var(--primary); }
        
        .color-srmgr { color: var(--color-srmgr); font-weight: 700; }
        .color-mgr { color: var(--color-mgr); font-weight: 600; }
        .color-sup { color: var(--color-sup); font-weight: 600; }
        .color-gold { color: var(--color-gold); font-weight: 600; }
        
        .page { display: none; } #page-review.active, #page-create.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: var(--text-main); transition: opacity 0.3s; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-app antialiased h-screen flex overflow-hidden">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Connecting to Dataverse...</div>
    </div>

    <div class="w-1/4 min-w-[300px] bg-card border-r border-color flex flex-col shadow-theme z-10">
        <div class="p-4 border-b border-color sidebar-header">
            <h1 class="text-xl font-bold">Performance Hub</h1>
            <p class="text-xs opacity-80">Dataverse Connected</p>
        </div>
        <div class="flex-1 overflow-y-auto">
            <div class="border-b border-color"><button onclick="toggleSection('dept')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Department <span id="chev-dept">‚ñº</span></button><div id="list-dept" class="p-2 space-y-1 hidden"></div></div>
            <div class="border-b border-color"><button onclick="toggleSection('mgr')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Manager Group <span id="chev-mgr">‚ñº</span></button><div id="list-mgr" class="p-2 space-y-1 hidden"></div></div>
            <div class="border-b border-color"><button onclick="toggleSection('sup')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Supervisor Group <span id="chev-sup">‚ñº</span></button><div id="list-sup" class="p-2 space-y-1 hidden"></div></div>
            <div class="border-b border-color"><button onclick="filterReps('GoldStar', true, this)" class="hierarchy-item block w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase">Gold Star Reps üåü</button></div>
            <div class="flex-1"><button onclick="toggleSection('rep')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Representative <span id="chev-rep">‚ñ≤</span></button><div id="list-rep" class="p-2 space-y-1 hidden"></div></div>
        </div>
        <div class="p-4 border-t border-color bg-input">
            <button onclick="initData()" class="w-full bg-card border border-color text-main py-2 rounded shadow-theme hover:bg-input text-sm font-medium flex justify-center items-center gap-2">
                Refresh Data
            </button>
        </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden relative">
        <header class="bg-card border-b border-color p-4 flex justify-between items-center shadow-theme">
            <div><h2 id="view-title" class="text-2xl font-bold text-main">Dashboard</h2><p id="view-subtitle" class="text-sm text-muted">Select an employee</p></div>
            <div class="flex gap-3 items-center">
                <select id="theme-select" onchange="applyTheme(this.value)" class="p-2 text-sm border border-color rounded bg-input text-main"><option value="winter">Winter</option><option value="midnight">Midnight</option></select>
                <button onclick="openCreateReviewModal()" id="btn-new-review" class="bg-primary text-primary-fg px-4 py-2 rounded shadow-theme text-sm hidden">New Review</button>
                <button onclick="openExportModal()" class="bg-primary text-primary-fg px-4 py-2 rounded shadow-theme text-sm">Export / Sign</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 bg-app">
            <div id="page-review" class="page max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-end bg-card p-4 rounded-xl shadow-theme">
                    <div class="w-full max-w-md space-y-2">
                        <div class="flex justify-between"><label class="text-xs font-bold text-muted uppercase">Period Ending</label><span id="current-review-date-display" class="text-sm font-bold text-main">--</span></div>
                        <input type="range" id="review-date-slider" class="w-full h-2 bg-input rounded-lg cursor-pointer" min="0" max="0" value="0" oninput="updateDashboardFromSlider()">
                        <div class="flex gap-2 items-center"><label class="text-xs font-bold text-muted uppercase">Compare:</label><select id="duration-select" onchange="updateDashboardFromSlider()" class="p-1 text-xs border border-color rounded bg-input text-main"><option value="1">Monthly</option><option value="3">Quarterly</option><option value="12">Annual</option></select></div>
                    </div>
                    <div class="text-right"><div class="text-sm text-muted">Reports to</div><div id="manager-name" class="font-medium text-main">--</div></div>
                </div>
                <div class="bg-card rounded-xl shadow-theme p-5 border border-color">
                    <h3 class="text-lg font-bold text-main mb-4">Performance Metrics</h3>
                    <div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-input text-xs uppercase text-muted"><tr><th class="px-4 py-2 text-left">KPI</th><th class="px-4 py-2 text-right">Target</th><th class="px-4 py-2 text-right">Actual</th><th class="px-4 py-2 text-center">Trend</th></tr></thead><tbody id="kpi-table-body" class="divide-y divide-border-color text-sm text-main"><tr><td colspan="4" class="text-center py-8 text-muted">Select a rep.</td></tr></tbody></table></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-card rounded-xl shadow-theme p-5 border-l-4 border-blue-500"><h4 class="font-bold text-main mb-2">üéØ Opportunities</h4><ul id="text-opps-this" class="text-sm text-main list-disc list-inside"></ul></div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border-l-4 border-green-500"><h4 class="font-bold text-main mb-2">‚ú® Best Practices</h4><ul id="text-best-practices" class="text-sm text-main list-disc list-inside"></ul></div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border-l-4 border-yellow-500"><h4 class="font-bold text-main mb-2">üöÄ Action Plan</h4><ul id="text-action-plan" class="text-sm text-main list-disc list-inside"></ul></div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border-l-4 border-gray-500"><h4 class="font-bold text-main mb-2">üó£Ô∏è Agent Voice</h4><p id="text-agent-voice" class="text-sm text-main italic"></p></div>
                </div>
            </div>

            <div id="page-create" class="page max-w-4xl mx-auto space-y-6">
                <h3 class="text-2xl font-bold text-main border-b border-color pb-2">New Review</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-card p-5 border border-color space-y-4">
                        <input type="date" id="form-date" class="w-full border p-2 rounded bg-input text-main">
                        <select id="form-type" class="w-full border p-2 rounded bg-input text-main"><option>EOM</option><option>EOQ</option></select>
                    </div>
                    <div class="bg-card p-5 border border-color" id="form-kpi-inputs"></div>
                </div>
                <div class="bg-card p-5 border border-color space-y-4">
                    <textarea id="form-opps-this" placeholder="Opportunities" class="w-full border p-2 rounded bg-input text-main"></textarea>
                    <textarea id="form-action-plan" placeholder="Action Plan" class="w-full border p-2 rounded bg-input text-main"></textarea>
                    <textarea id="form-special-notes" placeholder="Special Notes" class="w-full border p-2 rounded bg-input text-main"></textarea>
                    <button onclick="saveNewReview()" class="bg-blue-600 text-white px-4 py-2 rounded">Save Review</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // !IMPORTANT: PASTE THE FULL URLS HERE (Must start with https:// and end with &sig=...)
        const GET_DATA_FLOW_URL = "PASTE_FULL_GET_DATA_URL_HERE";
        const SAVE_DATA_FLOW_URL = "PASTE_FULL_SAVE_DATA_URL_HERE";

        let rawEmployees = [], dbReviews = [], dbLogs = [];
        let currentRepId = null;

        const kpiConfigs = {"Sales":[{id:"outbound",label:"Outbound Calls",target:50},{id:"invoices",label:"Invoices",target:10}],"Quotes":[{id:"projects",label:"Quotes",target:50}],"Food Service":[{id:"orders",label:"Orders",target:30}],"Retail":[{id:"sales",label:"Sales",target:5}]};

        // --- 2. DATA FETCHING ---
        async function callFlow(url, body) {
            // Simple Fetch for "Anyone" trigger (SAS Key)
            const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            if (!res.ok) throw new Error(`Flow Error: ${res.status}`);
            return await res.json();
        }

        async function initData() {
            const loader = document.getElementById('loading-overlay');
            loader.style.display = 'flex';
            
            if (GET_DATA_FLOW_URL.includes("PASTE_FULL")) {
                loader.innerHTML = `<div class="text-red-500 text-center font-bold">Configuration Error<br>Please edit the HTML and paste your full Flow URLs.</div>`;
                return;
            }

            try {
                const data = await callFlow(GET_DATA_FLOW_URL, {});
                rawEmployees = data.employees || [];
                dbReviews = data.reviews || [];
                dbLogs = data.logs || [];
                renderSidebar();
                loader.style.display = 'none';
            } catch (e) {
                loader.innerHTML = `<div class="text-red-500 text-center">Error: ${e.message}<br>Check console for details.</div>`;
                console.error(e);
            }
        }

        // --- 3. UI LOGIC ---
        function toggleSection(id) {
            const el = document.getElementById('list-'+id);
            el.classList.toggle('hidden');
            filterReps('All', null);
        }

        function filterReps(type, val, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            document.querySelectorAll('#list-rep .hierarchy-item').forEach(rBtn => {
                const rep = rawEmployees.find(e => e.id == rBtn.dataset.id);
                if(!rep) return;
                let show = true;

                // CASCADING FILTER LOGIC
                if (type === 'Department') {
                    show = rep.dept === val;
                    // Also filter manager lists if needed, but let's focus on Reps first
                } else if (type === 'Manager') {
                    show = rep.managerId === val;
                } else if (type === 'Supervisor') {
                     // Show reps who report to managers who report to this supervisor
                     const mgrs = rawEmployees.filter(m => m.supervisorId === val).map(m => m.id);
                     show = (rep.supervisorId === val) || mgrs.includes(rep.managerId);
                } else if (type === 'GoldStar') {
                    show = rep.isGoldStar;
                }
                rBtn.style.display = show ? 'flex' : 'none';
            });
            
            // Auto-expand rep list
            document.getElementById('list-rep').classList.remove('hidden');
        }

        function renderSidebar() {
            if(!rawEmployees.length) return;

            // 1. Departments
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(d => d).sort();
            document.getElementById('list-dept').innerHTML = depts.map(d => 
                `<button onclick="filterReps('Department', '${d}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span>${d}</span></button>`
            ).join('');

            // 2. Managers
            const mgrs = rawEmployees.filter(e => e.role === 'Manager').sort((a,b) => a.name.localeCompare(b.name));
            document.getElementById('list-mgr').innerHTML = mgrs.map(m => 
                `<button onclick="filterReps('Manager', ${m.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded text-blue-600 font-medium">${m.name}</button>`
            ).join('');

            // 3. Supervisors
            const sups = rawEmployees.filter(e => ['Supervisor', 'SR Manager', 'Director'].includes(e.role)).sort((a,b) => a.name.localeCompare(b.name));
            document.getElementById('list-sup').innerHTML = sups.map(s => 
                `<button onclick="filterReps('Supervisor', ${s.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded text-green-600 font-bold">${s.name}</button>`
            ).join('');

            // 4. Reps
            const reps = rawEmployees.filter(e => e.role === 'Rep').sort((a,b) => a.name.localeCompare(b.name));
            document.getElementById('list-rep').innerHTML = reps.map(r => 
                `<button data-id="${r.id}" onclick="loadRepDashboard(${r.id})" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span class="${r.isGoldStar ? 'text-yellow-600 font-bold' : ''}">${r.name}</span></button>`
            ).join('');
        }

        function loadRepDashboard(id) {
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            document.getElementById('view-title').textContent = emp.name;
            document.getElementById('page-review').classList.add('active');
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('btn-new-review').style.display = 'block';
            updateDashboardFromSlider(); // Load data for rep
        }

        // ... (Standard Slider & Chart logic from previous versions goes here) ...
        
        // Basic Slider stub to prevent error if you click without data
        function updateDashboardFromSlider() {
             if(!currentRepId) return;
             // Logic to filter dbReviews/dbLogs by repId would go here
             document.getElementById('kpi-table-body').innerHTML = '<tr><td colspan="4" class="text-center py-4">Data Loaded from Flow</td></tr>';
        }

        function openCreateReviewModal() {
            if(!currentRepId) return alert("Select Rep");
            const emp = rawEmployees.find(e => e.id === currentRepId);
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.add('active');
            document.getElementById('new-review-rep-name').textContent = emp.name;
        }

        async function saveNewReview() {
            const payload = {
                repId: currentRepId,
                date: document.getElementById('form-date').value,
                type: document.getElementById('form-type').value,
                opps: document.getElementById('form-opps-this').value,
                // ... other fields
            };
            try {
                await callFlow(SAVE_DATA_FLOW_URL, payload);
                alert("Saved!");
                initData();
            } catch(e) { alert("Save Failed: " + e.message); }
        }

        function openExportModal() { window.print(); }

        document.addEventListener('DOMContentLoaded', initData);
    </script>
</body>
</html>
