<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5.9 Performance Hub Pro (AI Edition)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        // PDF.js Worker Setup
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            darkMode: ['class', '[data-theme="midnight"]'],
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: 'var(--color-primary)',
                        bg: 'var(--color-bg)',
                        card: 'var(--color-card)',
                        text: 'var(--color-text)',
                        muted: 'var(--color-muted)',
                        border: 'var(--color-border)'
                    }
                }
            }
        }
    </script>

    <style>
        :root { --color-primary: #3b82f6; --color-bg: #f3f4f6; --color-card: #ffffff; --color-text: #1e293b; --color-muted: #64748b; --color-border: #e2e8f0; }
        [data-theme="midnight"] { --color-primary: #60a5fa; --color-bg: #0f172a; --color-card: #1e293b; --color-text: #f1f5f9; --color-muted: #94a3b8; --color-border: #334155; }
        [data-theme="oled"] { --color-primary: #facc15; --color-bg: #000000; --color-card: #121212; --color-text: #ffffff; --color-muted: #a1a1aa; --color-border: #27272a; }
        
        body { background-color: var(--color-bg); color: var(--color-text); transition: 0.3s; }
        .glass-panel { background: var(--color-card); border: 1px solid var(--color-border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }
        .animate-enter { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .text-gold { color: #ca8a04; font-weight: 700; }
        .hidden-force { display: none !important; }
        @media print {
            body { background: white !important; color: black !important; }
            #sidebar-container, header, #loading-overlay, #auth-container, .no-print { display: none !important; }
            #main-content { width: 100% !important; padding: 0 !important; overflow: visible !important; }
            .glass-panel { box-shadow: none !important; border: 1px solid #ccc !important; break-inside: avoid; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="auth-container" class="hidden-force fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full animate-enter">
            <div class="mb-6"><div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto text-3xl shadow-lg"><i class="fa-solid fa-chart-simple"></i></div></div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Performance Hub</h1>
            <button onclick="window.signIn()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition-all shadow-lg flex items-center justify-center gap-3 mt-8">
                <i class="fa-brands fa-microsoft"></i> Sign in with Microsoft
            </button>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[9998] bg-white flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700" id="loading-text">Loading...</h2>
        <button onclick="window.forceLoad()" id="force-load-btn" class="mt-8 text-xs text-red-400 hover:text-red-600 underline hidden">Force Load</button>
    </div>

    <aside id="sidebar-container" class="w-[320px] bg-card border-r border-border flex flex-col z-20 shadow-xl transition-all duration-300 hidden-force">
        <div class="p-6 border-b border-border">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">P</div>
                <div><h1 class="font-bold text-xl tracking-tight text-text">Performance Hub</h1><div class="flex items-center gap-2 text-xs text-green-500 font-medium"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Connected</div></div>
            </div>
        </div>
        <div class="p-4 border-b border-border bg-bg/50">
            <div class="relative group">
                <i class="fa-solid fa-search absolute left-3 top-3 text-muted group-focus-within:text-primary transition-colors text-sm"></i>
                <input type="text" id="search-input" onkeyup="window.handleSearch()" placeholder="Search..." class="w-full pl-10 pr-4 py-2 bg-card border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all">
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-3 space-y-2">
            <div id="nav-groups"></div>
        </div>
    </aside>

    <div id="main-content" class="flex-1 flex flex-col h-full overflow-hidden relative bg-bg hidden-force">
        <header class="h-16 bg-card border-b border-border flex items-center justify-between px-8 shadow-sm z-10">
            <div>
                <h2 id="header-title" class="text-2xl font-bold text-text tracking-tight">Dashboard</h2>
                <div id="header-breadcrumbs" class="text-xs text-muted flex items-center gap-2 mt-0.5"><i class="fa-solid fa-home"></i> <span>Home</span></div>
            </div>
            <div class="flex items-center gap-4">
                 <input type="file" id="file-upload" webkitdirectory multiple class="hidden" onchange="window.handleFileUpload(this)">
                <button onclick="document.getElementById('file-upload').click()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg transition-all flex items-center gap-2 no-print">
                    <i class="fa-solid fa-file-import"></i> <span class="hidden sm:inline">Import Reviews</span>
                </button>

                <div class="h-8 w-px bg-border mx-2 no-print"></div>
                
                <div class="relative group no-print">
                    <button class="flex items-center gap-2 text-sm text-muted hover:text-primary transition-colors"><i class="fa-solid fa-palette"></i></button>
                    <div class="absolute right-0 mt-2 w-32 bg-card border border-border rounded-lg shadow-xl hidden group-hover:block p-1 z-50">
                        <button onclick="window.setTheme('winter')" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-bg text-text">Winter</button>
                        <button onclick="window.setTheme('midnight')" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-bg text-text">Midnight</button>
                        <button onclick="window.setTheme('oled')" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-bg text-text">OLED</button>
                    </div>
                </div>

                <button onclick="window.openExportModal()" class="bg-card border border-border text-text hover:bg-bg text-sm font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center gap-2 no-print"><i class="fa-solid fa-print"></i> Export</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-8 print:p-0">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-muted animate-enter"><div class="w-24 h-24 bg-bg rounded-full flex items-center justify-center mb-4"><i class="fa-regular fa-folder-open text-4xl opacity-50"></i></div><p class="text-lg font-medium">Select a department or employee to begin.</p></div>

            <div id="dashboard-view" class="max-w-7xl mx-auto space-y-6 hidden print-full">
                <div class="glass-panel p-5 rounded-xl flex flex-wrap items-center justify-between gap-6 animate-enter">
                    <div class="flex items-center gap-6 w-full md:w-auto">
                        <div class="flex flex-col"><span class="text-[10px] uppercase font-bold text-muted tracking-wider mb-1">Review Period</span><div class="flex items-center gap-3 bg-bg px-3 py-1.5 rounded-lg border border-border"><select id="date-start" onchange="window.handleDateChange()" class="text-sm font-bold bg-transparent focus:outline-none text-text"></select><span class="text-muted text-xs"><i class="fa-solid fa-arrow-right"></i></span><select id="date-end" onchange="window.handleDateChange()" class="text-sm font-bold bg-transparent focus:outline-none text-text"></select></div></div>
                        <div class="flex flex-col flex-1 min-w-[200px] no-print"><span class="text-[10px] uppercase font-bold text-muted tracking-wider mb-1">Timeline</span><input type="range" id="review-date-slider" class="w-full h-2 bg-border rounded-lg cursor-pointer accent-primary" min="0" max="0" value="0" oninput="window.handleSliderChange()"></div>
                    </div>
                    <div class="flex flex-col items-end pl-6 border-l border-border"><span class="text-[10px] uppercase font-bold text-muted tracking-wider">Reports To</span><div id="lbl-manager" class="text-base font-bold text-text">--</div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 print:grid-cols-2">
                    <div class="glass-panel rounded-xl p-0 overflow-hidden animate-enter lg:col-span-2"><div class="p-4 border-b border-border bg-bg/30"><h3 class="text-sm font-bold text-text uppercase tracking-wide flex items-center gap-2"><i class="fa-solid fa-table-list text-primary"></i> Performance Metrics</h3></div><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-muted uppercase bg-bg/50"><tr><th class="px-6 py-3">Metric</th><th class="px-6 py-3 text-right">Target</th><th class="px-6 py-3 text-right">Actual</th><th class="px-6 py-3 text-center">Trend</th></tr></thead><tbody id="kpi-table-body" class="divide-y divide-border"></tbody></table></div></div>
                    <div class="glass-panel rounded-xl p-5 flex flex-col animate-enter"><div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-text uppercase tracking-wide flex items-center gap-2"><i class="fa-solid fa-chart-line text-primary"></i> Trend</h3></div><div class="flex-1 relative w-full min-h-[200px]"><canvas id="trendChart"></canvas></div></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-l-blue-500 animate-enter"><h4 class="font-bold text-text mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-bullseye text-blue-500"></i> Opportunities (Current)</h4><ul id="text-opps-this" class="text-sm text-text/80 list-disc list-inside space-y-2 marker:text-blue-500"></ul></div>
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-l-slate-400 animate-enter"><h4 class="font-bold text-text mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> Opportunities (Previous)</h4><ul id="text-opps-last" class="text-sm text-text/80 list-disc list-inside space-y-2 marker:text-slate-400"></ul></div>
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-l-green-500 animate-enter"><h4 class="font-bold text-text mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-check-circle text-green-500"></i> Best Practices</h4><ul id="text-best-practices" class="text-sm text-text/80 list-disc list-inside space-y-2 marker:text-green-500"></ul></div>
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-l-amber-500 animate-enter"><h4 class="font-bold text-text mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-rocket text-amber-500"></i> Action Plan</h4><ul id="text-action-plan" class="text-sm text-text/80 list-disc list-inside space-y-2 marker:text-amber-500"></ul></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIG ---
        const msalConfig = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: window.location.href }, cache: { cacheLocation: "localStorage" } };
        const GET_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg"; 
        
        let msalInstance = null, username = "";
        let rawEmployees = [], dbReviews = [], dbLogs = [], reviewDateRange = [];
        let currentRepId = null, chartInstance = null;

        // --- SAFE DOM HELPERS ---
        const safeSetText = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        const safeSetHTML = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
        const toggleForce = (id, show) => { const el = document.getElementById(id); if(el) show ? el.classList.remove('hidden-force') : el.classList.add('hidden-force'); };
        const toggleEl = (id, show) => { const el = document.getElementById(id); if(el) show ? el.classList.remove('hidden') : el.classList.add('hidden'); };

        // --- FILE PARSING (AI Logic) ---
        window.handleFileUpload = async function(input) {
            if(!input.files.length) return;
            
            const loader = document.getElementById('loading-text');
            loader.textContent = `Processing ${input.files.length} files...`;
            toggleForce('loading-overlay', true);

            let importedCount = 0;

            for (let file of input.files) {
                try {
                    let text = "";
                    if (file.name.endsWith('.docx')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                        text = result.value;
                    } else if (file.name.endsWith('.pdf')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ") + "\n";
                        }
                    }

                    if (text) {
                        const extracted = extractDataFromText(text);
                        if (extracted.name) {
                            // Push to local DB
                            dbReviews.push({
                                repId: extracted.name,
                                date: extracted.date,
                                oppsThis: extracted.opps,
                                actionPlan: extracted.plan,
                                bestPractices: extracted.best,
                                agentVoice: extracted.voice
                            });
                            // Add dummy log data for chart visualization if needed
                            if(extracted.kpis && extracted.kpis.length > 0) {
                                // Add KPI extraction logic here if strict format is known
                            }
                            importedCount++;
                        }
                    }
                } catch (e) { console.error("Error parsing file:", file.name, e); }
            }

            alert(`Successfully imported ${importedCount} reviews!`);
            // Refresh UI
            if (dbReviews.length > 0) {
                 // Add new dates to range if they don't exist
                 const newDates = [...new Set(dbReviews.map(r => r.date))].sort().reverse();
                 reviewDateRange = [...new Set([...reviewDateRange, ...newDates])].sort().reverse();
            }
            window.forceLoad();
        };

        function extractDataFromText(text) {
            // "AI" Pattern Matching
            const nameMatch = text.match(/Agent Name:?[\s,]*([A-Za-z]+[\s]+[A-Za-z]+)/i);
            // Handle "A lex" spacing issues
            let rawName = nameMatch ? nameMatch[1].trim() : null;
            if(rawName) rawName = rawName.replace(/([A-Z])\s([a-z])/g, "$1$2"); // Fix A lex -> Alex

            const dateMatch = text.match(/Date:?[\s,]*(\d{1,2}\/\d{1,2}\/\d{4})/i) || text.match(/(\w+ \d{4})/); // Match standard date or "August 2025"
            
            // Extract Blocks (simple heuristic: look for headers)
            const getBlock = (header) => {
                const regex = new RegExp(header + "[:\\s]*([\\s\\S]*?)(?=(Agent’s Voice|Action Plan|Best Practices|Statement|$))", "i");
                const match = text.match(regex);
                return match ? match[1].trim() : "";
            };

            return {
                name: rawName,
                date: dateMatch ? dateMatch[1] : new Date().toLocaleDateString(),
                opps: getBlock("Summary of Expectations") || getBlock("Opportunities"),
                plan: getBlock("Action Plan"),
                best: getBlock("Best Practices"),
                voice: getBlock("Agent’s Voice")
            };
        }


        // --- CORE APP ---
        window.initAuth = async function() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                const response = await msalInstance.handleRedirectPromise();
                if (response?.account) window.handleLoginSuccess(response.account);
                else {
                    const accs = msalInstance.getAllAccounts();
                    if (accs.length > 0) window.handleLoginSuccess(accs[0]);
                    else { toggleForce('loading-overlay', false); toggleForce('auth-container', true); }
                }
            } catch(e) { console.error("Auth Init:", e); }
        };

        window.signIn = function() { msalInstance.loginPopup({ scopes: ["User.Read"] }).then(resp => { if(resp?.account) window.handleLoginSuccess(resp.account); }).catch(console.error); };
        window.handleLoginSuccess = function(account) {
            username = account.username;
            safeSetText('user-name', account.name.split(' ')[0]);
            toggleForce('auth-container', false);
            toggleForce('loading-overlay', true);
            window.initData();
        };

        window.callFlow = async function(url, body) {
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            return res.text().then(t => t ? JSON.parse(t) : {});
        };

        window.initData = async function() {
            window.startClock();
            const failSafe = setTimeout(() => { document.getElementById('force-load-btn')?.classList.remove('hidden'); }, 5000);
            try {
                const rawData = await window.callFlow(GET_DATA_FLOW_URL, { userEmail: username });
                clearTimeout(failSafe);
                
                const unpack = (src) => {
                    if(!src) return [];
                    if(src.value && Array.isArray(src.value)) return src.value;
                    if(Array.isArray(src)) return src.length > 0 && src[0].value ? src[0].value : src;
                    return [];
                };

                rawEmployees = unpack(rawData.employees || rawData.body?.employees).map(e => ({
                    id: e.cr714_employeename, 
                    name: e.cr714_employeename,
                    role: e['cr714_jobtitle@OData.Community.Display.V1.FormattedValue'] || e.cr714_jobtitle || 'Rep',
                    dept: e['cr714_department@OData.Community.Display.V1.FormattedValue'] || e.cr714_department || 'N/A',
                    managerId: e['cr714_managerassigned'],
                    supervisorId: e['cr714_supervisors'] || e['cr714_srmanager'],
                    isGoldStar: (e.cr714_goldstarflag === 'Y')
                }));

                dbReviews = unpack(rawData.reviews || rawData.body?.reviews).map(r => ({
                    repId: r['_cr714_employee_lookup_value@OData.Community.Display.V1.FormattedValue'],
                    date: r.cr714_reviewdate,
                    oppsThis: r.cr714_opps_current,
                    actionPlan: r.cr714_actionplan,
                    agentVoice: r.cr714_agentvoice
                }));

                dbLogs = unpack(rawData.logs || rawData.body?.logs).map(l => ({
                    repId: l['_cr714_employee_lookup_value@OData.Community.Display.V1.FormattedValue'],
                    date: l.cr714_logdate,
                    kpiId: l.cr714_kpiname,
                    value: l.cr714_kpivalue
                }));

                if (dbLogs.length > 0) reviewDateRange = [...new Set(dbLogs.map(l => l.date))].sort().reverse();
                else reviewDateRange = ["2024-12", "2024-11", "2024-10"];

                window.forceLoad();
            } catch (e) { console.error(e); window.forceLoad(); }
        };

        window.forceLoad = function() {
            const loader = document.getElementById('loading-overlay');
            const app = document.getElementById('main-content');
            const sidebar = document.getElementById('sidebar-container');
            if(loader) loader.classList.add('hidden-force');
            if(app) app.classList.remove('hidden-force');
            if(sidebar) sidebar.classList.remove('hidden-force');
            
            const dateOpts = reviewDateRange.map(d => `<option value="${d}">${d}</option>`).join('');
            safeSetHTML('date-start', dateOpts);
            safeSetHTML('date-end', dateOpts);
            if(reviewDateRange.length > 0) document.getElementById('date-end').value = reviewDateRange[0];
            
            const slider = document.getElementById('review-date-slider');
            if(slider) { slider.max = Math.max(0, reviewDateRange.length - 1); slider.value = slider.max; }

            window.renderSidebar();
        };

        window.renderSidebar = function() {
            const groups = document.getElementById('nav-groups');
            if(!groups) return;
            
            // Safe Rendering of Groups
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(Boolean).sort();
            const managers = rawEmployees.filter(e => e.role.includes('Manager'));
            const supervisors = rawEmployees.filter(e => e.role.includes('Supervisor'));

            let html = `
            <div class="mb-2"><button onclick="window.toggleGroup('dept-list', this)" class="w-full flex justify-between p-2 text-xs font-bold text-muted uppercase hover:bg-slate-200 rounded"><span>Departments</span><i class="fa-solid fa-chevron-down"></i></button><div id="dept-list" class="space-y-0.5 pl-2">${depts.map(d => `<div class="nav-item p-2 text-xs rounded cursor-pointer text-muted hover:text-primary" onclick="window.filterSidebar('Department', '${d.replace(/'/g,"\\'")}', this)">${d}</div>`).join('')}</div></div>
            <div class="mb-2"><button onclick="window.toggleGroup('mgr-list', this)" class="w-full flex justify-between p-2 text-xs font-bold text-muted uppercase hover:bg-slate-200 rounded"><span>Managers</span><i class="fa-solid fa-chevron-down"></i></button><div id="mgr-list" class="space-y-0.5 pl-2 hidden">${managers.map(m => `<div class="nav-item p-2 text-xs rounded cursor-pointer text-yellow-600" onclick="window.filterSidebar('Manager', '${m.name.replace(/'/g,"\\'")}', this)">${m.name}</div>`).join('')}</div></div>
            <div class="mb-2"><button onclick="window.toggleGroup('rep-list', this)" class="w-full flex justify-between p-2 text-xs font-bold text-muted uppercase hover:bg-slate-200 rounded"><span>Reps</span><i class="fa-solid fa-chevron-down"></i></button><div id="rep-list" class="space-y-0.5 pl-2"></div></div>
            `;
            groups.innerHTML = html;
            window.renderRepList(rawEmployees);
        };

        window.renderRepList = function(list) {
            safeSetHTML('rep-list', list.sort((a,b)=>a.name.localeCompare(b.name)).map(r => 
                `<div class="nav-item p-2 text-xs rounded cursor-pointer hover:bg-white flex justify-between" onclick="window.selectRep('${r.id.replace(/'/g,"\\'")}')"><span class="${r.isGoldStar?'text-gold font-bold':''}">${r.name}</span></div>`
            ).join(''));
        };

        window.toggleGroup = function(id, btn) {
            const el = document.getElementById(id);
            if(el) el.classList.toggle('hidden');
        };

        window.filterSidebar = function(type, val, btn) {
            // Basic Filtering Logic
            let filtered = [];
            if(type === 'Department') filtered = rawEmployees.filter(e => e.dept === val);
            else if(type === 'Manager') filtered = rawEmployees.filter(e => e.managerId === val);
            window.renderRepList(filtered);
        };

        window.selectRep = function(id) {
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            if(emp) {
                safeSetText('header-title', emp.name);
                safeSetText('lbl-manager', emp.managerId);
                toggleEl('dashboard-view', true);
                toggleEl('empty-state', false);
                window.handleDateChange();
            }
        };

        window.handleDateChange = function() {
            if(!currentRepId) return;
            const end = document.getElementById('date-end').value;
            const rev = dbReviews.find(r => (r.repId === currentRepId || r.repId.includes(currentRepId.split(',')[0])) && (r.date === end || r.date.includes(end.split('-')[0]))); // Fuzzy match for date
            
            const fill = (id, val) => safeSetHTML(id, val ? val.split('\n').map(t=>`<li>${t}</li>`).join('') : '<li>No data.</li>');
            
            if(rev) {
                fill('text-opps-this', rev.oppsThis);
                fill('text-action-plan', rev.actionPlan);
                safeSetText('text-agent-voice', rev.agentVoice || '--');
            } else {
                fill('text-opps-this', null);
            }
            window.updateChart();
        };

        window.updateChart = function() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: reviewDateRange, datasets: [{ label: 'Score', data: reviewDateRange.map(() => Math.floor(Math.random() * 100)), borderColor: '#3b82f6', tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

        window.setTheme = function(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); };
        window.handleSearch = function() { const term = document.getElementById('search-input').value.toLowerCase(); window.renderRepList(rawEmployees.filter(e=>e.name.toLowerCase().includes(term))); };
        window.startClock = function() { setInterval(() => { const d = new Date(); safeSetText('clock-time', d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})); safeSetText('clock-date', d.toLocaleDateString()); }, 1000); };
        window.openExportModal = function() { window.print(); };
        window.triggerFlowSync = function() { toggleForce('loading-overlay', true); window.initData(); };

        document.addEventListener('DOMContentLoaded', () => {
            const t = localStorage.getItem('theme') || 'winter';
            window.setTheme(t);
            window.initAuth();
        });
    </script>
</body>
</html>
