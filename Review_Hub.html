<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Hub Pro | v10.0 Diagnostic</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script> 
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            darkMode: ['class', '[data-theme="midnight"]'],
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: 'var(--color-primary)',
                        bg: 'var(--color-bg)',
                        card: 'var(--color-card)',
                        text: 'var(--color-text)',
                        muted: 'var(--color-muted)',
                        border: 'var(--color-border)',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>

    <style>
        :root { --color-primary: #002f6c; --color-bg: #f4f7f6; --color-card: #ffffff; --color-text: #2c3e50; --color-muted: #7f8c8d; --color-border: #e2e8f0; --secondary: #d42e12; }
        [data-theme="midnight"] { --color-primary: #60a5fa; --color-bg: #0f172a; --color-card: #1e293b; --color-text: #f1f5f9; --color-muted: #94a3b8; --color-border: #334155; --secondary: #f87171; }
        
        body { background-color: var(--color-bg); color: var(--color-text); transition: background-color 0.3s, color 0.3s; }
        .glass-panel { background: var(--color-card); border: 1px solid var(--color-border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hidden-force { display: none !important; }
        .view { display: none; }
        .view.active { display: block; animation: slideIn 0.3s ease-in-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nav-item { cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(0,0,0,0.05); border-left-color: var(--secondary); color: var(--color-primary); }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 12px; background: var(--color-bg); color: var(--color-muted); font-weight: 700; border-bottom: 2px solid var(--color-border); text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 12px; border-bottom: 1px solid var(--color-border); vertical-align: middle; }
        tr:hover td { background: rgba(0,0,0,0.02); }

        .console-log {
            background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; font-size: 0.75rem;
            padding: 1rem; border-radius: 0.5rem; height: 250px; overflow-y: auto; border: 1px solid #333;
        }
        .log-success { color: #4ade80; }
        .log-warn { color: #facc15; }
        .log-err { color: #f87171; }
        .log-detail { color: #94a3b8; margin-left: 10px; font-size: 0.7rem; cursor: pointer; text-decoration: underline; }

        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        
        .trend-icon { font-size: 1rem; font-weight: bold; margin-left: 5px; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-flat { color: #6b7280; }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-content { background: var(--color-card); padding: 2rem; border-radius: 0.5rem; width: 500px; border: 1px solid var(--color-border); box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="settings-modal" class="modal hidden-force">
        <div class="modal-content animate-enter">
            <h3 class="text-xl font-bold mb-2 text-primary"><i class="fa-solid fa-key mr-2"></i>API Key Required</h3>
            <p class="text-sm text-muted mb-4">Enter your Gemini API Key. It is stored locally in your browser.</p>
            <label class="block text-xs font-bold uppercase text-muted mb-1">Gemini API Key</label>
            <input type="password" id="api-key-input" class="w-full p-3 border border-border rounded mb-6 focus:ring-2 focus:ring-primary outline-none" placeholder="Paste key starting with AIza...">
            <div class="flex justify-end gap-2">
                <button onclick="toggleForce('settings-modal', false)" class="px-4 py-2 text-sm font-bold text-muted hover:text-text">Cancel</button>
                <button onclick="saveSettings()" class="px-6 py-2 text-sm font-bold bg-primary hover:bg-blue-800 text-white rounded transition-colors">Save Key</button>
            </div>
        </div>
    </div>

    <div id="debug-modal" class="modal hidden-force">
        <div class="modal-content animate-enter">
            <h3 class="text-lg font-bold mb-2">Raw AI Response</h3>
            <pre id="debug-content" class="bg-gray-900 text-green-400 p-4 rounded text-xs overflow-auto h-64 font-mono"></pre>
            <div class="mt-4 text-right"><button onclick="toggleForce('debug-modal', false)" class="btn btn-sm btn-secondary">Close</button></div>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[9998] bg-white flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700" id="loading-text">Loading System...</h2>
        <button onclick="window.forceLoad()" class="mt-8 text-xs text-red-400 hover:text-red-600 underline">Force Load</button>
    </div>

    <aside id="sidebar-container" class="w-64 bg-card border-r border-border flex flex-col z-20 shadow-xl transition-all duration-300 hidden-force">
        <div class="p-6 border-b border-border flex items-center gap-3">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold shadow">P</div>
            <h1 class="font-bold text-lg tracking-tight text-text">Performance<span class="text-primary">Hub</span></h1>
        </div>
        
        <div class="flex-1 overflow-y-auto px-2 space-y-1 py-4">
            <div class="mb-6 mx-2 p-4 bg-blue-50 rounded-lg border border-blue-100 text-center">
                <p class="text-xs text-blue-800 font-bold mb-2">Step 1: Load Roster</p>
                <button onclick="document.getElementById('roster-upload').click()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-2 rounded transition-colors">Upload CSV</button>
                <input type="file" id="roster-upload" class="hidden" accept=".csv" onchange="window.handleRosterUpload(this)">
                <p id="roster-status" class="text-[10px] text-muted mt-2">0 Employees Loaded</p>
            </div>

            <div class="px-3 text-xs font-bold text-muted uppercase mb-2">Workspace</div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3 active" onclick="router.navigate('employees')">
                <i class="fa-solid fa-users w-5 text-center"></i> Employees
            </div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3" onclick="router.navigate('reviews-list')">
                <i class="fa-solid fa-file-contract w-5 text-center"></i> Review Log
            </div>
            
            <div class="mt-6 px-3 text-xs font-bold text-muted uppercase mb-2">Admin</div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3 text-warning bg-warning/5 border border-warning/20" onclick="router.navigate('migration')">
                <i class="fa-solid fa-brain w-5 text-center"></i> AI Migration
            </div>
        </div>
    </aside>

    <div id="main-content" class="flex-1 flex flex-col h-full overflow-hidden relative hidden-force">
        <header class="h-16 bg-card border-b border-border flex items-center justify-between px-6 shadow-sm z-10">
            <div><h2 id="page-title" class="text-xl font-bold text-text">Team Dashboard</h2></div>
            <div class="flex items-center gap-4">
                <button onclick="toggleForce('settings-modal', true)" class="p-2 text-muted hover:text-primary" title="API Settings"><i class="fa-solid fa-gear"></i></button>
                <button onclick="window.toggleTheme()" class="p-2 text-muted hover:text-primary"><i class="fa-solid fa-circle-half-stroke"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6">
            
            <div id="view-employees" class="view active max-w-7xl mx-auto">
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-4 border-b border-border bg-bg/50 flex justify-between items-center">
                        <h3 class="font-bold text-text">Roster</h3>
                        <input type="text" id="search-emp" onkeyup="window.filterEmployees()" placeholder="Search..." class="pl-3 pr-3 py-1 text-sm rounded border border-border">
                    </div>
                    <div class="overflow-x-auto">
                        <table id="emp-table"><thead><tr><th>Name</th><th>Title</th><th>Department</th><th>Status</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>

            <div id="view-migration" class="view max-w-7xl mx-auto">
                <div class="glass-panel p-6 rounded-xl mb-6">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-indigo-500 text-white flex items-center justify-center text-2xl shadow-lg"><i class="fa-solid fa-robot"></i></div>
                            <div>
                                <h2 class="text-2xl font-bold text-text">AI Migration Hub</h2>
                                <p class="text-sm text-muted">Powered by Gemini. Extracts exact KPI values from messy docs.</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <button onclick="window.exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow flex items-center gap-2">
                                <i class="fa-solid fa-file-excel"></i> Export (.xlsx)
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border border-border shadow-sm text-center cursor-pointer hover:border-primary transition-colors group" onclick="document.getElementById('mig-file-input').click()">
                            <i class="fa-solid fa-file-lines text-2xl text-primary mb-2"></i>
                            <div class="text-sm font-bold">Select Files</div>
                            <input type="file" id="mig-file-input" multiple class="hidden" onchange="window.handleFiles(this)">
                        </div>
                        
                        <div class="md:col-span-3 bg-bg/50 p-4 rounded-lg border border-border flex flex-col justify-center">
                            <div class="flex justify-between mb-2">
                                <span class="text-xs font-bold uppercase text-muted">Files Queued:</span>
                                <span id="stat-files" class="text-sm font-bold">0</span>
                            </div>
                            <div class="flex gap-2">
                                <button id="btn-parse" onclick="window.startAIParsing()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded font-bold text-sm opacity-50 cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> Process with AI
                                </button>
                                <button id="btn-upload" onclick="window.uploadBatches()" class="flex-1 bg-success hover:bg-emerald-600 text-white py-2 rounded font-bold text-sm opacity-50 cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-cloud-arrow-up"></i> Upload to Flow
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="mig-console" class="console-log mb-6">> Waiting for files...</div>

                    <div class="bg-white border border-border rounded-xl overflow-hidden shadow-md">
                        <div class="flex border-b border-border">
                            <button class="px-6 py-3 text-sm font-bold text-primary border-b-2 border-primary bg-blue-50" onclick="switchTable('reviews', this)">1. Reviews (<span id="count-reviews">0</span>)</button>
                            <button class="px-6 py-3 text-sm font-bold text-muted hover:text-text" onclick="switchTable('kpis', this)">2. KPIs (<span id="count-kpis">0</span>)</button>
                        </div>
                        <div id="table-reviews" class="h-96 overflow-y-auto block">
                            <table class="w-full"><thead class="sticky top-0 z-10 shadow-sm"><tr><th>File</th><th>Agent</th><th>Date</th><th>Type</th><th>Opps</th><th>Plan</th></tr></thead><tbody id="tbody-reviews" class="bg-white"></tbody></table>
                        </div>
                        <div id="table-kpis" class="h-96 overflow-y-auto hidden">
                            <table class="w-full"><thead class="sticky top-0 z-10 shadow-sm"><tr><th>Agent</th><th>Date</th><th>Metric</th><th>Target</th><th>Value</th><th>Trend</th></tr></thead><tbody id="tbody-kpis" class="bg-white"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-employee-detail" class="view max-w-6xl mx-auto">
                <button onclick="router.navigate('employees')" class="mb-4 text-sm font-bold text-muted hover:text-primary"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <div class="glass-panel p-8 rounded-xl mb-6">
                    <h1 id="profile-name" class="text-3xl font-bold text-primary">--</h1>
                </div>
                <div class="glass-panel rounded-xl overflow-hidden mb-6">
                    <div class="p-3 bg-bg border-b border-border font-bold">Reviews</div>
                    <table id="profile-table"><thead><tr><th>Date</th><th>Type</th><th>Opps</th></tr></thead><tbody></tbody></table>
                </div>
                 <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-3 bg-bg border-b border-border font-bold">KPIs</div>
                    <table id="profile-kpi-table"><thead><tr><th>Date</th><th>Metric</th><th>Val</th><th>Trend</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        // APP STATE
        let API_KEY = localStorage.getItem('GEMINI_KEY') || "";
        const FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg";
        
        let migrationQueue = { reviews: [], kpis: [] };
        let store = { employees: [], reviews: [], kpis: [] };
        let selectedFiles = [];
        let parsingStats = { processed: 0, noName: 0, noKPIs: 0 };
        let failedFiles = [];

        // --- 1. SETUP ---
        window.saveSettings = () => {
            const key = document.getElementById('api-key-input').value;
            if(key) {
                localStorage.setItem('GEMINI_KEY', key);
                API_KEY = key;
                alert("API Key Saved!");
                toggleForce('settings-modal', false);
            }
        };

        window.forceLoad = () => {
            if(!API_KEY) toggleForce('settings-modal', true); 
            toggleForce('loading-overlay', false);
            toggleForce('sidebar-container', true);
            toggleForce('main-content', true);
            renderEmployeeTable();
        };

        // --- 2. FILE HANDLING ---
        window.handleRosterUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            Papa.parse(file, { header: true, complete: function(results) {
                store.employees = results.data.filter(r => r.cr714_employeename).map(r => ({
                    id: r.cr714_employeeinformation1id, name: r.cr714_employeename,
                    title: r['cr714_title@OData.Community.Display.V1.FormattedValue'] || 'Rep',
                    dept: r['cr714_department@OData.Community.Display.V1.FormattedValue'] || 'N/A',
                    status: r['cr714_status@OData.Community.Display.V1.FormattedValue'] || 'Active'
                }));
                document.getElementById('roster-status').textContent = `${store.employees.length} Loaded`;
                renderEmployeeTable();
            }});
        };

        window.handleFiles = (input) => {
            const files = Array.from(input.files).filter(f => f.name.endsWith('.docx') || f.name.endsWith('.pdf'));
            if(files.length === 0) return logConsole("! No valid files.");
            selectedFiles = files;
            document.getElementById('stat-files').textContent = files.length;
            document.getElementById('btn-parse').disabled = false;
            document.getElementById('btn-parse').classList.remove('opacity-50', 'cursor-not-allowed');
            logConsole(`> Queued ${files.length} files.`);
        };

        // --- 3. AI PARSING ENGINE (ROBUST JSON) ---
        window.startAIParsing = async () => {
            // Re-check key at runtime
            API_KEY = localStorage.getItem('GEMINI_KEY') || "";
            if(!API_KEY) {
                toggleForce('settings-modal', true);
                return alert("API Key Missing. Please enter it in settings.");
            }
            if(!selectedFiles.length) return;
            
            logConsole(`> STARTING AI PARSE (v10.0)...`);
            
            const btn = document.getElementById('btn-parse');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Processing...`;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                logConsole(`> Analyzing [${i+1}/${selectedFiles.length}]: ${file.name}`);
                
                try {
                    let text = "";
                    if (file.name.endsWith('.docx')) {
                        const ab = await file.arrayBuffer();
                        const res = await mammoth.extractRawText({ arrayBuffer: ab });
                        text = res.value;
                    } else if (file.name.endsWith('.pdf')) {
                        const ab = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(ab).promise;
                        for (let j = 1; j <= pdf.numPages; j++) {
                            const p = await pdf.getPage(j);
                            const c = await p.getTextContent();
                            // Added space joiner for PDF safety
                            text += c.items.map(i => i.str).join(" ") + "\n";
                        }
                    }

                    // REST API Call
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: `
                                    You are a JSON Converter. Convert this review into JSON.
                                    Strictly follow this schema. Do not include markdown code blocks.
                                    
                                    {
                                      "agentName": "Name string from doc",
                                      "reviewDate": "YYYY-MM-DD",
                                      "reviewType": "End of Month" or "Annual" or "30 Day",
                                      "opps": "Opportunities text",
                                      "plan": "Action Plan text",
                                      "voice": "Agent Voice text",
                                      "kpis": [
                                        { "metric": "Metric Name", "target": "Last Month Value (Number only)", "value": "This Month Value (Number only)", "trend": "Up/Down/Flat" }
                                      ]
                                    }
                                    
                                    Rules:
                                    1. Look for 'THIS MONTH' table for 'value'. 'LAST MONTH' table for 'target'.
                                    2. Remove arrows (↑/↓) from numbers.
                                    3. If filename is '${file.name}', use it to guess Agent Name if missing.
                                    
                                    Text:
                                    ${text.substring(0, 14000)}` 
                                }]
                            }]
                        })
                    });

                    const result = await response.json();
                    
                    if(result.candidates && result.candidates[0].content) {
                        let rawJson = result.candidates[0].content.parts[0].text;
                        // SANITIZE JSON
                        rawJson = rawJson.replace(/```json/g, '').replace(/```/g, '').trim();
                        
                        let data;
                        try {
                             data = JSON.parse(rawJson);
                        } catch (parseError) {
                             logConsole(`  ! JSON Parse Error. <span class="log-detail" onclick="showDebug('${escape(rawJson)}')">View Raw</span>`, 'log-err');
                             continue;
                        }

                        if(data.agentName) {
                            const emp = findEmployee(data.agentName);
                            const empId = emp ? emp.id : null;
                            const empName = emp ? emp.name : data.agentName;

                            migrationQueue.reviews.push({
                                fileName: file.name,
                                cr714_employeename: empName,
                                _cr714_employee_value: empId,
                                cr714_reviewdate: data.reviewDate,
                                cr714_reviewtype: data.reviewType,
                                cr714_opportunities_current: data.opps,
                                cr714_actionplan: data.plan,
                                cr714_agentvoice: data.voice
                            });

                            if(data.kpis && data.kpis.length > 0) {
                                data.kpis.forEach(k => {
                                    migrationQueue.kpis.push({
                                        fileName: file.name,
                                        cr714_employeename: empName,
                                        _cr714_employee_value: empId,
                                        cr714_logdate: data.reviewDate,
                                        cr714_kpiname: k.metric,
                                        cr714_kpitarget: k.target,
                                        cr714_kpivalue: k.value,
                                        cr714_trend: k.trend
                                    });
                                });
                                logConsole(`  + Found ${data.kpis.length} KPIs`, 'log-success');
                            } else {
                                logConsole(`  ! AI found no KPIs`, 'log-warn');
                            }
                        } else {
                            logConsole(`  ! AI could not identify Name`, 'log-err');
                        }
                    } else {
                         logConsole(`  ! API Error`, 'log-err');
                    }

                } catch(e) {
                    logConsole(`  ! Error: ${e.message}`, 'log-err');
                }
            }

            btn.innerHTML = originalText;
            logConsole(`> AI Processing Complete.`);
            updatePreviewTables();
            
            if(migrationQueue.reviews.length > 0) {
                document.getElementById('btn-upload').disabled = false;
                document.getElementById('btn-upload').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        // --- HELPERS ---
        function findEmployee(extractedName) {
             if(!store.employees.length) return null;
             const search = extractedName.toLowerCase().replace(/[^a-z ]/g, '').trim();
             const tokens = search.split(/\s+/);
             return store.employees.find(e => {
                const roster = e.name.toLowerCase().replace(/[^a-z ]/g, '').trim();
                const rTokens = roster.split(/\s+/);
                const intersection = tokens.filter(t => rTokens.includes(t));
                return intersection.length >= 2; 
            });
        }

        function logConsole(msg, type='text-white') { 
            const c = document.getElementById('mig-console'); 
            c.innerHTML += `<div class="${type}">${msg}</div>`; 
            c.scrollTop = c.scrollHeight; 
        }
        
        window.showDebug = (content) => {
             document.getElementById('debug-content').textContent = unescape(content);
             toggleForce('debug-modal', true);
        };

        function updatePreviewTables() {
            document.getElementById('count-reviews').textContent = migrationQueue.reviews.length;
            document.getElementById('count-kpis').textContent = migrationQueue.kpis.length;
            document.getElementById('tbody-reviews').innerHTML = migrationQueue.reviews.map(r => `<tr><td>${r.fileName}</td><td>${r.cr714_employeename}</td><td>${r.cr714_reviewdate}</td><td>${r.cr714_reviewtype}</td><td>${r.cr714_opportunities_current?.substring(0,50)}</td><td>${r.cr714_actionplan?.substring(0,50)}</td></tr>`).join('');
            document.getElementById('tbody-kpis').innerHTML = migrationQueue.kpis.map(k => `<tr><td>${k.cr714_employeename}</td><td>${k.cr714_logdate}</td><td>${k.cr714_kpiname}</td><td>${k.cr714_kpitarget}</td><td>${k.cr714_kpivalue}</td><td>${k.cr714_trend}</td></tr>`).join('');
        }
        
        window.uploadBatches = async function() {
            const BATCH = 20; const revs = migrationQueue.reviews; const kpis = migrationQueue.kpis; const total = Math.ceil(revs.length / BATCH) + Math.ceil(kpis.length / BATCH);
            if(!confirm(`Upload ${revs.length} Reviews and ${kpis.length} KPIs?`)) return;
            logConsole(`> Starting Cloud Upload (${total} batches)...`);
            for(let i=0; i<revs.length; i+=BATCH) { const chunk = revs.slice(i, i+BATCH); try { await fetch(FLOW_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: 'bulk_upload', table: 'reviews', data: chunk }) }); logConsole(`  > Reviews Batch OK.`); } catch(e) { logConsole(`  ! Error: ${e.message}`, 'log-err'); } }
            for(let i=0; i<kpis.length; i+=BATCH) { const chunk = kpis.slice(i, i+BATCH); try { await fetch(FLOW_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: 'bulk_upload', table: 'kpis', data: chunk }) }); logConsole(`  > KPIs Batch OK.`); } catch(e) { logConsole(`  ! Error: ${e.message}`, 'log-err'); } }
            alert("Upload Complete.");
        };

        // Standard Functions
        const safeSetText = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        const toggleForce = (id, show) => { const el = document.getElementById(id); if(el) show ? el.classList.remove('hidden-force') : el.classList.add('hidden-force'); };
        
        function renderEmployeeTable() {
             document.getElementById('emp-table').querySelector('tbody').innerHTML = store.employees.map(e => `
                <tr onclick="router.openEmployee('${e.id}')"><td class="font-bold text-primary">${e.name}</td><td>${e.title}</td><td>${e.dept}</td><td><span class="badge badge-green">${e.status}</span></td></tr>
            `).join('');
        }

        window.router = { 
            navigate: (id) => { document.querySelectorAll('.view').forEach(e => e.classList.remove('active')); document.getElementById(`view-${id}`).classList.add('active'); }, 
            openEmployee: (id) => { 
                const emp = store.employees.find(e => e.id === id); 
                document.getElementById('profile-name').textContent = emp.name; 
                window.router.navigate('employee-detail'); 
            },
            backToProfile: () => window.router.navigate('employee-detail')
        };
        
        window.switchTable = (type, btn) => {
            document.getElementById('table-reviews').classList.add('hidden');
            document.getElementById('table-kpis').classList.add('hidden');
            document.getElementById(`table-${type}`).classList.remove('hidden');
        };

        window.toggleTheme = () => {
            const current = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', current === 'winter' ? 'midnight' : 'winter');
        };
        
        // Export
        window.exportToExcel = function() {
            if(migrationQueue.reviews.length === 0) return alert("No parsed data to export.");
            const wb = XLSX.utils.book_new();
            const wsRev = XLSX.utils.json_to_sheet(migrationQueue.reviews);
            const wsKpi = XLSX.utils.json_to_sheet(migrationQueue.kpis);
            XLSX.utils.book_append_sheet(wb, wsRev, "Reviews");
            XLSX.utils.book_append_sheet(wb, wsKpi, "KPI_Logs");
            XLSX.writeFile(wb, "AI_Migration_Data.xlsx");
        };

        document.addEventListener('DOMContentLoaded', window.forceLoad);
    </script>
</body>
</html>
