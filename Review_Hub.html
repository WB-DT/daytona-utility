<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4.9 Performance Hub Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Role Colors */
        .role-srmgr { color: #2563eb; font-weight: 700; } /* Blue */
        .role-mgr { color: #d97706; font-weight: 600; }   /* Amber */
        .role-sup { color: #16a34a; font-weight: 600; }   /* Green */
        .role-gold { color: #ca8a04; font-weight: 700; }  /* Gold */
        .role-rep { color: #334155; font-weight: 500; }   /* Slate */

        /* Sidebar Items */
        .nav-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        .nav-item:hover { background-color: #f1f5f9; }
        .nav-item.active { 
            background-color: #eff6ff; 
            border-left-color: #2563eb; 
            color: #1e40af;
        }
        
        /* Card Effects */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: #2563eb; cursor: pointer;
            margin-top: -6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: #e2e8f0; border-radius: 2px;
        }

        /* Overlays */
        #loading-overlay, #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; transition: opacity 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #loading-overlay { background: #ffffff; color: #334155; }
        #auth-container { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); }
        .hidden-force { display: none !important; }

        .spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Print Layout */
        @media print {
            @page { size: portrait; margin: 0.5cm; }
            body { background: white; height: auto; overflow: visible; }
            #sidebar, #header-bar, #loading-overlay, #auth-container, .no-print { display: none !important; }
            #main-content { width: 100% !important; padding: 0 !important; margin: 0 !important; height: auto !important; overflow: visible !important; }
            .print-card { box-shadow: none !important; border: 1px solid #ccc !important; margin-bottom: 20px !important; page-break-inside: avoid; }
            /* Hide non-essential UI in print */
            .print-hide { display: none !important; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800">

    <div id="auth-container" class="hidden-force">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full border border-slate-200">
            <div class="mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto text-2xl">
                    <i class="fa-solid fa-chart-line"></i>
                </div>
            </div>
            <h1 class="text-2xl font-bold text-slate-900 mb-2">Performance Hub</h1>
            <p class="text-slate-500 mb-8">Secure Dataverse Connection Required</p>
            <button onclick="window.signIn()" class="w-full bg-[#2f2f2f] text-white font-medium py-3 px-4 rounded-lg hover:bg-black transition-colors flex items-center justify-center gap-3">
                <img src="https://learn.microsoft.com/en-us/azure/active-directory/develop/media/howto-add-branding-in-azure-ad-apps/ms-symbollockup_mssymbol_19.png" class="h-5 w-5" alt="Microsoft">
                Sign in with Microsoft
            </button>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700">Loading Data...</h2>
        <p class="text-slate-400 text-sm mt-2" id="loading-text">Connecting to Flow...</p>
    </div>

    <aside id="sidebar" class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 shadow-lg transition-all duration-300 hidden-force">
        <div class="p-5 border-b border-slate-100">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">P</div>
                <h1 class="font-bold text-lg tracking-tight text-slate-800">Performance Hub</h1>
            </div>
            <div class="flex items-center gap-2 text-xs text-green-600 font-medium">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                Dataverse Connected
            </div>
        </div>

        <div class="p-3 bg-slate-50 border-b border-slate-100">
            <div class="relative">
                <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                <input type="text" id="search-input" onkeyup="window.handleSearch()" placeholder="Search reps, managers..." class="w-full pl-9 pr-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-1">
            
            <div class="mb-2">
                <button onclick="window.toggleGroup('dept-list', this)" class="w-full flex items-center justify-between p-2 text-xs font-bold text-slate-500 uppercase hover:bg-slate-100 rounded mb-1">
                    <span>Departments <span id="count-dept" class="ml-1 bg-slate-200 px-1.5 rounded-full">0</span></span>
                    <i class="fa-solid fa-chevron-down transition-transform"></i>
                </button>
                <div id="dept-list" class="space-y-0.5"></div>
            </div>

            <div class="mb-2">
                <button onclick="window.toggleGroup('mgr-list', this)" class="w-full flex items-center justify-between p-2 text-xs font-bold text-slate-500 uppercase hover:bg-slate-100 rounded mb-1">
                    <span>Managers <span id="count-mgr" class="ml-1 bg-slate-200 px-1.5 rounded-full">0</span></span>
                    <i class="fa-solid fa-chevron-down transition-transform"></i>
                </button>
                <div id="mgr-list" class="space-y-0.5 hidden"></div>
            </div>

            <div class="mb-2">
                <button onclick="window.toggleGroup('sup-list', this)" class="w-full flex items-center justify-between p-2 text-xs font-bold text-slate-500 uppercase hover:bg-slate-100 rounded mb-1">
                    <span>Supervisors <span id="count-sup" class="ml-1 bg-slate-200 px-1.5 rounded-full">0</span></span>
                    <i class="fa-solid fa-chevron-down transition-transform"></i>
                </button>
                <div id="sup-list" class="space-y-0.5 hidden"></div>
            </div>

            <div class="mb-2">
                <button onclick="window.toggleGroup('rep-list', this)" class="w-full flex items-center justify-between p-2 text-xs font-bold text-slate-500 uppercase hover:bg-slate-100 rounded mb-1">
                    <span>Representatives <span id="count-rep" class="ml-1 bg-slate-200 px-1.5 rounded-full">0</span></span>
                    <i class="fa-solid fa-chevron-down transition-transform"></i>
                </button>
                <div id="rep-list" class="space-y-0.5"></div>
            </div>

        </div>

        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <button onclick="window.triggerFlowSync()" class="w-full flex items-center justify-center gap-2 bg-white border border-slate-200 text-slate-700 py-2 px-4 rounded-lg text-xs font-medium hover:bg-slate-100 hover:border-slate-300 transition-all shadow-sm">
                <i class="fa-solid fa-rotate"></i> Sync Data
            </button>
        </div>
    </aside>

    <div id="main-content" class="flex-1 flex flex-col h-full overflow-hidden relative bg-white hidden-force">
        
        <header id="header-bar" class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10">
            <div class="flex flex-col">
                <h2 id="header-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
                <div id="header-breadcrumbs" class="text-xs text-slate-500 flex items-center gap-1">
                    <i class="fa-solid fa-home"></i> <span>Home</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col items-end mr-4 border-r pr-4 border-slate-200">
                    <span id="clock-time" class="text-sm font-mono font-bold text-slate-700">--:--</span>
                    <span id="clock-date" class="text-[10px] text-slate-400 uppercase">--</span>
                </div>

                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <div id="user-name" class="text-xs font-bold text-slate-700">Guest</div>
                        <div class="text-[10px] text-slate-400">Viewer</div>
                    </div>
                    <div class="h-8 w-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 border border-slate-200">
                        <i class="fa-solid fa-user"></i>
                    </div>
                </div>

                <div class="h-8 w-px bg-slate-200 mx-2"></div>

                <button onclick="window.openCreateReviewModal()" id="btn-new-review" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded-lg shadow-sm transition-colors hidden flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> New Review
                </button>
                <button onclick="window.print()" class="bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 text-xs font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center gap-2">
                    <i class="fa-solid fa-print"></i> Export
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-8 bg-slate-50">
            
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                <i class="fa-regular fa-folder-open text-6xl mb-4 opacity-20"></i>
                <p class="text-sm">Select a department or employee to begin.</p>
            </div>

            <div id="dashboard-view" class="max-w-6xl mx-auto space-y-6 hidden">
                
                <div class="print-card glass-panel p-4 rounded-xl flex flex-wrap items-center justify-between gap-4 bg-white border border-slate-200">
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Period Ending</span>
                            <span id="lbl-date-display" class="text-lg font-bold text-blue-600">--</span>
                        </div>
                        <div class="h-8 w-px bg-slate-200 mx-2 no-print"></div>
                        <div class="flex flex-col flex-1 no-print">
                            <input type="range" id="review-date-slider" class="w-48 h-2 bg-slate-200 rounded-lg cursor-pointer accent-blue-600" min="0" max="0" value="0" oninput="window.handleSliderChange()">
                            <div class="flex justify-between text-[10px] text-slate-400 mt-1">
                                <span>Past</span>
                                <span>Current</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3 no-print">
                        <span class="text-xs font-bold text-slate-500">Compare:</span>
                        <select id="duration-select" onchange="window.handleSliderChange()" class="text-xs border border-slate-200 rounded-md bg-white px-2 py-1 text-slate-700 focus:outline-none focus:border-blue-500">
                            <option value="1">Monthly</option>
                            <option value="3">Quarterly</option>
                            <option value="6">6 Months</option>
                            <option value="12">Annual</option>
                        </select>
                    </div>
                    
                    <div class="text-right pl-4 border-l border-slate-200 md:block hidden">
                        <div class="text-[10px] uppercase text-slate-400 font-bold">Reports To</div>
                        <div id="lbl-manager" class="text-sm font-medium text-slate-700">--</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="print-card lg:col-span-2 bg-white rounded-xl border border-slate-200 p-5 shadow-sm">
                        <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide mb-4 border-b border-slate-100 pb-2">Performance Metrics</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">Metric</th>
                                        <th class="px-4 py-3 text-right">Target</th>
                                        <th class="px-4 py-3 text-right">Actual</th>
                                        <th class="px-4 py-3 text-center rounded-r-lg">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="kpi-table-body" class="divide-y divide-slate-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="print-card bg-white rounded-xl border border-slate-200 p-5 shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide">Trend</h3>
                            <select id="chart-kpi-select" onchange="window.updateChart()" class="no-print text-xs border border-slate-200 rounded px-2 py-1 bg-white"></select>
                        </div>
                        <div class="flex-1 relative min-h-[200px]">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="print-card bg-white p-5 rounded-xl border border-slate-200 border-l-4 border-l-blue-500 shadow-sm">
                        <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye text-blue-500"></i> Opportunities (Current)</h4>
                        <ul id="text-opps-this" class="text-sm text-slate-600 list-disc list-inside space-y-1"></ul>
                    </div>
                    <div class="print-card bg-white p-5 rounded-xl border border-slate-200 border-l-4 border-l-gray-400 shadow-sm">
                        <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-gray-400"></i> Opportunities (Previous)</h4>
                        <ul id="text-opps-last" class="text-sm text-slate-600 list-disc list-inside space-y-1"></ul>
                    </div>
                    <div class="print-card bg-white p-5 rounded-xl border border-slate-200 border-l-4 border-l-green-500 shadow-sm">
                        <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fa-solid fa-check-circle text-green-500"></i> Best Practices</h4>
                        <ul id="text-best-practices" class="text-sm text-slate-600 list-disc list-inside space-y-1"></ul>
                    </div>
                    <div class="print-card bg-white p-5 rounded-xl border border-slate-200 border-l-4 border-l-amber-500 shadow-sm">
                        <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fa-solid fa-rocket text-amber-500"></i> Action Plan</h4>
                        <ul id="text-action-plan" class="text-sm text-slate-600 list-disc list-inside space-y-1"></ul>
                    </div>
                </div>

                <div class="print-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-comment-dots text-slate-400"></i> Agent's Voice</h4>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 italic text-sm text-slate-600" id="text-agent-voice">
                        --
                    </div>
                </div>

            </div>

            <div id="create-view" class="max-w-4xl mx-auto space-y-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-slate-800">New Review: <span id="new-review-name" class="text-blue-600">--</span></h3>
                    <button onclick="window.showDashboard()" class="text-sm text-slate-500 hover:text-slate-800">Cancel</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-4">
                        <h4 class="font-bold text-sm uppercase text-slate-400">Details</h4>
                        <div><label class="block text-xs font-bold text-slate-700 mb-1">Review Date</label><input type="date" id="form-date" class="w-full border border-slate-300 rounded-lg p-2 text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-700 mb-1">Review Type</label><select id="form-type" class="w-full border border-slate-300 rounded-lg p-2 text-sm"><option>EOM</option><option>EOQ</option><option>Annual</option><option>30-Day</option><option>90-Day</option></select></div>
                        <div><label class="block text-xs font-bold text-slate-700 mb-1">Reviewer Role</label><select id="form-level" class="w-full border border-slate-300 rounded-lg p-2 text-sm"><option>Manager</option><option>Supervisor</option><option>Director</option></select></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="font-bold text-sm uppercase text-slate-400 mb-4">Key Performance Indicators</h4>
                        <div id="form-kpi-inputs" class="space-y-3"></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-4">
                    <h4 class="font-bold text-sm uppercase text-slate-400">Qualitative Feedback</h4>
                    <div><label class="block text-xs font-bold text-slate-700 mb-1">Opportunities</label><textarea id="form-opps" rows="3" class="w-full border border-slate-300 rounded-lg p-2 text-sm"></textarea></div>
                    <div><label class="block text-xs font-bold text-slate-700 mb-1">Action Plan</label><textarea id="form-plan" rows="3" class="w-full border border-slate-300 rounded-lg p-2 text-sm"></textarea></div>
                    <div><label class="block text-xs font-bold text-slate-700 mb-1">Special Notes</label><textarea id="form-notes" rows="2" class="w-full border border-slate-300 rounded-lg p-2 text-sm"></textarea></div>
                    <div class="pt-4 flex gap-3">
                        <button onclick="window.saveNewReview()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition-colors">Save Review</button>
                        <button onclick="window.showDashboard()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 rounded-lg transition-colors">Cancel</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const msalConfig = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: window.location.href }, cache: { cacheLocation: "localStorage" } };
        const GET_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg"; 
        const SAVE_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/088be03ff3724bb4ac49e37532d96136/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=1vZTb9PuSi5SC6Q3_af9YNiuLxLDYcBPqCfOVDFFftA";

        // --- 2. STATE ---
        let msalInstance = null, username = "";
        let rawEmployees = [], dbReviews = [], dbLogs = [];
        let currentRepId = null, activeFilter = { type: 'All', value: null };
        let reviewDateRange = [], chartInstance = null;

        const kpiConfigs = {
            "Sales": [{id:"outbound",label:"Outbound Calls",target:50},{id:"invoices",label:"Invoices",target:10},{id:"talktime",label:"Talk Time (Avg)",target:120}],
            "Quotes": [{id:"projects",label:"Quotes Processed",target:50},{id:"accuracy",label:"Accuracy",target:98},{id:"items",label:"Items Quoted",target:500}],
            "Food Service": [{id:"orders",label:"Food Orders",target:30},{id:"errors",label:"Order Errors",target:2}],
            "Account Management 3": [{id:"touchpoints",label:"Touchpoints",target:15},{id:"growth",label:"Growth",target:10},{id:"nps",label:"NPS",target:70}]
        };

        // --- 3. AUTH ---
        window.initAuth = async function() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                const response = await msalInstance.handleRedirectPromise();
                if (response?.account) window.handleLoginSuccess(response.account);
                else {
                    const accs = msalInstance.getAllAccounts();
                    if (accs.length > 0) window.handleLoginSuccess(accs[0]);
                    else { 
                        document.getElementById('loading-overlay').classList.add('hidden-force');
                        document.getElementById('auth-container').classList.remove('hidden-force'); 
                        document.getElementById('auth-container').classList.remove('hidden');
                    }
                }
            } catch(e) { console.error("Auth Init:", e); }
        };

        window.signIn = function() {
            msalInstance.loginPopup({ scopes: ["User.Read"] }).then(resp => { if(resp?.account) window.handleLoginSuccess(resp.account); }).catch(console.error);
        };

        window.handleLoginSuccess = function(account) {
            username = account.username;
            document.getElementById('user-name').textContent = account.name.split(' ')[0]; // First name only
            document.getElementById('auth-container').classList.add('hidden-force');
            document.getElementById('loading-overlay').classList.remove('hidden-force');
            window.initData();
        };

        // --- 4. DATA ---
        window.callFlow = async function(url, body) {
            const options = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) };
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`Flow Error: ${res.status}`);
            const text = await res.text();
            return text ? JSON.parse(text) : {};
        };

        window.initData = async function() {
            window.startClock();
            try {
                const rawData = await window.callFlow(GET_DATA_FLOW_URL, { userEmail: username });
                
                // UNPACKING LOGIC - Critical for Flow compatibility
                let root = rawData.body || rawData;
                let empSource = root.employees || [];
                // Handle Dataverse "value" wrapper inside employees array if present
                if (empSource.value) empSource = empSource.value;
                else if (Array.isArray(empSource) && empSource[0]?.value) empSource = empSource[0].value;

                rawEmployees = empSource.map(e => ({
                    id: e.cr714_employeename, 
                    name: e.cr714_employeename,
                    role: e['cr714_jobtitle@OData.Community.Display.V1.FormattedValue'] || e.cr714_jobtitle || 'Rep',
                    dept: e['cr714_department@OData.Community.Display.V1.FormattedValue'] || e.cr714_department || 'N/A',
                    managerId: e['_cr714_managerassigned_value@OData.Community.Display.V1.FormattedValue'] || e.cr714_managerassigned,
                    supervisorId: e['_cr714_supervisors_value@OData.Community.Display.V1.FormattedValue'] || e.cr714_supervisors,
                    isGoldStar: (e.cr714_goldstarflag === 'Y' || e.cr714_goldstarflag === true)
                }));

                // Fallback Role Inference
                const mgrs = new Set(rawEmployees.map(e=>e.managerId).filter(Boolean));
                const sups = new Set(rawEmployees.map(e=>e.supervisorId).filter(Boolean));
                rawEmployees.forEach(e => {
                    if(e.role === 'Rep') {
                        if(sups.has(e.name)) e.role = 'Supervisor';
                        else if(mgrs.has(e.name)) e.role = 'Manager';
                    }
                });

                dbReviews = root.reviews || [];
                dbLogs = root.logs || [];
                if(dbLogs.length > 0) reviewDateRange = [...new Set(dbLogs.map(l => l.date))].sort();
                else reviewDateRange = ["2024-11", "2024-12", "2025-01"];

                document.getElementById('loading-overlay').classList.add('hidden-force');
                document.getElementById('main-app').classList.remove('hidden-force');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('sidebar').classList.remove('hidden-force');
                window.renderSidebar();

            } catch (e) { document.getElementById('loading-overlay').innerHTML = `<div class="text-red-500 font-bold">Sync Error: ${e.message}</div>`; }
        };

        // --- 5. UI & LOGIC ---
        window.renderSidebar = function() {
            if(!rawEmployees.length) return;
            
            const createBtn = (item, onClick, cls='') => `<div class="nav-item p-2 pl-3 text-xs font-medium text-slate-600 rounded-r-md flex justify-between items-center ${cls}" onclick="${onClick}"><span>${item.name || item}</span> <span class="text-[9px] bg-slate-100 px-1 rounded text-slate-400 border border-slate-200">${item.count || ''}</span></div>`;
            
            // Departments
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(d => d && d !== 'N/A').sort();
            document.getElementById('list-dept').innerHTML = depts.map(d => createBtn(d, `window.filterSidebar('Department', '${d}', this)`)).join('');
            document.getElementById('count-dept').textContent = depts.length;

            // Managers
            const mgrs = rawEmployees.filter(e => e.role.includes('Manager')).sort((a,b)=>a.name.localeCompare(b.name));
            document.getElementById('list-mgr').innerHTML = mgrs.map(m => createBtn(m, `window.filterSidebar('Manager', '${m.name}', this)`, 'role-mgr')).join('');
            document.getElementById('count-mgr').textContent = mgrs.length;

            // Supervisors
            const sups = rawEmployees.filter(e => e.role.includes('Supervisor')).sort((a,b)=>a.name.localeCompare(b.name));
            document.getElementById('list-sup').innerHTML = sups.map(s => createBtn(s, `window.filterSidebar('Supervisor', '${s.name}', this)`, 'role-sup')).join('');
            document.getElementById('count-sup').textContent = sups.length;

            // Reps (Including Gold Stars logic)
            window.renderRepList(rawEmployees); // Initial Full Render
        };

        window.renderRepList = function(list) {
            const container = document.getElementById('list-rep');
            container.innerHTML = list.sort((a,b)=>a.name.localeCompare(b.name)).map(r => {
                const isGold = r.isGoldStar;
                return `<div class="nav-item p-2 pl-3 text-xs rounded-r-md flex justify-between items-center" onclick="window.selectRep('${r.id}')" data-id="${r.id}">
                    <span class="${isGold ? 'role-gold' : 'role-rep'}">${r.name}</span>
                    ${isGold ? '<i class="fa-solid fa-star text-yellow-400 text-[10px]"></i>' : ''}
                </div>`;
            }).join('');
            document.getElementById('count-rep').textContent = list.length;
        };

        window.toggleGroup = function(id, btn) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            const icon = btn.querySelector('.fa-chevron-down');
            if(icon) icon.style.transform = el.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        };

        window.filterSidebar = function(type, val, btnElement) {
            // Visual Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            activeFilter = { type, value: val };
            
            // Update Breadcrumbs
            const bread = document.getElementById('header-breadcrumbs');
            bread.innerHTML = `<span>${type}</span> <i class="fa-solid fa-chevron-right text-[8px]"></i> <span class="font-bold text-slate-700">${val}</span>`;

            // Logic: Filter lists based on selection
            let filteredReps = [];

            if (type === 'Department') {
                // Filter Manager & Sup Lists
                const deptMgrs = rawEmployees.filter(e => e.role.includes('Manager') && e.dept === val);
                const deptSups = rawEmployees.filter(e => e.role.includes('Supervisor') && e.dept === val);
                
                // Update Manager List Visually
                const mgrList = document.getElementById('list-mgr');
                const mgrBtns = mgrList.children;
                for(let b of mgrBtns) {
                     const name = b.innerText.split(' ')[0] + ' ' + b.innerText.split(' ')[1]; // Hacky parsing, rely on dataset better usually
                     // Re-rendering sub-lists is safer
                }
                document.getElementById('list-mgr').innerHTML = deptMgrs.map(m => `<div class="nav-item p-2 pl-3 text-xs rounded-r-md role-mgr" onclick="window.filterSidebar('Manager', '${m.name}', this)">${m.name}</div>`).join('');
                document.getElementById('list-mgr').classList.remove('hidden');
                
                // Update Sup List Visually
                document.getElementById('list-sup').innerHTML = deptSups.map(s => `<div class="nav-item p-2 pl-3 text-xs rounded-r-md role-sup" onclick="window.filterSidebar('Supervisor', '${s.name}', this)">${s.name}</div>`).join('');
                document.getElementById('list-sup').classList.remove('hidden');

                // Filter Reps
                filteredReps = rawEmployees.filter(e => e.dept === val);
            } 
            else if (type === 'Manager') {
                filteredReps = rawEmployees.filter(e => e.managerId === val);
            } 
            else if (type === 'Supervisor') {
                // Supervisor sees direct reports + reports of their managers + THEMSELVES
                const subMgrs = rawEmployees.filter(m => m.supervisorId === val).map(m => m.id);
                filteredReps = rawEmployees.filter(e => e.supervisorId === val || subMgrs.includes(e.managerId));
                
                const self = rawEmployees.find(e => e.name === val);
                if(self && !filteredReps.includes(self)) filteredReps.unshift(self);
            }

            window.renderRepList(filteredReps);
            document.getElementById('list-rep').classList.remove('hidden');
        };

        window.selectRep = function(id) {
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('page-create').classList.add('hidden');
            document.getElementById('btn-new-review').classList.remove('hidden');

            // Update Header
            document.getElementById('header-breadcrumbs').innerHTML += ` <i class="fa-solid fa-chevron-right text-[8px]"></i> <span class="font-bold text-blue-600">${emp.name}</span>`;
            document.getElementById('lbl-manager').textContent = emp.managerId || 'Unassigned';

            // Reset Slider & Load Data
            const s = document.getElementById('review-date-slider');
            s.max = Math.max(0, reviewDateRange.length - 1);
            s.value = s.max;
            window.handleSliderChange();
        };

        window.handleSliderChange = function() {
            if (!currentRepId) return;
            const idx = document.getElementById('review-date-slider').value;
            const end = reviewDateRange[idx];
            document.getElementById('lbl-date-display').textContent = end;
            
            const logs = dbLogs.filter(l => l.repId === currentRepId && l.date === end);
            const kpis = kpiConfigs[rawEmployees.find(e=>e.id===currentRepId).dept] || kpiConfigs["Sales"];
            
            document.getElementById('kpi-table-body').innerHTML = kpis.map(k => {
                const l = logs.find(x=>x.kpiId === k.id);
                return `<tr><td class="px-4 py-3 font-medium text-slate-700">${k.label}</td><td class="px-4 py-3 text-right text-slate-500">${k.target}</td><td class="px-4 py-3 text-right font-bold text-slate-900">${l ? Math.floor(l.value) : '-'}</td><td class="px-4 py-3 text-center">-</td></tr>`;
            }).join('');
            
            // Charts & Text (Simplified for brevity)
            window.updateChart();
        };
        
        window.updateChart = function() {
             const ctx = document.getElementById('trendChart').getContext('2d');
             if(chartInstance) chartInstance.destroy();
             chartInstance = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false } });
        };

        window.handleSearch = function() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = rawEmployees.filter(e => e.name.toLowerCase().includes(term));
            window.renderRepList(filtered);
            document.getElementById('list-rep').classList.remove('hidden');
        };
        
        window.startClock = function() { setInterval(() => { const d = new Date(); document.getElementById('clock-time').textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); document.getElementById('clock-date').textContent = d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'}); }, 1000); };

        // --- Create / Export ---
        window.openCreateReviewModal = function() {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('page-create').classList.remove('hidden');
            document.getElementById('new-review-name').textContent = currentRepId;
            document.getElementById('form-date').valueAsDate = new Date();
            const kpis = kpiConfigs[rawEmployees.find(e=>e.id===currentRepId).dept] || kpiConfigs["Sales"];
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => `<div><label class="block text-xs font-bold text-slate-700 mb-1">${k.label}</label><input id="kpi-${k.id}" type="number" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"></div>`).join('');
        };
        
        window.saveNewReview = async function() {
            try {
                const payload = {
                    repId: currentRepId, date: document.getElementById('form-date').value,
                    type: document.getElementById('form-type').value,
                    opps: document.getElementById('form-opps').value,
                    plan: document.getElementById('form-plan').value,
                    notes: document.getElementById('form-notes').value
                };
                await window.callFlow(SAVE_DATA_FLOW_URL, payload);
                alert("Saved successfully!");
                window.initData();
            } catch(e) { alert("Save Failed: " + e.message); }
        };
        
        window.showDashboard = function() {
            document.getElementById('page-create').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
        };
        
        window.triggerFlowSync = function() { alert("Syncing..."); window.callFlow(GET_DATA_FLOW_URL, {}).then(()=>alert("Sync Complete")); };
        window.openExportModal = function() { window.print(); };
        window.applyTheme = function(v) { document.documentElement.setAttribute('data-theme', v); };

        document.addEventListener('DOMContentLoaded', window.initAuth);
    </script>
</body>
</html>
