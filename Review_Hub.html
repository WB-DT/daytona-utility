<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5.7 Performance Hub Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="midnight"]'],
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: 'var(--color-primary)',
                        bg: 'var(--color-bg)',
                        card: 'var(--color-card)',
                        text: 'var(--color-text)',
                        muted: 'var(--color-muted)',
                        border: 'var(--color-border)'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --color-primary: #3b82f6;
            --color-bg: #f3f4f6;
            --color-card: #ffffff;
            --color-text: #1e293b;
            --color-muted: #64748b;
            --color-border: #e2e8f0;
            --sidebar-w: 320px;
        }

        [data-theme="midnight"] {
            --color-primary: #60a5fa;
            --color-bg: #0f172a;
            --color-card: #1e293b;
            --color-text: #f1f5f9;
            --color-muted: #94a3b8;
            --color-border: #334155;
        }

        [data-theme="oled"] {
            --color-primary: #facc15;
            --color-bg: #000000;
            --color-card: #121212;
            --color-text: #ffffff;
            --color-muted: #a1a1aa;
            --color-border: #27272a;
        }

        body { background-color: var(--color-bg); color: var(--color-text); transition: background-color 0.3s, color 0.3s; }
        .glass-panel { background: var(--color-card); border: 1px solid var(--color-border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }

        /* Animations */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: slideIn 0.3s ease-out forwards; }
        
        /* Print Styles */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background: white !important; color: black !important; }
            #sidebar-container, header, #loading-overlay, #auth-container, .no-print { display: none !important; }
            #main-content { width: 100% !important; padding: 0 !important; height: auto !important; overflow: visible !important; }
            .glass-panel { box-shadow: none !important; border: 1px solid #ccc !important; break-inside: avoid; }
            .print-full { width: 100% !important; max-width: none !important; }
            /* Hide non-printable elements */
            button, select, input[type="range"] { display: none !important; }
            /* Show values for inputs */
            .print-value { display: block !important; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="auth-container" class="hidden-force fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full border border-slate-200 animate-enter">
            <div class="mb-6"><div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto text-3xl shadow-lg"><i class="fa-solid fa-chart-simple"></i></div></div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Performance Hub</h1>
            <p class="text-slate-500 mb-8">Sign in to access your dashboard.</p>
            <button onclick="window.signIn()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition-all shadow-lg hover:shadow-blue-500/30 flex items-center justify-center gap-3">
                <i class="fa-brands fa-microsoft"></i> Sign in with Microsoft
            </button>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[9998] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700">Syncing Data...</h2>
        <p class="text-slate-400 text-sm mt-2">Retrieving latest metrics from Dataverse</p>
        <button onclick="window.forceLoad()" id="force-load-btn" class="mt-8 text-xs text-red-400 hover:text-red-600 underline hidden">Force Load Dashboard</button>
    </div>

    <aside id="sidebar-container" class="w-[320px] bg-card border-r border-border flex flex-col z-20 shadow-xl transition-all duration-300 hidden-force">
        <div class="p-6 border-b border-border">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-primary/30">P</div>
                <div>
                    <h1 class="font-bold text-xl tracking-tight text-text">Performance Hub</h1>
                    <div class="flex items-center gap-2 text-xs text-green-500 font-medium"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Live Connected</div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-b border-border bg-bg/50">
            <div class="relative group">
                <i class="fa-solid fa-search absolute left-3 top-3 text-muted group-focus-within:text-primary transition-colors text-sm"></i>
                <input type="text" id="search-input" onkeyup="window.handleSearch()" placeholder="Search employees..." class="w-full pl-10 pr-4 py-2 bg-card border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all shadow-sm">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-2">
            <div class="space-y-1">
                <button onclick="window.toggleGroup('dept-list', this)" class="w-full flex items-center justify-between p-2.5 text-xs font-bold text-muted uppercase hover:bg-bg rounded-lg transition-colors group">
                    <span class="group-hover:text-primary">Departments <span id="count-dept" class="ml-1 bg-border/50 px-1.5 py-0.5 rounded text-text">0</span></span>
                    <i class="fa-solid fa-chevron-down transition-transform text-muted/50"></i>
                </button>
                <div id="dept-list" class="space-y-0.5 pl-2"></div>
            </div>

            <div class="space-y-1">
                <button onclick="window.toggleGroup('mgr-list', this)" class="w-full flex items-center justify-between p-2.5 text-xs font-bold text-yellow-600 uppercase hover:bg-bg rounded-lg transition-colors group">
                    <span class="group-hover:text-yellow-500">Managers <span id="count-mgr" class="ml-1 bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">0</span></span>
                    <i class="fa-solid fa-chevron-down transition-transform text-muted/50"></i>
                </button>
                <div id="mgr-list" class="space-y-0.5 pl-2 hidden"></div>
            </div>

            <div class="space-y-1">
                <button onclick="window.toggleGroup('sup-list', this)" class="w-full flex items-center justify-between p-2.5 text-xs font-bold text-green-600 uppercase hover:bg-bg rounded-lg transition-colors group">
                    <span class="group-hover:text-green-500">Supervisors <span id="count-sup" class="ml-1 bg-green-100 text-green-700 px-1.5 py-0.5 rounded">0</span></span>
                    <i class="fa-solid fa-chevron-down transition-transform text-muted/50"></i>
                </button>
                <div id="sup-list" class="space-y-0.5 pl-2 hidden"></div>
            </div>

            <div class="space-y-1">
                <button onclick="window.toggleGroup('rep-list', this)" class="w-full flex items-center justify-between p-2.5 text-xs font-bold text-muted uppercase hover:bg-bg rounded-lg transition-colors group">
                    <span class="group-hover:text-primary">Representatives <span id="count-rep" class="ml-1 bg-border/50 px-1.5 py-0.5 rounded text-text">0</span></span>
                    <i class="fa-solid fa-chevron-down transition-transform text-muted/50"></i>
                </button>
                <div id="rep-list" class="space-y-0.5 pl-2"></div>
            </div>
        </div>

        <div class="p-4 border-t border-border bg-bg/30">
            <button onclick="window.triggerFlowSync()" class="w-full flex items-center justify-center gap-2 bg-card border border-border text-text py-2.5 px-4 rounded-lg text-sm font-medium hover:bg-bg hover:border-primary/50 transition-all shadow-sm group">
                <i class="fa-solid fa-rotate group-hover:animate-spin"></i> Sync Data
            </button>
        </div>
    </aside>

    <div id="main-content" class="flex-1 flex flex-col h-full overflow-hidden relative bg-bg hidden-force">
        
        <header class="h-16 bg-card border-b border-border flex items-center justify-between px-8 shadow-sm z-10">
            <div>
                <h2 id="header-title" class="text-2xl font-bold text-text tracking-tight">Dashboard</h2>
                <div id="header-breadcrumbs" class="text-xs text-muted flex items-center gap-2 mt-0.5">
                    <i class="fa-solid fa-home"></i> <span>Home</span>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <div class="relative group no-print">
                    <button class="flex items-center gap-2 text-sm text-muted hover:text-primary transition-colors">
                        <i class="fa-solid fa-palette"></i> <span id="current-theme-name">Theme</span>
                    </button>
                    <div class="absolute right-0 mt-2 w-32 bg-card border border-border rounded-lg shadow-xl hidden group-hover:block p-1">
                        <button onclick="window.setTheme('winter')" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-bg text-text flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Winter</button>
                        <button onclick="window.setTheme('midnight')" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-bg text-text flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-800"></span> Midnight</button>
                        <button onclick="window.setTheme('oled')" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-bg text-text flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-black border border-white/20"></span> OLED</button>
                    </div>
                </div>

                <div class="hidden md:flex flex-col items-end border-r border-border pr-6 no-print">
                    <span id="clock-time" class="text-sm font-mono font-bold text-text">--:--</span>
                    <span id="clock-date" class="text-[10px] text-muted uppercase tracking-wider">--</span>
                </div>

                <div class="flex items-center gap-3 no-print">
                    <div class="text-right hidden sm:block">
                        <div id="user-name" class="text-sm font-bold text-text">User</div>
                        <div class="text-[10px] text-muted">Logged In</div>
                    </div>
                    <div class="h-9 w-9 bg-primary/10 text-primary rounded-full flex items-center justify-center border border-primary/20">
                        <i class="fa-solid fa-user"></i>
                    </div>
                </div>

                <div class="h-8 w-px bg-border mx-2 no-print"></div>

                <button onclick="window.openCreateReviewModal()" id="btn-new-review" class="bg-primary hover:opacity-90 text-white text-sm font-bold py-2 px-5 rounded-lg shadow-lg shadow-primary/20 transition-all flex items-center gap-2 no-print">
                    <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">New Review</span>
                </button>
                <button onclick="window.openExportModal()" class="bg-card border border-border text-text hover:bg-bg text-sm font-bold py-2 px-5 rounded-lg shadow-sm transition-all flex items-center gap-2 no-print">
                    <i class="fa-solid fa-file-export"></i> <span class="hidden sm:inline">Export</span>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-8 print:p-0">
            
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-muted animate-enter">
                <div class="w-24 h-24 bg-bg rounded-full flex items-center justify-center mb-4">
                    <i class="fa-regular fa-folder-open text-4xl opacity-50"></i>
                </div>
                <p class="text-lg font-medium">Select a department or employee to begin.</p>
            </div>

            <div id="dashboard-view" class="max-w-7xl mx-auto space-y-6 hidden print-full">
                
                <div class="glass-panel p-5 rounded-xl flex flex-wrap items-center justify-between gap-6 animate-enter">
                    <div class="flex items-center gap-6 w-full md:w-auto">
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase font-bold text-muted tracking-wider mb-1">Review Period</span>
                            <div class="flex items-center gap-3 bg-bg px-3 py-1.5 rounded-lg border border-border">
                                <select id="date-start" onchange="window.handleDateChange()" class="text-sm font-bold bg-transparent focus:outline-none text-text cursor-pointer"></select>
                                <span class="text-muted text-xs"><i class="fa-solid fa-arrow-right"></i></span>
                                <select id="date-end" onchange="window.handleDateChange()" class="text-sm font-bold bg-transparent focus:outline-none text-text cursor-pointer"></select>
                            </div>
                        </div>
                        
                        <div class="hidden md:block h-10 w-px bg-border"></div>

                        <div class="flex flex-col flex-1 min-w-[200px]">
                            <span class="text-[10px] uppercase font-bold text-muted tracking-wider mb-1">Timeline</span>
                            <input type="range" id="review-date-slider" class="w-full h-2 bg-border rounded-lg cursor-pointer accent-primary" min="0" max="0" value="0" oninput="window.handleSliderChange()">
                            <div class="flex justify-between text-[10px] text-muted mt-1"><span>Past</span><span>Current</span></div>
                        </div>
                    </div>

                    <div class="flex flex-col items-end pl-6 border-l border-border">
                        <span class="text-[10px] uppercase font-bold text-muted tracking-wider">Reports To</span>
                        <div id="lbl-manager" class="text-base font-bold text-text">--</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 print:grid-cols-2">
                    <div class="glass-panel rounded-xl p-0 overflow-hidden animate-enter lg:col-span-2">
                        <div class="p-4 border-b border-border bg-bg/30 flex justify-between items-center">
                            <h3 class="text-sm font-bold text-text uppercase tracking-wide flex items-center gap-2">
                                <i class="fa-solid fa-table-list text-primary"></i> Performance Metrics
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-muted uppercase bg-bg/50">
                                    <tr>
                                        <th class="px-6 py-3">Metric</th>
                                        <th class="px-6 py-3 text-right">Target</th>
                                        <th class="px-6 py-3 text-right">Actual</th>
                                        <th class="px-6 py-3 text-center">Trend</th>
                                        <th class="px-6 py-3 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="kpi-table-body" class="divide-y divide-border"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="glass-panel rounded-xl p-5 flex flex-col animate-enter" style="animation-delay: 0.1s">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-text uppercase tracking-wide flex items-center gap-2">
                                <i class="fa-solid fa-chart-line text-primary"></i> Trend
                            </h3>
                            <select id="chart-kpi-select" onchange="window.updateChart()" class="no-print text-xs border border-border rounded-lg px-2 py-1 bg-bg text-text focus:ring-1 focus:ring-primary outline-none"></select>
                        </div>
                        <div class="flex-1 relative w-full min-h-[200px]">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-l-blue-500 animate-enter" style="animation-delay: 0.2s">
                        <h4 class="font-bold text-text mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-bullseye text-blue-500"></i> Opportunities (Current)</h4>
                        <ul id="text-opps-this" class="text-sm text-text/80 list-disc list-inside space-y-2 marker:text-blue-500"></ul>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-l-slate-400 animate-enter" style="animation-delay: 0.3s">
                        <h4 class="font-bold text-text mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> Opportunities (Previous)</h4>
                        <ul id="text-opps-last" class="text-sm text-text/80 list-disc list-inside space-y-2 marker:text-slate-400"></ul>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-l-green-500 animate-enter" style="animation-delay: 0.4s">
                        <h4 class="font-bold text-text mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-check-circle text-green-500"></i> Best Practices</h4>
                        <ul id="text-best-practices" class="text-sm text-text/80 list-disc list-inside space-y-2 marker:text-green-500"></ul>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-l-amber-500 animate-enter" style="animation-delay: 0.5s">
                        <h4 class="font-bold text-text mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-rocket text-amber-500"></i> Action Plan</h4>
                        <ul id="text-action-plan" class="text-sm text-text/80 list-disc list-inside space-y-2 marker:text-amber-500"></ul>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-xl animate-enter" style="animation-delay: 0.6s">
                    <h4 class="font-bold text-text mb-3 flex items-center gap-2 text-lg"><i class="fa-solid fa-comment-dots text-primary"></i> Agent's Voice</h4>
                    <div class="bg-bg/50 p-5 rounded-xl border border-border italic text-sm text-text/70 leading-relaxed" id="text-agent-voice">--</div>
                </div>
            </div>

            <div id="create-view" class="max-w-4xl mx-auto space-y-6 hidden animate-enter">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h3 class="text-3xl font-bold text-text">New Review</h3>
                        <p class="text-muted text-sm mt-1">Creating evaluation for <span id="new-review-name" class="text-primary font-bold">--</span></p>
                    </div>
                    <button onclick="window.showDashboard()" class="text-sm text-muted hover:text-text bg-card border border-border px-4 py-2 rounded-lg transition-colors">Cancel</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-6">
                        <div class="glass-panel p-5 rounded-xl space-y-4">
                            <h4 class="font-bold text-xs uppercase text-muted tracking-wider mb-2">Review Details</h4>
                            <div>
                                <label class="block text-xs font-bold text-text mb-1.5">Date</label>
                                <input type="date" id="form-date" class="w-full bg-bg border border-border rounded-lg p-2.5 text-sm text-text focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-text mb-1.5">Type</label>
                                <select id="form-type" class="w-full bg-bg border border-border rounded-lg p-2.5 text-sm text-text focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                                    <option>EOM</option><option>EOQ</option><option>Annual</option><option>30-Day</option><option>90-Day</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-text mb-1.5">Reviewer Level</label>
                                <select id="form-level" class="w-full bg-bg border border-border rounded-lg p-2.5 text-sm text-text focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                                    <option>Manager</option><option>Supervisor</option><option>Director</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="glass-panel p-5 rounded-xl">
                             <h4 class="font-bold text-xs uppercase text-muted tracking-wider mb-4">Scoring (KPIs)</h4>
                             <div id="form-kpi-inputs" class="space-y-3"></div>
                        </div>
                    </div>

                    <div class="md:col-span-2 glass-panel p-6 rounded-xl space-y-5">
                        <h4 class="font-bold text-xs uppercase text-muted tracking-wider mb-2">Qualitative Feedback</h4>
                        <div>
                            <label class="block text-xs font-bold text-text mb-2 flex items-center gap-2"><i class="fa-solid fa-bullseye text-blue-500"></i> Opportunities</label>
                            <textarea id="form-opps" rows="4" class="w-full bg-bg border border-border rounded-lg p-3 text-sm text-text focus:ring-2 focus:ring-primary/50 outline-none transition-all placeholder-muted/50" placeholder="List key areas for improvement..."></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-text mb-2 flex items-center gap-2"><i class="fa-solid fa-rocket text-amber-500"></i> Action Plan</label>
                            <textarea id="form-plan" rows="4" class="w-full bg-bg border border-border rounded-lg p-3 text-sm text-text focus:ring-2 focus:ring-primary/50 outline-none transition-all placeholder-muted/50" placeholder="Specific steps to take..."></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-text mb-2 flex items-center gap-2"><i class="fa-solid fa-note-sticky text-purple-500"></i> Special Notes</label>
                            <textarea id="form-notes" rows="2" class="w-full bg-bg border border-border rounded-lg p-3 text-sm text-text focus:ring-2 focus:ring-primary/50 outline-none transition-all placeholder-muted/50"></textarea>
                        </div>
                        
                        <div class="pt-4 flex gap-4 border-t border-border mt-4">
                            <button onclick="window.saveNewReview()" class="flex-1 bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-primary/30 transition-all transform hover:-translate-y-0.5">Save Review</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- CONFIG ---
        const msalConfig = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: window.location.href }, cache: { cacheLocation: "localStorage" } };
        const GET_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg"; 
        const SAVE_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/088be03ff3724bb4ac49e37532d96136/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=1vZTb9PuSi5SC6Q3_af9YNiuLxLDYcBPqCfOVDFFftA";

        let msalInstance = null, username = "";
        let rawEmployees = [], dbReviews = [], dbLogs = [], reviewDateRange = [];
        let currentRepId = null, chartInstance = null;
        
        // KPI Config
        const kpiConfigs = {"Sales":[{id:"outbound",label:"Outbound Calls",target:50},{id:"invoices",label:"Invoices",target:10}],"Quotes":[{id:"projects",label:"Quotes Processed",target:50}],"Food Service":[{id:"orders",label:"Food Orders",target:30}],"Account Management 1":[{id:"touchpoints",label:"Touchpoints",target:20}],"Analytics/Workforce":[{id:"tickets",label:"Tickets",target:20}],"New Hire In Training":[{id:"modules",label:"Modules",target:10}]};

        // --- DOM HELPERS ---
        const safeSetText = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        const safeSetHTML = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
        const toggleEl = (id, show) => { const el = document.getElementById(id); if(el) show ? el.classList.remove('hidden') : el.classList.add('hidden'); };
        const toggleForce = (id, show) => { const el = document.getElementById(id); if(el) show ? el.classList.remove('hidden-force') : el.classList.add('hidden-force'); };

        // --- AUTH ---
        window.initAuth = async function() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                const response = await msalInstance.handleRedirectPromise();
                if (response?.account) window.handleLoginSuccess(response.account);
                else {
                    const accs = msalInstance.getAllAccounts();
                    if (accs.length > 0) window.handleLoginSuccess(accs[0]);
                    else { toggleForce('loading-overlay', false); toggleForce('auth-container', true); }
                }
            } catch(e) { console.error(e); }
        };

        window.signIn = function() { msalInstance.loginPopup({ scopes: ["User.Read"] }).then(resp => { if(resp?.account) window.handleLoginSuccess(resp.account); }).catch(console.error); };
        
        window.handleLoginSuccess = function(account) {
            username = account.username;
            safeSetText('user-name', account.name.split(' ')[0]);
            toggleForce('auth-container', false);
            toggleForce('loading-overlay', true); // Show loading while fetching data
            window.initData();
        };

        // --- DATA ---
        window.callFlow = async function(url, body) {
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (!res.ok) throw new Error(res.statusText);
            const text = await res.text();
            return text ? JSON.parse(text) : {};
        };

        window.initData = async function() {
            window.startClock();
            const failSafe = setTimeout(() => { document.getElementById('force-load-btn')?.classList.remove('hidden'); }, 5000);
            try {
                const rawData = await window.callFlow(GET_DATA_FLOW_URL, { userEmail: username });
                clearTimeout(failSafe);
                
                // Unpack Helper
                const unpack = (src) => {
                    if(!src) return [];
                    if(src.value && Array.isArray(src.value)) return src.value;
                    if(Array.isArray(src)) {
                        if(src.length > 0 && src[0].value && Array.isArray(src[0].value)) return src[0].value;
                        return src;
                    }
                    return [];
                };

                const empList = unpack(rawData.employees || rawData.body?.employees);
                rawEmployees = empList.map(e => ({
                    id: e.cr714_employeename, 
                    name: e.cr714_employeename,
                    role: e['cr714_jobtitle@OData.Community.Display.V1.FormattedValue'] || e.cr714_jobtitle || 'Rep',
                    dept: e['cr714_department@OData.Community.Display.V1.FormattedValue'] || e.cr714_department || 'N/A',
                    managerId: e['cr714_managerassigned'] || 'Unassigned',
                    supervisorId: e['cr714_supervisors'] || e['cr714_srmanager'],
                    isGoldStar: (e.cr714_goldstarflag === 'Y' || e.cr714_goldstarflag === true)
                }));

                // Role Inference fallback
                const mgrs = new Set(rawEmployees.map(e=>e.managerId).filter(n=>n && n!=='Unassigned'));
                const sups = new Set(rawEmployees.map(e=>e.supervisorId).filter(Boolean));
                rawEmployees.forEach(e => {
                    if(e.role === 'Rep') {
                        if(sups.has(e.name)) e.role = 'Supervisor';
                        else if(mgrs.has(e.name)) e.role = 'Manager';
                    }
                });

                dbReviews = unpack(rawData.reviews || rawData.body?.reviews).map(r => ({
                    repId: r['_cr714_employee_lookup_value@OData.Community.Display.V1.FormattedValue'] || r._cr714_employee_lookup_value,
                    date: r.cr714_reviewdate,
                    oppsThis: r.cr714_opps_current,
                    oppsLast: r.cr714_opps_previous,
                    bestPractices: r.cr714_bestpractices,
                    actionPlan: r.cr714_actionplan,
                    agentVoice: r.cr714_agentvoice
                }));

                dbLogs = unpack(rawData.logs || rawData.body?.logs).map(l => ({
                    repId: l['_cr714_employee_lookup_value@OData.Community.Display.V1.FormattedValue'] || l._cr714_employee_lookup_value,
                    date: l.cr714_logdate,
                    kpiId: l.cr714_kpiname,
                    value: l.cr714_kpivalue
                }));

                if (dbLogs.length > 0) reviewDateRange = [...new Set(dbLogs.map(l => l.date))].sort();
                else reviewDateRange = ["2024-11", "2024-12", "2025-01"];

                window.forceLoad();
            } catch (e) { console.error(e); window.forceLoad(); }
        };

        window.forceLoad = function() {
            toggleForce('loading-overlay', false);
            toggleForce('main-content', true);
            toggleForce('sidebar-container', true);
            
            // Populate Dates
            const dateOpts = reviewDateRange.map(d => `<option value="${d}">${d}</option>`).join('');
            safeSetHTML('date-start', dateOpts);
            safeSetHTML('date-end', dateOpts);
            if(reviewDateRange.length > 0) {
                 document.getElementById('date-end').value = reviewDateRange[reviewDateRange.length-1];
                 if(reviewDateRange.length > 1) document.getElementById('date-start').value = reviewDateRange[reviewDateRange.length-2];
            }
            
            const slider = document.getElementById('review-date-slider');
            if(slider) { slider.max = Math.max(0, reviewDateRange.length - 1); slider.value = slider.max; }

            window.renderSidebar();
        };

        // --- SIDEBAR & FILTERING ---
        window.renderSidebar = function() {
            if(!rawEmployees.length) return;
            
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(d => d && d !== 'N/A').sort();
            safeSetHTML('dept-list', depts.map(d => `<div class="nav-item p-2 pl-3 text-xs rounded-md flex justify-between items-center text-muted hover:text-primary cursor-pointer transition-colors" onclick="window.filterSidebar('Department', '${d}', this)"><span>${d}</span> <span class="text-[9px] bg-slate-200/50 px-1.5 rounded text-muted/80">${rawEmployees.filter(e=>e.dept===d).length}</span></div>`).join(''));
            safeSetText('count-dept', depts.length);

            const mgrs = rawEmployees.filter(e => e.role.includes('Manager')).sort((a,b)=>a.name.localeCompare(b.name));
            safeSetHTML('mgr-list', mgrs.map(m => `<div class="nav-item p-2 pl-3 text-xs rounded-md text-amber-600 hover:bg-amber-50 cursor-pointer transition-colors" onclick="window.filterSidebar('Manager', '${m.name}', this)">${m.name}</div>`).join(''));
            safeSetText('count-mgr', mgrs.length);

            const sups = rawEmployees.filter(e => e.role.includes('Supervisor')).sort((a,b)=>a.name.localeCompare(b.name));
            safeSetHTML('sup-list', sups.map(s => `<div class="nav-item p-2 pl-3 text-xs rounded-md text-green-600 hover:bg-green-50 cursor-pointer transition-colors" onclick="window.filterSidebar('Supervisor', '${s.name}', this)">${s.name}</div>`).join(''));
            safeSetText('count-sup', sups.length);

            window.renderRepList(rawEmployees);
        };

        window.renderRepList = function(list) {
            safeSetHTML('rep-list', list.sort((a,b)=>a.name.localeCompare(b.name)).map(r => {
                const isGold = r.isGoldStar;
                let roleBadge = '';
                if(r.role.includes('Supervisor')) roleBadge = `<span class="ml-1 w-2 h-2 rounded-full bg-green-500" title="Supervisor"></span>`;
                else if(r.role.includes('Manager')) roleBadge = `<span class="ml-1 w-2 h-2 rounded-full bg-amber-500" title="Manager"></span>`;

                return `<div class="nav-item p-2.5 pl-3 text-xs rounded-md flex justify-between items-center hover:bg-white hover:shadow-sm cursor-pointer transition-all mb-1" onclick="window.selectRep('${r.id}')" data-id="${r.id}">
                    <span class="${isGold ? 'text-yellow-600 font-bold' : 'text-text'}">${r.name}</span>
                    <div class="flex items-center gap-1">${isGold ? '<i class="fa-solid fa-star text-yellow-400 text-[10px]"></i>' : ''}${roleBadge}</div>
                </div>`;
            }).join(''));
            safeSetText('count-rep', list.length);
        };

        window.toggleGroup = function(id, btn) {
            const el = document.getElementById(id);
            if(!el) return;
            el.classList.toggle('hidden');
            const icon = btn.querySelector('.fa-chevron-down');
            if(icon) icon.style.transform = el.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        };

        window.filterSidebar = function(type, val, btn) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500'));
            // Add active style logic here if desired
            
            safeSetHTML('header-breadcrumbs', `<i class="fa-solid fa-filter text-primary"></i> <span>${type}</span> <i class="fa-solid fa-chevron-right text-[10px] text-muted"></i> <span class="font-bold text-text">${val}</span>`);

            let filtered = [];
            if(type === 'Department') {
                filtered = rawEmployees.filter(e => e.dept === val);
                // Filter sub-lists visual visibility if needed, simplified here to just rep list update
            } else if (type === 'Manager') filtered = rawEmployees.filter(e => e.managerId === val);
            else if (type === 'Supervisor') {
                 // Sup sees direct reports + manager reports + self
                 const directs = rawEmployees.filter(e => e.supervisorId === val);
                 const self = rawEmployees.find(e => e.name === val);
                 filtered = directs;
                 if(self && !filtered.includes(self)) filtered.unshift(self);
            }
            window.renderRepList(filtered);
            window.showDashboard();
        };

        window.selectRep = function(id) {
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            if(emp) {
                safeSetText('header-title', emp.name);
                safeSetText('lbl-manager', emp.managerId);
                safeSetHTML('header-breadcrumbs', `<i class="fa-solid fa-user text-primary"></i> <span>Employee View</span> <i class="fa-solid fa-chevron-right text-[10px] text-muted"></i> <span class="font-bold text-text">${emp.name}</span>`);
                
                window.showDashboard();
                window.handleDateChange();
            }
        };

        // --- DASHBOARD LOGIC ---
        window.handleDateChange = function() {
            if (!currentRepId) return;
            
            const start = document.getElementById('date-start').value;
            const end = document.getElementById('date-end').value;
            // Update slider to match end date if possible
            const idx = reviewDateRange.indexOf(end);
            if(idx !== -1) document.getElementById('review-date-slider').value = idx;

            // 1. Populate KPIs
            const logs = dbLogs.filter(l => l.repId === currentRepId && (l.date === start || l.date === end));
            const kpiSet = kpiConfigs[rawEmployees.find(e=>e.id===currentRepId).dept] || kpiConfigs["Sales"];
            
            safeSetHTML('kpi-table-body', kpiSet.map(k => {
                const lStart = logs.find(x => x.kpiId === k.id && x.date === start);
                const lEnd = logs.find(x => x.kpiId === k.id && x.date === end);
                const vStart = lStart ? Math.round(lStart.value) : 0;
                const vEnd = lEnd ? Math.round(lEnd.value) : 0;
                const isUp = vEnd >= vStart;
                const hitTarget = vEnd >= k.target;
                
                return `<tr class="hover:bg-bg/30 transition-colors">
                    <td class="px-6 py-4 font-medium text-text">${k.label}</td>
                    <td class="px-6 py-4 text-right text-muted font-mono">${k.target}</td>
                    <td class="px-6 py-4 text-right font-bold text-text font-mono">${vEnd}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="${isUp ? 'text-green-500' : 'text-red-500'} text-xs font-bold bg-card border border-border px-2 py-1 rounded-full">
                            ${isUp ? '▲' : '▼'} ${Math.abs(vEnd - vStart)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">${hitTarget ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : '<i class="fa-solid fa-circle-exclamation text-amber-500"></i>'}</td>
                </tr>`;
            }).join(''));

            // 2. Populate Text
            const rev = dbReviews.find(r => r.repId === currentRepId && r.date === end);
            const fill = (id, txt) => safeSetHTML(id, txt ? txt.split('\n').map(i => `<li class="leading-relaxed">${i}</li>`).join('') : '<li class="text-muted italic">No data for this period.</li>');
            
            if(rev) {
                fill('text-opps-this', rev.oppsThis); fill('text-opps-last', rev.oppsLast);
                fill('text-best-practices', rev.bestPractices); fill('text-action-plan', rev.actionPlan);
                safeSetText('text-agent-voice', rev.agentVoice || 'No comments.');
            } else {
                ['text-opps-this', 'text-opps-last', 'text-best-practices', 'text-action-plan'].forEach(id => fill(id, null));
                safeSetText('text-agent-voice', 'No review found.');
            }

            window.updateChart();
        };

        window.handleSliderChange = function() {
            const idx = document.getElementById('review-date-slider').value;
            const date = reviewDateRange[idx];
            if(date) {
                document.getElementById('date-end').value = date;
                window.handleDateChange();
            }
        };

        window.updateChart = function() {
             const ctx = document.getElementById('trendChart').getContext('2d');
             if(chartInstance) chartInstance.destroy();
             
             // Mock data for visuals since we lack full historical depth in the current filters
             chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: reviewDateRange,
                    datasets: [{
                        label: 'Performance Score',
                        data: reviewDateRange.map(() => Math.floor(Math.random() * 100)), // Placeholder
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
             });
        };

        // --- CREATE & EXPORT ---
        window.openCreateReviewModal = function() {
            if(!currentRepId) return alert("Please select a representative from the sidebar first.");
            
            toggleEl('dashboard-view', false);
            toggleEl('create-view', true);
            toggleEl('empty-state', false);
            safeSetText('new-review-name', currentRepId);
            document.getElementById('form-date').valueAsDate = new Date();
            
            const kpis = kpiConfigs[rawEmployees.find(e=>e.id===currentRepId).dept] || kpiConfigs["Sales"];
            safeSetHTML('form-kpi-inputs', kpis.map(k => `
                <div class="flex items-center justify-between">
                    <label class="text-xs font-bold text-text w-1/2">${k.label}</label>
                    <input id="kpi-${k.id}" type="number" class="w-20 bg-bg border border-border rounded p-1 text-sm text-right outline-none focus:border-primary">
                </div>
            `).join(''));
        };

        window.saveNewReview = async function() {
            const btn = document.querySelector('#create-view button');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            try {
                const payload = {
                    repId: currentRepId,
                    date: document.getElementById('form-date').value,
                    type: document.getElementById('form-type').value,
                    opps: document.getElementById('form-opps').value,
                    plan: document.getElementById('form-plan').value,
                    notes: document.getElementById('form-notes').value
                };
                await window.callFlow(SAVE_DATA_FLOW_URL, payload);
                alert("Review Saved Successfully!");
                window.showDashboard();
                window.initData(); // Refresh data
            } catch(e) { alert("Save Failed: " + e.message); }
            btn.innerHTML = 'Save Review';
        };

        window.showDashboard = function() {
            toggleEl('create-view', false);
            toggleEl('dashboard-view', true);
            toggleEl('empty-state', false);
        };

        window.openExportModal = function() {
            // The CSS @media print handles the layout
            window.print();
        };

        // --- UTILS ---
        window.setTheme = function(t) {
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
            safeSetText('current-theme-name', t.charAt(0).toUpperCase() + t.slice(1));
        };
        window.handleSearch = function() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = rawEmployees.filter(e => e.name.toLowerCase().includes(term));
            window.renderRepList(filtered);
        };
        window.startClock = function() { 
            setInterval(() => { 
                const d = new Date(); 
                safeSetText('clock-time', d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})); 
                safeSetText('clock-date', d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'})); 
            }, 1000); 
        };
        window.triggerFlowSync = function() { 
            toggleForce('loading-overlay', true); 
            window.initData(); 
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const t = localStorage.getItem('theme') || 'winter';
            window.setTheme(t);
            window.initAuth();
        });
    </script>
</body>
</html>
