<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Hub Pro | 6.9 Enterprise Migration</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            darkMode: ['class', '[data-theme="midnight"]'],
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: 'var(--color-primary)',
                        bg: 'var(--color-bg)',
                        card: 'var(--color-card)',
                        text: 'var(--color-text)',
                        muted: 'var(--color-muted)',
                        border: 'var(--color-border)',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>

    <style>
        :root { --color-primary: #002f6c; --color-bg: #f4f7f6; --color-card: #ffffff; --color-text: #2c3e50; --color-muted: #7f8c8d; --color-border: #e2e8f0; --secondary: #d42e12; }
        [data-theme="midnight"] { --color-primary: #60a5fa; --color-bg: #0f172a; --color-card: #1e293b; --color-text: #f1f5f9; --color-muted: #94a3b8; --color-border: #334155; --secondary: #f87171; }
        
        body { background-color: var(--color-bg); color: var(--color-text); transition: background-color 0.3s, color 0.3s; }
        
        /* Layout Utils */
        .glass-panel { background: var(--color-card); border: 1px solid var(--color-border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hidden-force { display: none !important; }
        .animate-enter { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Navigation */
        .view { display: none; }
        .view.active { display: block; animation: slideIn 0.3s ease-in-out; }
        .nav-item { cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(0,0,0,0.05); border-left-color: var(--secondary); color: var(--color-primary); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 12px; background: var(--color-bg); color: var(--color-muted); font-weight: 700; border-bottom: 2px solid var(--color-border); text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 12px; border-bottom: 1px solid var(--color-border); vertical-align: middle; }
        tr:hover td { background: rgba(0,0,0,0.02); }

        /* Console */
        .console-log {
            background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; font-size: 0.75rem;
            padding: 1rem; border-radius: 0.5rem; height: 300px; overflow-y: auto; border: 1px solid #333;
        }
        .log-warn { color: #facc15; }
        .log-err { color: #f87171; }
        .log-success { color: #4ade80; }
        .log-info { color: #60a5fa; }

        /* Status Badges */
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        
        /* Trends */
        .trend-icon { font-size: 1rem; font-weight: bold; margin-left: 5px; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-flat { color: #6b7280; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="loading-overlay" class="fixed inset-0 z-[9998] bg-white flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700" id="loading-text">Loading Performance Hub...</h2>
        <button onclick="window.forceLoad()" class="mt-8 text-xs text-red-400 hover:text-red-600 underline">Force Load</button>
    </div>

    <aside id="sidebar-container" class="w-64 bg-card border-r border-border flex flex-col z-20 shadow-xl transition-all duration-300 hidden-force">
        <div class="p-6 border-b border-border flex items-center gap-3">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold shadow">P</div>
            <h1 class="font-bold text-lg tracking-tight text-text">Performance<span class="text-primary">Hub</span></h1>
        </div>
        
        <div class="flex-1 overflow-y-auto px-2 space-y-1 py-4">
            <div class="px-3 text-xs font-bold text-muted uppercase mb-2">Workspace</div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3 active" onclick="router.navigate('employees')">
                <i class="fa-solid fa-users w-5 text-center"></i> Employees
            </div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3" onclick="router.navigate('reviews-list')">
                <i class="fa-solid fa-file-contract w-5 text-center"></i> Review Log
            </div>
            
            <div class="mt-6 px-3 text-xs font-bold text-muted uppercase mb-2">Admin Tools</div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3 text-warning bg-warning/5 border border-warning/20" onclick="router.navigate('migration')">
                <i class="fa-solid fa-server w-5 text-center"></i> Migration Hub
            </div>
        </div>

        <div class="p-4 border-t border-border">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-primary/10 text-primary rounded-full flex items-center justify-center"><i class="fa-solid fa-user"></i></div>
                <div class="overflow-hidden">
                    <div id="user-name" class="text-sm font-bold text-text truncate">Admin User</div>
                    <div class="text-[10px] text-muted truncate">Connected</div>
                </div>
            </div>
        </div>
    </aside>

    <div id="main-content" class="flex-1 flex flex-col h-full overflow-hidden relative hidden-force">
        
        <header class="h-16 bg-card border-b border-border flex items-center justify-between px-6 shadow-sm z-10">
            <div>
                <h2 id="page-title" class="text-xl font-bold text-text">Team Dashboard</h2>
                <div id="breadcrumbs" class="text-xs text-muted flex items-center gap-2">Home</div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="window.toggleTheme()" class="p-2 text-muted hover:text-primary transition-colors"><i class="fa-solid fa-circle-half-stroke"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6">
            
            <div id="view-employees" class="view active max-w-7xl mx-auto">
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-4 border-b border-border bg-bg/50 flex justify-between items-center">
                        <h3 class="font-bold text-text">Roster</h3>
                        <div class="relative">
                            <input type="text" id="search-emp" onkeyup="window.filterEmployees()" placeholder="Search..." class="pl-8 pr-3 py-1 text-sm rounded border border-border">
                            <i class="fa-solid fa-search absolute left-2.5 top-2 text-xs text-muted"></i>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="emp-table">
                            <thead><tr><th>Name</th><th>Title</th><th>Department</th><th>Manager</th><th>Status</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-migration" class="view max-w-7xl mx-auto">
                <div class="glass-panel p-6 rounded-xl mb-6">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-warning text-white flex items-center justify-center text-2xl shadow-lg"><i class="fa-solid fa-database"></i></div>
                            <div>
                                <h2 class="text-2xl font-bold text-text">Historical Migration</h2>
                                <p class="text-sm text-muted">Bulk parse Word/PDF files into Review and KPI tables.</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <button onclick="window.exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow flex items-center gap-2">
                                <i class="fa-solid fa-file-excel"></i> Export Results (.xlsx)
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border border-border shadow-sm text-center cursor-pointer hover:border-primary transition-colors group" onclick="document.getElementById('mig-file-input').click()">
                            <i class="fa-solid fa-file-lines text-2xl text-primary mb-2 group-hover:scale-110 transition-transform"></i>
                            <div class="text-sm font-bold">Select Files</div>
                            <div class="text-xs text-muted">For testing specific docs</div>
                            <input type="file" id="mig-file-input" multiple class="hidden" onchange="window.handleMigrationFiles(this)">
                        </div>

                        <div class="bg-white p-4 rounded-lg border border-border shadow-sm text-center cursor-pointer hover:border-warning transition-colors group" onclick="document.getElementById('mig-folder-input').click()">
                            <i class="fa-solid fa-folder-tree text-2xl text-warning mb-2 group-hover:scale-110 transition-transform"></i>
                            <div class="text-sm font-bold">Select Folder</div>
                            <div class="text-xs text-muted">For bulk processing (800+)</div>
                            <input type="file" id="mig-folder-input" webkitdirectory multiple class="hidden" onchange="window.handleMigrationFiles(this)">
                        </div>

                        <div class="md:col-span-2 bg-bg/50 p-4 rounded-lg border border-border flex flex-col justify-center">
                            <div class="flex justify-between mb-2">
                                <span class="text-xs font-bold uppercase text-muted">Files Selected:</span>
                                <span id="stat-files" class="text-sm font-bold">0</span>
                            </div>
                            <div class="flex gap-2">
                                <button id="btn-parse" onclick="window.startParsing()" class="flex-1 bg-primary text-white py-2 rounded font-bold text-sm opacity-50 cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-gear"></i> Parse
                                </button>
                                <button id="btn-upload" onclick="window.uploadBatches()" class="flex-1 bg-success text-white py-2 rounded font-bold text-sm opacity-50 cursor-not-allowed" disabled>
                                    <i class="fa-solid fa-cloud-arrow-up"></i> Upload
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="mig-console" class="console-log mb-6">
                        > Waiting for file selection...
                    </div>

                    <div class="bg-white border border-border rounded-xl overflow-hidden shadow-md">
                        <div class="flex border-b border-border">
                            <button class="px-6 py-3 text-sm font-bold text-primary border-b-2 border-primary bg-blue-50" onclick="switchTable('reviews', this)">
                                1. Reviews Table (<span id="count-reviews">0</span>)
                            </button>
                            <button class="px-6 py-3 text-sm font-bold text-muted hover:text-text" onclick="switchTable('kpis', this)">
                                2. KPIs Table (<span id="count-kpis">0</span>)
                            </button>
                        </div>
                        
                        <div id="table-reviews" class="h-96 overflow-y-auto block">
                            <table class="w-full">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr><th>File</th><th>Agent</th><th>Date</th><th>Type</th><th>Opportunities</th><th>Action Plan</th></tr>
                                </thead>
                                <tbody id="tbody-reviews" class="bg-white">
                                    <tr><td colspan="6" class="text-center p-8 text-muted">No data parsed.</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div id="table-kpis" class="h-96 overflow-y-auto hidden">
                            <table class="w-full">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th>Agent</th>
                                        <th>Log Date</th>
                                        <th>Metric Name</th>
                                        <th>Target (Last)</th>
                                        <th>Value (This)</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-kpis" class="bg-white">
                                    <tr><td colspan="6" class="text-center p-8 text-muted">No data parsed.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-employee-detail" class="view max-w-6xl mx-auto">
                <button onclick="router.navigate('employees')" class="mb-4 text-sm font-bold text-muted hover:text-primary"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <div class="glass-panel p-8 rounded-xl mb-6">
                    <h1 id="profile-name" class="text-3xl font-bold text-primary">--</h1>
                    <p id="profile-role" class="text-muted">--</p>
                </div>
                <div class="glass-panel rounded-xl overflow-hidden mb-6">
                    <div class="p-3 bg-bg border-b border-border font-bold">Review History</div>
                    <table id="profile-table"><thead><tr><th>Date</th><th>Type</th><th>Opps</th><th>Plan</th></tr></thead><tbody></tbody></table>
                </div>
                 <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-3 bg-bg border-b border-border font-bold">KPI Logs</div>
                    <table id="profile-kpi-table"><thead><tr><th>Date</th><th>Metric</th><th>Target</th><th>Value</th><th>Trend</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- CONFIG ---
        const FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg";
        
        let migrationQueue = { reviews: [], kpis: [] };
        let store = { employees: [], reviews: [], kpis: [] };
        let selectedFiles = [];
        let parsingStats = { processed: 0, inactive: 0, noName: 0, noKPIs: 0 };
        let failedFiles = [];

        // --- MIGRATION: FILE HANDLING ---
        window.handleMigrationFiles = function(input) {
            const files = Array.from(input.files).filter(f => f.name.endsWith('.docx') || f.name.endsWith('.pdf'));
            if(files.length === 0) return logConsole("! No valid .docx/.pdf files selected.");

            selectedFiles = files;
            document.getElementById('stat-files').textContent = files.length;
            document.getElementById('btn-parse').disabled = false;
            document.getElementById('btn-parse').classList.remove('opacity-50', 'cursor-not-allowed');
            logConsole(`> Queued ${files.length} files. Click 'Parse' to begin.`);
        };

        // --- MIGRATION: PARSING ENGINE ---
        window.startParsing = async function() {
            if(!selectedFiles.length) return;
            
            logConsole(`> --- STARTING PARSE ENGINE v6.8 ---`);
            migrationQueue = { reviews: [], kpis: [] };
            parsingStats = { processed: 0, inactive: 0, noName: 0, noKPIs: 0 };
            failedFiles = [];
            
            const btn = document.getElementById('btn-parse');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Processing...`;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                logConsole(`> Reading [${i+1}/${selectedFiles.length}]: ${file.name}`);
                
                try {
                    let text = "";
                    if (file.name.endsWith('.docx')) {
                        const ab = await file.arrayBuffer();
                        const res = await mammoth.extractRawText({ arrayBuffer: ab });
                        text = res.value;
                    } else if (file.name.endsWith('.pdf')) {
                        const ab = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(ab).promise;
                        for (let j = 1; j <= pdf.numPages; j++) {
                            const page = await pdf.getPage(j);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ") + "\n";
                        }
                    }

                    if(text) {
                        const data = extractDataFromText(text, file.name);
                        
                        if(data.name) {
                            // Link Employee & Check Active
                            const emp = store.employees.find(e => e.name.toLowerCase().includes(data.name.split(' ')[0].toLowerCase()));
                            
                            if (emp) {
                                // Filter Inactive
                                if (emp.status !== 'Active') {
                                    logConsole(`  ! Skipped: ${emp.name} is Inactive`, 'warn');
                                    parsingStats.inactive++;
                                    failedFiles.push({ file: file.name, reason: "Inactive Rep" });
                                    continue;
                                }

                                const empId = emp.id;
                                parsingStats.processed++;

                                // 1. REVIEWS
                                migrationQueue.reviews.push({
                                    fileName: file.name,
                                    cr714_employeename: data.name,
                                    _cr714_employee_value: empId,
                                    cr714_reviewdate: data.date,
                                    cr714_reviewtype: "End of Month",
                                    cr714_opportunities_current: data.opps,
                                    cr714_actionplan: data.plan,
                                    cr714_agentvoice: data.voice
                                });

                                // 2. KPIS
                                if(data.kpiRows && data.kpiRows.length > 0) {
                                    data.kpiRows.forEach(kpi => {
                                        migrationQueue.kpis.push({
                                            fileName: file.name,
                                            cr714_employeename: data.name,
                                            _cr714_employee_value: empId,
                                            cr714_logdate: data.date,
                                            cr714_kpiname: kpi.metric,
                                            cr714_kpitarget: kpi.target, 
                                            cr714_kpivalue: kpi.value,
                                            cr714_trend: kpi.trend
                                        });
                                    });
                                    logConsole(`  + Extracted ${data.kpiRows.length} KPIs`, 'success');
                                } else {
                                    logConsole(`  ! Warning: No KPIs found.`, 'warn');
                                    parsingStats.noKPIs++;
                                    failedFiles.push({ file: file.name, reason: "No KPIs Found" });
                                }
                            } else {
                                logConsole(`  ! Error: Rep "${data.name}" not in roster`, 'err');
                                parsingStats.noName++;
                                failedFiles.push({ file: file.name, reason: "Rep Not Found in DB" });
                            }

                        } else {
                            logConsole(`  ! Agent Name not found in ${file.name}`, 'err');
                            parsingStats.noName++;
                            failedFiles.push({ file: file.name, reason: "Name Parse Failed" });
                        }
                    }
                } catch(e) {
                    logConsole(`  ! Error: ${e.message}`, 'err');
                }
            }

            btn.innerHTML = originalText;
            printSummary();
            updatePreviewTables();
            
            if(migrationQueue.reviews.length > 0) {
                document.getElementById('btn-upload').disabled = false;
                document.getElementById('btn-upload').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        function printSummary() {
            logConsole("------------------------------------------------");
            logConsole(`MIGRATION SUMMARY:`);
            logConsole(`Total Files: ${selectedFiles.length}`);
            logConsole(`Successfully Parsed: ${parsingStats.processed}`, 'success');
            logConsole(`Skipped (Inactive): ${parsingStats.inactive}`, 'warn');
            logConsole(`Failed (No Name): ${parsingStats.noName}`, 'err');
            logConsole(`Warnings (No KPIs): ${parsingStats.noKPIs}`, 'warn');
            
            if (failedFiles.length > 0) {
                logConsole("--- FAILED / SKIPPED FILES ---");
                failedFiles.forEach(f => logConsole(`[${f.reason}] ${f.file}`, 'warn'));
            }
            logConsole("------------------------------------------------");
        }

        // --- ENHANCED EXTRACTOR LOGIC ---
        function extractDataFromText(text, fileName) {
            // Clean text
            const clean = text.replace(/\r\n/g, '\n').replace(/\t/g, ',').trim();
            const lines = clean.split('\n').map(l => l.trim()).filter(l => l);

            // 1. SMART NAME EXTRACTION
            let agentName = null;

            // Priority A: Inside Document Text
            // Regex for "Agent Name: [Name]" or "Name: [Name]"
            let nameMatch = clean.match(/(Agent Name|Name)[:\s,]*([A-Za-z]+\s+[A-Za-z]+)/i);
            
            if (nameMatch) {
                let candidate = nameMatch[2].trim();
                // Validation: Reject if it looks like a date (contains numbers or slashes)
                if (!/[\d\/]/.test(candidate)) {
                    agentName = candidate;
                }
            }

            // Priority B: Filename Fallback
            if (!agentName) {
                // Filenames often: "EOM_JohnDoe_May2025.docx"
                // Clean common prefixes/suffixes
                let nameFromFn = fileName.split('.')[0]
                                  .replace(/EOM[-_]?/i, '')
                                  .replace(/EOQ[-_]?/i, '')
                                  .replace(/_/g, ' ')
                                  .replace(/\d{4}/g, '') // Remove years
                                  .replace(/(January|February|March|April|May|June|July|August|September|October|November|December)/i, '')
                                  .trim();
                // Take first two words if possible
                let parts = nameFromFn.split(' ').filter(p => p.length > 1);
                if (parts.length >= 2) agentName = `${parts[0]} ${parts[1]}`;
            }

            let dateMatch = clean.match(/Date[:\s,]*(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
            let reviewDate = dateMatch ? dateMatch[1] : new Date().toLocaleDateString();

            // 2. Text Sections
            const getSection = (startMarker, endMarkers) => {
                let start = clean.indexOf(startMarker);
                if(start === -1) return "";
                start += startMarker.length;
                let end = clean.length;
                for(let m of endMarkers) {
                    let idx = clean.indexOf(m, start);
                    if(idx !== -1 && idx < end) end = idx;
                }
                return clean.substring(start, end).replace(/^[:\-\s]+/, '').trim();
            };
            
            const opps = getSection("Opportunities This Month", ["Best Practices", "Action Plan"]);
            const plan = getSection("Action Plan", ["Agent’s Voice", "Statement"]);
            const voice = getSection("Agent’s Voice", ["Statement"]);

            // 3. KPI Extraction (Zone-based)
            const kpiRows = [];
            const metrics = [
                "Total Calls", "Total Sales", "Avg. Talk Time", "Call Notes", 
                "Availability Per Shift", "AUX Accuracy", "Projects/Opps Completed", 
                "Average Break", "Average Lunch"
            ];

            const parseVal = (str) => {
                if(!str) return { v: "--", t: "Flat" };
                let t = "Flat";
                if(str.includes("↑")) t = "Up";
                if(str.includes("↓")) t = "Down";
                const cleanMatch = str.match(/[\$]?[\d,]+(\.\d+)?(:[\d:]+)?%?/);
                let v = cleanMatch ? cleanMatch[0] : str.replace(/[↑↓→]/g, '').trim();
                return { v, t };
            };

            const lastMonthIdx = clean.toUpperCase().indexOf("LAST MONTH");
            const thisMonthIdx = clean.toUpperCase().indexOf("THIS MONTH");
            const endMetricsIdx = clean.toUpperCase().indexOf("OPPORTUNITIES"); 

            if (lastMonthIdx !== -1 && thisMonthIdx !== -1) {
                const targetText = clean.substring(lastMonthIdx, thisMonthIdx);
                const valueText = clean.substring(thisMonthIdx, endMetricsIdx > -1 ? endMetricsIdx : clean.length);

                metrics.forEach(m => {
                    // Smart Regex: Matches metric name, ignores " ≤ 30 Minutes", grabs next value
                    const regex = new RegExp(`${m}.*?([↑↓→]?\\s*[\\$]?\\d[\\d,:.]*%?)`, "i");

                    const valMatch = valueText.match(regex);
                    const targetMatch = targetText.match(regex);

                    if (valMatch) {
                        const { v, t } = parseVal(valMatch[1]);
                        let target = "N/A";
                        if (targetMatch) {
                            const { v: tVal } = parseVal(targetMatch[1]);
                            target = tVal;
                        }
                        kpiRows.push({ metric: m, target: target, value: v, trend: t });
                    }
                });
            } else {
                metrics.forEach(m => {
                    const regex = new RegExp(`${m}.*?([↑↓→]?\\s*[\\$]?\\d[\\d,:.]*%?)`, "i");
                    const match = clean.match(regex);
                    if(match) {
                        const { v, t } = parseVal(match[1]);
                        kpiRows.push({ metric: m, target: "--", value: v, trend: t });
                    }
                });
            }

            return { name: agentName, date: reviewDate, opps, plan, voice, kpiRows };
        }

        // --- UI UPDATES ---
        function updatePreviewTables() {
            safeSetText('count-reviews', migrationQueue.reviews.length);
            safeSetText('count-kpis', migrationQueue.kpis.length);

            document.getElementById('tbody-reviews').innerHTML = migrationQueue.reviews.map((r, i) => `
                <tr class="hover:bg-blue-50">
                    <td class="text-xs text-muted truncate max-w-[100px]">${r.fileName}</td>
                    <td class="font-bold text-primary">${r.cr714_employeename}</td>
                    <td>${r.cr714_reviewdate}</td>
                    <td><span class="badge badge-yellow">${r.cr714_reviewtype}</span></td>
                    <td class="text-xs truncate max-w-[150px]">${r.cr714_opportunities_current}</td>
                    <td class="text-xs truncate max-w-[150px]">${r.cr714_actionplan}</td>
                </tr>
            `).join('');

            document.getElementById('tbody-kpis').innerHTML = migrationQueue.kpis.map((k) => `
                <tr>
                    <td class="font-bold text-sm">${k.cr714_employeename}</td>
                    <td class="text-xs">${k.cr714_logdate}</td>
                    <td class="text-sm">${k.cr714_kpiname}</td>
                    <td class="text-sm text-muted font-mono">${k.cr714_kpitarget}</td>
                    <td class="font-bold text-lg text-primary font-mono">${k.cr714_kpivalue}</td>
                    <td>${getTrendIcon(k.cr714_trend)}</td>
                </tr>
            `).join('');
        }

        function getTrendIcon(trend) {
            if (trend === 'Up') return '<i class="fa-solid fa-arrow-trend-up trend-icon trend-up"></i>';
            if (trend === 'Down') return '<i class="fa-solid fa-arrow-trend-down trend-icon trend-down"></i>';
            return '<i class="fa-solid fa-minus trend-icon trend-flat"></i>';
        }

        function switchTable(type, btn) {
            document.getElementById('table-reviews').classList.add('hidden');
            document.getElementById('table-kpis').classList.add('hidden');
            document.getElementById(`table-${type}`).classList.remove('hidden');
            const tabs = btn.parentElement.querySelectorAll('button');
            tabs.forEach(t => { t.classList.remove('border-b-2', 'border-primary', 'bg-blue-50', 'text-primary'); t.classList.add('text-muted'); });
            btn.classList.add('border-b-2', 'border-primary', 'bg-blue-50', 'text-primary');
            btn.classList.remove('text-muted');
        }

        // --- EXPORT & UPLOAD ---
        window.exportToExcel = function() {
            if(migrationQueue.reviews.length === 0) return alert("No parsed data to export.");
            const wb = XLSX.utils.book_new();
            const wsRev = XLSX.utils.json_to_sheet(migrationQueue.reviews);
            const wsKpi = XLSX.utils.json_to_sheet(migrationQueue.kpis);
            XLSX.utils.book_append_sheet(wb, wsRev, "Reviews");
            XLSX.utils.book_append_sheet(wb, wsKpi, "KPI_Logs");
            XLSX.writeFile(wb, "Performance_Migration_Export.xlsx");
        };

        window.uploadBatches = async function() {
            const BATCH = 20;
            const revs = migrationQueue.reviews;
            const kpis = migrationQueue.kpis;
            const total = Math.ceil(revs.length / BATCH) + Math.ceil(kpis.length / BATCH);
            if(!confirm(`Upload ${revs.length} Reviews and ${kpis.length} KPIs?`)) return;
            logConsole(`> Starting Cloud Upload (${total} batches)...`, 'log-info');
            
            for(let i=0; i<revs.length; i+=BATCH) {
                const chunk = revs.slice(i, i+BATCH);
                try {
                    await fetch(FLOW_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: 'bulk_upload', table: 'reviews', data: chunk }) });
                    logConsole(`  > Reviews Batch OK.`);
                } catch(e) { logConsole(`  ! Error: ${e.message}`, 'log-err'); }
            }
            for(let i=0; i<kpis.length; i+=BATCH) {
                const chunk = kpis.slice(i, i+BATCH);
                try {
                    await fetch(FLOW_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: 'bulk_upload', table: 'kpis', data: chunk }) });
                    logConsole(`  > KPIs Batch OK.`);
                } catch(e) { logConsole(`  ! Error: ${e.message}`, 'log-err'); }
            }
            alert("Upload Complete.");
        };

        // --- HELPER UTILS ---
        function logConsole(msg, type='text-white') { 
            const c = document.getElementById('mig-console'); 
            c.innerHTML += `<div class="${type}">${msg}</div>`; 
            c.scrollTop = c.scrollHeight; 
        }
        const safeSetText = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        const toggleForce = (id, show) => { const el = document.getElementById(id); if(el) show ? el.classList.remove('hidden-force') : el.classList.add('hidden-force'); };
        
        window.forceLoad = () => {
            // LOAD REAL EMPLOYEE DATA FROM PROMPT JSON
            // Paste the full JSON here in production, or fetch from Flow
            const rawData = { "value": [ {"cr714_employeename":"Joshua Williams","cr714_employeeinformation1id":"9c98e6d3-997e-f011-b4cb-000d3a149458","cr714_department@OData.Community.Display.V1.FormattedValue":"Jacksonville","cr714_title@OData.Community.Display.V1.FormattedValue":"Rep","cr714_status@OData.Community.Display.V1.FormattedValue":"Active"}, {"cr714_employeename":"Abigail Landi","cr714_employeeinformation1id":"4e3a4020-1f7d-f011-b4cb-000d3a537e3f","cr714_department@OData.Community.Display.V1.FormattedValue":"New Hire In Training","cr714_title@OData.Community.Display.V1.FormattedValue":"Rep","cr714_status@OData.Community.Display.V1.FormattedValue":"Active"} ] };
            store.employees = rawData.value.map(e => ({ id: e.cr714_employeeinformation1id, name: e.cr714_employeename, title: e['cr714_title@OData.Community.Display.V1.FormattedValue'], dept: e['cr714_department@OData.Community.Display.V1.FormattedValue'], status: e['cr714_status@OData.Community.Display.V1.FormattedValue'] }));
            
            document.getElementById('emp-table').querySelector('tbody').innerHTML = store.employees.map(e => `
                <tr onclick="router.openEmployee('${e.id}')"><td class="font-bold text-primary">${e.name}</td><td>${e.title}</td><td>${e.dept}</td><td>--</td><td><span class="badge badge-green">${e.status}</span></td></tr>
            `).join('');
            
            toggleForce('loading-overlay', false);
            toggleForce('sidebar-container', true);
            toggleForce('main-content', true);
        };

        const router = {
            navigate: (id) => {
                document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
                document.getElementById(`view-${id}`).classList.add('active');
            },
            openEmployee: (id) => {
                const emp = store.employees.find(e => e.id === id);
                document.getElementById('profile-name').textContent = emp.name;
                
                const userKPIs = migrationQueue.kpis.filter(k => k.cr714_employeename === emp.name);
                document.querySelector('#profile-kpi-table tbody').innerHTML = userKPIs.map(k => `
                    <tr><td>${k.cr714_logdate}</td><td>${k.cr714_kpiname}</td><td>${k.cr714_kpitarget}</td><td class="font-bold text-primary">${k.cr714_kpivalue}</td><td>${getTrendIcon(k.cr714_trend)}</td></tr>
                `).join('');

                router.navigate('employee-detail');
            }
        };

        window.toggleTheme = () => {
            const current = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', current === 'winter' ? 'midnight' : 'winter');
        };

        document.addEventListener('DOMContentLoaded', window.forceLoad);

    </script>
</body>
</html>
