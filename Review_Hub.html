<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4.3 Rep Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        :root {
            --bg-app: #f1f5f9; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --primary: #4f46e5; --primary-fg: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            
            /* ROLE COLORS */
            --color-srmgr: #2563eb; /* Blue */
            --color-mgr: #d97706;   /* Amber/Yellow (Readable) */
            --color-sup: #16a34a;   /* Green */
            --color-gold: #ca8a04;  /* Gold */
        }
        
        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; }
        
        .bg-app { background-color: var(--bg-app); } .bg-card { background-color: var(--bg-card); } .bg-input { background-color: var(--bg-input); }
        .text-main { color: var(--text-main); } .text-muted { color: var(--text-muted); } .border-color { border-color: var(--border-color); }
        .shadow-theme { box-shadow: var(--shadow); }
        .bg-primary { background-color: var(--primary); color: var(--primary-fg); }
        .sidebar-header { background-color: var(--primary); color: var(--primary-fg); }
        .hierarchy-item:hover { background-color: var(--border-color); }
        .hierarchy-item.active { background-color: var(--border-color); border-left: 4px solid var(--primary); }
        
        /* Dynamic Text Colors */
        .text-srmgr { color: var(--color-srmgr) !important; font-weight: 700; }
        .text-mgr { color: var(--color-mgr) !important; font-weight: 600; }
        .text-sup { color: var(--color-sup) !important; font-weight: 600; }
        .text-gold { color: var(--color-gold) !important; font-weight: 700; }

        .page { display: none; } #page-review.active, #page-create.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        
        /* Overlays */
        #loading-overlay, #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; transition: opacity 0.3s; }
        #loading-overlay { background: rgba(255,255,255,0.95); color: var(--text-main); font-weight: bold; display: flex; flex-direction: column; justify-content: center; align-items: center;}
        #auth-container { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .hidden-force { display: none !important; }
        
        .auth-box { background: var(--bg-card); padding: 3rem; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); max-width: 400px; width: 90%; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* PRINT STYLES - Export Only Content */
        @media print {
            body { background: white; height: auto; overflow: visible; }
            #sidebar-container, header, .no-print { display: none !important; }
            #main-app { display: block !important; width: 100% !important; height: auto !important; overflow: visible !important; }
            main { overflow: visible !important; padding: 0 !important; }
            .bg-card { box-shadow: none !important; border: 1px solid #ddd !important; break-inside: avoid; }
            /* Hide slider controls on print, show just date text */
            .print-hide { display: none !important; } 
        }
    </style>
</head>
<body class="bg-app antialiased h-screen flex overflow-hidden">

    <div id="auth-container" class="hidden">
        <div class="auth-box">
            <div class="mb-4 text-4xl">üìä</div>
            <h2 class="text-2xl font-bold mb-2 text-main">Performance Hub</h2>
            <p class="mb-6 text-muted text-sm">Sign in to access Dataverse.</p>
            <button onclick="window.signIn()" class="bg-primary text-primary-fg px-6 py-3 rounded-lg font-bold hover:opacity-90 w-full transition-all shadow-theme">
                Sign In with Microsoft
            </button>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" class="animate-pulse">Initializing App...</div>
    </div>

    <div id="main-app" class="flex w-full h-full hidden">
        <div id="sidebar-container" class="w-1/4 min-w-[300px] bg-card border-r border-color flex flex-col shadow-theme z-10">
            <div class="p-4 border-b border-color sidebar-header">
                <h1 class="text-xl font-bold">Performance Hub</h1>
                <p class="text-xs opacity-80">Dataverse Connected</p>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div class="border-b border-color">
                    <button onclick="window.toggleSection('dept')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between items-center hover:bg-gray-100">
                        <span>Department <span id="count-dept" class="ml-1 text-[10px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded-full">0</span></span>
                        <span id="chev-dept">‚ñº</span>
                    </button>
                    <div id="list-dept" class="p-2 space-y-1 hidden"></div>
                </div>
                <div class="border-b border-color">
                    <button onclick="window.toggleSection('mgr')" class="w-full text-left p-3 bg-input font-semibold text-xs text-mgr uppercase flex justify-between items-center hover:bg-gray-100">
                        <span>Manager Group <span id="count-mgr" class="ml-1 text-[10px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded-full">0</span></span>
                        <span id="chev-mgr">‚ñº</span>
                    </button>
                    <div id="list-mgr" class="p-2 space-y-1 hidden"></div>
                </div>
                <div class="border-b border-color">
                    <button onclick="window.toggleSection('sup')" class="w-full text-left p-3 bg-input font-semibold text-xs text-sup uppercase flex justify-between items-center hover:bg-gray-100">
                        <span>Supervisor Group <span id="count-sup" class="ml-1 text-[10px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded-full">0</span></span>
                        <span id="chev-sup">‚ñº</span>
                    </button>
                    <div id="list-sup" class="p-2 space-y-1 hidden"></div>
                </div>
                <div class="flex-1">
                    <button onclick="window.toggleSection('rep')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between items-center hover:bg-gray-100">
                        <span>Representatives <span id="count-rep" class="ml-1 text-[10px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded-full">0</span></span>
                        <span id="chev-rep">‚ñ≤</span>
                    </button>
                    <div id="list-rep" class="p-2 space-y-1 hidden"></div>
                </div>
            </div>
            <div class="p-4 border-t border-color bg-input">
                <button onclick="window.triggerFlowSync()" class="w-full bg-card border border-color text-main py-2 rounded shadow-theme hover:bg-input text-sm font-medium flex justify-center items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Sync Data
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden relative">
            <header class="bg-card border-b border-color p-4 flex justify-between items-center shadow-theme">
                <div>
                    <h2 id="view-title" class="text-2xl font-bold text-main">Dashboard</h2>
                    <p id="view-subtitle" class="text-sm text-muted">Select an employee</p>
                </div>
                <div class="flex gap-4 items-center">
                    <div id="clock" class="text-sm font-mono text-muted hidden md:block bg-input px-3 py-1 rounded no-print">--:--</div>
                    
                    <div class="flex items-center gap-2 no-print">
                        <span id="user-display" class="text-xs font-bold text-primary hidden md:inline border-r pr-2 mr-2 border-color"></span>
                        <select id="theme-select" onchange="window.applyTheme(this.value)" class="p-2 text-sm border border-color rounded bg-input text-main shadow-theme">
                            <option value="winter">Winter</option><option value="midnight">Midnight</option><option value="oled">OLED</option>
                        </select>
                    </div>
                    <button onclick="window.openCreateReviewModal()" id="btn-new-review" class="bg-primary text-primary-fg px-4 py-2 rounded shadow-theme text-sm font-medium hidden no-print hover:opacity-90 transition-opacity">New Review</button>
                    <button onclick="window.openExportModal()" class="bg-primary text-primary-fg px-4 py-2 rounded shadow-theme text-sm font-medium no-print hover:opacity-90 transition-opacity">Export</button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6 bg-app">
                <div id="page-review" class="page max-w-6xl mx-auto space-y-6">
                    <div class="flex justify-between items-end bg-card p-4 rounded-xl shadow-theme print:border-0 print:shadow-none">
                        <div class="w-full max-w-md space-y-2">
                            <div class="flex justify-between"><label class="text-xs font-bold text-muted uppercase">Period Ending</label><span id="current-review-date-display" class="text-sm font-bold text-main">--</span></div>
                            <input type="range" id="review-date-slider" class="w-full h-2 bg-input rounded-lg cursor-pointer print-hide" min="0" max="0" value="0" oninput="window.updateDashboardFromSlider()">
                            <div class="flex gap-2 items-center print-hide"><label class="text-xs font-bold text-muted uppercase">Compare:</label><select id="duration-select" onchange="window.updateDashboardFromSlider()" class="p-1 text-xs border border-color rounded bg-input text-main"><option value="1">Monthly</option><option value="3">Quarterly</option><option value="6">6 Months</option><option value="12">Annual</option></select></div>
                        </div>
                        <div class="text-right"><div class="text-sm text-muted">Reports to</div><div id="manager-name" class="font-medium text-main">--</div></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-card rounded-xl shadow-theme p-5 border border-color">
                            <h3 class="text-lg font-bold text-main mb-4">Performance Metrics</h3>
                            <div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-input text-xs uppercase text-muted"><tr><th class="px-4 py-2 text-left">KPI</th><th class="px-4 py-2 text-right">Target</th><th class="px-4 py-2 text-right">Actual</th><th class="px-4 py-2 text-center">Trend</th></tr></thead><tbody id="kpi-table-body" class="divide-y divide-border-color text-sm text-main"><tr><td colspan="4" class="text-center py-8 text-muted">Select a rep to view data.</td></tr></tbody></table></div>
                        </div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border border-color flex flex-col">
                            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-main">Trend</h3><select id="chart-kpi-select" onchange="window.updateChart()" class="text-xs border border-color rounded bg-card text-main print-hide"></select></div>
                            <div class="flex-1 relative w-full h-64"><canvas id="trendChart"></canvas></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--primary);"><h4 class="font-bold text-main mb-2">üéØ Opportunities (Current)</h4><ul id="text-opps-this" class="text-sm text-main list-disc list-inside"></ul></div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--text-muted);"><h4 class="font-bold text-main mb-2">üîô Opportunities (Previous)</h4><ul id="text-opps-last" class="text-sm text-main list-disc list-inside"></ul></div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--color-sup);"><h4 class="font-bold text-main mb-2">‚ú® Best Practices</h4><ul id="text-best-practices" class="text-sm text-main list-disc list-inside"></ul></div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--accent-warning);"><h4 class="font-bold text-main mb-2">üöÄ Action Plan</h4><ul id="text-action-plan" class="text-sm text-main list-disc list-inside"></ul></div>
                    </div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border border-color"><h4 class="font-bold text-main mb-2">üó£Ô∏è Agent's Voice</h4><p id="text-agent-voice" class="text-sm text-muted italic bg-input p-3 rounded"></p></div>
                </div>

                <div id="page-create" class="page max-w-4xl mx-auto space-y-6">
                    <h3 class="text-2xl font-bold text-main border-b border-color pb-2">New Review: <span id="new-review-rep-name"></span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-card rounded-xl shadow-theme p-5 border border-color space-y-4">
                            <h4 class="font-bold text-main mb-2">Review Details</h4>
                            <div><label class="text-sm font-medium text-main">Date</label><input type="date" id="form-date" class="w-full border border-color rounded p-2 bg-input text-main"></div>
                            <div><label class="text-sm font-medium text-main">Type</label><select id="form-type" class="w-full border border-color rounded p-2 bg-input text-main"><option>EOM</option><option>EOQ</option><option>Annual</option><option>30-Day</option><option>90-Day</option></select></div>
                             <div><label class="text-sm font-medium text-main">Reviewer Level</label><select id="form-level" class="w-full border border-color rounded p-2 bg-input text-main"><option>Manager</option><option>Supervisor</option><option>Director</option></select></div>
                        </div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border border-color"><h4 class="font-bold text-main mb-2">KPIs</h4><div id="form-kpi-inputs" class="space-y-2"></div></div>
                    </div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border border-color space-y-4">
                        <h4 class="font-bold text-main mb-2">Qualitative Feedback</h4>
                        <div><label class="text-sm font-medium text-main">Opportunities</label><textarea id="form-opps-this" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                        <div><label class="text-sm font-medium text-main">Action Plan</label><textarea id="form-action-plan" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                        <div><label class="text-sm font-medium text-main">Special Notes</label><textarea id="form-special-notes" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                        <div class="flex gap-4 mt-4"><button onclick="window.saveNewReview()" class="flex-1 bg-primary text-primary-fg py-2 rounded shadow-theme">Save</button><button onclick="window.loadRepDashboard(currentRepId)" class="flex-1 bg-input text-main py-2 rounded">Cancel</button></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const msalConfig = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: window.location.href }, cache: { cacheLocation: "localStorage" } };
        const GET_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg"; 
        const SAVE_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/088be03ff3724bb4ac49e37532d96136/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=1vZTb9PuSi5SC6Q3_af9YNiuLxLDYcBPqCfOVDFFftA";

        let msalInstance = null, username = "";
        let rawEmployees = [], dbReviews = [], dbLogs = [], reviewDateRange = [];
        let currentRepId = null, currentFilter = { type: 'All', value: null };
        let chartInstance = null;

        const kpiConfigs = {"Sales":[{id:"outbound",label:"Outbound Calls",target:50},{id:"invoices",label:"Invoices",target:10}],"Quotes":[{id:"projects",label:"Quotes",target:50}],"Food Service":[{id:"orders",label:"Orders",target:30}],"Retail":[{id:"sales",label:"Sales",target:5}]};

        // --- AUTH ---
        window.initAuth = async function() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                const response = await msalInstance.handleRedirectPromise();
                if (response?.account) window.handleLoginSuccess(response.account);
                else {
                    const accs = msalInstance.getAllAccounts();
                    if (accs.length > 0) window.handleLoginSuccess(accs[0]);
                    else { document.getElementById('loading-overlay').classList.add('hidden-force'); document.getElementById('auth-container').classList.remove('hidden'); }
                }
            } catch(e) { console.error(e); }
        };

        window.signIn = function() {
            msalInstance.loginPopup({ scopes: ["User.Read"] }).then(resp => { if(resp?.account) window.handleLoginSuccess(resp.account); }).catch(console.error);
        };

        window.handleLoginSuccess = function(account) {
            username = account.username;
            document.getElementById('user-display').textContent = account.name;
            document.getElementById('auth-container').classList.add('hidden-force');
            document.getElementById('loading-overlay').classList.remove('hidden-force');
            window.initData();
        };

        // --- DATA ---
        window.callFlow = async function(url, body) {
            const options = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) };
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(res.statusText);
            const text = await res.text();
            return text ? JSON.parse(text) : {};
        };

        window.initData = async function() {
            window.loadTheme(); window.startClock();
            try {
                const rawData = await window.callFlow(GET_DATA_FLOW_URL, { userEmail: username });
                
                let root = rawData.body || rawData;
                let employeesList = root.employees || [];
                if (employeesList.value) employeesList = employeesList.value;
                else if (Array.isArray(employeesList) && employeesList[0]?.value) employeesList = employeesList[0].value;

                // Smart Mapping logic to infer roles if jobtitle is missing/null
                rawEmployees = employeesList.map(e => {
                    let role = e['cr714_jobtitle@OData.Community.Display.V1.FormattedValue'] || e.cr714_jobtitle || 'Rep';
                    const name = e.cr714_employeename;
                    
                    // Fallback Role Logic if data missing
                    // If this person is listed as someone's manager, upgrade them
                    // (Note: This requires two passes, doing simple map first)
                    return {
                        id: name, name: name, role: role,
                        dept: e['cr714_department@OData.Community.Display.V1.FormattedValue'] || e.cr714_department || 'N/A',
                        managerId: e['_cr714_managerassigned_value@OData.Community.Display.V1.FormattedValue'] || e.cr714_managerassigned,
                        supervisorId: e['_cr714_supervisors_value@OData.Community.Display.V1.FormattedValue'] || e.cr714_supervisors,
                        isGoldStar: e.cr714_goldstars === 'Y' || e.cr714_goldstars === true
                    };
                });

                // 2nd Pass: Ensure Managers/Supervisors are identified even if JobTitle is null
                const managerNames = new Set(rawEmployees.map(e=>e.managerId).filter(n=>n));
                const supervisorNames = new Set(rawEmployees.map(e=>e.supervisorId).filter(n=>n));
                
                rawEmployees.forEach(e => {
                    if (e.role === 'Rep') {
                        if (supervisorNames.has(e.name)) e.role = 'Supervisor';
                        if (managerNames.has(e.name)) e.role = 'Manager';
                    }
                });

                dbReviews = root.reviews || [];
                dbLogs = root.logs || [];
                if (dbLogs.length > 0) reviewDateRange = [...new Set(dbLogs.map(l => l.date))].sort();
                else reviewDateRange = ["2024-11", "2024-12", "2025-01"];

                document.getElementById('loading-overlay').classList.add('hidden-force');
                document.getElementById('main-app').classList.remove('hidden');
                window.renderSidebar();

            } catch (e) { document.getElementById('loading-overlay').innerHTML = `<div class="text-red-500 font-bold">Error: ${e.message}</div>`; }
        };

        // --- UI ---
        window.toggleSection = function(id) {
            const el = document.getElementById('list-'+id);
            if(el) { el.classList.toggle('hidden'); document.getElementById('chev-'+id).textContent = el.classList.contains('hidden')?'‚ñº':'‚ñ≤'; window.filterReps('All',null); }
        };

        window.filterReps = function(type, val, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            const repList = document.getElementById('list-rep');
            if(repList.classList.contains('hidden')) window.toggleSection('rep');

            document.querySelectorAll('#list-rep .hierarchy-item').forEach(rBtn => {
                const rep = rawEmployees.find(e => e.id === rBtn.dataset.id);
                if(!rep) return;
                let show = false;
                if(type==='Department') show = rep.dept === val;
                else if(type==='Manager') show = rep.managerId === val;
                else if(type==='Supervisor') {
                    const mgrs = rawEmployees.filter(m => m.supervisorId === val).map(m => m.id);
                    show = (rep.supervisorId === val) || (mgrs.includes(rep.managerId));
                } else if(type==='GoldStar') show = rep.isGoldStar;
                else show = true;
                
                // Manager/Sup List Filtering
                if(type==='Department') {
                    const mgrBtns = document.getElementById('list-mgr').querySelectorAll('button');
                    mgrBtns.forEach(b => { 
                         const m = rawEmployees.find(e=>e.name===b.innerText);
                         b.style.display = (m && m.dept === val) ? 'block' : 'none';
                    });
                    document.getElementById('list-mgr').classList.remove('hidden');
                }
                
                rBtn.style.display = show ? 'flex' : 'none';
            });
            
            const t = document.getElementById('view-title'); t.textContent = type === 'All' ? 'Dashboard' : val;
            const s = document.getElementById('view-subtitle'); 
            if(type==='Department') {
                 const sr = rawEmployees.find(e=>(e.role.includes('Director') || e.role.includes('SR Manager')) && e.dept === val);
                 s.textContent = sr ? `Lead: ${sr.name}` : `Filter: ${val}`;
            } else {
                 s.textContent = type;
            }

            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('btn-new-review').style.display = 'none';
        };

        window.renderSidebar = function() {
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(d => d && d !== 'N/A').sort();
            document.getElementById('list-dept').innerHTML = depts.map(d => `<button onclick="window.filterReps('Department', '${d}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span>${d}</span></button>`).join('');
            document.getElementById('count-dept').textContent = depts.length;

            const mgrs = rawEmployees.filter(e => e.role.includes('Manager')).sort((a,b)=>a.name.localeCompare(b.name));
            document.getElementById('list-mgr').innerHTML = mgrs.map(m => `<button onclick="window.filterReps('Manager', '${m.name}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded text-mgr">${m.name}</button>`).join('');
            document.getElementById('count-mgr').textContent = mgrs.length;

            const sups = rawEmployees.filter(e => e.role.includes('Supervisor')).sort((a,b)=>a.name.localeCompare(b.name));
            document.getElementById('list-sup').innerHTML = sups.map(s => `<button onclick="window.filterReps('Supervisor', '${s.name}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded text-sup">${s.name}</button>`).join('');
            document.getElementById('count-sup').textContent = sups.length;

            // Reps + Gold Stars Merged
            document.getElementById('list-rep').innerHTML = rawEmployees.sort((a,b)=>a.name.localeCompare(b.name)).map(r => 
                `<button data-id="${r.id}" onclick="window.selectRep('${r.id}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between">
                    <span class="${r.isGoldStar ? 'text-gold' : ''}">${r.name}</span>
                    ${r.isGoldStar ? '‚≠ê' : ''}
                 </button>`
            ).join('');
            document.getElementById('count-rep').textContent = rawEmployees.length;
            document.getElementById('count-gold').textContent = rawEmployees.filter(e=>e.isGoldStar).length;
        };
        
        window.selectRep = function(id, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            document.getElementById('view-title').textContent = emp.name;
            document.getElementById('view-subtitle').textContent = `${emp.role} ‚Ä¢ ${emp.dept}`;
            document.getElementById('manager-name').textContent = emp.managerId || 'Unassigned';
            
            document.getElementById('page-review').classList.add('active');
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('btn-new-review').style.display = 'flex';
            
            const s = document.getElementById('review-date-slider');
            s.max = Math.max(0, reviewDateRange.length - 1);
            s.value = s.max;
            window.updateDashboardFromSlider();
        };

        window.updateDashboardFromSlider = function() {
            if (!currentRepId || !reviewDateRange.length) return;
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const end = reviewDateRange[idx];
            document.getElementById('current-review-date-display').textContent = end;
            
            const logs = dbLogs.filter(l => l.repId === currentRepId && l.date === end);
            const kpis = kpiConfigs[rawEmployees.find(e=>e.id===currentRepId).dept] || kpiConfigs["Sales"];
            
            document.getElementById('kpi-table-body').innerHTML = kpis.map(k => {
                const l = logs.find(x=>x.kpiId === k.id);
                return `<tr><td class="px-4 py-2">${k.label}</td><td class="px-4 py-2 text-right">${k.target}</td><td class="px-4 py-2 text-right font-bold">${l ? Math.floor(l.value) : '-'}</td><td class="px-4 py-2 text-center">-</td></tr>`;
            }).join('');
            
            const rev = dbReviews.find(r => r.repId === currentRepId && r.date === end);
            if(rev) {
                 const f = (id, txt) => document.getElementById(id).innerHTML = txt ? txt.split('\n').map(i=>`<li>${i}</li>`).join('') : '';
                 f('text-opps-this', rev.oppsThis); f('text-opps-last', rev.oppsLast);
                 f('text-best-practices', rev.bestPractices); f('text-action-plan', rev.actionPlan);
                 document.getElementById('text-agent-voice').textContent = rev.agentVoice || '';
            } else {
                 ['text-opps-this','text-opps-last','text-best-practices','text-action-plan'].forEach(id => document.getElementById(id).innerHTML='');
                 document.getElementById('text-agent-voice').textContent = 'No review data.';
            }
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] } }); 
        };

        window.applyTheme = function(t) { if(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('selectedTheme', t); } };
        window.loadTheme = function() { const t = localStorage.getItem('selectedTheme') || 'winter'; window.applyTheme(t); const el = document.getElementById('theme-select'); if(el) el.value = t; };
        window.startClock = function() { setInterval(() => { const el = document.getElementById('clock'); if(el) el.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', month:'short', day:'numeric'}); }, 1000); };

        window.openCreateReviewModal = function() {
            if(!currentRepId) return alert("Select Rep first");
            const e = rawEmployees.find(x=>x.id===currentRepId);
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.add('active');
            document.getElementById('btn-new-review').style.display='none';
            document.getElementById('new-review-rep-name').textContent=e.name;
            document.getElementById('form-date').valueAsDate=new Date();
            const kpis = kpiConfigs[e.dept] || kpiConfigs["Sales"];
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => `<div><label class="text-sm font-bold text-main">${k.label}</label><input id="kpi-${k.id}" type="number" class="w-full border p-2 rounded bg-input text-main"></div>`).join('');
        };

        window.saveNewReview = async function() {
            try {
                const payload = {
                    repId: currentRepId, date: document.getElementById('form-date').value,
                    type: document.getElementById('form-type').value,
                    oppsThis: document.getElementById('form-opps-this').value,
                    actionPlan: document.getElementById('form-action-plan').value,
                    specialNotes: document.getElementById('form-special-notes').value
                };
                await window.callFlow(SAVE_DATA_FLOW_URL, payload);
                alert("Saved!");
                window.initData(); 
            } catch(e) { alert("Save Failed: " + e.message); }
        };
        
        window.openExportModal = function() { window.print(); };
        window.triggerFlowSync = function() { alert("Syncing..."); window.callFlow(GET_DATA_FLOW_URL, {}).then(()=>alert("Done")); };

        document.addEventListener('DOMContentLoaded', () => { window.initAuth(); });
    </script>
</body>
</html>
