<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Hub Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            darkMode: ['class', '[data-theme="midnight"]'],
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: 'var(--color-primary)',
                        bg: 'var(--color-bg)',
                        card: 'var(--color-card)',
                        text: 'var(--color-text)',
                        muted: 'var(--color-muted)',
                        border: 'var(--color-border)'
                    }
                }
            }
        }
    </script>

    <style>
        /* --- THEMING VARIABLES --- */
        :root { --color-primary: #002f6c; --color-bg: #f4f7f6; --color-card: #ffffff; --color-text: #2c3e50; --color-muted: #7f8c8d; --color-border: #e2e8f0; --secondary: #d42e12; }
        [data-theme="midnight"] { --color-primary: #60a5fa; --color-bg: #0f172a; --color-card: #1e293b; --color-text: #f1f5f9; --color-muted: #94a3b8; --color-border: #334155; --secondary: #f87171; }
        [data-theme="oled"] { --color-primary: #facc15; --color-bg: #000000; --color-card: #121212; --color-text: #ffffff; --color-muted: #a1a1aa; --color-border: #27272a; --secondary: #fca5a5; }
        
        body { background-color: var(--color-bg); color: var(--color-text); transition: background-color 0.3s, color 0.3s; }
        
        /* --- UTILITIES --- */
        .glass-panel { background: var(--color-card); border: 1px solid var(--color-border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hidden-force { display: none !important; }
        .animate-enter { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- COMPONENT STYLES --- */
        .view { display: none; }
        .view.active { display: block; animation: slideIn 0.3s ease-in-out; }

        .nav-item { cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(0,0,0,0.05); border-left-color: var(--secondary); color: var(--color-primary); }
        [data-theme="midnight"] .nav-item:hover, [data-theme="oled"] .nav-item:hover { background: rgba(255,255,255,0.1); }

        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { text-align: left; padding: 12px 16px; background: var(--color-bg); color: var(--color-muted); font-weight: 600; border-bottom: 2px solid var(--color-border); }
        td { padding: 12px 16px; border-bottom: 1px solid var(--color-border); }
        tr:hover td { background: rgba(0,0,0,0.02); cursor: pointer; }

        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-review { background: #fef9c3; color: #854d0e; }

        .tabs { display: flex; gap: 20px; border-bottom: 2px solid var(--color-border); margin-bottom: 20px; }
        .tab { padding: 10px 0; cursor: pointer; color: var(--color-muted); font-weight: 500; position: relative; }
        .tab.active { color: var(--color-primary); }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: var(--color-primary); }

        /* Form Inputs */
        input, select, textarea { background-color: var(--color-card); color: var(--color-text); border-color: var(--color-border); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); ring: 2px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="auth-container" class="hidden-force fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full animate-enter">
            <div class="mb-6"><div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto text-3xl shadow-lg"><i class="fa-solid fa-chart-simple"></i></div></div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Performance Hub</h1>
            <p class="text-slate-500 mb-8">Secure Access Portal</p>
            <button onclick="window.signIn()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition-all shadow-lg flex items-center justify-center gap-3">
                <i class="fa-brands fa-microsoft"></i> Sign in with Microsoft
            </button>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[9998] bg-white flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700" id="loading-text">Loading System...</h2>
        <button onclick="window.forceLoad()" id="force-load-btn" class="mt-8 text-xs text-red-400 hover:text-red-600 underline hidden">Force Load Dashboard</button>
    </div>

    <aside id="sidebar-container" class="w-64 bg-card border-r border-border flex flex-col z-20 shadow-xl transition-all duration-300 hidden-force">
        <div class="p-6 border-b border-border flex items-center gap-3">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold shadow">P</div>
            <h1 class="font-bold text-lg tracking-tight text-text">Performance<span class="text-primary">Hub</span></h1>
        </div>
        
        <div class="p-4">
            <div class="relative">
                <i class="fa-solid fa-search absolute left-3 top-3 text-muted text-xs"></i>
                <input type="text" id="search-input" onkeyup="window.handleSearch()" placeholder="Search employees..." class="w-full pl-9 pr-3 py-2 bg-bg border border-border rounded-md text-sm focus:ring-1 focus:ring-primary">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-2 space-y-1" id="nav-content">
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3 active" onclick="router.navigate('employees')">
                <i class="fa-solid fa-users w-5 text-center"></i> All Employees
            </div>
            <div class="nav-item p-3 rounded-md text-sm font-medium flex items-center gap-3" onclick="router.navigate('reviews-list')">
                <i class="fa-solid fa-clipboard-check w-5 text-center"></i> Review Log
            </div>
            <div id="dept-groups" class="mt-4 pt-4 border-t border-border"></div>
        </div>

        <div class="p-4 border-t border-border">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-primary/10 text-primary rounded-full flex items-center justify-center"><i class="fa-solid fa-user"></i></div>
                <div class="overflow-hidden">
                    <div id="user-name" class="text-sm font-bold text-text truncate">User</div>
                    <div class="text-[10px] text-muted truncate">Connected</div>
                </div>
            </div>
        </div>
    </aside>

    <div id="main-content" class="flex-1 flex flex-col h-full overflow-hidden relative hidden-force">
        
        <header class="h-16 bg-card border-b border-border flex items-center justify-between px-6 shadow-sm z-10">
            <div>
                <h2 id="page-title" class="text-xl font-bold text-text">Team Dashboard</h2>
                <div id="breadcrumbs" class="text-xs text-muted flex items-center gap-2">Home</div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col items-end border-r border-border pr-4 mr-1">
                    <span id="clock-time" class="text-sm font-mono font-bold text-text">--:--</span>
                    <span id="clock-date" class="text-[10px] text-muted uppercase">--</span>
                </div>

                <div class="relative group">
                    <button class="p-2 text-muted hover:text-primary transition-colors"><i class="fa-solid fa-palette"></i></button>
                    <div class="absolute right-0 mt-2 w-32 bg-card border border-border rounded-lg shadow-xl hidden group-hover:block p-1 z-50">
                        <button onclick="window.setTheme('winter')" class="w-full text-left px-3 py-2 text-xs rounded hover:bg-bg text-text">Light</button>
                        <button onclick="window.setTheme('midnight')" class="w-full text-left px-3 py-2 text-xs rounded hover:bg-bg text-text">Dark</button>
                        <button onclick="window.setTheme('oled')" class="w-full text-left px-3 py-2 text-xs rounded hover:bg-bg text-text">OLED</button>
                    </div>
                </div>

                <input type="file" id="file-upload" webkitdirectory multiple class="hidden" onchange="window.handleFileUpload(this)">
                <button onclick="document.getElementById('file-upload').click()" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow transition-all flex items-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up"></i> <span class="hidden sm:inline">Import Docs</span>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6">
            
            <div id="view-employees" class="view active max-w-7xl mx-auto">
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-4 border-b border-border bg-bg/50 flex justify-between items-center">
                        <h3 class="font-bold text-text">Employee Roster</h3>
                        <div class="text-xs text-muted" id="roster-count">0 Records</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="emp-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Title</th>
                                    <th>Department</th>
                                    <th>Manager</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-employee-detail" class="view max-w-6xl mx-auto">
                <div class="mb-6 flex items-center justify-between">
                    <button onclick="router.navigate('employees')" class="text-sm font-medium text-muted hover:text-primary flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> Back to Dashboard</button>
                    <button onclick="openEditEmployee()" class="bg-card border border-border hover:bg-bg text-text text-sm font-bold py-2 px-4 rounded-lg shadow-sm">Edit Profile</button>
                </div>

                <div class="glass-panel p-8 rounded-xl mb-6 flex flex-col md:flex-row justify-between items-start gap-6">
                    <div>
                        <h1 id="detail-name" class="text-3xl font-bold text-primary mb-2">Employee Name</h1>
                        <div class="flex flex-wrap gap-4 text-sm text-text">
                            <span class="bg-bg px-3 py-1 rounded border border-border"><i class="fa-solid fa-briefcase text-muted mr-2"></i><span id="detail-title">Title</span></span>
                            <span class="bg-bg px-3 py-1 rounded border border-border"><i class="fa-solid fa-building text-muted mr-2"></i><span id="detail-dept">Dept</span></span>
                            <span class="bg-bg px-3 py-1 rounded border border-border"><i class="fa-solid fa-user-tie text-muted mr-2"></i><span id="detail-manager">Manager</span></span>
                        </div>
                        <div class="mt-4 text-sm text-muted">
                            <p><i class="fa-solid fa-envelope mr-2 w-5"></i> <span id="detail-email">email@example.com</span></p>
                            <p><i class="fa-solid fa-phone mr-2 w-5"></i> <span id="detail-phone">--</span></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold text-emerald-600 mb-1" id="detail-score">--</div>
                        <div class="text-xs uppercase tracking-wide text-muted">Latest Perf. Score</div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('reviews')">Performance Reviews</div>
                    <div class="tab" onclick="switchTab('kpis')">KPI History</div>
                    <div class="tab" onclick="switchTab('notes')">Notes & Docs</div>
                </div>

                <div id="tab-reviews" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Review History</h3>
                        <button onclick="router.openReview('new')" class="bg-primary hover:opacity-90 text-white text-sm font-bold py-2 px-4 rounded-lg shadow"><i class="fa-solid fa-plus"></i> Create Review</button>
                    </div>
                    <div class="glass-panel rounded-xl overflow-hidden">
                        <table id="detail-reviews-table">
                            <thead><tr><th>Date</th><th>Type</th><th>Opps Found</th><th>Action Plan</th><th>Status</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-kpis" class="tab-content hidden">
                    <div class="glass-panel rounded-xl p-6">
                        <canvas id="kpiChart" height="100"></canvas>
                        <div class="mt-6 overflow-x-auto">
                            <table id="detail-kpis-table">
                                <thead><tr><th>Log Date</th><th>Metric</th><th>Target</th><th>Value</th><th>Result</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-review-editor" class="view max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4">
                        <button onclick="router.backToProfile()" class="h-10 w-10 bg-card border border-border rounded-full flex items-center justify-center hover:bg-bg transition-all"><i class="fa-solid fa-arrow-left"></i></button>
                        <div>
                            <h2 class="text-2xl font-bold text-text">Performance Review</h2>
                            <p class="text-sm text-muted">For <span id="editor-emp-name" class="font-semibold text-primary">--</span></p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <span id="editor-status" class="px-3 py-2 rounded bg-yellow-100 text-yellow-800 text-xs font-bold uppercase self-center">Draft</span>
                        <button onclick="saveReview()" class="bg-primary text-white font-bold py-2 px-6 rounded-lg shadow hover:opacity-90 flex items-center gap-2"><i class="fa-solid fa-save"></i> Save</button>
                    </div>
                </div>

                <div class="glass-panel p-8 rounded-xl space-y-8">
                    <input type="hidden" id="review-id">
                    <input type="hidden" id="review-emp-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-text mb-2">Review Date</label>
                            <input type="date" id="review-date" class="w-full p-3 border border-border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-text mb-2">Review Type</label>
                            <select id="review-type" class="w-full p-3 border border-border rounded-lg">
                                <option value="End of Month">End of Month Performance Review</option>
                                <option value="30 Day">30 Day Review</option>
                                <option value="90 Day">90 Day Review</option>
                                <option value="Annual">Annual Review</option>
                                <option value="Ad-hoc">Ad-hoc / Correction</option>
                            </select>
                        </div>
                    </div>

                    <div class="h-px bg-border"></div>

                    <div>
                        <h4 class="text-primary font-bold uppercase text-xs tracking-wider mb-4"><i class="fa-solid fa-chart-pie mr-2"></i> Performance Data</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-bg p-4 rounded-lg border border-border">
                                <label class="block text-xs text-muted mb-1">Opps (Last)</label>
                                <input type="number" id="review-opps-last" class="w-full bg-transparent font-bold text-lg p-0 border-none focus:ring-0" placeholder="0">
                            </div>
                            <div class="bg-bg p-4 rounded-lg border border-border">
                                <label class="block text-xs text-muted mb-1">Opps (This)</label>
                                <input type="number" id="review-opps-this" class="w-full bg-transparent font-bold text-lg p-0 border-none focus:ring-0" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-text mb-2 text-emerald-600"><i class="fa-solid fa-thumbs-up mr-1"></i> Best Practices</label>
                            <textarea id="review-best" rows="4" class="w-full p-3 border border-border rounded-lg text-sm" placeholder="What did the agent do well?"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-text mb-2 text-rose-600"><i class="fa-solid fa-thumbs-down mr-1"></i> Opportunities</label>
                            <textarea id="review-opps-text" rows="4" class="w-full p-3 border border-border rounded-lg text-sm" placeholder="Areas for improvement..."></textarea>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-text mb-2 text-amber-600"><i class="fa-solid fa-road mr-1"></i> Action Plan</label>
                        <textarea id="review-plan" rows="4" class="w-full p-3 border border-border rounded-lg text-sm bg-amber-50/50" placeholder="Steps to improve performance..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-text mb-2 text-purple-600"><i class="fa-solid fa-comment mr-1"></i> Agent's Voice</label>
                        <textarea id="review-voice" rows="3" class="w-full p-3 border border-border rounded-lg text-sm italic" placeholder="Agent's comments or buy-in..."></textarea>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- AUTH CONFIG ---
        const msalConfig = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: window.location.href }, cache: { cacheLocation: "localStorage" } };
        const GET_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg";
        
        let msalInstance = null;
        let chartInstance = null;

        // --- DATA STORE ---
        const store = {
            employees: [],
            reviews: [],
            kpis: [],
            currentUser: null,
            currentEmployee: null,
            currentReview: null
        };

        // --- AUTH & INIT ---
        window.initAuth = async function() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                const response = await msalInstance.handleRedirectPromise();
                if (response?.account) handleLoginSuccess(response.account);
                else {
                    const accs = msalInstance.getAllAccounts();
                    if (accs.length > 0) handleLoginSuccess(accs[0]);
                    else { toggleForce('loading-overlay', false); toggleForce('auth-container', true); }
                }
            } catch(e) { console.error("Auth Init Error:", e); toggleForce('loading-overlay', false); }
        };

        function handleLoginSuccess(account) {
            store.currentUser = account;
            safeSetText('user-name', account.name);
            toggleForce('auth-container', false);
            toggleForce('loading-overlay', true);
            initData(); // Start fetching data
        }

        function signIn() { msalInstance.loginPopup({ scopes: ["User.Read"] }).then(resp => { if(resp?.account) handleLoginSuccess(resp.account); }); }

        // --- DATA FETCHING (Flow + Mock) ---
        async function initData() {
            startClock();
            
            // 1. Initial Load of the provided JSON structure (Simulating Flow Response)
            // In production, callFlow() would fetch this. Here we use the raw data from your prompt.
            const rawData = {
                "value": [
                    {"cr714_employeename":"Joshua Williams","cr714_employeeinformation1id":"9c98e6d3-997e-f011-b4cb-000d3a149458","cr714_department@OData.Community.Display.V1.FormattedValue":"Jacksonville","cr714_title@OData.Community.Display.V1.FormattedValue":"Rep","cr714_managerassigned":"Celah Teschner","cr714_emailaddress":"Joshua.EWilliams@wbmason.com","cr714_status@OData.Community.Display.V1.FormattedValue":"Active"},
                    {"cr714_employeename":"Abigail Landi","cr714_employeeinformation1id":"4e3a4020-1f7d-f011-b4cb-000d3a537e3f","cr714_department@OData.Community.Display.V1.FormattedValue":"New Hire In Training","cr714_title@OData.Community.Display.V1.FormattedValue":"Rep","cr714_emailaddress":"Abigail.Landi@wbmason.com","cr714_managerassigned":"Tondalaya Currier","cr714_status@OData.Community.Display.V1.FormattedValue":"Active"},
                    {"cr714_employeename":"Dexter Billingslea","cr714_employeeinformation1id":"3b826383-353d-ef11-8409-000d3a565327","cr714_department@OData.Community.Display.V1.FormattedValue":"Jacksonville","cr714_title@OData.Community.Display.V1.FormattedValue":"Rep","cr714_emailaddress":"Dexter.Billingslea@wbmason.com","cr714_managerassigned":"Celah Teschner","cr714_status@OData.Community.Display.V1.FormattedValue":"Active"}
                ]
            };

            // Parse Employees
            store.employees = rawData.value.map(e => ({
                id: e.cr714_employeeinformation1id,
                name: e.cr714_employeename,
                title: e['cr714_title@OData.Community.Display.V1.FormattedValue'],
                dept: e['cr714_department@OData.Community.Display.V1.FormattedValue'],
                manager: e.cr714_managerassigned,
                email: e.cr714_emailaddress,
                status: e['cr714_status@OData.Community.Display.V1.FormattedValue'],
                phone: e.cr714_personalphonenumber || '--'
            }));

            // Finish Loading
            renderSidebar();
            renderEmployeeList();
            toggleForce('loading-overlay', false);
            toggleForce('sidebar-container', true);
            toggleForce('main-content', true);
        }

        // --- ROUTER ---
        const router = {
            navigate: (viewId) => {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                const view = document.getElementById(`view-${viewId}`);
                if(view) view.classList.add('active');
                
                // Update Breadcrumbs
                const titleMap = { 'employees': 'Team Dashboard', 'employee-detail': 'Employee Profile', 'review-editor': 'Edit Review', 'reviews-list': 'All Reviews' };
                safeSetText('page-title', titleMap[viewId] || 'Dashboard');
                
                // Highlight Nav
                if(viewId === 'employees') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            },
            openEmployee: (empId) => {
                store.currentEmployee = store.employees.find(e => e.id === empId);
                renderEmployeeProfile();
                router.navigate('employee-detail');
                safeSetText('breadcrumbs', `Home > ${store.currentEmployee.name}`);
            },
            openReview: (reviewId) => {
                if(reviewId === 'new') {
                    store.currentReview = { 
                        id: null, 
                        empId: store.currentEmployee.id, 
                        date: new Date().toISOString().split('T')[0],
                        type: 'End of Month',
                        status: 'Draft' 
                    };
                } else {
                    store.currentReview = store.reviews.find(r => r.id === reviewId);
                }
                renderReviewEditor();
                router.navigate('review-editor');
                safeSetText('breadcrumbs', `Home > ${store.currentEmployee.name} > Review Editor`);
            },
            backToProfile: () => {
                router.navigate('employee-detail');
                safeSetText('breadcrumbs', `Home > ${store.currentEmployee.name}`);
            }
        };

        // --- RENDERERS ---
        function renderSidebar() {
            // Group by Dept for Sidebar
            const depts = [...new Set(store.employees.map(e => e.dept))];
            const container = document.getElementById('dept-groups');
            container.innerHTML = depts.map(dept => `
                <div class="mb-2">
                    <div class="px-3 py-1 text-xs font-bold text-muted uppercase">${dept}</div>
                    ${store.employees.filter(e => e.dept === dept).map(e => `
                        <div class="px-3 py-1.5 ml-2 text-sm text-text/80 cursor-pointer hover:text-primary rounded hover:bg-bg" onclick="router.openEmployee('${e.id}')">${e.name}</div>
                    `).join('')}
                </div>
            `).join('');
        }

        function renderEmployeeList() {
            const tbody = document.querySelector('#emp-table tbody');
            tbody.innerHTML = store.employees.map(e => `
                <tr onclick="router.openEmployee('${e.id}')">
                    <td class="font-medium text-primary">${e.name}</td>
                    <td>${e.title}</td>
                    <td>${e.dept}</td>
                    <td>${e.manager}</td>
                    <td><span class="status-badge status-active">${e.status}</span></td>
                </tr>
            `).join('');
            safeSetText('roster-count', `${store.employees.length} Records`);
        }

        function renderEmployeeProfile() {
            const emp = store.currentEmployee;
            if(!emp) return;

            safeSetText('detail-name', emp.name);
            safeSetText('detail-title', emp.title);
            safeSetText('detail-dept', emp.dept);
            safeSetText('detail-manager', emp.manager);
            safeSetText('detail-email', emp.email);
            safeSetText('detail-phone', emp.phone);

            // Filter reviews for this employee
            const empReviews = store.reviews.filter(r => r.empId === emp.id);
            const reviewBody = document.querySelector('#detail-reviews-table tbody');
            
            if(empReviews.length === 0) {
                reviewBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No reviews found. Import files or create new.</td></tr>';
            } else {
                reviewBody.innerHTML = empReviews.map(r => `
                    <tr onclick="router.openReview('${r.id}')">
                        <td>${r.date}</td>
                        <td><span class="font-semibold text-primary">${r.type}</span></td>
                        <td>${r.oppsThis || 0}</td>
                        <td class="truncate max-w-xs text-muted">${r.actionPlan || '-'}</td>
                        <td><span class="status-badge status-review">${r.status || 'Done'}</span></td>
                    </tr>
                `).join('');
            }
        }

        function renderReviewEditor() {
            const rev = store.currentReview;
            const emp = store.currentEmployee;
            
            safeSetText('editor-emp-name', emp.name);
            safeSetText('editor-status', rev.status || 'Draft');
            
            document.getElementById('review-id').value = rev.id || '';
            document.getElementById('review-emp-id').value = rev.empId;
            document.getElementById('review-date').value = rev.date;
            document.getElementById('review-type').value = rev.type || 'End of Month';
            document.getElementById('review-opps-last').value = rev.oppsLast || '';
            document.getElementById('review-opps-this').value = rev.oppsThis || '';
            document.getElementById('review-best').value = rev.bestPractices || '';
            document.getElementById('review-opps-text').value = rev.opportunitiesText || '';
            document.getElementById('review-plan').value = rev.actionPlan || '';
            document.getElementById('review-voice').value = rev.agentVoice || '';
        }

        // --- SMART IMPORT LOGIC ---
        window.handleFileUpload = async function(input) {
            if(!input.files.length) return;
            const loader = document.getElementById('loading-text');
            loader.textContent = `Parsing ${input.files.length} documents...`;
            toggleForce('loading-overlay', true);

            let addedCount = 0;

            for (let file of input.files) {
                try {
                    let text = "";
                    if (file.name.endsWith('.docx')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                        text = result.value;
                    } else if (file.name.endsWith('.pdf')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ") + "\n";
                        }
                    }

                    if (text) {
                        const extracted = extractDataFromText(text);
                        if (extracted.name) {
                            // Find matching employee ID
                            const matchEmp = store.employees.find(e => e.name.toLowerCase().includes(extracted.name.split(' ')[0].toLowerCase()));
                            const empId = matchEmp ? matchEmp.id : 'unknown';

                            const newReview = {
                                id: 'rev-' + Math.random().toString(36).substr(2, 9),
                                empId: empId,
                                date: extracted.date,
                                type: 'End of Month', // Default inferred
                                oppsThis: extracted.opps,
                                actionPlan: extracted.plan,
                                bestPractices: extracted.best,
                                agentVoice: extracted.voice,
                                status: 'Imported'
                            };
                            
                            store.reviews.push(newReview);
                            addedCount++;
                        }
                    }
                } catch (e) { console.error("Parse Error", file.name, e); }
            }

            toggleForce('loading-overlay', false);
            alert(`Import Complete: ${addedCount} reviews added.`);
            
            // Refresh current view
            if(store.currentEmployee) renderEmployeeProfile();
        };

        function extractDataFromText(text) {
            // Normalize
            const clean = text.replace(/\s+/g, ' ').trim();
            
            // Extract Name (Heuristic)
            let nameMatch = clean.match(/Agent Name[:\s,]*([A-Za-z]+[\s]+[A-Za-z]+)/i);
            
            // Extract Date
            let dateMatch = clean.match(/Date[:\s,]*(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
            
            // Helper to get text between headers
            const getSection = (headers) => {
                let start = -1;
                for(let h of headers) {
                    let idx = clean.search(new RegExp(h, "i"));
                    if(idx !== -1) { start = idx + h.length; break; }
                }
                if(start === -1) return "";
                // Look for next section
                const stops = ["Action Plan", "Best Practices", "Agent's Voice", "Manager Signature"];
                let end = clean.length;
                for(let s of stops) {
                    let idx = clean.indexOf(s, start + 10);
                    if(idx !== -1 && idx < end) end = idx;
                }
                return clean.substring(start, end).replace(/^[:\-\s]+/, '').trim();
            };

            return {
                name: nameMatch ? nameMatch[1] : null,
                date: dateMatch ? new Date(dateMatch[1]).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                plan: getSection(["Action Plan"]),
                best: getSection(["Best Practices"]),
                voice: getSection(["Agent's Voice", "Buy In"])
            };
        }

        // --- ACTIONS ---
        function saveReview() {
            const id = document.getElementById('review-id').value;
            const payload = {
                id: id || 'rev-' + Math.random().toString(36).substr(2,9),
                empId: document.getElementById('review-emp-id').value,
                date: document.getElementById('review-date').value,
                type: document.getElementById('review-type').value,
                oppsLast: document.getElementById('review-opps-last').value,
                oppsThis: document.getElementById('review-opps-this').value,
                actionPlan: document.getElementById('review-plan').value,
                bestPractices: document.getElementById('review-best').value,
                agentVoice: document.getElementById('review-voice').value,
                status: 'Completed'
            };

            // Update Store
            const existingIdx = store.reviews.findIndex(r => r.id === payload.id);
            if(existingIdx >= 0) store.reviews[existingIdx] = payload;
            else store.reviews.push(payload);

            alert("Review saved locally!");
            router.backToProfile();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        }

        function openEditEmployee() { alert("Edit Profile Modal would open here."); }

        // --- UTILS ---
        const safeSetText = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        const toggleForce = (id, show) => { const el = document.getElementById(id); if(el) show ? el.classList.remove('hidden-force') : el.classList.add('hidden-force'); };
        window.setTheme = (t) => { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); };
        window.startClock = () => { setInterval(() => { const d = new Date(); safeSetText('clock-time', d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})); safeSetText('clock-date', d.toLocaleDateString()); }, 1000); };
        window.handleSearch = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const rows = document.querySelectorAll('#emp-table tbody tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        };

        // Boot
        document.addEventListener('DOMContentLoaded', () => {
            const t = localStorage.getItem('theme') || 'winter';
            window.setTheme(t);
            initAuth();
        });

    </script>
</body>
</html>
