<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replace the flows with yours - MB - Rep Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        :root {
            --bg-app: #f1f5f9; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --primary: #4f46e5; --primary-fg: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --color-srmgr: #f97316; --color-mgr: #06b6d4; --color-sup: #22c55e; --color-gold: #facc15;
        }
        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; }
        [data-theme="oled"] { --bg-app: #000000; --bg-card: #121212; --bg-input: #2a2a2a; --text-main: #ffffff; --text-muted: #a1a1aa; --border-color: #27272a; --primary: #facc15; --primary-fg: #000000; }
        
        .bg-app { background-color: var(--bg-app); } .bg-card { background-color: var(--bg-card); } .bg-input { background-color: var(--bg-input); }
        .text-main { color: var(--text-main); } .text-muted { color: var(--text-muted); } .border-color { border-color: var(--border-color); }
        .shadow-theme { box-shadow: var(--shadow); }
        .bg-primary { background-color: var(--primary); color: var(--primary-fg); }
        .sidebar-header { background-color: var(--primary); color: var(--primary-fg); }
        
        .hierarchy-item:hover { background-color: var(--border-color); }
        .hierarchy-item.active { background-color: var(--border-color); border-left: 4px solid var(--primary); }
        
        .color-srmgr { color: var(--color-srmgr); font-weight: 700; }
        .color-mgr { color: var(--color-mgr); font-weight: 600; }
        .color-sup { color: var(--color-sup); font-weight: 600; }
        .color-gold { color: var(--color-gold); font-weight: 600; }
        
        .page { display: none; } #page-review.active, #page-create.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #review-date-slider { -webkit-appearance: none; background: var(--border-color); }
        #review-date-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: var(--text-main); transition: opacity 0.3s; }
        #auth-container { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--bg-card); padding: 2rem; border-radius: 10px; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print { body * { visibility: hidden; } #print-section, #print-section * { visibility: visible; } #print-section { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; color: #000; background: #fff; } }
    </style>

    <script>
        // --- 1. CONFIGURATION ---
        // URL from Turn 11 (GET DATA) - CONFIRMED
        const GET_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d0d57d29d13548959817da5747dcd63f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=y6xY5kfe1HX8q5Ka_8XBMEgql953PqGdonFZZ3wC7Cg";
        
        // URL for SAVE DATA - **PASTE YOUR FULL URL HERE**
        const SAVE_DATA_FLOW_URL = "PASTE_YOUR_FULL_SAVE_URL_HERE";

        const msalConfig = { 
            auth: { 
                clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", 
                authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", 
                redirectUri: window.location.href 
            }, 
            cache: { cacheLocation: "localStorage" } 
        };
        
        // --- 2. GLOBAL VARIABLES ---
        let msalInstance = null;
        let username = "";
        let currentRepId = null;
        let currentFilter = { type: 'All', value: null };
        let reviewDateRange = [];
        let rawEmployees = [];
        let dbReviews = [];
        let dbLogs = [];
        let currentReview = null;
        let chartInstance = null;

        const kpiConfigs = {"Sales":[{id:"outbound",label:"Outbound Calls",target:50,type:"number",agg:"sum"},{id:"invoices",label:"Invoices",target:10,type:"number",agg:"sum"},{id:"talktime",label:"Avg Talk Time",target:120,type:"time",agg:"avg"}],"Quotes":[{id:"projects",label:"Quotes",target:50,type:"number",agg:"sum"},{id:"accuracy",label:"Accuracy",target:98,type:"percent",agg:"avg"}],"Food Service":[{id:"orders",label:"Orders",target:30,type:"number",agg:"sum"}],"Retail":[{id:"sales",label:"Sales",target:5,type:"number",agg:"sum"}]};

        // --- 3. AUTH & API FUNCTIONS ---
        
        window.initAuth = async function() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                const response = await msalInstance.handleRedirectPromise();
                
                if (response && response.account) {
                    window.handleLoginSuccess(response.account);
                } else {
                    const currentAccounts = msalInstance.getAllAccounts();
                    if (currentAccounts.length > 0) {
                        window.handleLoginSuccess(currentAccounts[0]);
                    } else {
                        // Show Login Screen
                        document.getElementById('loading-overlay').style.display = 'none';
                        document.getElementById('auth-container').classList.remove('hidden');
                    }
                }
            } catch (e) {
                console.error("Auth Init Failed:", e);
                document.getElementById('loading-overlay').innerHTML = `<div class="text-red-500 font-bold">Auth Error: ${e.message}</div>`;
            }
        };

        window.signIn = function() {
            msalInstance.loginPopup({ scopes: ["User.Read"] }).then(resp => {
                if (resp && resp.account) {
                    window.handleLoginSuccess(resp.account);
                }
            }).catch(e => {
                console.error("Login Failed:", e);
                alert("Login failed: " + e.message);
            });
        };

        window.handleLoginSuccess = function(account) {
            username = account.username;
            document.getElementById('user-display').textContent = account.name;
            
            // FORCE HIDE AUTH & SHOW LOADING
            document.getElementById('auth-container').classList.add('hidden');
            const loader = document.getElementById('loading-overlay');
            loader.style.display = 'flex';
            loader.innerHTML = '<div class="spinner"></div><div id="loading-text">Fetching Data...</div>';
            
            window.initData();
        };

        window.getToken = async function() {
            const account = msalInstance.getAllAccounts()[0];
            if (!account) return null;
            try {
                const response = await msalInstance.acquireTokenSilent({ scopes: ["User.Read"], account: account });
                return response.accessToken;
            } catch (e) { return null; }
        };

        window.callFlow = async function(url, body) {
            const headers = { 'Content-Type': 'application/json' };
            // Only add token if signature is missing (SAS vs Bearer)
            if (!url.includes('sig=')) {
                const token = await window.getToken();
                if (token) headers['Authorization'] = `Bearer ${token}`;
            }
            
            const options = { method: 'POST', headers: headers, body: JSON.stringify(body) };
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`Flow Error: ${res.status}`);
            const text = await res.text();
            return text ? JSON.parse(text) : {};
        };

        // --- 4. DATA INITIALIZATION ---
        window.initData = async function() {
            window.loadTheme();
            
            try {
                const data = await window.callFlow(GET_DATA_FLOW_URL, { userEmail: username });
                
                // Populate Data
                rawEmployees = data.employees || [];
                dbReviews = data.reviews || [];
                dbLogs = data.logs || [];

                // Calculate Dates
                if (dbLogs.length > 0) {
                    reviewDateRange = [...new Set(dbLogs.map(l => l.date))].sort();
                } else {
                    reviewDateRange = ["2024-11", "2024-12", "2025-01"];
                }

                // Render
                document.getElementById('loading-overlay').style.display = 'none';
                window.renderSidebar();
                
            } catch (error) {
                console.error("Fetch error:", error);
                document.getElementById('loading-overlay').innerHTML = `<div class="text-red-500 text-center p-4"><b>Error:</b> ${error.message}<br><br><button onclick="location.reload()" class="underline">Retry</button></div>`;
            }
        };

        // --- 5. UI LOGIC ---
        window.applyTheme = function(t) { if(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('selectedTheme', t); } };
        window.loadTheme = function() { const t = localStorage.getItem('selectedTheme') || 'winter'; window.applyTheme(t); const el = document.getElementById('theme-select'); if(el) el.value = t; };

        window.toggleSection = function(id) {
            const el = document.getElementById('list-'+id);
            if(!el) return;
            el.classList.toggle('hidden');
            const icon = document.getElementById('chev-'+id);
            if(icon) icon.textContent = el.classList.contains('hidden') ? '▼' : '▲';
            window.filterReps('All', null);
        };

        window.filterReps = function(type, val, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            currentFilter = { type: type, value: val };
            
            document.querySelectorAll('#list-rep .hierarchy-item').forEach(rBtn => {
                const rep = rawEmployees.find(e => e.id == rBtn.dataset.id);
                if(!rep) return;
                let show = false;
                if (type === 'Department') show = rep.dept === val;
                else if (type === 'Manager') show = rep.managerId === val;
                else if (type === 'Supervisor') {
                    const mgrs = rawEmployees.filter(m => m.supervisorId === val).map(m => m.id);
                    show = (rep.supervisorId === val) || (mgrs.includes(rep.managerId));
                } else if (type === 'GoldStar') show = rep.isGoldStar;
                else show = true;
                rBtn.style.display = show ? 'flex' : 'none';
            });
            
            const t = document.getElementById('view-title'); if(t) t.textContent = type === 'All' ? 'Dashboard' : val;
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('btn-new-review').style.display = 'none';
            
            const repList = document.getElementById('list-rep');
            if(repList.classList.contains('hidden')) window.toggleSection('rep');
        };

        window.selectRep = function(id, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            window.loadRepDashboard(id);
        };

        window.renderSidebar = function() {
            if(!rawEmployees.length) {
                document.getElementById('list-rep').innerHTML = '<div class="p-4 text-sm text-muted italic">No data returned from Flow.</div>';
                return;
            }
            const getRole = (r) => rawEmployees.filter(e => e.role === r).sort((a,b) => a.name.localeCompare(b.name));
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(d => d && d !== 'N/A').sort();
            
            document.getElementById('list-dept').innerHTML = depts.map(d => `<button onclick="window.filterReps('Department', '${d}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span>${d}</span></button>`).join('');
            document.getElementById('list-mgr').innerHTML = getRole('Manager').map(m => `<button onclick="window.filterReps('Manager', ${m.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded color-mgr">${m.name}</button>`).join('');
            document.getElementById('list-sup').innerHTML = rawEmployees.filter(e => ['Supervisor','SR Manager','Director'].includes(e.role)).sort((a,b)=>a.name.localeCompare(b.name)).map(s => `<button onclick="window.filterReps('Supervisor', ${s.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded color-srmgr">${s.name}</button>`).join('');
            document.getElementById('list-rep').innerHTML = getRole('Rep').map(r => `<button data-id="${r.id}" onclick="window.selectRep(${r.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span class="${r.isGoldStar ? 'color-gold' : ''}">${r.name}</span></button>`).join('');
            
            ['dept', 'mgr', 'sup'].forEach(id => { const el = document.getElementById('list-'+id); if(el) el.classList.add('hidden'); });
        };

        window.loadRepDashboard = function(id) {
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            document.getElementById('view-title').textContent = emp.name;
            document.getElementById('view-subtitle').textContent = `${emp.role} • ${emp.dept}`;
            const mgr = rawEmployees.find(e => e.id === emp.managerId);
            document.getElementById('manager-name').innerHTML = mgr ? mgr.name : "Unassigned";
            
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('page-review').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'flex';
            
            const s = document.getElementById('review-date-slider');
            s.max = Math.max(0, reviewDateRange.length - 1);
            s.value = s.max;
            window.updateDashboardFromSlider();
        };

        window.updateDashboardFromSlider = function() {
            if (!currentRepId || !reviewDateRange.length) return;
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const end = reviewDateRange[idx];
            document.getElementById('current-review-date-display').textContent = end;
            
            const logs = dbLogs.filter(l => l.repId === currentRepId && l.date === end);
            const kpis = kpiConfigs[rawEmployees.find(e=>e.id===currentRepId).dept] || kpiConfigs["Sales"];
            
            document.getElementById('kpi-table-body').innerHTML = kpis.map(k => {
                const l = logs.find(x=>x.kpiId === k.id);
                return `<tr><td class="px-4 py-2">${k.label}</td><td class="px-4 py-2 text-right">${k.target}</td><td class="px-4 py-2 text-right font-bold">${l ? Math.floor(l.value) : '-'}</td><td class="px-4 py-2 text-center">-</td></tr>`;
            }).join('');
            
            // Reviews
            const rev = dbReviews.find(r => r.repId === currentRepId && r.date === end);
            if(rev) {
                 const f = (id, arr) => document.getElementById(id).innerHTML = (arr||[]).map(i=>`<li>${i}</li>`).join('');
                 f('text-opps-this', rev.oppsThis); f('text-opps-last', rev.oppsLast);
                 f('text-best-practices', rev.bestPractices); f('text-action-plan', rev.actionPlan);
                 document.getElementById('text-agent-voice').textContent = rev.agentVoice || '';
            } else {
                 ['text-opps-this','text-opps-last','text-best-practices','text-action-plan'].forEach(id => document.getElementById(id).innerHTML='');
                 document.getElementById('text-agent-voice').textContent = 'No review data.';
            }
            window.updateChart();
        };

        window.updateChart = function() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] } }); 
        };

        window.openCreateReviewModal = function() {
            if(!currentRepId) return alert("Select Rep");
            const e = rawEmployees.find(x=>x.id===currentRepId);
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.add('active');
            document.getElementById('btn-new-review').style.display='none';
            document.getElementById('new-review-rep-name').textContent=e.name;
            document.getElementById('form-date').valueAsDate=new Date();
            const kpis = kpiConfigs[e.dept] || kpiConfigs["Sales"];
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => `<div><label class="text-sm font-bold text-main">${k.label}</label><input id="kpi-${k.id}" type="number" class="w-full border p-2 rounded bg-input text-main"></div>`).join('');
        };

        window.saveNewReview = async function() {
            try {
                const payload = {
                    repId: currentRepId, date: document.getElementById('form-date').value,
                    type: document.getElementById('form-type').value,
                    oppsThis: document.getElementById('form-opps-this').value.split('\n'),
                    specialNotes: document.getElementById('form-special-notes').value
                };
                await window.callFlow(SAVE_DATA_FLOW_URL, payload);
                alert("Saved!");
                window.initData(); 
            } catch(e) { alert("Save Failed: " + e.message); }
        };
        
        window.openExportModal = function() { window.print(); };
        window.triggerFlowSync = function() { alert("Syncing..."); window.callFlow(GET_DATA_FLOW_URL, {}).then(()=>alert("Done")); };

        // START
        document.addEventListener('DOMContentLoaded', () => { window.initAuth(); });
    </script>
</body>
</html>
