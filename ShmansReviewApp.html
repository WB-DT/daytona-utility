<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rep Performance Dashboard v6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        :root {
            --bg-app: #f1f5f9; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --primary: #4f46e5; --primary-fg: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --color-srmgr: #f97316; --color-mgr: #06b6d4; --color-sup: #22c55e; --color-gold: #facc15;
        }
        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; }
        [data-theme="oled"] { --bg-app: #000000; --bg-card: #121212; --bg-input: #2a2a2a; --text-main: #ffffff; --text-muted: #a1a1aa; --border-color: #27272a; --primary: #facc15; --primary-fg: #000000; }
        [data-theme="forest"] { --bg-app: #ecfdf5; --bg-card: #ffffff; --bg-input: #f0fdf4; --text-main: #064e3b; --text-muted: #65a30d; --border-color: #bbf7d0; --primary: #16a34a; --primary-fg: #ffffff; }
        [data-theme="ocean"] { --bg-app: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); --bg-card: rgba(255,255,255,0.95); --bg-input: rgba(255,255,255,0.8); --text-main: #0c4a6e; --text-muted: #0284c7; --border-color: #bae6fd; --primary: #0284c7; --primary-fg: #ffffff; }
        [data-theme="sunset"] { --bg-app: #fff7ed; --bg-card: #ffffff; --bg-input: #ffedd5; --text-main: #7c2d12; --text-muted: #c2410c; --border-color: #fed7aa; --primary: #ea580c; --primary-fg: #ffffff; }
        [data-theme="cyber"] { --bg-app: #050505; --bg-card: #11001c; --bg-input: #240046; --text-main: #e0aaff; --text-muted: #9d4edd; --border-color: #5a189a; --primary: #ff00ff; --primary-fg: #11001c; --shadow: 0 0 10px #ff00ff; }
        [data-theme="holiday-cheer"] { --bg-app: #f0fdf4; --bg-card: #ffffff; --bg-input: #fff1f2; --text-main: #14532d; --text-muted: #991b1b; --border-color: #166534; --primary: #dc2626; --primary-fg: #ffffff; --accent-warning: #fbbf24; }
        [data-theme="winter"] { --bg-app: linear-gradient(to bottom, #eff6ff, #dbeafe); --bg-card: #ffffff; --bg-input: #f0f9ff; --text-main: #1e3a8a; --text-muted: #60a5fa; --border-color: #bfdbfe; --primary: #2563eb; --primary-fg: #ffffff; }
        [data-theme="harvest"] { --bg-app: #fffbeb; --bg-card: #ffffff; --bg-input: #fff7ed; --text-main: #78350f; --text-muted: #d97706; --border-color: #fcd34d; --primary: #d97706; --primary-fg: #ffffff; }

        .bg-app { background-color: var(--bg-app); } .bg-card { background-color: var(--bg-card); } .bg-input { background-color: var(--bg-input); }
        .text-main { color: var(--text-main); } .text-muted { color: var(--text-muted); } .border-color { border-color: var(--border-color); }
        .shadow-theme { box-shadow: var(--shadow); }
        .bg-primary { background-color: var(--primary); color: var(--primary-fg); }
        .hover\:bg-primary:hover { background-color: var(--primary); opacity: 0.9; color: var(--primary-fg); }
        .sidebar-header { background-color: var(--primary); color: var(--primary-fg); }
        
        .hierarchy-item:hover { background-color: var(--border-color); }
        .hierarchy-item.active { background-color: var(--border-color); border-left: 4px solid var(--primary); }
        
        .color-srmgr { color: var(--color-srmgr); font-weight: 700; }
        .color-mgr { color: var(--color-mgr); font-weight: 600; }
        .color-sup { color: var(--color-sup); font-weight: 600; }
        .color-gold { color: var(--color-gold); font-weight: 600; }
        
        .page { display: none; } #page-review.active, #page-create.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #review-date-slider { -webkit-appearance: none; background: var(--border-color); }
        #review-date-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: var(--text-main); transition: opacity 0.3s; }
        #auth-container { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--bg-card); padding: 2rem; border-radius: 10px; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            body * { visibility: hidden; } #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; color: #000; background: #fff; }
            .no-print { display: none !important; }
            .bg-card, .bg-app { background-color: white !important; } .text-main { color: black !important; }
        }
        
        #debug-log {
            position: fixed; bottom: 10px; right: 10px; width: 300px; height: 150px; 
            background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; font-size: 10px;
            overflow-y: auto; z-index: 9999; padding: 5px; border-radius: 5px; pointer-events: none;
            display: none; /* Change to 'block' to view debug log */
        }
    </style>
</head>
<body class="bg-app antialiased h-screen flex overflow-hidden">

    <div id="debug-log">Log:</div>

    <div id="auth-container">
        <div class="auth-box">
            <h2 class="text-2xl font-bold mb-4 text-main">Performance Hub</h2>
            <p class="mb-6 text-muted">Sign in with your Microsoft account to access data.</p>
            <button onclick="signIn()" class="bg-primary text-primary-fg px-6 py-3 rounded font-bold hover:opacity-90">Sign In</button>
            <div id="login-error" class="text-red-500 mt-4 text-sm hidden"></div>
        </div>
    </div>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <div id="loading-text">Authenticating...</div>
    </div>

    <div id="app-content" class="h-full w-full flex" style="display: none;">

        <div class="w-1/4 min-w-[300px] bg-card border-r border-color flex flex-col shadow-theme z-10">
            <div class="p-4 border-b border-color sidebar-header">
                <h1 class="text-xl font-bold">Performance Hub</h1>
                <p class="text-xs opacity-80">Dataverse Connected</p>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div class="border-b border-color"><button onclick="toggleSection('dept')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Department <span id="chev-dept">‚ñº</span></button><div id="list-dept" class="p-2 space-y-1 hidden"></div></div>
                <div class="border-b border-color"><button onclick="toggleSection('mgr')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Manager Group <span id="chev-mgr">‚ñº</span></button><div id="list-mgr" class="p-2 space-y-1 hidden"></div></div>
                <div class="border-b border-color"><button onclick="toggleSection('sup')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Supervisor Group <span id="chev-sup">‚ñº</span></button><div id="list-sup" class="p-2 space-y-1 hidden"></div></div>
                <div class="border-b border-color"><button onclick="filterReps('GoldStar', true, this)" class="hierarchy-item block w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase">Gold Star Reps üåü</button></div>
                <div class="flex-1"><button onclick="toggleSection('rep')" class="w-full text-left p-3 bg-input font-semibold text-xs text-muted uppercase flex justify-between">Representative <span id="chev-rep">‚ñº</span></button><div id="list-rep" class="p-2 space-y-1 hidden"></div></div>
            </div>
            <div class="p-4 border-t border-color bg-input">
                <button onclick="triggerFlowSync()" class="w-full bg-card border border-color text-main py-2 rounded shadow-theme hover:bg-input text-sm font-medium flex justify-center items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Sync Data
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden relative">
            <header class="bg-card border-b border-color p-4 flex justify-between items-center shadow-theme">
                <div><h2 id="view-title" class="text-2xl font-bold text-main">Dashboard</h2><p id="view-subtitle" class="text-sm text-muted">Select an employee</p></div>
                <div class="flex gap-3 items-center">
                    <span id="user-display" class="text-xs font-bold text-primary"></span>
                    <select id="theme-select" onchange="applyTheme(this.value)" class="p-2 text-sm border border-color rounded bg-input text-main shadow-theme">
                        <option value="winter">Winter</option><option value="midnight">Midnight</option><option value="oled">OLED</option><option value="forest">Forest</option><option value="ocean">Ocean</option><option value="sunset">Sunset</option><option value="cyber">Cyber</option><option value="harvest">Harvest</option><option value="holiday-cheer">Holiday</option>
                    </select>
                    <button onclick="openCreateReviewModal()" id="btn-new-review" class="bg-primary text-primary-fg px-4 py-2 rounded shadow-theme text-sm hidden no-print">New Review</button>
                    <button onclick="openExportModal()" class="bg-primary text-primary-fg px-4 py-2 rounded shadow-theme text-sm no-print">Export / Sign</button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6 bg-app">
                <div id="page-review" class="page max-w-6xl mx-auto space-y-6">
                    <div class="flex justify-between items-end bg-card p-4 rounded-xl shadow-theme">
                        <div class="w-full max-w-md space-y-2">
                            <div class="flex justify-between"><label class="text-xs font-bold text-muted uppercase">Period Ending</label><span id="current-review-date-display" class="text-sm font-bold text-main">--</span></div>
                            <input type="range" id="review-date-slider" class="w-full h-2 bg-input rounded-lg cursor-pointer" min="0" max="0" value="0" oninput="updateDashboardFromSlider()">
                            <div class="flex gap-2 items-center"><label class="text-xs font-bold text-muted uppercase">Compare:</label><select id="duration-select" onchange="updateDashboardFromSlider()" class="p-1 text-xs border border-color rounded bg-input text-main"><option value="1">Monthly</option><option value="3">Quarterly</option><option value="6">6 Months</option><option value="12">Annual</option></select></div>
                        </div>
                        <div class="text-right"><div class="text-sm text-muted">Reports to</div><div id="manager-name" class="font-medium text-main">--</div></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-card rounded-xl shadow-theme p-5 border border-color">
                            <h3 class="text-lg font-bold text-main mb-4">Performance Metrics</h3>
                            <div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-input text-xs uppercase text-muted"><tr><th class="px-4 py-2 text-left">KPI</th><th class="px-4 py-2 text-right">Target</th><th class="px-4 py-2 text-right">Actual</th><th class="px-4 py-2 text-center">Trend</th></tr></thead><tbody id="kpi-table-body" class="divide-y divide-border-color text-sm text-main"><tr><td colspan="4" class="text-center py-8 text-muted">Select a rep to view data.</td></tr></tbody></table></div>
                        </div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border border-color flex flex-col">
                            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-main">Trend</h3><select id="chart-kpi-select" onchange="updateChart()" class="text-xs border border-color rounded bg-card text-main"></select></div>
                            <div class="flex-1 relative w-full h-64"><canvas id="trendChart"></canvas></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--primary);"><h4 class="font-bold text-main mb-2">üéØ Opportunities (Current)</h4><ul id="text-opps-this" class="text-sm text-main list-disc list-inside"></ul></div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--text-muted);"><h4 class="font-bold text-main mb-2">üîô Opportunities (Previous)</h4><ul id="text-opps-last" class="text-sm text-main list-disc list-inside"></ul></div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--color-sup);"><h4 class="font-bold text-main mb-2">‚ú® Best Practices</h4><ul id="text-best-practices" class="text-sm text-main list-disc list-inside"></ul></div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border-l-4" style="border-color: var(--color-gold);"><h4 class="font-bold text-main mb-2">üöÄ Action Plan</h4><ul id="text-action-plan" class="text-sm text-main list-disc list-inside"></ul></div>
                    </div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border border-color"><h4 class="font-bold text-main mb-2">üó£Ô∏è Agent's Voice</h4><p id="text-agent-voice" class="text-sm text-muted italic bg-input p-3 rounded"></p></div>
                </div>

                <div id="page-create" class="page max-w-4xl mx-auto space-y-6">
                    <h3 class="text-2xl font-bold text-main border-b border-color pb-2">New Review: <span id="new-review-rep-name"></span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-card rounded-xl shadow-theme p-5 border border-color space-y-4">
                            <h4 class="font-bold text-main mb-2">Review Details</h4>
                            <div><label class="text-sm font-medium text-main">Date</label><input type="date" id="form-date" class="w-full border border-color rounded p-2 bg-input text-main"></div>
                            <div><label class="text-sm font-medium text-main">Type</label><select id="form-type" class="w-full border border-color rounded p-2 bg-input text-main"><option>EOM</option><option>EOQ</option><option>Annual</option><option>30-Day</option><option>90-Day</option></select></div>
                            <div><label class="text-sm font-medium text-main">Reviewer Level</label><select id="form-level" class="w-full border border-color rounded p-2 bg-input text-main"><option>Manager</option><option>Supervisor</option><option>Director</option></select></div>
                        </div>
                        <div class="bg-card rounded-xl shadow-theme p-5 border border-color"><h4 class="font-bold text-main mb-2">KPIs</h4><div id="form-kpi-inputs" class="space-y-2"></div></div>
                    </div>
                    <div class="bg-card rounded-xl shadow-theme p-5 border border-color space-y-4">
                        <h4 class="font-bold text-main mb-2">Qualitative Feedback</h4>
                        <div><label class="text-sm font-medium text-main">Opportunities</label><textarea id="form-opps-this" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                        <div><label class="text-sm font-medium text-main">Action Plan</label><textarea id="form-action-plan" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                        <div><label class="text-sm font-medium text-main">Special Notes</label><textarea id="form-special-notes" rows="2" class="w-full border border-color rounded p-2 bg-input text-main"></textarea></div>
                        <div class="flex gap-4 mt-4"><button onclick="saveNewReview()" class="flex-1 bg-primary text-primary-fg py-2 rounded">Save</button><button onclick="loadRepDashboard(currentRepId)" class="flex-1 bg-input text-main py-2 rounded">Cancel</button></div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="print-section" class="hidden bg-card">
        <div class="max-w-3xl mx-auto">
            <div class="flex justify-between border-b border-black pb-4 mb-6"><div><h1 class="text-2xl font-bold">Performance Review</h1><p id="print-subtitle"></p></div><div class="text-right"><h2 class="font-bold text-xl">W.B. Mason</h2><p id="print-date"></p></div></div>
            <table class="w-full mb-6 text-sm"><thead><tr class="bg-input"><th class="p-2 text-left">KPI</th><th class="p-2 text-right">Target</th><th class="p-2 text-right">Result</th><th class="p-2 text-center">Status</th></tr></thead><tbody id="print-table-body"></tbody></table>
            <div id="print-text-content" class="space-y-4 text-sm"></div>
            <div class="mt-12 pt-8 grid grid-cols-2 gap-10"><div class="border-t border-black pt-2"><p class="font-bold">Manager Signature</p></div><div class="border-t border-black pt-2"><p class="font-bold">Employee Signature</p></div></div>
        </div>
    </div>

    <script>
        function log(msg) { console.log("[App]", msg); const el = document.getElementById('debug-log'); if(el) el.innerHTML += `<div>${msg}</div>`; }

        // --- 1. MSAL AUTH CONFIG ---
        // SCOPE FOR USER LOGIN (Microsoft Graph/OIDC)
        const LOGIN_SCOPES = ["openid", "profile", "User.Read"];
        // SCOPE FOR API/FLOW ACCESS (Power Platform Resource)
        const FLOW_SCOPE = ["https://api.powerplatform.com/.default"];

        const msalConfig = { 
            auth: { 
                clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", 
                authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", 
                redirectUri: window.location.href
            }, 
            cache: { cacheLocation: "localStorage" } 
        };
        
        let msalInstance;
        let username = "";

        // --- 2. FLOW CONFIG ---
        const RAW_GET_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c82c5aa6117a4df3b1f8dbb0f8a098bb/triggers/manual/paths/invoke?api-version=1";
        const RAW_SAVE_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/088be03ff3724bb4ac49e37532d96136/triggers/manual/paths/invoke?api-version=1";

        let currentRepId = null;
        let currentFilter = { type: 'All', value: null };
        let reviewDateRange = [];
        let rawEmployees = [];
        let dbReviews = [];
        let dbLogs = [];
        let currentReview = null;

        // --- 3. STATIC CONFIGS ---
        const kpiConfigs = {"Sales":[{id:"outbound",label:"Outbound Calls",target:50,type:"number",agg:"sum"},{id:"talktime",label:"Avg Talk Time",target:120,type:"time",agg:"avg"},{id:"notes",label:"% Call Notes",target:100,type:"percent",agg:"avg"},{id:"invoices",label:"Invoices",target:10,type:"number",agg:"sum"},{id:"aux",label:"AUX Accuracy",target:95,type:"percent",agg:"avg"}],"Quotes":[{id:"projects",label:"Quotes Processed",target:50,type:"number",agg:"sum"},{id:"accuracy",label:"Quote Accuracy",target:98,type:"percent",agg:"avg"},{id:"items",label:"Items Quoted",target:500,type:"number",agg:"sum"},{id:"turnaround",label:"Turnaround (Hours)",target:8,type:"number",agg:"avg"}],"Food Service":[{id:"orders",label:"Food Orders",target:30,type:"number",agg:"sum"},{id:"call_time",label:"Avg Call Time",target:180,type:"time",agg:"avg"},{id:"notes",label:"% Order Notes",target:95,type:"percent",agg:"avg"},{id:"errors",label:"Order Errors",target:2,type:"number",agg:"sum"}],"Account Management 1":[{id:"touchpoints",label:"Client Touchpoints",target:20,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:8,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:3,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:75,type:"number",agg:"avg"}],"Account Management 2":[{id:"touchpoints",label:"Client Touchpoints",target:18,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:9,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:4,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:72,type:"number",agg:"avg"}],"Account Management 3":[{id:"touchpoints",label:"Client Touchpoints",target:15,type:"number",agg:"sum"},{id:"growth",label:"Account Growth",target:10,type:"percent",agg:"avg"},{id:"churn",label:"Client Churn",target:5,type:"percent",agg:"avg"},{id:"nps",label:"NPS Score",target:70,type:"number",agg:"avg"}],"Analytics/Workforce":[{id:"tickets",label:"Tickets Closed",target:20,type:"number",agg:"sum"},{id:"quality",label:"Analysis Quality",target:95,type:"percent",agg:"avg"},{id:"projects",label:"Projects Completed",target:5,type:"number",agg:"sum"}],"New Hire In Training":[{id:"modules",label:"Modules Completed",target:10,type:"number",agg:"sum"},{id:"quizzes",label:"Quiz Avg (%)",target:85,type:"percent",agg:"avg"},{id:"shadows",label:"Shadow Hours",target:40,type:"number",agg:"sum"}]};
        
        // --- 4. AUTH LOGIC ---
        async function initMSAL() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                log("MSAL initialized");

                // Check for existing accounts
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    log("User already signed in. Logging in silently...");
                    msalInstance.setActiveAccount(accounts[0]);
                    // Get a token to ensure session is live, using basic scopes
                    const tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: LOGIN_SCOPES,
                        account: accounts[0]
                    });
                    handleLoginSuccess(accounts[0]);
                } else {
                    log("No user signed in.");
                    document.getElementById('auth-container').classList.remove('hidden');
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            } catch (e) {
                // This usually means the silent token acquisition failed, which is fine, 
                // we'll just show the login button.
                log("Init Error / Silent Login Failed: " + e.message);
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function handleLoginSuccess(account) {
            username = account.username;
            document.getElementById('user-display').textContent = account.name;
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').style.display = 'flex';
            initData();
        }

        async function signIn() {
            log("Starting Popup Login with Basic Scopes...");
            try {
                // Request basic LOGIN_SCOPES first.
                const loginResponse = await msalInstance.loginPopup({
                    scopes: LOGIN_SCOPES 
                });
                log("Login Success");
                msalInstance.setActiveAccount(loginResponse.account);
                handleLoginSuccess(loginResponse.account);
            } catch (e) {
                log("Login Failed: " + e.message);
                document.getElementById('login-error').textContent = e.message;
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        // IMPORTANT: This function now explicitly requests the FLOW_SCOPE token.
        async function getToken() {
            const account = msalInstance.getActiveAccount();
            if (!account) throw new Error("No active account");

            const request = {
                // *** Using FLOW_SCOPE here which contains the resource/.default scope ***
                scopes: FLOW_SCOPE, 
                account: account
            };

            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (e) {
                log("Silent token for Flow failed, trying popup");
                try {
                    const response = await msalInstance.acquireTokenPopup(request);
                    return response.accessToken;
                } catch (err) {
                    throw err;
                }
            }
        }
        
        // --- 5. DATA FETCHING ---
        async function callFlow(url, payload) {
            log("Getting Power Platform token...");
            const token = await getToken();
            log("Token received. Calling Flow...");

            const cleanUrl = url.split('&sig=')[0]; 

            const response = await fetch(cleanUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const txt = await response.text();
                throw new Error(`Flow Call Status ${response.status}: ${txt}`);
            }
            return response.json();
        }

        async function initData() {
            try {
                document.getElementById('loading-text').textContent = "Fetching Data...";
                const data = await callFlow(RAW_GET_URL, { data: 'all' });
                log("Data received successfully.");

                rawEmployees = data.employees || [];
                dbReviews = data.reviews || [];
                dbLogs = data.logs || [];
                
                const dates = [...new Set(dbLogs.map(l => l.date))].sort();
                reviewDateRange = dates.length ? dates : ["2024-01"]; 

                renderSidebar();
                
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex';
                toggleSection('rep');
                
                const defaultRep = rawEmployees.find(e => e.role === 'Rep');
                if (defaultRep) loadRepDashboard(defaultRep.id);

            } catch (error) {
                log("Data Error: " + error.message);
                document.getElementById('loading-overlay').innerHTML = `<div class="text-red-500 font-bold text-center p-5">Data Fetch Error<br><span class="text-sm font-normal text-gray-600">${error.message}</span></div>`;
            }
        }

        // --- 6. UI LOGIC (Standard) ---
        function applyTheme(t) {
            if(t) {
                document.documentElement.setAttribute('data-theme', t);
                localStorage.setItem('selectedTheme', t);
            }
        }
        function loadTheme() {
            const t = localStorage.getItem('selectedTheme') || 'winter';
            applyTheme(t);
            const el = document.getElementById('theme-select');
            if(el) el.value = t;
        }
        function toggleSection(id) {
            const el = document.getElementById('list-'+id);
            const chev = document.getElementById('chev-'+id);
            const isHidden = el.classList.contains('hidden');
            ['dept', 'mgr', 'sup', 'rep'].forEach(otherId => {
                const otherEl = document.getElementById('list-' + otherId);
                const otherChev = document.getElementById('chev-' + otherId);
                if (otherId !== id && otherEl && otherChev) {
                    otherEl.classList.add('hidden');
                    otherChev.textContent = '‚ñº';
                }
            });
            if (isHidden) {
                el.classList.remove('hidden');
                chev.textContent = '‚ñ≤';
            } else {
                el.classList.add('hidden');
                chev.textContent = '‚ñº';
            }
            filterReps('All', null);
        }
        function filterReps(type, val, btn) {
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            currentFilter = { type: type, value: val };
            document.querySelectorAll('#list-rep button').forEach(rBtn => {
                const rep = rawEmployees.find(e => e.id == rBtn.dataset.id);
                if (!rep) return;
                let show = false;
                if (type === 'Department') show = rep.dept === val;
                else if (type === 'Manager') show = rep.managerId == val;
                else if (type === 'Supervisor') {
                    const mgrs = rawEmployees.filter(e => e.role === 'Manager' && e.supervisorId == val).map(m => m.id);
                    show = (rep.supervisorId == val) || (mgrs.includes(rep.managerId));
                }
                else if (type === 'GoldStar') show = rep.isGoldStar;
                else show = true;
                rBtn.style.display = show ? 'flex' : 'none';
            });
            const titleEl = document.getElementById('view-title');
            if (titleEl) titleEl.textContent = type === 'All' ? 'Dashboard' : (type === 'GoldStar' ? 'Gold Star Reps' : val);
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('btn-new-review').style.display = 'none';
            const repList = document.getElementById('list-rep');
            if(repList.classList.contains('hidden')) toggleSection('rep');
        }
        function selectRep(id, btn) {
            document.querySelectorAll('#list-rep button').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            loadRepDashboard(id);
        }
        function renderSidebar() {
            if(!rawEmployees.length) return;
            const getRole = (r) => rawEmployees.filter(e => e.role === r).sort((a,b) => a.name.localeCompare(b.name));
            const depts = [...new Set(rawEmployees.map(e => e.dept))].filter(d => d && d !== 'N/A').sort();
            document.getElementById('list-dept').innerHTML = depts.map(d => {
                const sr = rawEmployees.find(e => (e.role === 'SR Manager' || e.role === 'Director') && e.dept === d);
                return `<button onclick="filterReps('Department', '${d}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span>${d}</span><span class="text-xs opacity-50 ${sr ? 'color-srmgr' : ''}">${sr ? sr.name : '--'}</span></button>`;
            }).join('');
            document.getElementById('list-mgr').innerHTML = getRole('Manager').map(m => `<button data-id="${m.id}" onclick="filterReps('Manager', ${m.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded color-mgr">${m.name} (${m.dept})</button>`).join('');
            document.getElementById('list-sup').innerHTML = getRole('Supervisor').concat(getRole('SR Manager')).concat(getRole('Director')).sort((a,b) => a.name.localeCompare(b.name)).map(s => `<button data-id="${s.id}" onclick="filterReps('Supervisor', ${s.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded ${s.role === 'SR Manager' || s.role === 'Director' ? 'color-srmgr' : 'color-sup'}">${s.name} (${s.role})</button>`).join('');
            document.getElementById('list-rep').innerHTML = getRole('Rep').map(r => `<button data-id="${r.id}" onclick="selectRep(${r.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span class="${r.isGoldStar ? 'color-gold' : ''}">${r.name}</span><span class="text-xs opacity-50">${r.dept}</span></button>`).join('');
        }
        function loadRepDashboard(id) {
            currentRepId = id;
            const emp = rawEmployees.find(e => e.id === id);
            const mgr = rawEmployees.find(e => e.id === emp.managerId);
            const sup = rawEmployees.find(e => e.id === emp.supervisorId);
            document.getElementById('view-title').textContent = emp.name;
            document.getElementById('view-subtitle').textContent = `${emp.role} ‚Ä¢ ${emp.dept}`;
            let mText = mgr ? `<span class="color-mgr">${mgr.name}</span>` : "Unassigned";
            if(sup) mText += ` (via <span class="${sup.role === 'SR Manager' ? 'color-srmgr' : 'color-sup'}">${sup.name}</span>)`;
            document.getElementById('manager-name').innerHTML = mText;
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('page-review').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'flex';
            const s = document.getElementById('review-date-slider');
            s.max = Math.max(0, reviewDateRange.length - 1);
            s.value = s.max;
            updateDashboardFromSlider();
        }
        function formatValue(kpi, val) {
            if (kpi.type === 'percent') return `${val.toFixed(1)}%`;
            if (kpi.type === 'time') {
                const minutes = Math.floor(val / 60);
                const seconds = Math.floor(val % 60).toString().padStart(2, '0');
                return `${minutes}:${seconds}`;
            }
            return Math.round(val).toLocaleString();
        }
        function getStatusIcon(actual, target) {
            if (actual >= target * 1.05) return 'üöÄ'; 
            if (actual >= target) return '‚úÖ';
            if (actual >= target * 0.9) return '‚ö†Ô∏è'; 
            return '‚ùå';
        }
        function fill(id, arr) {
            const el = document.getElementById(id);
            el.innerHTML = arr && arr.length ? arr.map(item => `<li>${item}</li>`).join('') : '<li class="text-muted italic">None recorded.</li>';
        }
        function updateDashboardFromSlider() {
            if (!currentRepId) return;
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const dur = parseInt(document.getElementById('duration-select').value);
            if (!reviewDateRange.length) return;
            const end = reviewDateRange[idx];
            let sIdx = Math.max(0, idx - dur + 1);
            const start = reviewDateRange[sIdx];
            document.getElementById('current-review-date-display').textContent = `${start} to ${end}`;
            const logs = dbLogs.filter(l => l.repId === currentRepId && l.date >= start && l.date <= end);
            const emp = rawEmployees.find(e => e.id === currentRepId);
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            document.getElementById('kpi-table-body').innerHTML = kpis.map(k => {
                const sub = logs.filter(l => l.kpiId === k.id);
                let val = 0;
                if(sub.length) {
                    const sum = sub.reduce((a,b)=>a+b.value,0);
                    val = k.agg === 'sum' ? sum : (sum/sub.length);
                }
                const t = k.target * (k.agg === 'sum' ? dur : 1);
                const hit = getStatusIcon(val, t);
                const color = hit === '‚úÖ' || hit === 'üöÄ' ? 'text-green-600' : (hit === '‚ö†Ô∏è' ? 'text-yellow-600' : 'text-red-600');
                return `<tr><td class="px-4 py-2 font-medium">${k.label}</td><td class="px-4 py-2 text-right text-muted">${formatValue(k, t)}</td><td class="px-4 py-2 text-right font-bold ${color}">${formatValue(k, val)}</td><td class="px-4 py-2 text-center">${hit}</td></tr>`;
            }).join('');
            const revs = dbReviews.filter(r => r.repId === currentRepId).sort((a,b) => b.date.localeCompare(a.date));
            const rev = revs.find(r => r.date === end);
            currentReview = rev;
            if (rev) {
                const prevRev = revs.find(r => r.date < rev.date);
                fill('text-opps-this', rev.oppsThis); fill('text-action-plan', rev.actionPlan); fill('text-best-practices', rev.bestPractices || []); fill('text-opps-last', prevRev ? prevRev.oppsThis : []);
                document.getElementById('text-agent-voice').textContent = rev.agentVoice || '--';
            } else {
                fill('text-opps-this', []); fill('text-opps-last', []); fill('text-best-practices', []); fill('text-action-plan', []);
                document.getElementById('text-agent-voice').textContent = 'No review data available.';
            }
            const sel = document.getElementById('chart-kpi-select');
            if(sel.children.length === 0) sel.innerHTML = kpis.map(k => `<option value="${k.id}">${k.label}</option>`).join('');
            updateChart();
        }

        let chartInstance = null;
        function updateChart() {
            if (!currentRepId) return;
            const kpiId = document.getElementById('chart-kpi-select').value;
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const dates = reviewDateRange.slice(Math.max(0, idx-5), idx+1);
            const data = dates.map(d => {
                const l = dbLogs.find(x => x.repId === currentRepId && x.date === d && x.kpiId === kpiId);
                return l ? l.value : 0;
            });
            const emp = rawEmployees.find(e => e.id === currentRepId);
            const kpi = kpiConfigs[emp.dept].find(k => k.id === kpiId);
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{ label: kpi.label, data: data, borderColor: 'var(--primary)', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true }, { label: 'Target', data: dates.map(() => kpi.target), borderColor: 'var(--text-muted)', borderDash: [5, 5], pointRadius: 0, backgroundColor: 'transparent' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: true } }, interaction: { mode: 'index', intersect: false } }
            });
        }

        function openCreateReviewModal() {
            if(!currentRepId) return alert("Select Rep first");
            const emp = rawEmployees.find(e => e.id === currentRepId);
            document.getElementById('page-review').classList.remove('active'); document.getElementById('page-create').classList.add('active'); document.getElementById('btn-new-review').style.display = 'none';
            document.getElementById('new-review-rep-name').textContent = emp.name;
            document.getElementById('form-date').valueAsDate = new Date();
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => `<div><label class="block text-sm text-main">${k.label}</label><input type="number" id="kpi-${k.id}" class="w-full border border-color rounded p-2 bg-input text-main"></div>`).join('');
        }
        async function saveNewReview() {
            const emp = rawEmployees.find(e => e.id === currentRepId);
            const dt = document.getElementById('form-date').value;
            if(!dt) return alert("Select date");
            const payload = { repId: currentRepId, date: dt, type: document.getElementById('form-type').value, reviewerLevel: document.getElementById('form-level').value, oppsThis: document.getElementById('form-opps-this').value.split('\n'), actionPlan: document.getElementById('form-action-plan').value.split('\n'), specialNotes: document.getElementById('form-special-notes').value, kpis: [] };
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            kpis.forEach(k => { const v = document.getElementById(`kpi-${k.id}`).value; if(v) payload.kpis.push({id: k.id, value: parseFloat(v)}); });
            try { await callFlow(RAW_SAVE_URL, payload); alert("Saved!"); document.getElementById('loading-overlay').style.display = 'flex'; document.getElementById('app-content').style.display = 'none'; initData(); } catch(e) { alert("Save Failed: " + e.message); }
        }
        function openExportModal() { window.print(); }
        async function triggerFlowSync() { alert("Syncing..."); try { document.getElementById('loading-overlay').style.display = 'flex'; await callFlow(RAW_GET_URL, { data: 'sync' }); alert("Done."); initData(); } catch(e) { alert(e); } }

        // --- INITIALIZE ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            initMSAL();
        });

    </script>
</body>
</html>
