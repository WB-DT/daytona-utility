<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rep Performance Dashboard v11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom CSS variables for theme */
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        :root {
            --bg-app: #f1f5f9; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --primary: #4f46e5; --primary-fg: #ffffff;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }
        
        /* Utility classes for visual feedback */
        .page-content:not(.active) { display: none; }
        .rep-item.active { background-color: var(--primary); color: var(--primary-fg); font-weight: 600; }
        .rep-item.active:hover { background-color: var(--primary); }
    </style>
</head>
<body class="bg-app text-main min-h-screen">

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar: Rep List -->
        <div class="w-64 bg-card p-4 flex flex-col shadow-xl overflow-y-auto">
            <h1 class="text-2xl font-bold text-primary mb-6 border-b pb-2">Rep Reviews</h1>
            
            <div id="rep-list" class="flex-grow space-y-2">
                <!-- Representative list will be rendered here -->
            </div>

            <div class="mt-4 border-t pt-4">
                <button onclick="openExportModal()" class="w-full bg-primary text-primary-fg font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-primary/90 transition-all">
                    Export Report (Print)
                </button>
                <button onclick="triggerFlowSync()" class="w-full mt-2 bg-text-muted/10 text-text-muted font-semibold py-2 px-4 rounded-lg hover:bg-text-muted/20 transition-all">
                    Sync Data
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 p-8 overflow-y-auto">

            <!-- Review Dashboard Page -->
            <div id="page-review" class="page-content active">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-3xl font-bold"><span id="dashboard-rep-name">Select an Employee</span> - Review History</h2>
                    <button id="btn-new-review" onclick="openCreateReviewModal()" class="bg-success text-white font-semibold py-2 px-6 rounded-lg shadow-lg hover:bg-success/90 transition-all hidden">
                        + New Monthly Review
                    </button>
                </div>
                
                <div id="dashboard-content" class="space-y-8">
                    <p class="text-center text-lg text-text-muted mt-10">Please select an employee from the left panel to view their performance history.</p>
                </div>
                
                <!-- Chart Section -->
                <div id="chart-section" class="mt-10 bg-card p-6 rounded-xl shadow-lg border hidden">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Performance Trend</h3>
                    <div class="relative h-96">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Create New Review Page -->
            <div id="page-create" class="page-content">
                <h2 class="text-3xl font-bold mb-6 border-b pb-4">Create New Review for <span id="new-review-rep-name" class="text-primary"></span></h2>

                <div class="bg-card p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="new-review-form" onsubmit="event.preventDefault(); saveNewReview();">
                        <div class="mb-4">
                            <label for="form-date" class="block text-sm font-medium text-main">Review Date</label>
                            <input type="date" id="form-date" required class="w-full border border-color rounded p-3 mt-1 bg-input text-main focus:ring-primary focus:border-primary transition">
                        </div>
                        
                        <div id="form-kpi-inputs" class="space-y-4 mb-6">
                            <!-- KPI inputs will be dynamically generated here -->
                            <p class="text-text-muted">Loading KPI inputs...</p>
                        </div>

                        <div class="mb-6">
                            <label for="form-general-comment" class="block text-sm font-medium text-main">General Review Summary</label>
                            <textarea id="form-general-comment" rows="3" class="w-full border border-color rounded p-3 mt-1 bg-input text-main focus:ring-primary focus:border-primary transition" placeholder="Summarize overall performance..."></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="loadRepDashboard(currentRepId)" class="bg-text-muted/10 text-text-muted font-semibold py-2 px-6 rounded-lg hover:bg-text-muted/20 transition-all">
                                Cancel
                            </button>
                            <button type="submit" class="bg-primary text-primary-fg font-semibold py-2 px-6 rounded-lg shadow-lg hover:bg-primary/90 transition-all">
                                Save Review
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // --- GLOBAL DATA STORES (FIXED: Populated with initial data) ---
        // This data now initializes the app correctly.

        const kpiConfigs = {
            "Sales": [
                { "id": "revenue", "label": "Revenue Achieved ($)", "max": 500000, "target": 400000, "unit": "$" },
                { "id": "deals", "label": "Deals Closed (Count)", "max": 20, "target": 15, "unit": "" },
                { "id": "customer-satisfaction", "label": "Customer Satisfaction (%)", "max": 100, "target": 90, "unit": "%" }
            ],
            "Support": [
                { "id": "tickets", "label": "Tickets Closed (Count)", "max": 500, "target": 450, "unit": "" },
                { "id": "resolution-time", "label": "Average Resolution Time (Hours)", "max": 10, "target": 5, "invert": true, "unit": "h" },
                { "id": "satisfaction-score", "label": "Customer Satisfaction Score (0-5)", "max": 5, "target": 4.5, "unit": "" }
            ]
        };

        let repData = [
            {
                "id": 101,
                "name": "Alice Johnson",
                "dept": "Sales",
                "reviews": [
                    {
                        "date": "2025-10-31",
                        "data": {
                            "revenue": { "value": 450000, "comment": "Exceeded target. Strong Q4 start." },
                            "deals": { "value": 18, "comment": "High volume of high-value deals." },
                            "customer-satisfaction": { "value": 92, "comment": "Maintained excellent satisfaction." }
                        }
                    },
                    {
                        "date": "2025-11-30",
                        "data": {
                            "revenue": { "value": 380000, "comment": "Slight dip below target." },
                            "deals": { "value": 14, "comment": "Need to focus on closing more." },
                            "customer-satisfaction": { "value": 95, "comment": "Excellent satisfaction this month." }
                        }
                    }
                ]
            },
            {
                "id": 102,
                "name": "Bob Smith",
                "dept": "Support",
                "reviews": [
                    {
                        "date": "2025-10-31",
                        "data": {
                            "tickets": { "value": 480, "comment": "High ticket volume handled efficiently." },
                            "resolution-time": { "value": 4.5, "comment": "Well below the 5-hour target." },
                            "satisfaction-score": { "value": 4.8, "comment": "Outstanding customer feedback." }
                        }
                    },
                    {
                        "date": "2025-11-30",
                        "data": {
                            "tickets": { "value": 420, "comment": "Met target." },
                            "resolution-time": { "value": 5.1, "comment": "Slightly over target, check reasons." },
                            "satisfaction-score": { "value": 4.6, "comment": "Good score." }
                        }
                    }
                ]
            },
            {
                "id": 103,
                "name": "Charlie Brown",
                "dept": "Sales",
                "reviews": [
                    {
                        "date": "2025-11-30",
                        "data": {
                            "revenue": { "value": 410000, "comment": "Slightly over target." },
                            "deals": { "value": 16, "comment": "Strong performance." },
                            "customer-satisfaction": { "value": 89, "comment": "Needs improvement in CSAT." }
                        }
                    }
                ]
            },
            {
                "id": 104,
                "name": "Diana Prince",
                "dept": "Support",
                "reviews": [
                    {
                        "date": "2025-11-30",
                        "data": {
                            "tickets": { "value": 455, "comment": "Exceeded target." },
                            "resolution-time": { "value": 4.8, "comment": "Excellent resolution time." },
                            "satisfaction-score": { "value": 4.9, "comment": "Highest score this month." }
                        }
                    }
                ]
            }
        ];

        let employeeMap = {};
        let currentRepId = null;
        let myChart = null;

        // --- CORE APPLICATION LOGIC ---

        function createEmployeeMap() {
            // Converts the array of reps into a map for O(1) lookup by ID
            employeeMap = repData.reduce((acc, rep) => {
                acc[rep.id] = rep;
                return acc;
            }, {});
        }

        function loadRepList() {
            const repList = document.getElementById('rep-list');
            
            // Render all rep names
            repList.innerHTML = Object.values(employeeMap)
                .map(rep => `<li id="rep-${rep.id}" class="rep-item p-3 text-main cursor-pointer hover:bg-primary/10 rounded-lg transition" onclick="selectRep(${rep.id})">${rep.name} <span class="text-xs text-text-muted/80 ml-2">(${rep.dept})</span></li>`)
                .join('');

            // Select the first rep by default if available
            const firstRepId = Object.keys(employeeMap)[0];
            if (firstRepId) {
                // Must parse to integer as IDs are stored as string keys in the map
                selectRep(parseInt(firstRepId)); 
            }
        }

        function selectRep(id) {
            // Deselect previous rep
            document.querySelectorAll('.rep-item').forEach(el => el.classList.remove('active'));
            
            currentRepId = id;
            
            // Select new rep
            const selectedRepElement = document.getElementById(`rep-${id}`);
            if (selectedRepElement) {
                selectedRepElement.classList.add('active');
            }
            
            loadRepDashboard(id);
        }

        function loadRepDashboard(id) {
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('page-review').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'block';

            const rep = employeeMap[id];
            if (!rep) return;

            document.getElementById('dashboard-rep-name').textContent = rep.name;
            const dashboardContent = document.getElementById('dashboard-content');
            
            // Check if there are any reviews
            if (rep.reviews.length === 0) {
                dashboardContent.innerHTML = `<p class="text-center text-lg text-text-muted mt-10">No review history found for ${rep.name}. Click '+ New Monthly Review' to start.</p>`;
                document.getElementById('chart-section').classList.add('hidden');
                return;
            }

            // Sort reviews by date descending (most recent first)
            const sortedReviews = [...rep.reviews].sort((a, b) => new Date(b.date) - new Date(a.date));
            const kpiConfiguration = kpiConfigs[rep.dept] || [];

            // 1. Generate Review Cards
            dashboardContent.innerHTML = sortedReviews.map(review => {
                // Get general comment or use a default
                const generalComment = review.data['general-comment']?.comment || 'No general summary provided.';
                
                // Generate KPI detail rows
                const kpiRows = kpiConfiguration.map(kpi => {
                    const reviewValue = review.data[kpi.id]?.value || 0;
                    const reviewComment = review.data[kpi.id]?.comment || 'No specific comments.';
                    const target = kpi.target;
                    const isTargetMet = kpi.invert 
                        ? (reviewValue <= target) // Lower is better
                        : (reviewValue >= target); // Higher is better

                    const statusClass = isTargetMet ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger';
                    const icon = isTargetMet ? '✅' : '❌';

                    let formattedValue = reviewValue;
                    if (kpi.unit === '$') {
                        formattedValue = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(reviewValue);
                    } else if (kpi.unit === '%') {
                        formattedValue = `${reviewValue}%`;
                    } else if (kpi.unit === 'h') {
                        formattedValue = `${reviewValue} hrs`;
                    }


                    return `
                        <div class="flex justify-between items-start py-2 border-b border-color/50">
                            <div class="text-sm font-medium text-text-main w-1/3">${kpi.label}</div>
                            <div class="w-1/3">
                                <span class="text-sm font-semibold p-1 rounded-full ${statusClass}">
                                    ${icon} ${formattedValue}
                                </span>
                            </div>
                            <div class="text-sm text-text-muted italic w-1/3">${reviewComment}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-card p-6 rounded-xl shadow-lg border border-color">
                        <h3 class="text-xl font-semibold mb-4 text-primary">${review.date} Review</h3>
                        <div class="mb-4">
                            ${kpiRows}
                        </div>
                        <div class="pt-4 border-t border-color/50">
                            <p class="text-sm font-semibold mb-1">General Summary:</p>
                            <p class="text-text-main italic">${generalComment}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // 2. Load Chart
            document.getElementById('chart-section').classList.remove('hidden');
            renderPerformanceChart(rep, kpiConfiguration);
        }
        
        function renderPerformanceChart(rep, kpis) {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            // Destroy previous chart instance if it exists
            if (myChart) {
                myChart.destroy();
            }

            // We only chart the first KPI for simplicity
            if (kpis.length === 0) return; 

            const mainKpi = kpis[0]; 
            const reviews = [...rep.reviews].sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort ascending for chart

            const data = {
                labels: reviews.map(r => r.date),
                datasets: [{
                    label: `${mainKpi.label} Trend`,
                    data: reviews.map(r => r.data[mainKpi.id]?.value),
                    borderColor: 'var(--primary)',
                    backgroundColor: 'var(--primary)/20',
                    tension: 0.3,
                    fill: false,
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'Target',
                    data: reviews.map(() => mainKpi.target),
                    borderColor: 'var(--danger)',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0,
                    fill: false
                }]
            };

            myChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: `Monthly Trend for ${mainKpi.label}` }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: mainKpi.max * 1.05, // A little padding above max
                            title: { display: true, text: mainKpi.label }
                        }
                    }
                }
            });
        }
        
        function openCreateReviewModal() {
            // Replaces alert with a custom message box for a better UX
            if(!currentRepId) {
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="bg-warning/20 text-warning p-4 rounded-lg mt-10 text-center font-semibold">
                        Please select an employee first before creating a new review.
                    </div>
                `;
                return;
            }
            
            const emp = employeeMap[currentRepId];
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'none';
            document.getElementById('new-review-rep-name').textContent = emp.name;
            
            // Set default date to today
            document.getElementById('form-date').valueAsDate = new Date();
            
            // Generate Inputs dynamically based on department KPIs
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"]; // Default to Sales if dept not found
            
            // Generates the KPI input fields
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => {
                const isTargetInverted = k.invert ? ' (Lower is Better)' : '';
                return `
                    <div>
                        <label class="block text-sm font-medium text-main">${k.label} (Target: ${k.target}${k.unit}${isTargetInverted})</label>
                        <input type="number" step="0.1" id="kpi-${k.id}" required class="w-full border border-color rounded p-3 mt-1 bg-input text-main focus:ring-primary focus:border-primary transition" placeholder="Enter value (Max: ${k.max})">
                        <label class="block text-sm font-medium text-text-muted mt-2">Comment:</label>
                        <input type="text" id="kpi-${k.id}-comment" class="w-full border border-color rounded p-3 mt-1 bg-input text-main transition" placeholder="Optional comment for this KPI">
                    </div>
                `;
            }).join('');
        }
        
        function saveNewReview() {
            const form = document.getElementById('new-review-form');
            const emp = employeeMap[currentRepId];
            const kpiConfiguration = kpiConfigs[emp.dept] || [];
            
            const newReview = {
                date: form['form-date'].value,
                data: {}
            };

            // Collect KPI data from form inputs
            kpiConfiguration.forEach(kpi => {
                const valueInput = document.getElementById(`kpi-${kpi.id}`);
                const commentInput = document.getElementById(`kpi-${kpi.id}-comment`);

                newReview.data[kpi.id] = {
                    value: parseFloat(valueInput.value),
                    comment: commentInput.value.trim()
                };
            });

            // Add general comment
            const generalComment = document.getElementById('form-general-comment').value.trim();
            if (generalComment) {
                newReview.data['general-comment'] = { comment: generalComment };
            }

            // Save the new review to repData (local storage for now)
            repData = repData.map(r => {
                if (r.id === currentRepId) {
                    // Check for duplicate date to prevent errors
                    if (!r.reviews.find(rev => rev.date === newReview.date)) {
                        r.reviews.push(newReview);
                    } else {
                        // Use a custom message box instead of alert()
                        document.getElementById('dashboard-content').innerHTML = `
                            <div class="bg-danger/20 text-danger p-4 rounded-lg mt-10 text-center font-semibold">
                                Error: A review for ${newReview.date} already exists for ${emp.name}.
                            </div>
                        `;
                        return r;
                    }
                }
                return r;
            });

            // Update the map after updating the array
            createEmployeeMap();

            // Notify user of save (replace alert)
            document.getElementById('dashboard-content').innerHTML = `
                <div class="bg-success/20 text-success p-4 rounded-lg mt-10 text-center font-semibold">
                    Review successfully saved for ${newReview.date}!
                </div>
            `;

            // Clear form and reload dashboard
            form.reset();
            setTimeout(() => loadRepDashboard(currentRepId), 1500); // Reload after brief success message
        }
        
        // Functions that need to be defined but are simple placeholders
        function openExportModal() { 
            // Replace simple window.print() with a custom confirmation/info box if this were a real app
            // For now, we keep the simple functionality but avoid alert
            window.print(); 
        }
        
        function triggerFlowSync() { 
            // Replace alert with a temporary message box
            const syncMessage = document.createElement('div');
            syncMessage.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            syncMessage.innerHTML = '<div class="bg-card p-6 rounded-xl shadow-2xl text-lg font-semibold text-primary">Syncing data... (This is a placeholder action)</div>';
            document.body.appendChild(syncMessage);
            
            setTimeout(() => {
                syncMessage.remove();
            }, 1500);
        }

        function initData() {
            // 1. Prepare data structures (now they have data from the definitions above)
            createEmployeeMap(); 
            // 2. Load the list in the sidebar
            loadRepList();
            // 3. The loadRepList function automatically selects and loads the dashboard for the first rep.
        }

        // Initialize App after DOM Content Loaded to prevent null reference errors
        document.addEventListener('DOMContentLoaded', initData);

    </script>
</body>
