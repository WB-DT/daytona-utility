<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rep Performance Dashboard v9(Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        :root {
            --bg-app: #f1f5f9; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --primary: #4f46e5; --primary-fg: #ffffff;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --color-srmgr: #f97316; --color-mgr: #06b6d4; --color-sup: #22c55e; --color-gold: #facc15;
        }
        [data-theme="midnight"] { --bg-app: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-fg: #0f172a; }
        [data-theme="oled"] { --bg-app: #000000; --bg-card: #121212; --bg-input: #2a2a2a; --text-main: #ffffff; --text-muted: #a1a1aa; --border-color: #27272a; --primary: #facc15; --primary-fg: #000000; }
        [data-theme="forest"] { --bg-app: #ecfdf5; --bg-card: #ffffff; --bg-input: #f0fdf4; --text-main: #064e3b; --text-muted: #65a30d; --border-color: #bbf7d0; --primary: #16a34a; --primary-fg: #ffffff; }
        [data-theme="ocean"] { --bg-app: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); --bg-card: rgba(255,255,255,0.95); --bg-input: rgba(255,255,255,0.8); --text-main: #0c4a6e; --text-muted: #0284c7; --border-color: #bae6fd; --primary: #0284c7; --primary-fg: #ffffff; }
        [data-theme="sunset"] { --bg-app: #fff7ed; --bg-card: #ffffff; --bg-input: #ffedd5; --text-main: #7c2d12; --text-muted: #c2410c; --border-color: #fed7aa; --primary: #ea580c; --primary-fg: #ffffff; }
        [data-theme="cyber"] { --bg-app: #050505; --bg-card: #11001c; --bg-input: #240046; --text-main: #e0aaff; --text-muted: #9d4edd; --border-color: #5a189a; --primary: #ff00ff; --primary-fg: #11001c; --shadow: 0 0 10px #ff00ff; }
        [data-theme="holiday-cheer"] { --bg-app: #f0fdf4; --bg-card: #ffffff; --bg-input: #fff1f2; --text-main: #14532d; --text-muted: #991b1b; --border-color: #166534; --primary: #dc2626; --primary-fg: #ffffff; --accent-warning: #fbbf24; }
        [data-theme="winter"] { --bg-app: linear-gradient(to bottom, #eff6ff, #dbeafe); --bg-card: #ffffff; --bg-input: #f0f9ff; --text-main: #1e3a8a; --text-muted: #60a5fa; --border-color: #bfdbfe; --primary: #2563eb; --primary-fg: #ffffff; }
        [data-theme="harvest"] { --bg-app: #fffbeb; --bg-card: #ffffff; --bg-input: #fff7ed; --text-main: #78350f; --text-muted: #d97706; --border-color: #fcd34d; --primary: #d97706; --primary-fg: #ffffff; }

        .bg-app { background-color: var(--bg-app); } .bg-card { background-color: var(--bg-card); } .bg-input { background-color: var(--bg-input); }
        .text-main { color: var(--text-main); } .text-muted { color: var(--text-muted); } .border-color { border-color: var(--border-color); }
        .shadow-theme { box-shadow: var(--shadow); }
        .bg-primary { background-color: var(--primary); color: var(--primary-fg); }
        .hover\:bg-primary:hover { background-color: var(--primary); opacity: 0.9; color: var(--primary-fg); }

        .sidebar-header { background-color: var(--primary); color: var(--primary-fg); }
        .hierarchy-item:hover { background-color: var(--border-color); }
        .hierarchy-item.active { background-color: var(--border-color); border-left: 4px solid var(--primary); }
        
        .color-srmgr { color: var(--color-srmgr); font-weight: 700; }
        .color-mgr { color: var(--color-mgr); font-weight: 600; }
        .color-sup { color: var(--color-sup); font-weight: 600; }
        .color-gold { color: var(--color-gold); font-weight: 600; }
        
        .page { display: none; } #page-review.active, #page-create.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #review-date-slider { -webkit-appearance: none; background: var(--border-color); }
        #review-date-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: var(--text-main); transition: opacity 0.3s; }
        #auth-container { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--bg-card); padding: 2rem; border-radius: 10px; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            body * { visibility: hidden; } #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; color: #000; background: #fff; }
            .no-print { display: none !important; }
            .bg-card, .bg-app { background-color: white !important; } .text-main { color: black !important; }
        }
    </style>
</head>
<body class="bg-app antialiased h-screen flex overflow-hidden">

    <div id="auth-container" class="hidden">
        <div class="auth-box">
            <h2 class="text-2xl font-bold mb-4 text-main">Performance Hub</h2>
            <p class="mb-6 text-muted">Sign in with your Microsoft account to access data.</p>
            <button onclick="signIn()" class="bg-primary text-primary-fg px-6 py-3 rounded font-bold">Sign In</button>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Authenticating...</div>
    </div>

    <div class="w-1/4 min-w-[300px] bg-card border-r border-color flex flex-col shadow-theme z-10">
        </div>

    <div class="flex-1 flex flex-col overflow-hidden relative">
        <header class="bg-card border-b border-color p-4 flex justify-between items-center shadow-theme">
            </header>
        <main class="flex-1 overflow-y-auto p-6 bg-app">
            <div id="print-section">
                <div id="page-review" class="page max-w-7xl mx-auto space-y-6"></div>
                <div id="page-create" class="page max-w-4xl mx-auto space-y-6"></div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. MSAL CONFIGURATION ---
        const msalConfig = {
            auth: {
                // Client ID from your HAR file's token request error
                clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", 
                authority: "https://login.microsoftonline.com/common",
                redirectUri: "https://wb-dt.github.io/daytona-utility/ShmansReviewApp.html",
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false,
            }
        };
        
        // **NEW ROBUST MSAL INITIALIZATION**
        let msalInstance;
        try {
            // Attempt to initialize the MSAL instance immediately
            msalInstance = new msal.PublicClientApplication(msalConfig);
        } catch(e) {
            console.error("FATAL ERROR: MSAL Library failed to initialize.", e);
            // This alert will pop up if the msal-browser.min.js file failed to load.
            alert("FATAL ERROR: The Microsoft Authentication Library (MSAL) failed to initialize. Please check the browser console for more details (F12).");
            // Prevent further script execution that depends on msalInstance
            // We don't throw, we let the rest of the script continue but without msalInstance being properly set.
        }

        const loginRequest = {
            // These scopes are requested during initial sign-in/consent
            scopes: ["User.Read", "openid", "profile", "api://afe649b6-9c70-4b1a-8592-78588284c8ee/Access_as_user"],
        };
        const tokenRequest = {
            // This is the scope for your Power Automate flow
            scopes: ["api://afe649b6-9c70-4b1a-8592-78588284c8ee/Access_as_user"]
        };

        // --- 2. FLOW URLS & DATA (unchanged) ---
        const GET_DATA_FLOW_URL = "https://prod-11.westus.logic.azure.com:443/workflows/535451e0029b4694939b7d85c4a520a0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=5_R5jX3j83mN3yW4E-a-d2d4r8qJ3d7v1p9_h2d9g9d";
        const SAVE_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/088be03ff3724bb4ac49e37532d96136/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=1vZTb9PuSi5SC6Q3_af9YNiuLxLDYcBPqCfOVDFFftA";

        let currentRepId = null;
        let currentFilter = { type: 'All', value: null };
        let reviewDateRange = [];
        let rawEmployees = [];
        let dbReviews = [];
        let dbLogs = [];
        let currentReview = null;
        let chartInstance = null;
        let employeeMap = {};

        // --- 3. STATIC CONFIGS (unchanged) ---
        const kpiConfigs = {"Sales":[{id:"outbound",label:"Outbound Calls",target:50,type:"number",agg:"sum"},{id:"talktime",label:"Avg Talk Time",target:120,type:"time",agg:"avg"},{id:"notes",label:"% Call Notes",target:100,type:"percent",agg:"avg"},{id:"invoices",label:"Invoices",target:10,type:"number",agg:"sum"},{id:"aux",label:"AUX Accuracy",target:95,type:"percent",agg:"avg"}],"Quotes":[{id:"projects",label:"Quotes Processed",target:50,type:"number",agg:"sum"},{id:"accuracy",label:"Quote Accuracy",target:98,type:"percent",agg:"avg"},{id:"items",label:"Items Quoted",target:500,type:"number",agg:"sum"},{id:"turnaround",label:"Turnaround (Hours)",target:8,type:"number",agg:"avg"}],"Food Service":[{id:"orders",label:"Food Orders",target:30,type:"number",agg:"sum"},{id:"call_time",label:"Avg Call Time",target:180,type:"time",agg:"avg"},{id:"notes",label:"% Order Notes",target:95,type:"percent",agg:"avg"},{id:"errors",label:"Order Errors",target:2,type:"number",agg:"sum"}],"Account Management 1":[{id:"touchpoints",label:"Client Touchpoints",target:100,type:"number",agg:"sum"},{id:"retention",label:"Retention Rate",target:90,type:"percent",agg:"avg"},{id:"c-sat",label:"C-SAT Score",target:90,type:"percent",agg:"avg"}],"Account Management 2":[{id:"touchpoints",label:"Client Touchpoints",target:80,type:"number",agg:"sum"},{id:"upsells",label:"Upsell Count",target:5,type:"number",agg:"sum"},{id:"c-sat",label:"C-SAT Score",target:95,type:"percent",agg:"avg"}]};


        // --- 4. MSAL AUTHENTICATION & FLOW LOGIC ---

        // Helper function to show the sign-in box
        function showSignInBox() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('auth-container').classList.remove('hidden');
        }

        // Function to handle the sign-in button click (ADDED DEBUG LOGIC)
        function signIn() {
            // New diagnostic log
            console.log("Sign-in button clicked. Attempting loginRedirect...");

            if (!msalInstance) {
                alert("MSAL is not initialized. Check the console for fatal script errors.");
                return;
            }
            
            try {
                // This initiates the redirect to the Microsoft login page
                msalInstance.loginRedirect(loginRequest);
            } catch (error) {
                // CRITICAL FIX: Report silent errors to the user
                console.error("Sign-in initiation failed (caught error):", error);
                alert("Sign-in failed. Please check the **browser console** for the error details: " + error.message);
            }
        }

        // Function to call the Power Automate flow with token acquisition logic
        async function callFlow(flowUrl, payload) {
            if (!msalInstance) { throw new Error("MSAL is not available."); }
            
            const account = msalInstance.getActiveAccount();
            if (!account) {
                msalInstance.loginRedirect(loginRequest);
                throw new Error("Initiating interactive login for Flow call.");
            }

            let accessToken;
            try {
                const response = await msalInstance.acquireTokenSilent({
                    ...tokenRequest,
                    account: account
                });
                accessToken = response.accessToken;
            } catch (error) {
                console.warn("Token acquisition failed silently. Initiating interactive redirect.", error);
                
                await msalInstance.acquireTokenRedirect({
                    ...loginRequest,
                    account: account
                });
                
                throw new Error("Redirecting for interactive token acquisition.");
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            };
            
            const response = await fetch(flowUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Flow call failed with status ${response.status}: ${error}`);
            }

            return await response.json();
        }

        // Function to fetch all data after successful authentication
        async function fetchData() {
            if (!msalInstance) return;

            document.getElementById('loading-text').textContent = "Fetching Data...";

            try {
                const data = await callFlow(GET_DATA_FLOW_URL, {});
                
                const accounts = msalInstance.getAllAccounts();
                const account = accounts[0];
                document.getElementById('user-display').textContent = account.username;
                
                // Process Data (unchanged)
                rawEmployees = data.employees || [];
                dbReviews = data.reviews || [];
                dbLogs = data.logs || [];
                employeeMap = rawEmployees.reduce((map, obj) => { map[obj.id] = obj; return map; }, {});

                const allDates = [...dbReviews.map(r => r.date.substring(0, 7)), ...dbLogs.map(l => l.date.substring(0, 7))];
                reviewDateRange = [...new Set(allDates)].sort().reverse();
                if (reviewDateRange.length === 0) reviewDateRange = ["2025-01"];
                
                // Hide loading, show app content
                document.getElementById('loading-overlay').style.display = 'none';
                
                renderSidebar();
                
                if (currentRepId) {
                    loadRepDashboard(currentRepId);
                }

            } catch (error) {
                console.error("Fetch error:", error);
                
                if (error.message !== "Redirecting for interactive token acquisition." && error.message !== "MSAL is not available.") {
                    document.getElementById('loading-overlay').innerHTML = `<div class="text-red-500 text-center font-bold p-4">Error Loading Data<br><span class="text-sm font-normal text-gray-600">${error.message}</span><br><button onclick="location.reload()" class="mt-4 underline text-blue-600">Retry</button></div>`;
                }
            }
        }
        
        // --- The main initialization function ---
        async function initData() {
            if (!msalInstance) { 
                 showSignInBox(); // Show box, but sign-in button will show alert if clicked
                 return;
            }

            // 1. Process redirect response (if any)
            try {
                await msalInstance.handleRedirectPromise();
            } catch (error) {
                console.error("Error handling redirect promise:", error);
            }
            
            // 2. Check for an active account
            let account = msalInstance.getActiveAccount();
            if (!account) {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    account = accounts[0];
                    msalInstance.setActiveAccount(account);
                }
            }
            
            // 3. If an account is found, proceed to fetch data
            if (account) {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('loading-text').textContent = "Authenticating...";
                
                await fetchData();
            } else {
                // 4. No account found, show the sign-in prompt
                showSignInBox();
            }
        }

        // --- 5. DATA MANIPULATION & HELPERS (unchanged) ---
        function getRole(role) { return rawEmployees.filter(e => e.role === role); }
        function getHierarchy(id) { 
            const rep = employeeMap[id];
            const children = rawEmployees.filter(e => e.managerId === id || e.supervisorId === id || e.repId === id);
            return { rep, children };
        }
        function shuffleArray(arr, size) {
            let shuffled = arr.slice();
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled.slice(0, size);
        }
        
        // --- 6. UI LOGIC (unchanged) ---
        function applyTheme(t) { if(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('selectedTheme', t); } }
        function loadTheme() { const t = localStorage.getItem('selectedTheme') || 'winter'; applyTheme(t); const el = document.getElementById('theme-select'); if(el) el.value = t; }
        function toggleSection(id) { 
            const el = document.getElementById('list-'+id); if(!el) return; el.classList.toggle('hidden'); 
            const icon = document.getElementById('chev-'+id); if(icon) icon.textContent = el.classList.contains('hidden') ? '▼' : '▲';
            filterReps('All', null);
        }
        function filterReps(type, val, btn) { 
            document.querySelectorAll('.hierarchy-item').forEach(b => b.classList.remove('active')); 
            if(btn) btn.classList.add('active');
            currentFilter = { type: type, value: val }; 
            document.querySelectorAll('#list-rep .hierarchy-item').forEach(rBtn => { 
                const rep = employeeMap[rBtn.dataset.id]; if (!rep) return; let show = false; 
                if (type === 'Department') show = rep.dept === val; 
                else if (type === 'Manager') show = rep.managerId === val; 
                else if (type === 'Supervisor') show = rep.supervisorId === val; 
                else if (type === 'GoldStar') show = rep.isGoldStar === true; 
                else show = true; 
                rBtn.style.display = show ? 'flex' : 'none';
            }); 
        }
        function renderSidebar() {
            // Build Maps
            const mgrMap = rawEmployees.reduce((acc, e) => { if(e.managerId) acc[e.managerId] = true; return acc; }, {});
            const supMap = rawEmployees.reduce((acc, e) => { if(e.supervisorId) acc[e.supervisorId] = true; return acc; }, {});

            // Render Hierarchy
            document.getElementById('list-dept').innerHTML = [...new Set(rawEmployees.map(e => e.dept))].sort().map(d => `<button onclick="filterReps('Department', '${d}', this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded">${d}</button>`).join('');
            document.getElementById('list-mgr').innerHTML = getRole('Manager').map(m => `<button onclick="filterReps('Manager', ${m.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded ${supMap[m.id] ? 'color-srmgr' : 'color-mgr'}">${m.name}</button>` ).join('');
            document.getElementById('list-sup').innerHTML = getRole('Supervisor').map(s => `<button onclick="filterReps('Supervisor', ${s.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded ${s.role === 'SR Manager' || s.role === 'Director' ? 'color-srmgr' : 'color-sup'}">${s.name} (${s.role})</button>` ).join('');
            document.getElementById('list-rep').innerHTML = getRole('Rep').map(r => `<button data-id="${r.id}" onclick="selectRep(${r.id}, this)" class="hierarchy-item block w-full text-left px-4 py-2 text-sm rounded flex justify-between"><span class="${r.isGoldStar ? 'color-gold' : ''}">${r.name}</span><span class="text-xs opacity-50">${r.dept}</span></button>` ).join('');
            
            // Collapse sections initially
            ['dept', 'mgr', 'sup'].forEach(id => { const el = document.getElementById('list-'+id); if(el) el.classList.add('hidden'); });
        }
        function loadRepDashboard(id) {
            currentRepId = id;
            document.querySelectorAll('#list-rep .hierarchy-item').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-id="${id}"]`).classList.add('active');

            const emp = employeeMap[id];
            const mgr = rawEmployees.find(e => e.id === emp.managerId);
            const sup = rawEmployees.find(e => e.id === emp.supervisorId);

            document.getElementById('rep-name-header').textContent = emp.name;
            document.getElementById('rep-detail-header').textContent = `${emp.role} • ${emp.dept}`;
            
            let mText = mgr ? `<span class="color-mgr">${mgr.name}</span>` : "Unassigned";
            if(sup) mText += ` (via <span class="${sup.role === 'SR Manager' ? 'color-srmgr' : 'color-sup'}">${sup.name}</span>)`;
            document.getElementById('manager-name').innerHTML = mText;

            document.getElementById('page-create').classList.remove('active');
            document.getElementById('page-review').classList.add('active');

            // Find reviews for this rep
            const repReviews = dbReviews.filter(r => r.repId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
            const reviewDates = repReviews.map(r => r.date.substring(0, 7)); // YYYY-MM
            
            // Populate date slider
            const dateSelect = reviewDates.length > 0 ? reviewDates : reviewDateRange;
            const slider = document.getElementById('review-date-slider');
            slider.max = dateSelect.length - 1;
            slider.value = 0; // Latest date
            slider.oninput = updateChart;
            
            // Populate review history
            document.getElementById('review-history-table').innerHTML = repReviews.map((r, i) => `
                <tr onclick="document.getElementById('review-date-slider').value=${i}; updateChart()" class="cursor-pointer hover:bg-input transition-colors">
                    <td class="px-4 py-2 text-sm font-medium text-main">${r.date}</td>
                    <td class="px-4 py-2 text-sm text-muted">${r.type}</td>
                </tr>
            `).join('');

            // Load latest review text data
            const rev = repReviews[0];
            const fill = (id, items) => document.getElementById(id).innerHTML = items.filter(i => i && i.trim() !== '').map(i => `<li>${i}</li>`).join('');

            if (rev) {
                fill('text-opps-this', rev.oppsThis || []);
                fill('text-opps-last', repReviews[1] ? repReviews[1].oppsThis : []); // Use opps from second latest for "previous"
                fill('text-best-practices', rev.bestPractices || []);
                fill('text-action-plan', rev.actionPlan || []);
                document.getElementById('text-agent-voice').textContent = rev.agentVoice || '--';
            } else {
                fill('text-opps-this', []); fill('text-opps-last', []); fill('text-best-practices', []); fill('text-action-plan', []);
                document.getElementById('text-agent-voice').textContent = 'No review data available.';
            }

            // Populate KPI select for chart
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            const sel = document.getElementById('chart-kpi-select');
            if(sel.children.length === 0 || sel.dataset.dept !== emp.dept) {
                sel.innerHTML = kpis.map(k => `<option value="${k.id}">${k.label}</option>`).join('');
                sel.dataset.dept = emp.dept;
            }
            
            updateChart();
        }
        function updateChart() {
            if (!currentRepId) return;
            const rep = employeeMap[currentRepId];
            const kpiId = document.getElementById('chart-kpi-select').value;
            const idx = parseInt(document.getElementById('review-date-slider').value);
            const repReviews = dbReviews.filter(r => r.repId === currentRepId).sort((a, b) => new Date(b.date) - new Date(a.date));
            const currentReview = repReviews[idx];
            const kpis = kpiConfigs[rep.dept] || kpiConfigs["Sales"];
            const kpiConfig = kpis.find(k => k.id === kpiId);
            const reviewDates = repReviews.map(r => r.date.substring(0, 7)).reverse();
            
            if(!kpiConfig) return;

            // Update date labels
            const dateText = reviewDates[idx];
            document.getElementById('date-label-start').textContent = dateText;
            document.getElementById('date-label-end').textContent = reviewDates[reviewDates.length - 1];
            
            const dataLabels = [];
            const dataValues = [];
            
            // Build data for the chart: Past 6 reviews or all reviews
            const relevantReviews = repReviews.slice(0, 6).reverse(); // Last 6 reviews, oldest first
            relevantReviews.forEach(r => {
                const kpiData = r.kpis.find(k => k.id === kpiId);
                dataLabels.push(r.date.substring(5, 10)); // MM-DD
                dataValues.push(kpiData ? kpiData.value : null);
            });

            // Prepare for Chart.js
            const ctx = document.getElementById('kpiChart').getContext('2d');
            
            const targetLine = {
                id: 'targetLine',
                beforeDraw(chart, args, options) {
                    const {ctx, chartArea: {top, bottom, left, right, width, height}, scales: {x, y}} = chart;
                    ctx.save();
                    
                    const targetY = y.getPixelForValue(kpiConfig.target);
                    if (targetY > top && targetY < bottom) {
                        ctx.beginPath();
                        ctx.strokeStyle = '#dc2626'; // Tailwind red-600
                        ctx.lineWidth = 2;
                        ctx.setLineDash([6, 6]);
                        ctx.moveTo(left, targetY);
                        ctx.lineTo(right, targetY);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#dc2626';
                        ctx.textAlign = 'left';
                        ctx.font = 'bold 10px Inter';
                        ctx.fillText(`TARGET: ${kpiConfig.target}`, left + 5, targetY - 5);
                    }
                    ctx.restore();
                }
            };
            
            if (chartInstance) { chartInstance.destroy(); }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataLabels,
                    datasets: [{
                        label: kpiConfig.label,
                        data: dataValues,
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, title: { display: true, text: kpiConfig.label } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                },
                plugins: [targetLine]
            });
            document.getElementById('kpiChart').style.height = '300px'; 
        }
        function selectRep(id, btn) {
            loadRepDashboard(id);
            document.querySelectorAll('#list-rep .hierarchy-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        function openCreateReviewModal() {
            if(!currentRepId) return alert("Select Rep first");
            const emp = employeeMap[currentRepId];
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'none';
            document.getElementById('new-review-rep-name').textContent = emp.name;
            document.getElementById('form-date').valueAsDate = new Date();
            
            // Generate Inputs
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => 
                `<div><label class="block text-sm text-main">${k.label}</label><input type="number" id="kpi-${k.id}" class="w-full border border-color rounded p-2 bg-input text-main"></div>`
            ).join('');
        }
        async function saveNewReview() {
            const emp = employeeMap[currentRepId];
            const dt = document.getElementById('form-date').value;
            if(!dt) return alert("Select date");
            
            const payload = {
                repId: currentRepId,
                date: dt,
                type: document.getElementById('form-type').value,
                reviewerLevel: document.getElementById('form-level').value,
                oppsThis: document.getElementById('form-opps-this').value.split('\n'),
                actionPlan: document.getElementById('form-action-plan').value.split('\n'),
                agentVoice: document.getElementById('form-agent-voice').value,
                specialNotes: document.getElementById('form-special-notes').value,
                kpis: []
            };
            
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            kpis.forEach(k => { const v = document.getElementById(`kpi-${k.id}`).value; if(v) payload.kpis.push({id: k.id, value: parseFloat(v)}); });

            try {
                await callFlow(SAVE_DATA_FLOW_URL, payload);
                alert("Saved!");
                // Re-fetch data to update the dashboard
                await fetchData();
                loadRepDashboard(currentRepId);
            } catch(e) { 
                if (e.message !== "Redirecting for interactive token acquisition." && e.message !== "MSAL is not available.") {
                    alert("Save Failed: " + e.message); 
                }
            }
        }
        function openExportModal() { window.print(); }
        async function triggerFlowSync() { 
            alert("Syncing..."); 
            try {
                await callFlow(GET_DATA_FLOW_URL, {});
                alert("Done!");
                await fetchData();
            } catch(e) {
                if (e.message !== "Redirecting for interactive token acquisition." && e.message !== "MSAL is not available.") {
                    alert("Sync Failed: " + e.message); 
                }
            }
        }

        // Initialize App after DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            // Start the MSAL flow process
            initData();
        });

    </script>
</body>
</html>
