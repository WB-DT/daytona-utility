<!DOCTYPE html>
<html lang="en" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rep Performance Dashboard v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js is used for the Performance Trend graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom CSS and variables */
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        :root {
            --bg-app: #f1f5f9; --bg-card: #ffffff; --bg-input: #f8fafc;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --primary: #4f46e5; --primary-fg: #ffffff;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }
        
        /* Utility classes for visual feedback */
        .page-content:not(.active) { display: none; }
        .rep-item.active { background-color: var(--primary); color: var(--primary-fg); font-weight: 600; }
        .rep-item.active:hover { background-color: var(--primary); }

        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-app text-main min-h-screen">

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar: Rep List -->
        <div class="w-64 bg-card p-4 flex flex-col shadow-xl overflow-y-auto">
            <h1 class="text-2xl font-bold text-primary mb-6 border-b pb-2">Rep Reviews</h1>
            
            <div id="rep-list" class="flex-grow space-y-2">
                <!-- Representative list will be rendered here -->
            </div>

            <div class="mt-4 border-t pt-4">
                <button onclick="openExportModal()" class="w-full bg-primary text-primary-fg font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-primary/90 transition-all">
                    Export Report (Print)
                </button>
                <button onclick="fetchDataFromFlow(true)" class="w-full mt-2 bg-text-muted/10 text-text-muted font-semibold py-2 px-4 rounded-lg hover:bg-text-muted/20 transition-all">
                    Sync Data
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 p-8 overflow-y-auto">

            <!-- Review Dashboard Page -->
            <div id="page-review" class="page-content active">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-3xl font-bold"><span id="dashboard-rep-name">Select an Employee</span> - Review History</h2>
                    <button id="btn-new-review" onclick="openCreateReviewModal()" class="bg-success text-white font-semibold py-2 px-6 rounded-lg shadow-lg hover:bg-success/90 transition-all hidden">
                        + New Monthly Review
                    </button>
                </div>
                
                <div id="dashboard-content" class="space-y-8 min-h-[200px] flex flex-col justify-center">
                    <p class="text-center text-lg text-text-muted mt-10">Loading initial data from Power Automate Flow...</p>
                    <div class="spinner"></div>
                </div>
                
                <!-- Chart Section -->
                <div id="chart-section" class="mt-10 bg-card p-6 rounded-xl shadow-lg border hidden">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Performance Trend</h3>
                    <div class="relative h-96">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Create New Review Page -->
            <div id="page-create" class="page-content">
                <h2 class="text-3xl font-bold mb-6 border-b pb-4">Create New Review for <span id="new-review-rep-name" class="text-primary"></span></h2>

                <div class="bg-card p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="new-review-form" onsubmit="event.preventDefault(); saveNewReview();">
                        <div class="mb-4">
                            <label for="form-date" class="block text-sm font-medium text-main">Review Date</label>
                            <input type="date" id="form-date" required class="w-full border border-color rounded p-3 mt-1 bg-input text-main focus:ring-primary focus:border-primary transition">
                        </div>
                        
                        <div id="form-kpi-inputs" class="space-y-4 mb-6">
                            <!-- KPI inputs will be dynamically generated here -->
                            <p class="text-text-muted">Loading KPI inputs...</p>
                        </div>

                        <div class="mb-6">
                            <label for="form-general-comment" class="block text-sm font-medium text-main">General Review Summary</label>
                            <textarea id="form-general-comment" rows="3" class="w-full border border-color rounded p-3 mt-1 bg-input text-main focus:ring-primary focus:border-primary transition" placeholder="Summarize overall performance..."></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="loadRepDashboard(currentRepId)" class="bg-text-muted/10 text-text-muted font-semibold py-2 px-6 rounded-lg hover:bg-text-muted/20 transition-all">
                                Cancel
                            </button>
                            <button type="submit" class="bg-primary text-primary-fg font-semibold py-2 px-6 rounded-lg shadow-lg hover:bg-primary/90 transition-all">
                                Save Review (Local Only)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Custom Modal/Message Box (for alerts and loading) -->
    <div id="app-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div id="modal-content" class="bg-card p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <!-- Content injected here -->
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Your specific Power Automate Flow URL
        const POWER_AUTOMATE_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c82c5aa6117a4df3b1f8dbb0f8a098bb/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9NlNJzdB9nO-12No3oVcrptS45NC6I9gsFtokTeH_6E";

        // --- GLOBAL DATA STORES ---
        let kpiConfigs = {};
        let repData = [];
        let employeeMap = {};
        let currentRepId = null;
        let myChart = null;

        // --- UTILITY FUNCTIONS (Custom Modal/Messaging) ---
        
        function showMessage(type, message, duration = 2000) {
            const modal = document.getElementById('app-modal');
            const content = document.getElementById('modal-content');
            
            let color = '';
            let title = '';
            
            switch(type) {
                case 'loading':
                    color = 'text-primary';
                    title = 'Processing...';
                    content.innerHTML = `<div class="spinner mb-4"></div><p class="text-lg font-semibold ${color}">${message}</p>`;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    return; 
                case 'success':
                    color = 'text-success';
                    title = 'Success!';
                    break;
                case 'error':
                    color = 'text-danger';
                    title = 'Error!';
                    duration = 5000; 
                    break;
                case 'info':
                default:
                    color = 'text-text-muted';
                    title = 'Information';
                    break;
            }

            content.innerHTML = `<h3 class="text-xl font-bold ${color} mb-3">${title}</h3><p class="text-main">${message}</p>`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, duration);
        }
        
        function hideMessage() {
            document.getElementById('app-modal').classList.remove('flex');
            document.getElementById('app-modal').classList.add('hidden');
        }

        // --- FLOW INTEGRATION (The Fix) ---
        
        /**
         * Fetches data from the Power Automate Flow URL via a POST request.
         * @param {boolean} isManualSync - true if triggered by the Sync button.
         */
        async function fetchDataFromFlow(isManualSync = false) {
            // Show loading message
            showMessage('loading', isManualSync ? 'Syncing latest data from Flow...' : 'Loading initial data...');
            
            try {
                // Perform POST request to trigger the flow and retrieve data
                const response = await fetch(POWER_AUTOMATE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                // The flow must return the unified JSON structure (kpiConfigs and repData)
                const flowData = await response.json();
                
                if (flowData.repData && flowData.kpiConfigs) {
                    repData = flowData.repData;
                    kpiConfigs = flowData.kpiConfigs;
                    
                    // Re-initialize the app with the new data
                    initData(true); 

                    if (isManualSync) {
                        showMessage('success', 'Data sync successful! Dashboard updated.');
                    }
                } else {
                    throw new Error("Flow response is malformed. Expected 'repData' and 'kpiConfigs'.");
                }

            } catch (error) {
                console.error("Error fetching data from Power Automate Flow. If you see a 'CORS' error, check your flow's configuration.", error);
                
                // Fallback to hardcoded sample data on failure to prevent a blank screen
                loadFallbackData(); 
                
                showMessage('error', `Failed to load data from flow! Displaying sample data. Please check your flow URL/CORS settings. Error: ${error.message.substring(0, 100)}...`);
            } finally {
                // Ensure the loading message is hidden after processing
                hideMessage();
            }
        }
        
        // --- FALLBACK DATA (For local testing or when the flow fails) ---
        function loadFallbackData() {
            kpiConfigs = {
                "Sales": [
                    { "id": "revenue", "label": "Revenue Achieved ($)", "max": 500000, "target": 400000, "unit": "$" },
                    { "id": "deals", "label": "Deals Closed (Count)", "max": 20, "target": 15, "unit": "" },
                    { "id": "customer-satisfaction", "label": "Customer Satisfaction (%)", "max": 100, "target": 90, "unit": "%" }
                ],
                "Support": [
                    { "id": "tickets", "label": "Tickets Closed (Count)", "max": 500, "target": 450, "unit": "" },
                    { "id": "resolution-time", "label": "Average Resolution Time (Hours)", "max": 10, "target": 5, "invert": true, "unit": "h" },
                    { "id": "satisfaction-score", "label": "Customer Satisfaction Score (0-5)", "max": 5, "target": 4.5, "unit": "" }
                ]
            };
            repData = [
                { id: 101, name: "Alice Johnson", dept: "Sales", reviews: [{ date: "2025-11-30", data: { "revenue": { value: 450000 }, "deals": { value: 18 }, "customer-satisfaction": { value: 92 } } }] },
                { id: 102, name: "Bob Smith", dept: "Support", reviews: [{ date: "2025-11-30", data: { "tickets": { value: 480 }, "resolution-time": { value: 4.5 }, "satisfaction-score": { value: 4.8 } } }] }
            ];
            initData(true); // Render the app with fallback data
        }

        // --- APPLICATION RENDERING LOGIC ---

        function createEmployeeMap() {
            employeeMap = repData.reduce((acc, rep) => {
                acc[rep.id] = rep;
                return acc;
            }, {});
        }

        function loadRepList() {
            const repList = document.getElementById('rep-list');
            
            if (repData.length === 0) {
                 repList.innerHTML = `<p class="text-xs text-text-muted mt-2 p-2">No employee data loaded.</p>`;
                 return;
            }

            repList.innerHTML = Object.values(employeeMap)
                .map(rep => `<li id="rep-${rep.id}" class="rep-item p-3 text-main cursor-pointer hover:bg-primary/10 rounded-lg transition" onclick="selectRep(${rep.id})">${rep.name} <span class="text-xs text-text-muted/80 ml-2">(${rep.dept})</span></li>`)
                .join('');

            const firstRepId = Object.keys(employeeMap)[0];
            if (firstRepId) {
                selectRep(parseInt(firstRepId)); 
            }
        }

        function selectRep(id) {
            document.querySelectorAll('.rep-item').forEach(el => el.classList.remove('active'));
            currentRepId = id;
            const selectedRepElement = document.getElementById(`rep-${id}`);
            if (selectedRepElement) {
                selectedRepElement.classList.add('active');
            }
            loadRepDashboard(id);
        }

        function loadRepDashboard(id) {
            document.getElementById('page-create').classList.remove('active');
            document.getElementById('page-review').classList.add('active');
            
            const rep = employeeMap[id];
            if (!rep) return;

            document.getElementById('btn-new-review').style.display = 'block';
            document.getElementById('dashboard-rep-name').textContent = rep.name;
            const dashboardContent = document.getElementById('dashboard-content');
            
            const kpiConfiguration = kpiConfigs[rep.dept] || [];

            if (rep.reviews.length === 0) {
                dashboardContent.innerHTML = `<p class="text-center text-lg text-text-muted mt-10">No review history found for ${rep.name}. Click '+ New Monthly Review' to start.</p>`;
                document.getElementById('chart-section').classList.add('hidden');
                return;
            }

            const sortedReviews = [...rep.reviews].sort((a, b) => new Date(b.date) - new Date(a.date));

            // 1. Generate Review Cards
            dashboardContent.innerHTML = sortedReviews.map(review => {
                const generalComment = review.data['general-comment']?.comment || 'No general summary provided.';
                
                const kpiRows = kpiConfiguration.map(kpi => {
                    const reviewValue = review.data[kpi.id]?.value || 0;
                    const reviewComment = review.data[kpi.id]?.comment || 'No specific comments.';
                    const target = kpi.target;
                    const isTargetMet = kpi.invert 
                        ? (reviewValue <= target) 
                        : (reviewValue >= target); 

                    const statusClass = isTargetMet ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger';
                    const icon = isTargetMet ? '✅' : '❌';

                    let formattedValue = reviewValue;
                    if (kpi.unit === '$') {
                        formattedValue = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(reviewValue);
                    } else if (kpi.unit === '%') {
                        formattedValue = `${reviewValue}%`;
                    } else if (kpi.unit === 'h') {
                        formattedValue = `${reviewValue} hrs`;
                    }


                    return `
                        <div class="flex justify-between items-start py-2 border-b border-color/50">
                            <div class="text-sm font-medium text-text-main w-1/3">${kpi.label}</div>
                            <div class="w-1/3">
                                <span class="text-sm font-semibold p-1 rounded-full ${statusClass}">
                                    ${icon} ${formattedValue}
                                </span>
                            </div>
                            <div class="text-sm text-text-muted italic w-1/3">${reviewComment}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-card p-6 rounded-xl shadow-lg border border-color">
                        <h3 class="text-xl font-semibold mb-4 text-primary">${review.date} Review</h3>
                        <div class="mb-4">
                            ${kpiRows}
                        </div>
                        <div class="pt-4 border-t border-color/50">
                            <p class="text-sm font-semibold mb-1">General Summary:</p>
                            <p class="text-text-main italic">${generalComment}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // 2. Load Chart
            document.getElementById('chart-section').classList.remove('hidden');
            renderPerformanceChart(rep, kpiConfiguration);
        }
        
        function renderPerformanceChart(rep, kpis) {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }

            if (kpis.length === 0) return; 

            const mainKpi = kpis[0]; 
            const reviews = [...rep.reviews].sort((a, b) => new Date(a.date) - new Date(b.date)); 

            const data = {
                labels: reviews.map(r => r.date),
                datasets: [{
                    label: `${mainKpi.label} Trend`,
                    data: reviews.map(r => r.data[mainKpi.id]?.value),
                    borderColor: 'var(--primary)',
                    backgroundColor: 'var(--primary)/20',
                    tension: 0.3,
                    fill: false,
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'Target',
                    data: reviews.map(() => mainKpi.target),
                    borderColor: 'var(--danger)',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0,
                    fill: false
                }]
            };

            myChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: `Monthly Trend for ${mainKpi.label}` }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: mainKpi.max * 1.05, 
                            title: { display: true, text: mainKpi.label }
                        }
                    }
                }
            });
        }
        
        function openCreateReviewModal() {
            if(!currentRepId) {
                showMessage('info', "Please select an employee first before creating a new review.");
                return;
            }
            
            const emp = employeeMap[currentRepId];
            document.getElementById('page-review').classList.remove('active');
            document.getElementById('page-create').classList.add('active');
            document.getElementById('btn-new-review').style.display = 'none';
            document.getElementById('new-review-rep-name').textContent = emp.name;
            
            document.getElementById('form-date').valueAsDate = new Date();
            
            const kpis = kpiConfigs[emp.dept] || kpiConfigs["Sales"];
            
            document.getElementById('form-kpi-inputs').innerHTML = kpis.map(k => {
                const isTargetInverted = k.invert ? ' (Lower is Better)' : '';
                const unit = k.unit || '';
                return `
                    <div>
                        <label class="block text-sm font-medium text-main">${k.label} (Target: ${k.target}${unit}${isTargetInverted})</label>
                        <input type="number" step="0.1" id="kpi-${k.id}" required class="w-full border border-color rounded p-3 mt-1 bg-input text-main focus:ring-primary focus:border-primary transition" placeholder="Enter value (Max: ${k.max})">
                        <label class="block text-sm font-medium text-text-muted mt-2">Comment:</label>
                        <input type="text" id="kpi-${k.id}-comment" class="w-full border border-color rounded p-3 mt-1 bg-input text-main transition" placeholder="Optional comment for this KPI">
                    </div>
                `;
            }).join('');
        }
        
        function saveNewReview() {
            const form = document.getElementById('new-review-form');
            const emp = employeeMap[currentRepId];
            const kpiConfiguration = kpiConfigs[emp.dept] || [];
            
            const newReview = {
                date: form['form-date'].value,
                data: {}
            };

            kpiConfiguration.forEach(kpi => {
                const valueInput = document.getElementById(`kpi-${kpi.id}`);
                const commentInput = document.getElementById(`kpi-${kpi.id}-comment`);

                newReview.data[kpi.id] = {
                    value: parseFloat(valueInput.value),
                    comment: commentInput.value.trim()
                };
            });

            const generalComment = document.getElementById('form-general-comment').value.trim();
            if (generalComment) {
                newReview.data['general-comment'] = { comment: generalComment };
            }

            let isDuplicate = false;
            repData = repData.map(r => {
                if (r.id === currentRepId) {
                    if (!r.reviews.find(rev => rev.date === newReview.date)) {
                        r.reviews.push(newReview);
                    } else {
                        isDuplicate = true;
                    }
                }
                return r;
            });
            
            if (isDuplicate) {
                showMessage('error', `A review for ${newReview.date} already exists for ${emp.name}.`);
                return;
            }

            createEmployeeMap();
            // Note: This only saves locally. A future step would be to call a 'Save Data' flow here.
            showMessage('success', 'Review successfully saved locally!');

            form.reset();
            setTimeout(() => loadRepDashboard(currentRepId), 1500);
        }
        
        function openExportModal() { 
            window.print(); 
        }

        /**
         * The main entry point for the application.
         * @param {boolean} isRefetch - True if this is a refresh call after successful data fetch.
         */
        function initData(isRefetch = false) {
            // On initial page load, fetch data from the flow
            if (!isRefetch) {
                fetchDataFromFlow();
            } else {
                // Once data is available (after successful fetch or fallback)
                createEmployeeMap(); 
                loadRepList();
            }
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', initData);

    </script>
</body>
