<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daytona Manager v7.26 (Templates & Profile Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-app: #f1f5f9; 
            --bg-card: #ffffff; 
            --bg-input: #f8fafc;
            --bg-header: #f8fafc;
            --text-main: #0f172a; 
            --text-muted: #64748b;
            --primary: #2563eb; --primary-fg: #ffffff;
            --accent-danger: #ef4444; --accent-success: #22c55e; --accent-warning: #eab308;
            --border-color: #cbd5e1; 
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 0.5rem; 
            --modal-bg: #ffffff;
        }

        /* DARK THEMES */
        [data-theme="midnight"] { --bg-app: #020617; --bg-card: #1e293b; --bg-input: #334155; --bg-header: #0f172a; --text-main: #f8fafc; --text-muted: #94a3b8; --border-color: #475569; --primary: #38bdf8; --primary-fg: #0f172a; --modal-bg: #1e293b; }
        [data-theme="oled"] { --bg-app: #000000; --bg-card: #171717; --bg-input: #262626; --bg-header: #0a0a0a; --text-main: #ffffff; --text-muted: #a3a3a3; --border-color: #404040; --primary: #facc15; --primary-fg: #000000; --modal-bg: #171717; }
        [data-theme="matt"] { --bg-app: #262626; --bg-card: #404040; --bg-input: #525252; --bg-header: #404040; --text-main: #ffffff; --text-muted: #d4d4d4; --border-color: #737373; --primary: #22d3ee; --primary-fg: #000000; --accent-danger: #fb7185; --accent-warning: #fbbf24; --modal-bg: #404040; }
        
        /* Light Themes */
        [data-theme="forest"] { --bg-app: #ecfdf5; --bg-card: #ffffff; --bg-input: #f0fdf4; --bg-header: #d1fae5; --text-main: #064e3b; --text-muted: #047857; --border-color: #6ee7b7; --primary: #16a34a; --primary-fg: #ffffff; --modal-bg: #ffffff; }
        [data-theme="ocean"] { --bg-app: #f0f9ff; --bg-card: #ffffff; --bg-input: #e0f2fe; --bg-header: #bae6fd; --text-main: #0c4a6e; --text-muted: #0369a1; --border-color: #7dd3fc; --primary: #0284c7; --primary-fg: #ffffff; --modal-bg: #ffffff; }
        [data-theme="sunset"] { --bg-app: #fff7ed; --bg-card: #ffffff; --bg-input: #ffedd5; --bg-header: #fed7aa; --text-main: #7c2d12; --text-muted: #c2410c; --border-color: #fdba74; --primary: #ea580c; --primary-fg: #ffffff; --modal-bg: #ffffff; }
        [data-theme="holiday-cheer"] { --bg-app: #fef2f2; --bg-card: #ffffff; --bg-input: #fee2e2; --bg-header: #fecaca; --text-main: #991b1b; --text-muted: #b91c1c; --border-color: #f87171; --primary: #dc2626; --primary-fg: #ffffff; --modal-bg: #ffffff; }
        [data-theme="winter"] { --bg-app: #eff6ff; --bg-card: #ffffff; --bg-input: #dbeafe; --bg-header: #bfdbfe; --text-main: #1e3a8a; --text-muted: #1d4ed8; --border-color: #60a5fa; --primary: #2563eb; --primary-fg: #ffffff; --modal-bg: #ffffff; }
        [data-theme="harvest"] { --bg-app: #fffbeb; --bg-card: #ffffff; --bg-input: #fef3c7; --bg-header: #fde68a; --text-main: #78350f; --text-muted: #92400e; --border-color: #f59e0b; --primary: #d97706; --primary-fg: #ffffff; --modal-bg: #ffffff; }

        /* GLOBAL */
        body { font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); padding: 0.5rem 1rem; height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: background 0.3s ease; }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 0.75rem; }
        .card-header { font-weight: 600; border-bottom: 1px solid var(--border-color); padding: 0.5rem 0.75rem; display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-header); border-radius: var(--radius) var(--radius) 0 0; color: var(--text-main); }
        
        /* INPUTS */
        input, select, textarea { 
            background-color: var(--bg-input) !important; 
            border: 1px solid var(--border-color) !important; 
            color: var(--text-main) !important; 
            border-radius: 0.375rem; 
            padding: 0.5rem; 
            width: 100%; 
            font-size: 0.875rem; 
            box-sizing: border-box; 
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary) !important; }
        input:disabled, select:disabled, textarea:disabled { opacity: 0.6; cursor: not-allowed; background-color: rgba(0,0,0,0.05) !important; }
        [data-theme="midnight"] input, [data-theme="oled"] input, [data-theme="matt"] input { color-scheme: dark; }

        .btn-primary { background: var(--primary); color: var(--primary-fg); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; border: none; }
        .btn-secondary { background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; }
        .btn-secondary:hover { background-color: rgba(0,0,0,0.05); }

        /* FILTER PILLS */
        .filter-pills { display: flex; gap: 0.5rem; align-items: center; overflow-x: auto; padding-bottom: 2px; }
        .filter-pill-label { cursor: pointer; font-size: 0.75rem; font-weight: 600; padding: 4px 12px; border-radius: 999px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-muted); transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
        .filter-pill-input { display: none; }
        .filter-pill-input:checked + .filter-pill-label { background-color: var(--primary); color: var(--primary-fg); border-color: var(--primary); }
        .filter-pill-label:hover { border-color: var(--primary); opacity: 0.9; }

        /* LAYOUT */
        .app-grid { display: grid; grid-template-columns: 350px 1fr; gap: 1rem; flex-grow: 1; overflow: hidden; width: 100%; max-width: 100%; }
        .col-left { display: grid; grid-template-rows: 40% 1fr; gap: 1rem; height: 100%; min-height: 0; overflow: hidden; min-width: 0; }
        .col-right { display: flex; flex-direction: column; gap: 0.75rem; height: 100%; overflow: hidden; min-width: 0; }
        .col-right .card.workspace { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; }
        
        .notes-container { display: flex; flex-direction: column; height: 100%; min-height: 0; overflow: hidden; }
        .note-textarea { width: 100%; resize: none; overflow-y: auto; min-height: 0; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.5rem; white-space: pre-wrap; font-family: monospace; color: var(--text-main); }
        .editable-field.is-editable, .note-textarea.is-editable { background-color: var(--bg-card) !important; border: 2px solid var(--accent-warning) !important; color: var(--text-main) !important; }
        .editable-field { background: transparent !important; border: 1px solid transparent !important; padding: 0.25rem 0.5rem; transition: all 0.3s; }

        /* GALLERY & INDICATORS */
        .gallery-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; padding: 2px; }
        .gallery-item { padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .gallery-item:hover { border-color: var(--primary); }
        .gallery-item.is-selected { border-color: var(--primary); background: var(--primary); color: var(--primary-fg); }
        .gallery-item.is-selected * { color: var(--primary-fg) !important; }
        .gallery-item-id { color: var(--primary); font-weight: 700; font-size: 0.9rem; } 
        .gallery-item-company { color: var(--text-main); font-weight: 600; font-size: 0.85rem; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sent-indicator { display: none; font-size: 0.7rem; color: var(--accent-success); margin-left: 0.5rem; }
        .gallery-item.has-sent-email .sent-indicator { display: inline-block; }
        .gallery-item.is-selected .sent-indicator { color: white !important; }

        /* NOTE HISTORY CARDS & AI BOXES */
        .ai-box { padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 0.375rem; border-left: 4px solid; background: var(--bg-card); border: 1px solid var(--border-color); border-left-width: 4px; }
        .ai-header { font-weight: 700; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem; }
        .ai-imp { border-left-color: var(--accent-danger); } .ai-imp .ai-header { color: var(--accent-danger); }
        .ai-mgr { border-left-color: var(--accent-success); } .ai-mgr .ai-header { color: var(--accent-success); }
        .ai-key { border-left-color: var(--primary); } .ai-key .ai-header { color: var(--primary); }

        .note-card { margin-bottom: 0.75rem; border-radius: 0.375rem; border: 1px solid var(--border-color); background-color: var(--bg-card); box-shadow: var(--shadow); overflow: hidden; }
        .note-card-header { padding: 0.5rem; background-color: var(--bg-header); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .note-card-body { padding: 0.75rem; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; font-family: 'Segoe UI', sans-serif; color: var(--text-main); line-height: 1.5; }

        /* SCROLL FIX FOR PREVIEW */
        #qb-notes-preview { 
            flex: 1; 
            border: 1px solid var(--border-color); 
            border-radius: 0.375rem; 
            background-color: var(--bg-input); 
            padding: 0.75rem; 
            overflow-y: auto; 
            min-height: 0; 
            height: 100%; 
            color: var(--text-main); 
        }

        /* ANIMATIONS */
        #global-loader { position: fixed; inset: 0; background-color: var(--bg-app); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; color: var(--text-main); }
        .loader-dot { animation: bounce 1.4s infinite ease-in-out both; background-color: var(--primary); border-radius: 50%; display: inline-block; height: 15px; width: 15px; margin: 0 3px; }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; background-color: var(--primary); }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; background-color: var(--accent-warning); }
        .loader-dot:nth-child(3) { animation-delay: 0s; background-color: var(--accent-danger); }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* MISC UI */
        .note-collapse-wrapper { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.4s ease; padding: 0; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 0.375rem; margin-top: 0.5rem; }
        .note-collapse-wrapper.open { max-height: 200px; opacity: 1; padding: 10px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.hidden { display: none !important; }
        .modal-content { background: var(--modal-bg); color: var(--text-main); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 0.5rem; max-width: 500px; width: 100%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.25); }
        
        #email-modal-content { max-width: 1600px; width: 90%; height: 90vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: var(--bg-card); border: 3px solid var(--border-color); }
        .email-modal-header { background: var(--bg-header); border-bottom: 1px solid var(--border-color); color: var(--text-main); padding: 1rem; }
        
        .email-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; height: 100%; overflow: hidden; padding: 1.5rem; }
        .email-left { display: flex; flex-direction: column; gap: 1rem; height: 100%; overflow: hidden; overflow-y: auto; }
        .email-body-container { flex-grow: 1; display: flex; flex-direction: column; min-height: 300px; }
        
        /* RICH TEXT EDITOR */
        #email-modal-body { flex-grow: 1; resize: none; height: 100%; overflow-y: auto !important; border: 1px solid var(--border-color); background-color: var(--bg-input); padding: 10px; outline: none; white-space: pre-wrap; color: var(--text-main); }
        #email-modal-body:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); border-color: var(--primary); }
        #email-modal-body img { max-width: 100%; height: auto; display: block; margin: 0.5rem 0; cursor: pointer; }
        
        /* EMAIL TOOLBAR */
        .email-toolbar { display: flex; gap: 0.5rem; padding: 0.5rem; background: var(--bg-header); border: 1px solid var(--border-color); border-bottom: none; border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem; flex-wrap: wrap; }
        .toolbar-btn { background: var(--bg-card); border: 1px solid var(--border-color); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; color: var(--text-main); }
        .toolbar-btn:hover { background: var(--bg-input); }
        
        .email-footer { flex-shrink: 0; margin-top: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .email-right { height: 100%; overflow: hidden; }
        .email-preview-pane { border: 3px solid var(--border-color); background: white; color: black; padding: 2rem; overflow-y: auto; height: 100%; border-radius: 0.375rem; font-family: 'Segoe UI', sans-serif; }

        /* THEME MENU */
        .theme-dropdown { position: relative; display: inline-block; }
        .theme-menu-content { display: none; position: absolute; right: 0; top: 100%; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; z-index: 50; min-width: 180px; box-shadow: var(--shadow); }
        .theme-menu-content.show { display: block; }
        .theme-option { padding: 0.5rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .theme-option:hover { background: var(--bg-input); }
        .theme-swatch { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #ccc; }

        /* PROGRESS BAR */
        .progress-container { width: 100%; background-color: var(--bg-input); border-radius: 999px; height: 8px; overflow: hidden; margin-top: 5px; border: 1px solid var(--border-color); }
        .progress-bar { height: 100%; width: 0%; transition: width 0.5s ease, background-color 0.5s ease; }
        .bar-green { background-color: #22c55e; }
        .bar-yellow { background-color: #eab308; }
        .bar-red { background-color: #ef4444; }

        /* ALERT BUTTONS */
        .btn-alert-base { font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease; border: 2px solid transparent; position: relative; overflow: hidden; }
        .btn-has-data-red { color: #dc2626 !important; background: #fee2e2 !important; border: 1px solid #dc2626; animation: pulse-red 2s infinite; }
        .btn-has-data-yellow { color: #ca8a04 !important; background: #fef9c3 !important; border: 1px solid #ca8a04; animation: pulse-yellow 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(202, 138, 4, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(202, 138, 4, 0); } 100% { box-shadow: 0 0 0 0 rgba(202, 138, 4, 0); } }
    </style>
</head>
<body class="p-0 md:p-4">

    <div id="global-loader" style="display:flex;">
        <div class="mb-4"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div>
        <h2 class="text-lg font-bold">Loading...</h2>
    </div>

    <div id="login-container" class="modal-overlay hidden" style="display:none;">
        <div class="modal-content text-center">
            <i class="fas fa-lock text-4xl mb-4" style="color: var(--primary);"></i>
            <h2 class="text-2xl font-bold mb-2">Daytona Utility</h2>
            <p class="mb-6 text-sm opacity-80">Sign in to manage your accounts.</p>
            <button onclick="window.login()" id="login-button" class="btn-primary w-full text-lg py-3">Sign in with Microsoft</button>
            <p id="login-error" class="text-red-500 mt-4 text-sm hidden"></p>
        </div>
    </div>

    <div id="main-app-container" class="hidden flex flex-col h-full" style="display:none;">
        <div class="card mb-3 p-3 flex flex-wrap items-center justify-between gap-4 shrink-0" id="header-panel">
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <h1 class="text-xl font-bold flex items-center gap-2" style="color: var(--primary);">
                        <i id="header-icon" class="fas fa-list-ul"></i> My Accounts
                    </h1>
                </div>
                <button onclick="window.loadRecords()" class="btn-primary text-xs">Refresh</button>
                <div class="flex items-center gap-2 ml-2 pl-4 border-l" style="border-color: var(--border-color)">
                    <span id="welcome-message" onclick="window.showUserProfileCard()" class="text-sm font-medium cursor-pointer hover:text-blue-600" title="View Profile"></span>
                    <button onclick="window.promptAdminLogin()" class="hover:text-brand transition-colors" style="color: var(--text-muted);" title="Admin Override"><i class="fas fa-user-lock"></i></button>
                </div>
            </div>
            
            <div class="flex-grow max-w-md mx-4">
                <label for="search-bar" class="sr-only">Search Accounts</label>
                <input type="text" id="search-bar" onkeyup="window.filterAndSortGallery()" placeholder="Search accounts..." class="text-sm" />
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex flex-col justify-center h-full mr-2">
                    <div class="flex justify-between w-[100px] text-[9px] font-bold text-gray-500 mb-0.5">
                        <span>EMAILS</span>
                        <span id="header-email-counter">0/100</span>
                    </div>
                    <div class="progress-container" style="height:4px; width:100px; margin:0; border:1px solid #cbd5e1;">
                         <div id="header-progress-bar" class="progress-bar bar-green"></div>
                    </div>
                </div>

                <div class="theme-dropdown">
                    <button onclick="window.toggleThemeMenu()" id="theme-toggle-btn" class="btn-secondary text-xs flex items-center gap-2"><i class="fas fa-palette"></i> Theme</button>
                    <div id="theme-menu" class="theme-menu-content"></div>
                </div>
                
                <label for="sort-dropdown" class="sr-only">Sort</label>
                <select id="sort-dropdown" onchange="window.filterAndSortGallery()" class="text-xs w-40">
                    <option value="company-asc">Sort: Company A-Z</option>
                    <option value="days-desc">Days Since Order &#x2193;</option>
                    <option value="followup-asc">Follow Up (Oldest)</option>
                    <option value="followup-desc">Follow Up (Newest)</option>
                    <option value="rep-asc">Rep A-Z</option>
                </select>

                <label for="filter-action-dropdown" class="sr-only">Filter Action</label>
                <select id="filter-action-dropdown" onchange="window.filterAndSortGallery()" class="text-xs w-40" disabled><option value="">Filter: All Actions</option></select>
            </div>

            <div class="w-full flex justify-end gap-2 text-xs border-t pt-2 mt-1 filter-pills" style="border-color: var(--border-color)">
                 <label class="cursor-pointer select-none"><input type="checkbox" id="filter-followup" class="filter-pill-input" onchange="window.filterAndSortGallery()"><span class="filter-pill-label"><i class="fas fa-clock"></i> Follow Ups</span></label>
                 <label class="cursor-pointer select-none"><input type="checkbox" id="filter-nonotes" class="filter-pill-input" onchange="window.filterAndSortGallery()"><span class="filter-pill-label"><i class="fas fa-sticky-note"></i> No Notes</span></label>
                 <label class="cursor-pointer select-none"><input type="checkbox" id="filter-norecent" class="filter-pill-input" onchange="window.filterAndSortGallery()"><span class="filter-pill-label"><i class="fas fa-history"></i> No Recent (>14d)</span></label>
                 <label class="cursor-pointer select-none"><input type="checkbox" id="filter-requests" class="filter-pill-input" onchange="window.filterAndSortGallery()"><span class="filter-pill-label"><i class="fas fa-tasks"></i> Button Req.</span></label>
                 <label class="cursor-pointer select-none"><input type="checkbox" id="filter-hidesent" class="filter-pill-input" onchange="window.filterAndSortGallery()"><span class="filter-pill-label"><i class="fas fa-eye-slash"></i> Hide Sent</span></label>
            </div>
        </div>

        <div class="app-grid">
            <div class="col-left">
                <div class="card flex flex-col min-h-0 overflow-hidden">
                    <div class="card-header"><span>Account List</span><span id="record-count" class="text-xs px-2 py-0.5 rounded text-white" style="background-color: var(--primary);">0</span></div>
                    <div id="record-gallery-list" class="gallery-list"><div class="text-center p-4 text-xs text-muted italic">Records not loaded.</div></div>
                </div>
                
                <div class="card flex flex-col min-h-0 p-3 overflow-hidden">
                    <div class="flex items-center justify-between mb-3 border-b pb-2" style="border-color: var(--border-color)">
                        <div class="flex flex-col overflow-hidden mr-2">
                             <h3 class="font-bold text-sm" style="color: var(--primary);">Sales Snapshot</h3>
                             <span id="sales-customer-name" class="text-xs font-medium mt-1 truncate text-main" style="color: var(--text-main);">--</span>
                        </div>
                        <div class="text-right flex flex-col flex-shrink-0">
                             <span class="text-[10px] uppercase tracking-wider font-bold" style="color: var(--text-muted);">3-Mo Total</span>
                             <span id="sales-ytd" class="font-extrabold text-xl" style="color: var(--accent-success);">--</span>
                        </div>
                    </div>
                    <div id="sales-account-info" class="hidden mb-3 p-2 rounded border text-xs space-y-1" style="background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-main);"></div>
                    
                    <div id="sales-loader" class="hidden flex justify-center py-6">
                        <div class="loader-dot" style="width:10px; height:10px;"></div><div class="loader-dot" style="width:10px; height:10px;"></div><div class="loader-dot" style="width:10px; height:10px;"></div>
                    </div>
                    
                    <div id="sales-content" class="hidden flex-grow overflow-y-auto min-h-0">
                        <h4 class="text-[10px] font-bold uppercase mb-2 tracking-wide" style="color: var(--text-muted);">Category Breakdown</h4>
                        <ul id="sales-category-list" class="text-xs space-y-2"></ul>
                    </div>
                    <div id="sales-placeholder" class="text-xs text-center py-8 flex flex-col items-center justify-center gap-2" style="color: var(--text-muted);">
                        <span class="italic">Select an account to view sales.</span>
                    </div>
                    <div class="text-center pt-2 border-t mt-auto text-xs" style="border-color: var(--border-color); color: var(--text-muted);"><span id="clock-display">--:-- --</span></div>
                </div>
            </div>

            <div class="col-right">
                <div class="card p-3" id="contact-sticky-header">
                    <div class="card-header mt-0 pt-0 px-0 pb-2 mb-2">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span><i id="profile-icon" class="fas fa-user-circle mr-2" style="color: var(--primary);"></i>Profile: <span id="acct-number-header" class="font-bold" style="color: var(--text-color);">--</span></span>
                            <span id="profile-sent-badge" class="hidden bg-green-100 text-green-700 text-[10px] px-2 rounded-full font-bold border border-green-200"><i class="fas fa-check"></i> Email Sent Today</span>
                        </div>
                        <div class="flex gap-2">
                            <div id="save-controls" class="hidden gap-2 mr-4 border-r pr-4" style="border-color: var(--border-color)">
                                <button onclick="window.handleCustomSave()" class="btn-primary text-xs py-1">Save</button>
                                <button onclick="window.handleCustomReset()" class="btn-secondary text-xs py-1">Cancel</button>
                            </div>
                            <button onclick="window.showAdvisory()" id="btn-account-alerts" class="hidden btn-secondary text-xs px-2 rounded">Alerts</button>
                            <button onclick="window.toggleEditMode()" id="editModeButton" class="btn-secondary text-xs py-1 ml-2" disabled>Edit Profile</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 text-sm mb-2">
                        <div><label for="contact-name-most" class="text-[10px] uppercase block" style="color: var(--text-muted);">Primary Contact</label><input type="text" id="contact-name-most" class="editable-field" disabled></div>
                        <div><label for="contact-name-latest" class="text-[10px] uppercase block" style="color: var(--text-muted);">Recent Contact</label><input type="text" id="contact-name-latest" class="editable-field" disabled></div>
                        <div><label for="contact-phone-primary" class="text-[10px] uppercase block" style="color: var(--text-muted);">Phone</label><input type="text" id="contact-phone-primary" class="editable-field" disabled></div>
                        <div><label for="contact-email-most" class="text-[10px] uppercase block font-bold text-blue-600" style="color: var(--primary);">*Email (Required)</label><input type="email" id="contact-email-most" class="editable-field font-bold" disabled></div>
                        <div class="hidden"><input type="email" id="contact-email-latest"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-xs pt-1 border-t" style="border-color: var(--border-color);">
                        <div class="min-w-0"><span class="uppercase font-bold block truncate" style="color: var(--text-muted);">Company:</span> <span id="acct-company" class="font-medium truncate block">--</span></div>
                        <div class="min-w-0"><span class="uppercase font-bold block truncate" style="color: var(--text-muted);">Action:</span> <span id="acct-action" class="font-medium truncate block">--</span></div>
                        <div class="min-w-0"><span class="uppercase font-bold block truncate" style="color: var(--text-muted);">Message:</span> <span id="acct-action-message" class="font-medium truncate block">--</span></div>
                    </div>
                </div>

                <div class="card workspace p-0 flex flex-col overflow-hidden">
                    <div class="card-header p-3 border-b flex-shrink-0">
                        <div class="flex items-center gap-4 w-full justify-between">
                            <div class="flex items-center gap-2">
                                <label for="follow-up-date" class="sr-only">Date</label>
                                <input type="date" id="follow-up-date" class="text-xs w-32" disabled>
                                <label for="follow-up-time" class="sr-only">Time</label>
                                <input type="time" id="follow-up-time" class="text-xs w-28" disabled>
                                <button onclick="window.createCalendarEvent()" class="btn-primary text-xs px-2 py-1" aria-label="Add to Calendar"><i class="fas fa-calendar-plus"></i></button>
                            </div>
                            <div class="flex gap-2 flex-grow max-w-md">
                                <label for="email-template-dropdown" class="sr-only">Template</label>
                                <select id="email-template-dropdown" class="text-xs flex-grow" disabled></select>
                                <button onclick="window.launchEmailLogic()" id="launch-email-button" class="btn-secondary text-xs px-3" disabled aria-label="Open Email"><i class="fas fa-paper-plane"></i></button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.toggleInternalNote()" id="help-button" class="btn-secondary text-xs px-2" style="border-color: #93c5fd; color: #2563eb;" disabled>Help / Note</button>
                                <button onclick="window.handleActionButtonClick('No Opp')" id="noopp-button" class="btn-secondary text-xs px-2" style="border-color: #d8b4fe; color: #9333ea;" disabled>No Opp</button>
                                <button onclick="window.handleActionButtonClick('CloseAccount')" id="close-button" class="btn-secondary text-xs px-2" style="border-color: #fca5a5; color: #dc2626;" disabled>Close</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow p-4 overflow-hidden">
                        <div class="grid grid-cols-2 gap-6 h-full">
                            <div class="notes-container relative flex flex-col gap-2 h-full">
                                <div class="flex flex-col flex-grow h-full min-h-0">
                                    <div class="flex justify-between items-center mb-1 flex-shrink-0">
                                        <label for="qb-notes-input" class="text-xs font-bold" style="color: var(--text-muted);">General Note</label>
                                        <button onclick="window.insertTemplate()" class="text-sm font-bold text-blue-500 hover:underline">+ Template</button>
                                    </div>
                                    <textarea id="qb-notes-input" oninput="window.updateNotesPreview()" class="note-textarea w-full p-3 text-sm font-mono rounded border flex-grow" disabled></textarea>
                                </div>
                                <div id="internal-note-wrapper" class="note-collapse-wrapper">
                                    <label for="internal-note-input" class="text-[10px] uppercase font-bold block mb-1" style="color: var(--text-muted);">Internal / Specialty Note (To Manager)</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="internal-note-input" class="text-sm flex-grow border p-1 rounded" placeholder="Type message for help/manager...">
                                        <button onclick="window.sendInternalNote()" class="btn-primary text-xs px-3">Send</button>
                                    </div>
                                </div>
                            </div>
                            <div class="notes-container">
                                <div class="flex justify-between items-center mb-1 flex-shrink-0">
                                    <label class="text-xs font-bold" style="color: var(--text-muted);">History & Preview</label>
                                    <div class="flex gap-2 text-xs">
                                        <label class="cursor-pointer flex items-center gap-1 select-none"><input type="checkbox" id="show-ai-summary" checked onchange="window.toggleNoteView(this.id)"> AI</label>
                                        <label class="cursor-pointer flex items-center gap-1 select-none"><input type="checkbox" id="show-new-note" checked onchange="window.updateNotesPreview()"> New</label>
                                        <label class="cursor-pointer flex items-center gap-1 select-none"><input type="checkbox" id="show-prev-note" onchange="window.toggleNoteView(this.id)"> Prev</label>
                                    </div>
                                </div>
                                <div id="qb-notes-preview">
                                    <div class="text-center italic mt-10" style="color: var(--text-muted);">Select an account.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal-overlay hidden" style="display:none; z-index: 1000;">
        <div id="email-modal-content" class="modal-content bg-white" style="background-color: rgba(176, 182, 184, 1); border: 3px solid rgba(214, 221, 224, 1);">
            <div class="bg-gray-500 p-3 text-white font-bold text-lg text-center border-b-2 border-gray-300 flex justify-between items-center email-modal-header">
                <span>Action Email Screen</span>
                <button onclick="document.getElementById('email-modal').classList.add('hidden'); document.getElementById('email-modal').style.display = 'none';" class="text-yellow-300 hover:text-white font-bold px-2">Close X</button>
            </div>
            <div class="email-grid">
                <div class="email-left">
                    <div class="email-inputs">
                        <div><label for="email-modal-to" class="block text-white font-bold italic underline mb-1 text-sm">*To</label><input type="text" id="email-modal-to" class="w-full p-2 rounded border-2 border-gray-300 font-semibold text-green-700"></div>
                        <div><label for="email-modal-subject" class="block text-white font-bold italic underline mb-1 text-sm">*Subject</label><input type="text" id="email-modal-subject" class="w-full p-2 rounded border-2 border-gray-300 font-semibold text-green-700"></div>
                    </div>
                    <div class="email-body-container">
                        <label class="block text-white font-bold italic underline mb-1 text-sm">Email Body (Drag & Drop Images Here)</label>
                        <div class="email-toolbar">
                            <button class="toolbar-btn" onclick="document.execCommand('bold',false,null)"><b>B</b></button>
                            <button class="toolbar-btn" onclick="document.execCommand('italic',false,null)"><i>I</i></button>
                            <button class="toolbar-btn" onclick="document.execCommand('underline',false,null)"><u>U</u></button>
                            <input type="color" onchange="document.execCommand('foreColor',false,this.value)" style="height:24px;width:24px;border:none;cursor:pointer;">
                        </div>
                        <div id="email-modal-body" contenteditable="true" oninput="window.updateEmailPreview()" class="w-full p-3 rounded-b border-2 border-t-0 border-gray-300 font-semibold text-green-700 shadow-inner"></div>
                    </div>
                    
                    <div class="email-footer text-center pt-4 border-t mt-2">
                         <div class="flex justify-between items-center mb-2">
                             <p id="email-limit-counter" class="text-xs text-gray-300 font-mono"></p>
                             <div class="progress-container w-1/3"><div id="email-progress-bar" class="progress-bar bar-green"></div></div>
                         </div>
                         <button id="email-modal-btn" onclick="window.handleModalSend()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded shadow-lg w-full text-lg flex items-center justify-center gap-2">
                             <i class="fas fa-paper-plane"></i> Send Email via Flow
                         </button>
                    </div>
                </div>
                <div class="email-right h-full"><div id="email-modal-preview" class="email-preview-pane"></div></div>
            </div>
        </div>
    </div>
    
    <div id="profile-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')" style="display:none; z-index: 70;">
        <div class="modal-content max-w-md p-0 overflow-hidden relative">
            <div class="bg-gradient-to-r from-blue-600 to-blue-400 h-24 relative">
                <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="px-6 pb-6 text-center">
                <div class="relative -mt-12 mb-4"><div class="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center text-4xl text-blue-500 shadow-lg border-4 border-white"><i class="fas fa-user"></i></div></div>
                <h3 id="popout-name" class="text-2xl font-bold text-gray-800">--</h3>
                <p id="popout-title" class="text-sm text-gray-500 mb-4 uppercase tracking-wide">--</p>
                <div class="grid grid-cols-2 gap-4 text-left bg-gray-50 p-4 rounded-lg text-sm border border-gray-100 mt-4">
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Department</span><span id="popout-department" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Location</span><span id="popout-location" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Manager</span><span id="popout-manager" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Secondary</span><span id="popout-secondary-manager" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Sr. Manager</span><span id="popout-sr-manager" class="font-semibold">--</span></div>
                    <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Director</span><span id="popout-supervisor" class="font-semibold">--</span></div>
                    <div class="col-span-2 border-t pt-2 mt-1"><span class="block text-[10px] font-bold text-gray-400 uppercase">Gold Star</span><span id="popout-gold-star">--</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-modal" class="modal-overlay hidden" style="display:none;"><div class="modal-content"><h3 class="text-lg font-bold mb-2">Admin</h3><input type="password" id="admin-password" class="mb-3" placeholder="Password"><div id="admin-rep-input" class="hidden mb-3"><input type="text" id="override-rep-name" placeholder="Rep Name"></div><div class="flex justify-end gap-2"><button onclick="window.closeAdminModal()" class="btn-secondary text-xs">Cancel</button><button onclick="window.checkAdminPassword()" id="admin-action-btn" class="btn-primary text-xs">Authenticate</button></div></div></div>
    <div id="notification-modal" class="modal-overlay hidden" style="display:none;"><div class="modal-content text-center max-w-xs"><h3 id="notification-title" class="text-lg font-bold mb-2">Notice</h3><p id="notification-message" class="text-sm mb-4"></p><button onclick="window.closeNotification()" class="btn-primary w-full">OK</button></div></div>
    
    <div id="advisory-modal" class="modal-overlay hidden" style="display:none; z-index: 75;">
        <div class="modal-content max-w-2xl border-t-4 border-blue-600">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-gray-800"><i class="fas fa-bell text-blue-600 mr-2"></i>Account Advisory</h3><button onclick="window.closeAdvisory()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
            <div id="advisory-content" class="space-y-4 max-h-[60vh] overflow-y-auto p-1"></div>
            <button onclick="window.closeAdvisory()" class="btn-primary w-full mt-4">Acknowledge</button>
        </div>
    </div>
    
    <div id="welcome-toast" class="fixed bottom-5 right-5 z-50 hidden transition-all duration-500 transform translate-y-full opacity-0"><div class="bg-white border-l-4 border-blue-500 shadow-2xl rounded p-4 max-w-xs"><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-blue-800">Welcome! ðŸš€</h4><button onclick="window.dismissWelcome()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><p class="text-xs text-gray-600 mb-2">1. Sign in<br>2. Click Refresh<br>3. Select Account</p><button onclick="window.dismissWelcome()" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded hover:bg-blue-200 w-full">Got it</button></div></div>

    <script>
        // CONFIG
        const msalConfig = { auth: { clientId: "afe649b6-9c70-4b1a-8592-78588284c8ee", authority: "https://login.microsoftonline.com/9a7c474b-f702-4ae4-a2f9-b72a1e117401", redirectUri: "https://WB-DT.github.io/daytona-utility/" }, cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false } };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null;

        // GLOBALS
        const GET_MY_RECORDS_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2d5cc7c0ffa34dcb87e6416df29b9acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8qFD-lNiuxDgafyu31UYZ8zzePJMRJ4wpUzLzbb9bMs";
        const PATCH_RECORD_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/774bb53ee87542e5825b46958f5bd55d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EbaJTl1gKlG8rjTn3ZmoLwUiQ430Sju1kWZYZ6hr0zE";
        const SALES_DATA_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a6f98d7dcf0434fa630e691778901bf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=me09n4bmICH84IIjEV0BDzCIeLfhoFdy5f7hB2AEDOw";
        const ACTION_BUTTON_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a2fa2c69f1d24a85a980599d21631808/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aSQ1J4-BFNxrOURAp3-8tCQwunP0JITYHZfWV5BbDYI";
        const SEND_EMAIL_FLOW_URL = "https://e25b831597b0e29e9b9b7f764adfe8.0f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/dd21e6714c204213b54e1fac2065b9ca/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=1vZTb9PuSi5SC6Q3_af9YNiuLxLDYcBPqCfOVDFFftA"; 
        
        const EMAIL_LIMIT_PER_HOUR = 100;
        const QB_NOTES_TEMPLATE = `Locations: \nNumber of employees: \nCurrent Vendors: \nFrequency of Orders: \nMonthly spend: \nAnyone involved: \nNext Order Expected: \nOPP: \n`;
        const STANDARD_ACTIONS = ['Cadence'];
        const CUSTOM_FLOW_ACTIONS = ["Automotive", "Blizzard Water", "Category", "Chair Mat Contest", "Intro", "NONBUY", "NOVNoSales", "OCTNoSales", "Prospecting"];
        const THEMES = [
            {name:'Modern',id:'modern',color:'#2563eb'},{name:'Midnight',id:'midnight',color:'#0f172a'},{name:'OLED',id:'oled',color:'#000000'},
            {name:'Forest',id:'forest',color:'#16a34a'},{name:'Ocean',id:'ocean',color:'#0ea5e9'},{name:'Sunset',id:'sunset',color:'#ea580c'},{name:'Cyberpunk',id:'cyber',color:'#d946ef'},
            {name:'Holiday Cheer',id:'holiday-cheer',color:'#dc2626'},{name:'Winter Wonderland',id:'winter',color:'#3b82f6'},{name:'Harvest',id:'harvest',color:'#d97706'},
            {name:"Matt's Theme",id:'matt',color:'#f97316'}
        ];
        const IMG_10_OFF = "https://raw.githubusercontent.com/WB-DT/daytona-utility/refs/heads/main/WB%2010%20off.png";
        const IMG_15_OFF = "https://raw.githubusercontent.com/WB-DT/daytona-utility/refs/heads/main/WB%2015%20Off.png";
        const IMG_SIG = "https://raw.githubusercontent.com/WB-DT/daytona-utility/refs/heads/main/WB%20Cold%20and%20FLU.jpg";
        const IMG_CHAIR = "https://raw.githubusercontent.com/WB-DT/daytona-utility/refs/heads/main/WB%20Chair%20Mat.png"; 

        let currentThemeIdx=0, isEditMode=false, allRecords=[], currentSelectedRecord=null, currentRecordId=null, currentUserRepName=null, currentUserProfile=null;
        
        // --- HELPERS ---
        window.getVal = function(obj, k) { return (obj && obj[k] != null) ? obj[k] : ''; }
        window.escapeHTML = function(str) { if (!str) return ''; return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'})[m]); }
        window.getElementValue = function(id) { const el=document.getElementById(id); return el ? (el.value?.trim()??el.textContent?.trim()??null) : null; }
        window.showNotification = function(t, m) { const el=document.getElementById('notification-modal'); if(el){ document.getElementById('notification-title').innerText=t; document.getElementById('notification-message').innerText=m; el.classList.remove('hidden'); el.style.display = 'flex'; } }
        window.closeNotification = function() { const el=document.getElementById('notification-modal'); el.classList.add('hidden'); el.style.display = 'none'; }
        
        window.updateTheme = function(idx) { 
             if(!THEMES[idx]) return; 
             document.body.setAttribute('data-theme', THEMES[idx].id); 
             const star = document.getElementById('popout-gold-star');
             const hdr = document.getElementById('header-icon');
             if(THEMES[idx].id === 'matt') {
                 if(star && !star.innerHTML.includes('paw')) star.innerHTML += ' <i class="fas fa-paw ml-2 text-orange-500"></i>';
                 if(hdr) { hdr.classList.remove('fa-list-ul'); hdr.classList.add('fa-cat'); }
             } else {
                 if(hdr) { hdr.classList.add('fa-list-ul'); hdr.classList.remove('fa-cat'); }
             }
        }
        
        window.toggleThemeMenu = function() { const m=document.getElementById('theme-menu'); m.classList.toggle('show'); if(m.innerHTML.trim()===''){ THEMES.forEach((t,i)=>{ const d=document.createElement('div'); d.className='theme-option'; d.onclick=()=>{ window.updateTheme(i); document.getElementById('theme-menu').classList.remove('show'); }; d.innerHTML=`<div class="theme-swatch" style="background-color:${t.color}"></div><span>${t.name}</span>`; document.getElementById('theme-menu').appendChild(d); }); } }
        window.onclick = function(event) { if (!event.target.matches('#theme-toggle-btn') && !event.target.closest('#theme-toggle-btn')) { document.getElementById('theme-menu').classList.remove('show'); } }
        window.startClock = function() { setInterval(() => { const el = document.getElementById('clock-display'); if(el) el.innerText = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString(); }, 1000); }
        
        window.checkFirstRun = function() { const last = localStorage.getItem('hasSeenWelcome_v4'); const now = new Date(); const cur = `${now.getFullYear()}-${now.getMonth()+1}`; if (last !== cur) { setTimeout(() => { const t = document.getElementById('welcome-toast'); if(t){ t.classList.remove('hidden'); t.style.display='flex'; setTimeout(()=>t.classList.add('show'),100);} }, 1500); } }
        window.dismissWelcome = function() { const t = document.getElementById('welcome-toast'); if(t) { t.classList.remove('show'); setTimeout(()=> { t.classList.add('hidden'); t.style.display='none'; },500); } const now = new Date(); localStorage.setItem('hasSeenWelcome_v4', `${now.getFullYear()}-${now.getMonth()+1}`); }
        
        window.checkEmailRateLimit = function() {
             const now = Date.now();
             let timestamps = JSON.parse(localStorage.getItem('daytona_email_timestamps') || '[]');
             timestamps = timestamps.filter(ts => (now - ts) < 3600000);
             localStorage.setItem('daytona_email_timestamps', JSON.stringify(timestamps));
             
             const count = timestamps.length;
             const pct = Math.min((count / EMAIL_LIMIT_PER_HOUR) * 100, 100);
             
             const counterEl = document.getElementById('email-limit-counter');
             if(counterEl) { counterEl.innerText = `Sent (1h): ${count}/${EMAIL_LIMIT_PER_HOUR}`; }
             
             const headerCounter = document.getElementById('header-email-counter');
             if(headerCounter) { headerCounter.innerText = `${count}/${EMAIL_LIMIT_PER_HOUR}`; if(count >= EMAIL_LIMIT_PER_HOUR) headerCounter.classList.add('text-red-600', 'font-bold'); else headerCounter.classList.remove('text-red-600', 'font-bold'); }

             const bars = [document.getElementById('email-progress-bar'), document.getElementById('header-progress-bar')];
             bars.forEach(bar => { if(bar) { bar.style.width = `${pct}%`; bar.className = 'progress-bar'; if(count >= 95) bar.classList.add('bar-red'); else if(count >= 80) bar.classList.add('bar-yellow'); else bar.classList.add('bar-green'); } });
             
             const btn = document.getElementById('email-modal-btn');
             if(btn) { if(count >= EMAIL_LIMIT_PER_HOUR) { btn.disabled = true; btn.innerText = "Limit Reached"; btn.classList.add('opacity-50', 'cursor-not-allowed'); } else { btn.disabled = false; btn.innerText = "Send via Flow"; btn.classList.remove('opacity-50', 'cursor-not-allowed'); } }

             if (count >= EMAIL_LIMIT_PER_HOUR) return false;
             return true;
        }
        
        window.markEmailSentForRecord = function(recordId) {
            let sentRecs = JSON.parse(localStorage.getItem('daytona_sent_records') || '[]');
            if(!sentRecs.includes(recordId)) { sentRecs.push(recordId); localStorage.setItem('daytona_sent_records', JSON.stringify(sentRecs)); }
        }
        
        window.logEmailSent = function() {
             const now = Date.now();
             let timestamps = JSON.parse(localStorage.getItem('daytona_email_timestamps') || '[]');
             timestamps.push(now);
             localStorage.setItem('daytona_email_timestamps', JSON.stringify(timestamps));
             window.checkEmailRateLimit();
             if(currentRecordId) window.markEmailSentForRecord(currentRecordId);
        }

        window.safeJSONParse = function(str) { try { if (typeof str === 'object' && str !== null) return str; const parsed = JSON.parse(str); if (typeof parsed === 'string') return JSON.parse(parsed); return parsed; } catch (e) { return null; } };

        // --- FETCH UTILS ---
        async function fetchWithPolling(url, options) {
            let res = await fetch(url, options);
            if (res.status === 202) {
                const location = res.headers.get('location');
                if (!location) throw new Error("Async 202 received but no Location header.");
                let retries = 0;
                while (retries < 40) { await new Promise(r => setTimeout(r, 3000)); let pollRes = await fetch(location); if (pollRes.status === 200) return pollRes; if (pollRes.status === 202) { retries++; continue; } throw new Error(`Polling failed: ${pollRes.status}`); }
                throw new Error("Polling timed out.");
            }
            return res;
        }
        
        // --- NOTES LOGIC ---
        window.generateAiSummary = function(record) {
            const notes = getVal(record, 'cr714_qbnotes', '').trim();
            const mgrNotes = getVal(record, 'cr714_managernotes', '').trim();
            const impInfo = getVal(record, 'cr714_importantaccountinformation', '').trim();
            let summaryHtml = "";
            if (impInfo) summaryHtml += `<div class="ai-box ai-imp"><div class="ai-header"><i class="fas fa-exclamation-triangle"></i> IMPORTANT INFO</div><div class="ai-body">${escapeHTML(impInfo)}</div></div>`;
            if (mgrNotes) summaryHtml += `<div class="ai-box ai-mgr"><div class="ai-header"><i class="fas fa-user-tie"></i> MANAGER FEEDBACK</div><div class="ai-body">${escapeHTML(mgrNotes)}</div></div>`;
            if (notes) {
                const qbLines = notes.split('\n').filter(line => line.trim() !== '------------------------------' && line.trim() !== '' && !line.includes('Modified On:') && !line.includes('Modified By:')).slice(0, 5);
                if (qbLines.length > 0) summaryHtml += `<div class="ai-box ai-key"><div class="ai-header"><i class="fas fa-file-alt"></i> KEY ACCOUNT DATA</div><div class="ai-body">${escapeHTML(qbLines.join('\n'))}</div></div>`;
            }
            return summaryHtml;
        }

        window.parseNotes = function(rawNotes) { 
            if (!rawNotes) return []; 
            let cleanRaw = rawNotes.replace(/\r\n/g, '\n');
            const rawEntries = cleanRaw.split(/[-]{5,}/).filter(s => s.trim().length > 0); 
            const parsed = []; 
            rawEntries.forEach(entry => { 
                const lines = entry.trim().split('\n'); 
                let date = "Unknown Date"; let author = "Unknown User"; let content = []; 
                lines.forEach(line => { 
                    if (line.toLowerCase().includes('modified on:')) { date = line.split(':')[1].trim().split(' ')[0]; } 
                    else if (line.toLowerCase().includes('modified by:')) { author = line.split(':')[1].trim(); } 
                    else { content.push(line); } 
                }); 
                let cleanContent = content.join('\n').trim().replace(/\n{3,}/g, '\n\n');
                if (cleanContent) parsed.push({ date, author, text: cleanContent }); 
            }); 
            return parsed; 
        }

        window.toggleNoteView = function(id) { window.updateNotesPreview(); }

        window.updateNotesPreview = function() {
            if(!currentSelectedRecord) {
                document.getElementById('qb-notes-preview').innerHTML = '<div class="text-center italic mt-10" style="color: var(--text-muted);">Select an account.</div>';
                return;
            }
            
            const showAI = document.getElementById('show-ai-summary')?.checked; 
            const showNew = document.getElementById('show-new-note')?.checked; 
            const showPrev = document.getElementById('show-prev-note')?.checked; 
            const genVal = document.getElementById('qb-notes-input')?.value.replace(QB_NOTES_TEMPLATE, '').trim();
            const intVal = document.getElementById('internal-note-input') ? document.getElementById('internal-note-input').value.trim() : '';
            let html = '';
            
            if(showAI) html += window.generateAiSummary(currentSelectedRecord);
            if(showNew && (genVal || intVal)) {
                html += `<div class="ai-box ai-key" style="border-color: var(--accent-warning); background: var(--bg-input);"><div class="ai-header" style="color: var(--accent-warning);"><i class="fas fa-pencil-alt"></i> Draft Note Preview</div><div class="ai-body">`;
                if(genVal) html += `<div>${window.escapeHTML(genVal)}</div>`;
                if(genVal && intVal) html += `<br><hr style="border-color:var(--border-color)"><br>`;
                if(intVal) html += `<div><strong>INTERNAL NOTE:</strong><br>${window.escapeHTML(intVal)}</div>`;
                html += `</div></div>`;
            }
            if(showPrev) { 
                const history = window.parseNotes(currentSelectedRecord.cr714_qbnotes || ''); 
                if(history.length > 0) {
                    history.forEach(item => { 
                        let cleanText = item.text.replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n');
                        html += `<div class="note-card"><div class="note-card-header"><span><i class="far fa-clock mr-1"></i> ${window.escapeHTML(item.date)}</span><span class="uppercase tracking-wider"><i class="fas fa-user mr-1"></i> ${window.escapeHTML(item.author)}</span></div><div class="note-card-body">${window.escapeHTML(cleanText)}</div></div>`;
                    });
                } else {
                    html += '<div class="text-xs text-muted italic p-2 text-center">No history available.</div>';
                }
            }
            
            document.getElementById('qb-notes-preview').innerHTML = html || '<div class="text-center italic mt-10" style="color: var(--text-muted);">No notes available for this account.</div>';
        }

        // --- CORE LOGIC ---
        window.loadRecords = async function() {
            const list = document.getElementById('record-gallery-list'); 
            list.innerHTML = '<div class="loader">Loading...</div>'; 
            document.getElementById('global-loader').style.display = 'flex'; 
            document.getElementById('global-loader').style.opacity = '1'; 
            allRecords = [];
            try {
                const response = await fetchWithPolling(GET_MY_RECORDS_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ repName: currentUserRepName }) });
                if (!response.ok) throw new Error(`Flow Error: ${response.status}`);
                let data = await response.json();
                if (typeof data === 'string') { try { data = JSON.parse(data); } catch(e) {} }
                if (data.accountList && Array.isArray(data.accountList)) { allRecords = data.accountList; if (data.userProfile) currentUserProfile = data.userProfile; } else if (Array.isArray(data)) { allRecords = data; }
                document.getElementById('record-count').textContent = allRecords.length;
                const dropdown = document.getElementById('filter-action-dropdown');
                if(dropdown) {
                    const recordActions = new Set(allRecords.map(r => r.cr714_action).filter(Boolean));
                    const allActions = new Set([...STANDARD_ACTIONS, ...recordActions]);
                    dropdown.innerHTML = '<option value="">Filter: All Actions</option>';
                    allActions.forEach(a => dropdown.innerHTML += `<option value="${a}">${a}</option>`);
                    dropdown.disabled = false;
                }
                window.filterAndSortGallery();
                document.getElementById('global-loader').style.opacity = '0'; 
                setTimeout(()=>document.getElementById('global-loader').style.display='none', 500);
            } catch (e) { list.innerHTML = `<div class="p-4 text-red-600 text-center">Error: ${e.message}<br><button onclick="window.loadRecords()" class="mt-2 underline font-bold">Retry</button></div>`; document.getElementById('global-loader').style.display='none'; }
        }

        window.loadSalesData = async function(id) {
            const container = document.getElementById('sales-content');
            const loader = document.getElementById('sales-loader');
            const placeholder = document.getElementById('sales-placeholder');
            const acctName = document.getElementById('sales-customer-name');
            const ytdDisplay = document.getElementById('sales-ytd');
            const acctInfoBox = document.getElementById('sales-account-info');
            
            if(acctName) acctName.textContent = currentSelectedRecord ? currentSelectedRecord.cr714_company : '--';
            if(ytdDisplay) ytdDisplay.textContent = '--';
            if(acctInfoBox) { acctInfoBox.innerHTML = ''; acctInfoBox.classList.add('hidden'); }
            
            placeholder.classList.add('hidden'); 
            container.classList.add('hidden');
            loader.classList.remove('hidden');    
            
            try {
                const res = await fetchWithPolling(SALES_DATA_FLOW_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ text: id, accountId: id }) });
                if(!res.ok) throw new Error(`Sales API Error: ${res.status}`);
                const json = await res.json();
                const root = json.body ? json.body : json;

                if (root.customers) {
                    let custData = window.safeJSONParse(root.customers) || [];
                    if (Array.isArray(custData) && custData.length > 0) {
                        const cust = custData[0];
                        const nameField = document.getElementById('contact-name-most');
                        if (!nameField.value || nameField.value === 'Unknown Name') nameField.value = cust['[FullName_most]'] || cust['[FullName_latest]'] || '';
                        const phoneField = document.getElementById('contact-phone-primary');
                        if (!phoneField.value) phoneField.value = cust['[Phone]'] || '';
                        const emailField = document.getElementById('contact-email-most');
                        emailField.value = cust['[Email_most]'] || cust['[Email_latest]'] || '';
                        if(acctInfoBox) {
                            let infoHtml = '';
                            if(cust['[Phone]']) infoHtml += `<div><i class="fas fa-phone mr-1 text-muted"></i> ${cust['[Phone]']}</div>`;
                            if(cust['[Email_most]']) infoHtml += `<div><i class="fas fa-envelope mr-1 text-muted"></i> ${cust['[Email_most]']}</div>`;
                            if(infoHtml) { acctInfoBox.innerHTML = infoHtml; acctInfoBox.classList.remove('hidden'); }
                        }
                    }
                }
                
                let salesData = [];
                if (root.salesByCategory) salesData = window.safeJSONParse(root.salesByCategory) || [];
                let total = 0;
                const list = document.getElementById('sales-category-list');
                list.innerHTML = '';
                
                if (salesData.length > 0) {
                    salesData.sort((a, b) => parseFloat(b["[Sales_Last3Months]"]||0) - parseFloat(a["[Sales_Last3Months]"]||0));
                    salesData.forEach(s => {
                        const amt = parseFloat(s["[Sales_Last3Months]"] || 0);
                        total += amt;
                        list.innerHTML += `<li class="flex justify-between border-b py-2 border-dashed" style="border-color: var(--border-color)"><span class="text-muted font-medium">${window.escapeHTML(s["DimItemIDitemtypegroup[ItemTypeGroupDescription]"]||"Unknown")}</span><span class="font-bold text-brand">$${amt.toFixed(2)}</span></li>`;
                    });
                    if(ytdDisplay) ytdDisplay.innerText = `$${total.toFixed(2)}`;
                    container.classList.remove('hidden');
                } else {
                    if(ytdDisplay) ytdDisplay.innerText = "$0.00";
                    list.innerHTML = `<li class="text-center text-muted italic text-xs py-4">No sales found in the last 3 months.</li>`;
                    container.classList.remove('hidden');
                }
            } catch(e) { 
                placeholder.innerHTML = `<div class="text-red-500 font-bold">Error loading sales. <br><button onclick="window.loadSalesData('${id}')" class="underline mt-1">Retry</button></div>`;
                placeholder.classList.remove('hidden'); 
            } finally { loader.classList.add('hidden'); }
        }

        window.populateForm = function(rec) {
            if(!rec) return;
            document.getElementById('acct-number-header').innerText = rec.cr714_id || '--';
            document.getElementById('acct-company').innerText = rec.cr714_company || '--';
            document.getElementById('acct-action-message').innerText = rec.cr714_actionmessage || rec.cr714_action || '--';
            document.getElementById('acct-action').innerText = rec.cr714_action || '--';

            const marquee = document.getElementById('marquee-text');
            if (marquee) {
                marquee.innerText = `Customer: ${rec.cr714_company} (${rec.cr714_id}) - Invoiced Sales Only - May Not Include Open Orders!`;
            }
            
            const sentRecs = JSON.parse(localStorage.getItem('daytona_sent_records') || '[]');
            const isSent = sentRecs.includes(String(rec.cr714_id));
            const sentBadge = document.getElementById('profile-sent-badge');
            if(isSent) sentBadge.classList.remove('hidden'); else sentBadge.classList.add('hidden');

            const fields = {'contact-name-most': 'cr714_namemost', 'contact-name-latest': 'cr714_namelatest', 'contact-phone-primary': 'cr714_primaryphone', 'contact-email-most': 'cr714_emailmost', 'contact-email-latest': 'cr714_emaillatest'};
            for(const [id, key] of Object.entries(fields)) { const el = document.getElementById(id); if(el) el.value = rec[key] || ''; }
            
            document.getElementById('qb-notes-input').value = ""; document.getElementById('qb-notes-input').placeholder = QB_NOTES_TEMPLATE;
            if(document.getElementById('internal-note-input')) document.getElementById('internal-note-input').value = "";
            document.getElementById('internal-note-wrapper').classList.remove('open');

            const dd = document.getElementById('email-template-dropdown');
            dd.innerHTML = ""; 
            const genericOptions = [
                {val: "Green Category.msg", txt: "Green Category"}, 
                {val: "Green Follow Up Email.msg", txt: "Green Follow Up"}, 
                {val: "Green Non-Buy Email.msg", txt: "Green Non-Buy"}, 
                {val: "Yellow Non-Buy Email.msg", txt: "Yellow Non-Buy"}
            ];
            
            let specificOption = null;
            if(rec.cr714_action === "Chair Mat Contest") specificOption = {val: "Chair Mat Promo", txt: "Chair Mat Promo"};
            else if(rec.cr714_action === "NONBUY") specificOption = {val: "15% Off Coupon", txt: "15% Off Coupon"};
            else if(rec.cr714_action === "NOVNoSales") specificOption = {val: "10% Off Coupon", txt: "10% Off Coupon"};
            else if(rec.cr714_action === "Prospecting") specificOption = {val: "Trying To Reach You", txt: "Trying To Reach You"};

            if(specificOption) { dd.innerHTML += `<option value="${specificOption.val}">${specificOption.txt}</option>`; }
            genericOptions.forEach(o => dd.innerHTML += `<option value="${o.val}">${o.txt}</option>`);

            const filterVal = document.getElementById('filter-action-dropdown').value;
            if(filterVal && filterVal === rec.cr714_action && specificOption) { dd.value = specificOption.val; }

            const dEl = document.getElementById('follow-up-date'), tEl = document.getElementById('follow-up-time');
            if(rec.cr714_followup) { const dt = new Date(rec.cr714_followup); if(!isNaN(dt)) { dEl.value = dt.toISOString().split('T')[0]; tEl.value = dt.toTimeString().substring(0,5); } else { dEl.value=''; tEl.value=''; } } else { dEl.value=''; tEl.value=''; }
            
            const hasMgr = (rec.cr714_managernotes && rec.cr714_managernotes.trim().length > 0);
            const hasImp = (rec.cr714_importantaccountinformation && rec.cr714_importantaccountinformation.trim().length > 0);
            const alertBtn = document.getElementById('btn-account-alerts');
            if (hasMgr || hasImp) {
                alertBtn.classList.remove('hidden');
                if (hasMgr) alertBtn.className = "btn-alert-base btn-has-data-red text-xs px-2 rounded";
                else alertBtn.className = "btn-alert-base btn-has-data-yellow text-xs px-2 rounded";
                window.showAdvisory();
            } else { alertBtn.classList.add('hidden'); }
            window.updateNotesPreview();
        }

        window.selectRecord = function(id) {
            currentRecordId = String(id);
            currentSelectedRecord = allRecords.find(r => String(r.cr714_id) === currentRecordId);
            const items = document.querySelectorAll('.gallery-item');
            items.forEach(item => { if(item.innerHTML.includes(id)) item.classList.add('is-selected'); else item.classList.remove('is-selected'); });
            if(currentSelectedRecord) { window.populateForm(currentSelectedRecord); window.loadSalesData(id); isEditMode = true; window.updateFormDisplayMode(); document.getElementById('qb-notes-input').focus(); }
        }

        window.filterAndSortGallery = function() {
            const search = window.getElementValue('search-bar')?.toLowerCase() || '';
            const sort = window.getElementValue('sort-dropdown') || 'company-asc';
            const filter = window.getElementValue('filter-action-dropdown') || '';
            const filterFollow = document.getElementById('filter-followup')?.checked;
            const filterNoNotes = document.getElementById('filter-nonotes')?.checked;
            const filterRequests = document.getElementById('filter-requests')?.checked;
            const filterNoRecent = document.getElementById('filter-norecent')?.checked;
            const filterHideSent = document.getElementById('filter-hidesent')?.checked;
            const sentRecs = JSON.parse(localStorage.getItem('daytona_sent_records') || '[]');

            let filtered = allRecords.filter(r => {
                if (!r.cr714_id) return false;
                if(filter && r.cr714_action !== filter) return false;
                if(filterFollow && !r.cr714_followup) return false;
                if(filterNoNotes && (r.cr714_qbnotes || '').trim() !== '') return false;
                if(filterRequests && !['Help','No Opp','Close Account'].includes(r.cr714_action)) return false; 
                if(search && !JSON.stringify(r).toLowerCase().includes(search)) return false;
                if(filterHideSent && sentRecs.includes(String(r.cr714_id))) return false;
                if (filterNoRecent) {
                    const notes = window.parseNotes(r.cr714_qbnotes || '');
                    if (notes.length > 0) { const lastDate = new Date(notes[0].date); if (!isNaN(lastDate) && Math.ceil(Math.abs(new Date() - lastDate)/(1000*60*60*24)) < 14) return false; }
                }
                return true;
            });
            filtered.sort((a, b) => {
                const get = (item, key) => (item[key] || '').toString().toLowerCase();
                if(sort.includes('company')) return sort === 'company-asc' ? get(a,'cr714_company').localeCompare(get(b,'cr714_company')) : get(b,'cr714_company').localeCompare(get(a,'cr714_company'));
                if(sort.includes('followup')) {
                    const da = a.cr714_followup ? new Date(a.cr714_followup) : new Date(sort === 'followup-asc' ? 8640000000000000 : -8640000000000000);
                    const db = b.cr714_followup ? new Date(b.cr714_followup) : new Date(sort === 'followup-asc' ? 8640000000000000 : -8640000000000000);
                    return sort === 'followup-asc' ? da - db : db - da;
                }
                if(sort.includes('days')) { const da = parseFloat(a.cr714_dayssincelastorder) || 0; const db = parseFloat(b.cr714_dayssincelastorder) || 0; return sort === 'days-asc' ? da - db : db - da; }
                if(sort.includes('rep')) return sort === 'rep-asc' ? get(a,'cr714_rep').localeCompare(get(b,'cr714_rep')) : get(b,'cr714_rep').localeCompare(get(a,'cr714_rep'));
                return 0;
            });
            const list = document.getElementById('record-gallery-list'); list.innerHTML = '';
            document.getElementById('record-count').textContent = filtered.length;
            if(filtered.length === 0) { list.innerHTML = '<div class="loader">No records found.</div>'; return; }
            filtered.forEach(r => {
                const div = document.createElement('div');
                const isSent = sentRecs.includes(String(r.cr714_id));
                div.className = `gallery-item ${currentRecordId === String(r.cr714_id) ? 'is-selected' : ''} ${isSent ? 'has-sent-email' : ''}`;
                div.onclick = () => window.selectRecord(r.cr714_id);
                let followUpBadge = '';
                if(r.cr714_followup) { const d = new Date(r.cr714_followup); if(!isNaN(d)) followUpBadge = `<span class="gallery-item-followup"><i class="fas fa-clock mr-1"></i>${d.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>`; }
                let repDisplay = `<span class="text-xs text-muted italic"><i class="fas fa-user mr-1"></i>Rep: ${window.escapeHTML(r.cr714_rep)}</span>`;
                div.innerHTML = `<div class="flex justify-between items-start w-full"><span class="gallery-item-id">${r.cr714_id}<i class="fas fa-envelope-circle-check sent-indicator" title="Email Sent"></i></span>${followUpBadge}</div><div class="gallery-item-company">${window.escapeHTML(r.cr714_company)}</div>${repDisplay}`;
                list.appendChild(div);
            });
        }

        window.updateFormDisplayMode = function() {
            const btn = document.getElementById('editModeButton');
            const saveControls = document.getElementById('save-controls');
            if(btn) {
                btn.innerHTML = isEditMode ? '<i class="fas fa-eye"></i> View' : '<i class="fas fa-pencil-alt"></i> Edit Profile';
                btn.disabled = !currentSelectedRecord;
                if (isEditMode) { btn.className = "py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold text-black bg-yellow-400 hover:bg-yellow-500"; } 
                else { btn.className = "py-1 px-3 text-xs rounded-md shadow transition-all duration-200 font-bold bg-gray-200 text-gray-700 hover:bg-gray-300"; }
            }
            if(saveControls) saveControls.style.display = isEditMode ? 'flex' : 'none';
            document.querySelectorAll('.editable-field, #follow-up-date, #follow-up-time').forEach(el => { el.disabled = !isEditMode; if(isEditMode) { el.removeAttribute('disabled'); el.classList.add('is-editable'); } else { el.setAttribute('disabled', 'true'); el.classList.remove('is-editable'); } });
            
            const noteInputs = ['qb-notes-input', 'internal-note-input'];
            noteInputs.forEach(id => { const el = document.getElementById(id); if (el) { if(isEditMode) { el.removeAttribute('disabled'); el.classList.add('is-editable'); el.style.opacity = '1'; } else { el.setAttribute('disabled', 'true'); el.classList.remove('is-editable'); } } });
            ['launch-email-button', 'email-template-dropdown', 'help-button', 'noopp-button', 'close-button'].forEach(id => { const el = document.getElementById(id); if(el) el.disabled = !isEditMode; });
        }
        
        window.toggleEditMode = function() {
            if(!currentSelectedRecord) return;
            isEditMode = !isEditMode;
            window.updateFormDisplayMode();
        }

        window.createCalendarEvent = function() {
            if(!currentSelectedRecord) return;
            const d = document.getElementById('follow-up-date').value; const t = document.getElementById('follow-up-time').value;
            if(!d) { window.showNotification("Error", "Pick date."); return; }
            let dtStart = t ? `${d.replace(/-/g,'')}T${t.replace(':','')}00` : `${d.replace(/-/g,'')}`;
            let dtEnd = t ? `${d.replace(/-/g,'')}T${(parseInt(t.split(':')[0])+1).toString().padStart(2,'0')}${t.split(':')[1]}00` : `${d.replace(/-/g,'')}`;
            const description = `Account: ${currentSelectedRecord.cr714_company}\nNotes:\n${document.getElementById('qb-notes-input').value}`;
            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${dtStart}\nDTEND:${dtEnd}\nSUMMARY:Follow Up: ${currentSelectedRecord.cr714_company}\nDESCRIPTION:${description.replace(/\n/g, '\\n')}\nEND:VEVENT\nEND:VCALENDAR`;
            const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a'); link.href = window.URL.createObjectURL(blob); link.setAttribute('download', 'FollowUp.ics'); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        window.launchEmailLogic = function() {
            if (!currentSelectedRecord) { window.showNotification("Error", "Select record."); return; }
            if (!window.checkEmailRateLimit()) { window.showNotification("Limit Reached", "Wait."); return; }
            
            const mainEmailField = document.getElementById('contact-email-most');
            const emailValue = mainEmailField ? mainEmailField.value.trim() : '';
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailValue || !emailRegex.test(emailValue)) {
                window.showNotification("Invalid Email", "Valid email required in Primary Contact field.");
                if(mainEmailField) { mainEmailField.style.borderColor = "red"; setTimeout(() => mainEmailField.style.borderColor = "", 3000); }
                return;
            }

            const action = currentSelectedRecord.cr714_action;
            const templateVal = document.getElementById('email-template-dropdown').value;
            const accName = currentSelectedRecord.cr714_company;
            const accNum = currentSelectedRecord.cr714_id;
            
            let subject = `It's ${currentUserRepName} with WB Mason--ACC# ${accNum} // ${accName}`; 
            let body = "";

            if (templateVal === "Green Category.msg") { body = `Good Morning/Afternoon,<br><br>Thank you for speaking with me today. I will be on the lookout for your order confirmations.<br>While I wait, I want to show you a quick view of some of the pricing we offer for items you buy.<br>Let me know if you are getting different items or better pricing elsewhere.<br><br><img src="${IMG_CHAIR}" style="max-width:100%;"><br>`; }
            else if (templateVal === "Green Follow Up Email.msg") { body = `Good Morning/Afternoon!<br><br>I was unable to reach you today. When we spoke, you stated that you would review my email and provide a list of items you are purchasing from my competitors for us to quote.<br>I have not heard from you and wanted to follow up on this to see if you have gotten the chance to review.<br><br>Will you be able to send over items to quote before your next office supply order so you can start saving sooner than later?<br><br>When can I expect to see that list to get started on your savings?`; }
            else if (templateVal.includes("Non-Buy")) { subject = `WB Mason, Price Match Program--${accNum} // ${accName}`; body = `Good morning/afternoon!<br><br>Thank you for speaking with me today. It is my responsibility as a part of the retention department to deliver the best experience possible for our customers.<br><br>I would like for W.B Mason to be a one-stop-shop for all your business needs.<br>Before your next order with my competitor, send me any recent order confirmations or their shopping cart from them and I will at least match any pricing if I am not already lower.<br><br>Just for the opportunity to show you better pricing on the items you buy from my competitors, we will be giving you 15% off your next order of those items.<br><br>With that said, what would be a good date and time to connect with you regarding your account?`; }
            
            if (CUSTOM_FLOW_ACTIONS.includes(action)) {
                 const isActionTemplateSelected = (
                    (action === "Chair Mat Contest" && templateVal === "Chair Mat Promo") ||
                    (action === "NONBUY" && templateVal === "15% Off Coupon") ||
                    (action === "NOVNoSales" && templateVal === "10% Off Coupon") ||
                    (action === "Prospecting" && templateVal === "Trying To Reach You")
                 );

                 if (isActionTemplateSelected) {
                     if (action === "Chair Mat Contest") {
                        subject = `${accNum} - A Promo That Matters`;
                        body = `I wanted to reach out as it looks like youâ€™ve purchased a chair with us recently. Are you in need of a chair mat for your office?<br><br>Please see attached link for both carpeted and hardwood options: Shop Chair Mats | W.B. Mason.<br><br>Iâ€™m happy to help narrow down selections and help search for what will best fit your business needs. Let me know how I can assist!<br><br><img src="${IMG_CHAIR}" style="max-width:100%;"><br>`;
                     } else if (action === "NONBUY") {
                        subject = "WB Mason - 15% Off";
                        body = `Iâ€™m reaching out to see if thereâ€™s anything you need before the end of the month. I didnâ€™t see you placed any orders recently.<br><br>I just received a coupon you can use through the end of the month!<br><br><img src="${IMG_15_OFF}" style="max-width:100%;"><br>`;
                     } else if (action === "NOVNoSales") {
                        subject = "WB Mason - 10% Off";
                        body = `Iâ€™m reaching out to see if thereâ€™s anything you need before the end of the month. I didnâ€™t see you placed any orders recently.<br><br>I just received a coupon you can use through the end of the month!<br><br><img src="${IMG_10_OFF}" style="max-width:100%;"><br>`;
                     } else if (action === "Prospecting") {
                        subject = `Trying To Reach You - ${accNum} // ${accName}`;
                        body = `Good Morning/Afternoon,<br><br>I am reaching out to you as I was advised you handle where you currently purchase supplies for your company?<br><br>It doesn't look like you've ordered in a little while and we miss your business!<br>I would love the opportunity to price out your top 10 most purchased items.<br><br>Simply send me a copy of a recent invoice, order confirmation, favorites list or just the top items you purchase with the current item numbers you are buying from a competitor.<br><br>If this is something that you are interested in, please contact me directly or reply to this email.<br><br>I look forward to your future business! At W.B. Mason we guarantee:<br><ul><li>Customized pricing with amazing prices on what your business actually orders.</li><li>Free delivery with no order minimums.</li><li>Personal driver, customer service representative, and inside sales representative.</li><li>One-stop shopping for all your needs, no need to go anywhere else!</li></ul>`;
                     }
                 }
            }

            // Append Signature Image to all templates
            body += `<br><br><img src="${IMG_SIG}" style="max-width:100%;">`;

            document.getElementById('email-modal-to').value = emailValue;
            document.getElementById('email-modal-subject').value = subject;
            document.getElementById('email-modal-body').innerHTML = body; 
            
            const el = document.getElementById('email-modal');
            el.classList.remove('hidden');
            el.style.display = 'flex';
            window.checkEmailRateLimit();
            window.updateEmailPreview();
        }

        window.handleModalSend = function() { if (!window.checkEmailRateLimit()) { window.showNotification("Rate Limit", "Wait."); return; } window.sendCustomEmailViaFlow(); }

        window.updateEmailPreview = function() {
            const to = document.getElementById('email-modal-to').value;
            const sub = document.getElementById('email-modal-subject').value;
            const bodyNote = document.getElementById('email-modal-body').innerHTML;
            const action = currentSelectedRecord ? currentSelectedRecord.cr714_action : "";
            const accName = currentSelectedRecord ? currentSelectedRecord.cr714_company : "";
            let html = `<div style="font-family: 'Segoe UI', sans-serif; color: #1f2937; line-height: 1.4;"><div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;"><p style="color:green; font-weight:bold;">TO: ${window.escapeHTML(to)}</p><p style="color:green; font-weight:bold;">Subject: ${window.escapeHTML(sub)}</p><p>Hi <span style="color:green; font-weight:bold;">${window.escapeHTML(accName)}</span>,</p></div><div style="color:black; font-weight:normal; margin: 10px 0;">${bodyNote}</div><div style="margin-top:20px; font-size:14px; border-top: 1px solid #eee; padding-top: 10px;">Thank you,<br><b>${currentUserRepName}</b> | W.B. MASON CO, INC.<br>Email: ${msalAccount ? msalAccount.username : ''} | <a href="https://www.wbmason.com" style="color:#0b66c3;">www.wbmason.com</a></div></div>`;
            document.getElementById('email-modal-preview').innerHTML = html;
        }

        window.sendCustomEmailViaFlow = async function() {
            window.showNotification("Sending...", "Dispatching via Flow...");
            const action = currentSelectedRecord.cr714_action;
            const editedTo = document.getElementById('email-modal-to').value;
            const editedSub = document.getElementById('email-modal-subject').value;
            const bodyHTML = document.getElementById('email-modal-body').innerHTML;
            const accName = currentSelectedRecord.cr714_company;
            const fullHtmlBody = `Hi <b>${accName}</b>,<br><br>${bodyHTML}<br><br>Thank you,<br>${currentUserRepName}`;

            const payload = { action: action, to: editedTo, subject: editedSub, body: fullHtmlBody, repEmail: msalAccount ? msalAccount.username : '', recordId: currentRecordId };
            try {
                const res = await fetch(SEND_EMAIL_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error("Email Flow Error");
                window.logEmailSent(); 
                document.getElementById('email-modal').classList.add('hidden');
                document.getElementById('email-modal').style.display = 'none';
                window.showNotification("Success", "Email Sent via Flow!");
                window.handleCustomSave(`Action Email Sent (Flow).\nSubject: ${payload.subject}`, true);
                window.filterAndSortGallery(); 
            } catch(e) { window.showNotification("Error", e.message); }
        }
        
        window.handleActionButtonClick = async function(type, customMessage = null) {
             if(!currentSelectedRecord) return;
             if(type === 'LaunchEmail') { window.launchEmailLogic(); return; }
             window.showNotification("Processing...", `Sending ${type}...`);
             let notes = customMessage ? customMessage : window.getElementValue('qb-notes-input').replace(QB_NOTES_TEMPLATE, '').trim();
             const data = { recordId: currentRecordId, action: type, notes: notes, repName: currentUserRepName };
             try {
                 const res = await fetch(ACTION_BUTTON_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                 if(!res.ok) throw new Error("Action Error");
                 window.showNotification("Success", `${type} Completed.`);
             } catch(e) { window.showNotification("Error", e.message); }
        }
        
        // UTILS
        window.closeManagerFeedback = function() { document.getElementById('manager-feedback-modal').style.display = 'none'; }
        window.closeImportantInfo = function() { document.getElementById('important-info-modal').style.display = 'none'; }
        window.promptAdminLogin = function() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('admin-modal').style.display = 'flex'; document.getElementById('admin-password').focus(); }
        window.closeAdminModal = function() { document.getElementById('admin-modal').classList.add('hidden'); document.getElementById('admin-modal').style.display = 'none'; }
        window.checkAdminPassword = function() {
            const passInput = document.getElementById('admin-password'); const repInputDiv = document.getElementById('admin-rep-input'); const repNameInput = document.getElementById('override-rep-name');
            if (passInput.value === "daytona123" || passInput.value === "admin") {
                if (repInputDiv.classList.contains('hidden')) { repInputDiv.classList.remove('hidden'); passInput.disabled = true; document.getElementById('admin-action-btn').textContent = "Load Rep Data"; repNameInput.focus(); } 
                else { currentUserRepName = repNameInput.value.trim(); window.showNotification("Success", `Switched to user: ${currentUserRepName}`); window.closeAdminModal(); window.loadRecords(); document.getElementById('welcome-message').innerHTML = `<i class="fas fa-user-secret"></i> ${currentUserRepName}`; }
            } else { window.showNotification("Error", "Invalid Password"); }
        }

        window.toggleInternalNote = function() { const w = document.getElementById('internal-note-wrapper'); if(w.classList.contains('open')) w.classList.remove('open'); else { w.classList.add('open'); document.getElementById('internal-note-input').focus(); } }
        window.sendInternalNote = function() { const val = document.getElementById('internal-note-input').value.trim(); if(!val) { window.showNotification("Error", "Type a message."); return; } window.handleActionButtonClick('Help', val); document.getElementById('internal-note-input').value = ""; window.toggleInternalNote(); }
        
        window.showAdvisory = function() {
            if(!currentSelectedRecord) return;
            const mgr = currentSelectedRecord.cr714_managernotes || ""; const imp = currentSelectedRecord.cr714_importantaccountinformation || "";
            if (!mgr.trim() && !imp.trim()) return;
            let html = "";
            if (mgr.trim()) html += `<div class="border-l-4 border-red-500 bg-red-50 p-4 rounded shadow-sm text-gray-800"><h4 class="font-bold text-red-700 text-sm uppercase mb-1">Manager Feedback</h4><p class="text-sm font-medium whitespace-pre-wrap">${window.escapeHTML(mgr)}</p></div>`;
            if (imp.trim()) html += `<div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded shadow-sm text-gray-800"><h4 class="font-bold text-yellow-700 text-sm uppercase mb-1">Important Info</h4><p class="text-sm font-medium whitespace-pre-wrap">${window.escapeHTML(imp)}</p></div>`;
            document.getElementById('advisory-content').innerHTML = html;
            document.getElementById('advisory-modal').classList.remove('hidden');
            document.getElementById('advisory-modal').style.display = 'flex';
        }
        window.closeAdvisory = function() { document.getElementById('advisory-modal').classList.add('hidden'); document.getElementById('advisory-modal').style.display = 'none'; }
        
        window.showUserProfileCard = function() {
            let p = { name: currentUserRepName, title: 'Sales Rep', department: 'Sales', location: 'Unknown', manager: 'Unknown', isGold: false };
            if (currentUserProfile) { 
                p.name = currentUserProfile['cr714_employeename'] || currentUserProfile['cr714_name'] || p.name;
                p.title = currentUserProfile['cr714_title@OData.Community.Display.V1.FormattedValue'] || currentUserProfile['cr714_title'] || 'Rep';
                p.department = currentUserProfile['cr714_department@OData.Community.Display.V1.FormattedValue'] || '--';
                p.location = currentUserProfile['cr714_location@OData.Community.Display.V1.FormattedValue'] || '--';
                p.manager = currentUserProfile['cr714_managerassigned'] || '--';
                p.secondaryManager = currentUserProfile['cr714_backupcsr'] || '--';
                p.srManager = currentUserProfile['cr714_srmanager'] || '--';
                p.supervisor = currentUserProfile['cr714_director@OData.Community.Display.V1.FormattedValue'] || '--';
                
            }
            document.getElementById('popout-name').textContent = p.name; 
            document.getElementById('popout-title').textContent = p.title; 
            document.getElementById('popout-department').textContent = p.department; 
            document.getElementById('popout-location').textContent = p.location; 
            document.getElementById('popout-manager').textContent = p.manager;
            document.getElementById('popout-secondary-manager').textContent = p.secondaryManager;
            document.getElementById('popout-sr-manager').textContent = p.srManager;
            document.getElementById('popout-supervisor').textContent = p.supervisor;
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-modal').style.display = 'flex';
        };

        window.handleCustomSave = async function(note=null, quiet=false) {
            let n = note ? note : document.getElementById('qb-notes-input').value.replace(QB_NOTES_TEMPLATE, '').trim();
            const full = (n ? `------------------------------\nModified On: ${new Date().toLocaleString()}\nModified By: ${currentUserRepName}\n\n${n}\n\n` : "") + (currentSelectedRecord.cr714_qbnotes || '');
            if(!isEditMode && !note) return;
            if (!quiet) window.showNotification("Saving...", "Please wait...");
            let d=document.getElementById('follow-up-date').value, t=document.getElementById('follow-up-time').value, iso=d ? (t?`${d}T${t}:00Z`:`${d}T00:00:00Z`):null;
            const payload = { recordId: currentRecordId, qbNotes: full, followUp: iso, nameMost: document.getElementById('contact-name-most').value, nameLatest: document.getElementById('contact-name-latest').value, primaryPhone: document.getElementById('contact-phone-primary').value, emailMost: document.getElementById('contact-email-most').value, emailLatest: document.getElementById('contact-email-latest').value, repName: currentUserRepName };
            try { 
                const res = await fetch(PATCH_RECORD_FLOW_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error("Flow Error");
                if (!quiet) window.showNotification("Success", "Saved!");
                currentSelectedRecord.cr714_qbnotes=full; currentSelectedRecord.cr714_followup=iso; currentSelectedRecord.cr714_emailmost=payload.emailMost;
                if(isEditMode) { isEditMode=false; window.updateFormDisplayMode(); } window.updateNotesPreview(); window.filterAndSortGallery();
            } catch(e) { window.showNotification("Error", e.message); }
        }

        window.insertTemplate = function() {
            const notesInput = document.getElementById('qb-notes-input');
            if (notesInput && !notesInput.disabled) {
                if (!notesInput.value.includes("Locations:")) { notesInput.value = QB_NOTES_TEMPLATE + notesInput.value; }
                notesInput.focus(); window.updateNotesPreview();
            } else { window.showNotification("Info", "Enable Edit Profile to insert template."); }
        }
        
        window.handleCustomReset = function() {
            if(currentSelectedRecord) {
                window.populateForm(currentSelectedRecord);
                isEditMode = false;
                window.updateFormDisplayMode();
                window.showNotification("Info", "Changes discarded.");
            }
        }

        window.login = function() { msalInstance.loginPopup({ scopes: ["User.Read"] }).then(window.handleMsalResponse).catch(e => { console.error(e); document.getElementById('login-error').textContent = "Login Failed."; document.getElementById('login-error').classList.remove('hidden'); }); }
        window.handleMsalResponse = function(resp) { if(resp && resp.account) { msalAccount = resp.account; currentUserRepName = msalAccount.name; window.initializeApp(); } }
        window.initializeApp = function() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('main-app-container').classList.remove('hidden');
            document.getElementById('main-app-container').style.display = 'flex';
            document.getElementById('welcome-message').textContent = `Hi, ${currentUserRepName.split(' ')[0]}`;
            document.getElementById('welcome-message').classList.remove('hidden');
            document.getElementById('qb-notes-input').placeholder = QB_NOTES_TEMPLATE;
            window.startClock();
            
            // CRITICAL: Explicitly call loadRecords immediately
            setTimeout(() => window.loadRecords(), 200);
            
            window.checkFirstRun();
            
            // --- FAILSAFE LOADER CLEAR ---
            setTimeout(() => { 
                const l = document.getElementById('global-loader'); 
                if(l && l.style.display !== 'none') { 
                    l.style.opacity = '0'; 
                    setTimeout(()=>l.style.display='none', 500); 
                } 
            }, 5000); 
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            window.updateTheme(0);
            msalInstance.handleRedirectPromise().then(resp => { if (resp && resp.account) window.handleMsalResponse(resp); else { const accs = msalInstance.getAllAccounts(); if(accs.length > 0) { msalAccount = accs[0]; currentUserRepName = msalAccount.name; window.initializeApp(); } else { document.getElementById('global-loader').style.display='none'; document.getElementById('login-container').classList.remove('hidden'); document.getElementById('login-container').style.display='flex'; } } }).catch(e => { document.getElementById('global-loader').style.display='none'; document.getElementById('login-container').style.display='flex'; });
        });
    </script>
</body>
</html>
